{"text": "Search LoginPreferencesHelp GuideAbout Trac WikiTimelineRoadmapBrowse SourceView TicketsSearch Context Navigation BlameRevision Log source nomatic tags NomaticIM 3 buddy bots src twisted internet gtk2reactor py View diff against View revision Visit trunk Last change on this file was 712 checked in by cbaker 7 years ago First draft of nomatic buddy bots oscar bot is functional if you give it good authentication credentials jabber bot is just an example from the web File size 9 7 KB Line 1 Copyright c 2 1 2 4 Twisted Matrix Laboratories 2 See LICENSE for details 345 6This module provides support for Twisted to interact with the glib gtk2 mainloop 78In order to use this support simply do the following 91 from twisted internet import gtk2reactor11 gtk2reactor install 1213Then use twisted internet APIs as usual The other methods here are not14intended to be called directly 1516When installing the reactor you can choose whether to use the glib17event loop or the GTK event loop which is based on it but adds GUI18integration 192 API Stability stable2122Maintainer U Itamar Shtull Trauring mailto twisted itamarst org 23 2425 all install 2627 System Imports28import sys29from zope interface import implements3 try 31 if not hasattr sys frozen 32 Don t want to check this for py2exe33 import pygtk34 pygtk require 2 35except ImportError AttributeError 36 pass maybe we re using pygtk before this hack existed 37import gobject38if hasattr gobject threads init 39 recent versions of python gtk expose this python gtk 2 4 14 wrapping glib 2 4 7 does python gtk 2 wrapping41 glib 2 2 3 does not 42 gobject threads init 4344 Twisted Imports45from twisted python import log threadable runtime failure46from twisted internet interfaces import IReactorFDSet4748 Sibling Imports49from twisted internet import main posixbase error selectreactor5 51reads 52writes 53hasReader reads has key54hasWriter writes has key5556 the next callback57 simtag None58POLL DISCONNECTED gobject IO HUP gobject IO ERR gobject IO NVAL596 glib s iochannel sources won t tell us about any events that we haven t61 asked for even if those events aren t sensible inputs to the poll 62 call 63INFLAGS gobject IO IN POLL DISCONNECTED64OUTFLAGS gobject IO OUT POLL DISCONNECTED6566def our mainquit 67 XXX gtk main quit which is used for crash raises an exception if68 gtk main level however all the tests freeze if we use this69 function to stop the reactor what gives I believe this may have been7 a stupid mistake where I forgot to import gtk here I will remove this71 comment if the tests pass 72 import gtk73 if gtk main level 74 gtk main quit 7576class Gtk2Reactor posixbase PosixReactorBase 77 GTK 2 event loop reactor 78 798 implements IReactorFDSet 8182 def init self useGtk True 83 self context gobject main context default 84 self loop gobject MainLoop 85 posixbase PosixReactorBase init self 86 pre 2 3 91 the glib iteration and mainloop functions didn t release87 global interpreter lock thus breaking thread and signal support 88 if hasattr gobject pygtk version and gobject pygtk version 2 3 91 89 and not useGtk 9 self pending self context pending91 self iteration self context iteration92 self crash self loop quit93 self run self loop run94 else 95 import gtk96 self pending gtk events pending97 self iteration gtk main iteration98 self crash our mainquit99 self run gtk main1 1 1 The input add function in pygtk1 checks for objects with a1 2 fileno method and if present uses the result of that method1 3 as the input source The pygtk2 input add does not do this The1 4 function below replicates the pygtk1 functionality 1 51 6 In addition pygtk maps gtk input add to gobject io add watch and1 7 g io add watch takes different condition bitfields than1 8 gtk input add We use g io add watch here in case pygtk fixes this1 9 bug 11 def input add self source condition callback 111 if hasattr source fileno 112 handle python objects113 def wrapper source condition real s source real cb callback 114 return real cb real s condition 115 return gobject io add watch source fileno condition wrapper 116 else 117 return gobject io add watch source condition callback 118119 def addReader self reader 12 if not hasReader reader 121 reads reader self input add reader INFLAGS self callback 122123 def addWriter self writer 124 if not hasWriter writer 125 writes writer self input add writer OUTFLAGS self callback 126127 def removeAll self 128 return self removeAll reads writes 129 13 def removeReader self reader 131 if hasReader reader 132 gobject source remove reads reader 133 del reads reader 134135 def removeWriter self writer 136 if hasWriter writer 137 gobject source remove writes writer 138 del writes writer 13914 doIterationTimer None141142 def doIterationTimeout self args 143 self doIterationTimer None144 return auto remove145 146 def doIteration self delay 147 flush some pending events return if there was something to do148 don t use the usual while self context pending self context iteration 149 idiom because lots of IO in particular test tcp s15 ProperlyCloseFilesTestCase can keep us from ever exiting 151 log msg channel system event iteration reactor self 152 if self pending 153 self iteration 154 return155 nothing to do must delay156 if delay 157 return shouldn t delay so just return158 self doIterationTimer gobject timeout add int delay 1 159 self doIterationTimeout 16 This will either wake up from IO or from a timeout 161 self iteration 1 block162 note with the simulate timer below delays 1 will always be163 woken up by the simulate timer164 if self doIterationTimer 165 if woken by IO need to cancel the timer166 gobject source remove self doIterationTimer 167 self doIterationTimer None168169 def crash self 17 self crash 171172 def run self installSignalHandlers 1 173 self startRunning installSignalHandlers installSignalHandlers 174 gobject timeout add self simulate 175 self run 176 177 def doReadOrWrite self source condition faildict 178 error ConnectionDone failure Failure error ConnectionDone 179 error ConnectionLost failure Failure error ConnectionLost 18 181 why None182 didRead None183 if condition POLL DISCONNECTED and 184 not condition gobject IO IN 185 why main CONNECTION LOST186 else 187 try 188 if condition gobject IO IN 189 why source doRead 19 didRead source doRead191 if not why and condition gobject IO OUT 192 if doRead caused connectionLost don t call doWrite193 if doRead is doWrite don t call it again 194 if not source disconnected and source doWrite didRead 195 why source doWrite 196 didRead source doWrite if failed it was in write197 except 198 why sys exc info 1 199 log msg Error In s source 2 log deferr 2 12 2 if why 2 3 self disconnectSelectable source why didRead source doRead 2 4 2 5 def callback self source condition 2 6 log callWithLogger source self doReadOrWrite source condition 2 7 self simulate fire Twisted timers2 8 return 1 1 don t auto remove the source2 921 def simulate self 211 Run simulation loops and reschedule callbacks 212 213 global simtag214 if simtag is not None 215 gobject source remove simtag 216 self runUntilCurrent 217 timeout min self timeout 1 218 if timeout is None 219 timeout 122 grumble221 simtag gobject timeout add int timeout 1 1 self simulate 222223224class PortableGtkReactor selectreactor SelectReactor 225 Reactor that works on Windows 226227 input add is not supported on GTK for Win32 apparently 228 22923 def crash self 231 import gtk232 mainquit is deprecated in newer versions233 if hasattr gtk main quit 234 gtk main quit 235 else 236 gtk mainquit 237238 def run self installSignalHandlers 1 239 import gtk24 self startRunning installSignalHandlers installSignalHandlers 241 self simulate 242 mainloop is deprecated in newer versions243 if hasattr gtk main 244 gtk main 245 else 246 gtk mainloop 247248 def simulate self 249 Run simulation loops and reschedule callbacks 25 251 global simtag252 if simtag is not None 253 gobject source remove simtag 254 self iterate 255 timeout min self timeout 1 256 if timeout is None 257 timeout 1258 grumble259 simtag gobject timeout add int timeout 1 1 self simulate 26 261262def install useGtk True 263 Configure the twisted mainloop to be run inside the gtk mainloop 264265 param useGtk should glib rather than GTK event loop be266 used this will be slightly faster but does not support GUI 267 268 reactor Gtk2Reactor useGtk 269 from twisted internet main import installReactor27 installReactor reactor 271 return reactor272273def portableInstall useGtk True 274 Configure the twisted mainloop to be run inside the gtk mainloop 275 276 reactor PortableGtkReactor 277 from twisted internet main import installReactor278 installReactor reactor 279 return reactor28 281if runtime platform getType posix 282 install portableInstall Note See TracBrowser for help on using the repository browser Download in other formats Plain Text Original Format Powered by Trac 1 1 By Edgewall Software All content copyright 2 7 2 8 by LUCI http luci ics uci edu ", "_id": "http://djp3-pc2.ics.uci.edu/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py", "title": "\n      gtk2reactor.py in nomatic/tags/nomaticim-0.0.3/buddy_bots/src/twisted/internet\n     \u2013 nomatic*im\n    ", "html": "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n  \n  \n\n  \n\n\n  <head>\n\t\t<title>\n      gtk2reactor.py in nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet\n     \u2013 Nomatic*IM\n    </title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" /><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" /><link rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search\" /><link rel=\"help\" href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py?format=txt\" type=\"text/plain\" title=\"Plain Text\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py\" type=\"application/x-python; charset=iso-8859-15\" title=\"Original Format\" /><link rel=\"start\" href=\"/LUCICodeRepository/nomaticIM/wiki\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/code.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/pygments/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/browser.css\" type=\"text/css\" /><link rel=\"shortcut icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link rel=\"icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link type=\"application/opensearchdescription+xml\" rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search/opensearch\" title=\"Search Nomatic*IM\" /><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/jquery.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/babel.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/messages/en_US.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/trac.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/search.js\"></script><script type=\"text/javascript\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/folding.js\"></script><script type=\"text/javascript\">\n      jQuery(document).ready(function($) {\n        $(\".trac-toggledeleted\").show().click(function() {\n                  $(this).siblings().find(\".trac-deleted\").toggle();\n                  return false;\n        }).click();\n        $(\"#jumploc input\").hide();\n        $(\"#jumploc select\").change(function () {\n          this.parentNode.parentNode.submit();\n        });\n          $('#preview table.code').enableCollapsibleColumns($('#preview table.code thead th.content'));\n      });\n    </script>\n\t</head>\n  <body>\n    <div id=\"banner\">\n      <div id=\"header\">\n        <a id=\"logo\" href=\"http://luci.ics.uci.edu/#code\"><img src=\"http://luci.ics.uci.edu/blog/archives/LUCIhorzTight.jpg\" alt=\"LUCI Code Repository\" /></a>\n      </div>\n      <form id=\"search\" action=\"/LUCICodeRepository/nomaticIM/search\" method=\"get\">\n        <div>\n          <label for=\"proj-search\">Search:</label>\n          <input type=\"text\" id=\"proj-search\" name=\"q\" size=\"18\" value=\"\" />\n          <input type=\"submit\" value=\"Search\" />\n        </div>\n      </form>\n      <div id=\"metanav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/login\">Login</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/prefs\">Preferences</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\">Help/Guide</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/about\">About Trac</a></li>\n    </ul>\n  </div>\n    </div>\n    <div id=\"mainnav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/wiki\">Wiki</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/timeline\">Timeline</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/roadmap\">Roadmap</a></li><li class=\"active\"><a href=\"/LUCICodeRepository/nomaticIM/browser\">Browse Source</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/report\">View Tickets</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/search\">Search</a></li>\n    </ul>\n  </div>\n    <div id=\"main\">\n      <div id=\"ctxtnav\" class=\"nav\">\n        <h2>Context Navigation</h2>\n        <ul>\n          <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/trunk/buddy_bots/twisted/internet/gtk2reactor.py?annotate=blame\" title=\"Annotate each line with the last changed revision (this can be time consuming...)\">Blame</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/log/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py\">Revision Log</a></li>\n        </ul>\n        <hr />\n      </div>\n    <div id=\"content\" class=\"browser\">\n        <h1>\n          \n<a class=\"pathentry first\" href=\"/LUCICodeRepository/nomaticIM/browser?order=name\" title=\"Go to repository root\">source:</a>\n<a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic?order=name\" title=\"View nomatic\">nomatic</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags?order=name\" title=\"View tags\">tags</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3?order=name\" title=\"View NomaticIM-0.0.3\">NomaticIM-0.0.3</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots?order=name\" title=\"View buddy_bots\">buddy_bots</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src?order=name\" title=\"View src\">src</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted?order=name\" title=\"View twisted\">twisted</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet?order=name\" title=\"View internet\">internet</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py?order=name\" title=\"View gtk2reactor.py\">gtk2reactor.py</a>\n<br style=\"clear: both\" />\n\n        </h1>\n        <div id=\"diffrev\">\n          <form action=\"/LUCICodeRepository/nomaticIM/changeset\" method=\"get\">\n            <div>\n              <label title=\"Show the diff against a specific revision\">\n                View diff against: <input type=\"text\" name=\"old\" size=\"6\" />\n                <input type=\"hidden\" name=\"old_path\" value=\"nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py\" />\n                <input type=\"hidden\" name=\"new\" />\n                <input type=\"hidden\" name=\"new_path\" value=\"nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py\" />\n              </label>\n            </div>\n          </form>\n        </div>\n        <div id=\"jumprev\">\n          <form action=\"\" method=\"get\">\n            <div>\n              <label for=\"rev\">\n                View revision:</label>\n              <input type=\"text\" id=\"rev\" name=\"rev\" size=\"6\" />\n            </div>\n          </form>\n        </div>\n        <div id=\"jumploc\">\n          <form action=\"\" method=\"get\">\n            <div class=\"buttons\">\n              <label for=\"preselected\">Visit:</label>\n              <select id=\"preselected\" name=\"preselected\">\n                <option selected=\"selected\"></option>\n                <optgroup label=\"branches\">\n                  <option value=\"/LUCICodeRepository/nomaticIM/browser/trunk\">trunk</option>\n                </optgroup>\n              </select>\n              <input type=\"submit\" value=\"Go!\" title=\"Jump to the chosen preselected path\" />\n            </div>\n          </form>\n        </div>\n        <div class=\"trac-tags\">\n        </div>\n      <table id=\"info\" summary=\"Revision info\">\n        <tr>\n          <th>\n                <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/nomatic/trunk/buddy_bots/twisted/internet/gtk2reactor.py\" title=\"View differences\">Last change</a>\n                  on this file was\n                  <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/\" title=\"View changeset 712\">712</a>,\n                  checked in by cbaker, <a class=\"timeline\" href=\"/LUCICodeRepository/nomaticIM/timeline?from=2008-02-16T08%3A16%3A53-08%3A00&amp;precision=second\" title=\"See timeline at Feb 16, 2008, 8:16:53 AM\">7 years ago</a>\n          </th>\n        </tr>\n        <tr>\n          <td class=\"message searchable\">\n              <p>\nFirst draft of nomatic buddy bots. oscar_bot is functional if you give it good authentication credentials, jabber_bot is just an example from the web <br />\n</p>\n          </td>\n        </tr>\n        <tr><td colspan=\"2\">\n            <strong>File size:</strong>\n            <span title=\"9918 bytes\">9.7 KB</span>\n          </td></tr>\n      </table>\n      <div id=\"preview\" class=\"searchable\">\n        \n  <table class=\"code\"><thead><tr><th class=\"lineno\" title=\"Line numbers\">Line</th><th class=\"content\">\u00a0</th></tr></thead><tbody><tr><th id=\"L1\"><a href=\"#L1\">1</a></th><td><span class=\"c\"># Copyright (c) 2001-2004 Twisted Matrix Laboratories.</span></td></tr><tr><th id=\"L2\"><a href=\"#L2\">2</a></th><td><span class=\"c\"># See LICENSE for details.</span></td></tr><tr><th id=\"L3\"><a href=\"#L3\">3</a></th><td></td></tr><tr><th id=\"L4\"><a href=\"#L4\">4</a></th><td></td></tr><tr><th id=\"L5\"><a href=\"#L5\">5</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L6\"><a href=\"#L6\">6</a></th><td><span class=\"sd\">This module provides support for Twisted to interact with the glib/gtk2 mainloop.</span></td></tr><tr><th id=\"L7\"><a href=\"#L7\">7</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L8\"><a href=\"#L8\">8</a></th><td><span class=\"sd\">In order to use this support, simply do the following::</span></td></tr><tr><th id=\"L9\"><a href=\"#L9\">9</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L10\"><a href=\"#L10\">10</a></th><td><span class=\"sd\">\u00a0 \u00a0 |\u00a0 from twisted.internet import gtk2reactor</span></td></tr><tr><th id=\"L11\"><a href=\"#L11\">11</a></th><td><span class=\"sd\">\u00a0 \u00a0 |\u00a0 gtk2reactor.install()</span></td></tr><tr><th id=\"L12\"><a href=\"#L12\">12</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L13\"><a href=\"#L13\">13</a></th><td><span class=\"sd\">Then use twisted.internet APIs as usual.\u00a0 The other methods here are not</span></td></tr><tr><th id=\"L14\"><a href=\"#L14\">14</a></th><td><span class=\"sd\">intended to be called directly.</span></td></tr><tr><th id=\"L15\"><a href=\"#L15\">15</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L16\"><a href=\"#L16\">16</a></th><td><span class=\"sd\">When installing the reactor, you can choose whether to use the glib</span></td></tr><tr><th id=\"L17\"><a href=\"#L17\">17</a></th><td><span class=\"sd\">event loop or the GTK+ event loop which is based on it but adds GUI</span></td></tr><tr><th id=\"L18\"><a href=\"#L18\">18</a></th><td><span class=\"sd\">integration.</span></td></tr><tr><th id=\"L19\"><a href=\"#L19\">19</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L20\"><a href=\"#L20\">20</a></th><td><span class=\"sd\">API Stability: stable</span></td></tr><tr><th id=\"L21\"><a href=\"#L21\">21</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L22\"><a href=\"#L22\">22</a></th><td><span class=\"sd\">Maintainer: U{Itamar Shtull-Trauring&lt;mailto:twisted@itamarst.org&gt;}</span></td></tr><tr><th id=\"L23\"><a href=\"#L23\">23</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L24\"><a href=\"#L24\">24</a></th><td></td></tr><tr><th id=\"L25\"><a href=\"#L25\">25</a></th><td>__all__ <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"s\">'install'</span><span class=\"p\">]</span></td></tr><tr><th id=\"L26\"><a href=\"#L26\">26</a></th><td></td></tr><tr><th id=\"L27\"><a href=\"#L27\">27</a></th><td><span class=\"c\"># System Imports</span></td></tr><tr><th id=\"L28\"><a href=\"#L28\">28</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">sys</span></td></tr><tr><th id=\"L29\"><a href=\"#L29\">29</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">zope.interface</span>\u00a0<span class=\"kn\">import</span>\u00a0implements</td></tr><tr><th id=\"L30\"><a href=\"#L30\">30</a></th><td><span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L31\"><a href=\"#L31\">31</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>sys<span class=\"p\">,</span>\u00a0<span class=\"s\">'frozen'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L32\"><a href=\"#L32\">32</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Don't want to check this for py2exe</span></td></tr><tr><th id=\"L33\"><a href=\"#L33\">33</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"kn\">import</span>\u00a0<span class=\"nn\">pygtk</span></td></tr><tr><th id=\"L34\"><a href=\"#L34\">34</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 pygtk<span class=\"o\">.</span>require<span class=\"p\">(</span><span class=\"s\">'2.0'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L35\"><a href=\"#L35\">35</a></th><td><span class=\"k\">except</span>\u00a0<span class=\"p\">(</span><span class=\"ne\">ImportError</span><span class=\"p\">,</span>\u00a0<span class=\"ne\">AttributeError</span><span class=\"p\">):</span></td></tr><tr><th id=\"L36\"><a href=\"#L36\">36</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span>\u00a0<span class=\"c\"># maybe we're using pygtk before this hack existed.</span></td></tr><tr><th id=\"L37\"><a href=\"#L37\">37</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">gobject</span></td></tr><tr><th id=\"L38\"><a href=\"#L38\">38</a></th><td><span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>gobject<span class=\"p\">,</span>\u00a0<span class=\"s\">\"threads_init\"</span><span class=\"p\">):</span></td></tr><tr><th id=\"L39\"><a href=\"#L39\">39</a></th><td>\u00a0 \u00a0 <span class=\"c\"># recent versions of python-gtk expose this. python-gtk=2.4.1</span></td></tr><tr><th id=\"L40\"><a href=\"#L40\">40</a></th><td>\u00a0 \u00a0 <span class=\"c\"># (wrapping glib-2.4.7) does. python-gtk=2.0.0 (wrapping</span></td></tr><tr><th id=\"L41\"><a href=\"#L41\">41</a></th><td>\u00a0 \u00a0 <span class=\"c\"># glib-2.2.3) does not.</span></td></tr><tr><th id=\"L42\"><a href=\"#L42\">42</a></th><td>\u00a0 \u00a0 gobject<span class=\"o\">.</span>threads_init<span class=\"p\">()</span></td></tr><tr><th id=\"L43\"><a href=\"#L43\">43</a></th><td></td></tr><tr><th id=\"L44\"><a href=\"#L44\">44</a></th><td><span class=\"c\"># Twisted Imports</span></td></tr><tr><th id=\"L45\"><a href=\"#L45\">45</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.python</span>\u00a0<span class=\"kn\">import</span>\u00a0log<span class=\"p\">,</span>\u00a0threadable<span class=\"p\">,</span>\u00a0runtime<span class=\"p\">,</span>\u00a0failure</td></tr><tr><th id=\"L46\"><a href=\"#L46\">46</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.internet.interfaces</span>\u00a0<span class=\"kn\">import</span>\u00a0IReactorFDSet</td></tr><tr><th id=\"L47\"><a href=\"#L47\">47</a></th><td></td></tr><tr><th id=\"L48\"><a href=\"#L48\">48</a></th><td><span class=\"c\"># Sibling Imports</span></td></tr><tr><th id=\"L49\"><a href=\"#L49\">49</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.internet</span>\u00a0<span class=\"kn\">import</span>\u00a0main<span class=\"p\">,</span>\u00a0posixbase<span class=\"p\">,</span>\u00a0error<span class=\"p\">,</span>\u00a0selectreactor</td></tr><tr><th id=\"L50\"><a href=\"#L50\">50</a></th><td></td></tr><tr><th id=\"L51\"><a href=\"#L51\">51</a></th><td>reads <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L52\"><a href=\"#L52\">52</a></th><td>writes <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L53\"><a href=\"#L53\">53</a></th><td>hasReader <span class=\"o\">=</span>\u00a0reads<span class=\"o\">.</span>has_key</td></tr><tr><th id=\"L54\"><a href=\"#L54\">54</a></th><td>hasWriter <span class=\"o\">=</span>\u00a0writes<span class=\"o\">.</span>has_key</td></tr><tr><th id=\"L55\"><a href=\"#L55\">55</a></th><td></td></tr><tr><th id=\"L56\"><a href=\"#L56\">56</a></th><td><span class=\"c\"># the next callback</span></td></tr><tr><th id=\"L57\"><a href=\"#L57\">57</a></th><td>_simtag <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L58\"><a href=\"#L58\">58</a></th><td>POLL_DISCONNECTED <span class=\"o\">=</span>\u00a0gobject<span class=\"o\">.</span>IO_HUP <span class=\"o\">|</span>\u00a0gobject<span class=\"o\">.</span>IO_ERR <span class=\"o\">|</span>\u00a0gobject<span class=\"o\">.</span>IO_NVAL</td></tr><tr><th id=\"L59\"><a href=\"#L59\">59</a></th><td></td></tr><tr><th id=\"L60\"><a href=\"#L60\">60</a></th><td><span class=\"c\"># glib's iochannel sources won't tell us about any events that we haven't</span></td></tr><tr><th id=\"L61\"><a href=\"#L61\">61</a></th><td><span class=\"c\"># asked for, even if those events aren't sensible inputs to the poll()</span></td></tr><tr><th id=\"L62\"><a href=\"#L62\">62</a></th><td><span class=\"c\"># call.</span></td></tr><tr><th id=\"L63\"><a href=\"#L63\">63</a></th><td>INFLAGS <span class=\"o\">=</span>\u00a0gobject<span class=\"o\">.</span>IO_IN <span class=\"o\">|</span>\u00a0POLL_DISCONNECTED</td></tr><tr><th id=\"L64\"><a href=\"#L64\">64</a></th><td>OUTFLAGS <span class=\"o\">=</span>\u00a0gobject<span class=\"o\">.</span>IO_OUT <span class=\"o\">|</span>\u00a0POLL_DISCONNECTED</td></tr><tr><th id=\"L65\"><a href=\"#L65\">65</a></th><td></td></tr><tr><th id=\"L66\"><a href=\"#L66\">66</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">_our_mainquit</span><span class=\"p\">():</span></td></tr><tr><th id=\"L67\"><a href=\"#L67\">67</a></th><td>\u00a0 \u00a0 <span class=\"c\"># XXX: gtk.main_quit() (which is used for crash()) raises an exception if</span></td></tr><tr><th id=\"L68\"><a href=\"#L68\">68</a></th><td>\u00a0 \u00a0 <span class=\"c\"># gtk.main_level() == 0; however, all the tests freeze if we use this</span></td></tr><tr><th id=\"L69\"><a href=\"#L69\">69</a></th><td>\u00a0 \u00a0 <span class=\"c\"># function to stop the reactor.\u00a0 what gives?\u00a0 (I believe this may have been</span></td></tr><tr><th id=\"L70\"><a href=\"#L70\">70</a></th><td>\u00a0 \u00a0 <span class=\"c\"># a stupid mistake where I forgot to import gtk here... I will remove this</span></td></tr><tr><th id=\"L71\"><a href=\"#L71\">71</a></th><td>\u00a0 \u00a0 <span class=\"c\"># comment if the tests pass)</span></td></tr><tr><th id=\"L72\"><a href=\"#L72\">72</a></th><td>\u00a0 \u00a0 <span class=\"kn\">import</span>\u00a0<span class=\"nn\">gtk</span></td></tr><tr><th id=\"L73\"><a href=\"#L73\">73</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0gtk<span class=\"o\">.</span>main_level<span class=\"p\">():</span></td></tr><tr><th id=\"L74\"><a href=\"#L74\">74</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 gtk<span class=\"o\">.</span>main_quit<span class=\"p\">()</span></td></tr><tr><th id=\"L75\"><a href=\"#L75\">75</a></th><td></td></tr><tr><th id=\"L76\"><a href=\"#L76\">76</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Gtk2Reactor</span><span class=\"p\">(</span>posixbase<span class=\"o\">.</span>PosixReactorBase<span class=\"p\">):</span></td></tr><tr><th id=\"L77\"><a href=\"#L77\">77</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"GTK+-2 event loop reactor.</span></td></tr><tr><th id=\"L78\"><a href=\"#L78\">78</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L79\"><a href=\"#L79\">79</a></th><td></td></tr><tr><th id=\"L80\"><a href=\"#L80\">80</a></th><td>\u00a0 \u00a0 implements<span class=\"p\">(</span>IReactorFDSet<span class=\"p\">)</span></td></tr><tr><th id=\"L81\"><a href=\"#L81\">81</a></th><td></td></tr><tr><th id=\"L82\"><a href=\"#L82\">82</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0useGtk<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">):</span></td></tr><tr><th id=\"L83\"><a href=\"#L83\">83</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>context <span class=\"o\">=</span>\u00a0gobject<span class=\"o\">.</span>main_context_default<span class=\"p\">()</span></td></tr><tr><th id=\"L84\"><a href=\"#L84\">84</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>loop <span class=\"o\">=</span>\u00a0gobject<span class=\"o\">.</span>MainLoop<span class=\"p\">()</span></td></tr><tr><th id=\"L85\"><a href=\"#L85\">85</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 posixbase<span class=\"o\">.</span>PosixReactorBase<span class=\"o\">.</span>__init__<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span></td></tr><tr><th id=\"L86\"><a href=\"#L86\">86</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># pre 2.3.91 the glib iteration and mainloop functions didn't release</span></td></tr><tr><th id=\"L87\"><a href=\"#L87\">87</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># global interpreter lock, thus breaking thread and signal support.</span></td></tr><tr><th id=\"L88\"><a href=\"#L88\">88</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"p\">(</span><span class=\"nb\">hasattr</span><span class=\"p\">(</span>gobject<span class=\"p\">,</span>\u00a0<span class=\"s\">\"pygtk_version\"</span><span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0gobject<span class=\"o\">.</span>pygtk_version <span class=\"o\">&gt;=</span>\u00a0<span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span>\u00a0<span class=\"mi\">3</span><span class=\"p\">,</span>\u00a0<span class=\"mi\">91</span><span class=\"p\">)</span></td></tr><tr><th id=\"L89\"><a href=\"#L89\">89</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"ow\">and</span>\u00a0<span class=\"ow\">not</span>\u00a0useGtk<span class=\"p\">):</span></td></tr><tr><th id=\"L90\"><a href=\"#L90\">90</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__pending <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>context<span class=\"o\">.</span>pending</td></tr><tr><th id=\"L91\"><a href=\"#L91\">91</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__iteration <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>context<span class=\"o\">.</span>iteration</td></tr><tr><th id=\"L92\"><a href=\"#L92\">92</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__crash <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>loop<span class=\"o\">.</span>quit</td></tr><tr><th id=\"L93\"><a href=\"#L93\">93</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__run <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>loop<span class=\"o\">.</span>run</td></tr><tr><th id=\"L94\"><a href=\"#L94\">94</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L95\"><a href=\"#L95\">95</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"kn\">import</span>\u00a0<span class=\"nn\">gtk</span></td></tr><tr><th id=\"L96\"><a href=\"#L96\">96</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__pending <span class=\"o\">=</span>\u00a0gtk<span class=\"o\">.</span>events_pending</td></tr><tr><th id=\"L97\"><a href=\"#L97\">97</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__iteration <span class=\"o\">=</span>\u00a0gtk<span class=\"o\">.</span>main_iteration</td></tr><tr><th id=\"L98\"><a href=\"#L98\">98</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__crash <span class=\"o\">=</span>\u00a0_our_mainquit</td></tr><tr><th id=\"L99\"><a href=\"#L99\">99</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__run <span class=\"o\">=</span>\u00a0gtk<span class=\"o\">.</span>main</td></tr><tr><th id=\"L100\"><a href=\"#L100\">100</a></th><td></td></tr><tr><th id=\"L101\"><a href=\"#L101\">101</a></th><td>\u00a0 \u00a0 <span class=\"c\"># The input_add function in pygtk1 checks for objects with a</span></td></tr><tr><th id=\"L102\"><a href=\"#L102\">102</a></th><td>\u00a0 \u00a0 <span class=\"c\"># 'fileno' method and, if present, uses the result of that method</span></td></tr><tr><th id=\"L103\"><a href=\"#L103\">103</a></th><td>\u00a0 \u00a0 <span class=\"c\"># as the input source. The pygtk2 input_add does not do this. The</span></td></tr><tr><th id=\"L104\"><a href=\"#L104\">104</a></th><td>\u00a0 \u00a0 <span class=\"c\"># function below replicates the pygtk1 functionality.</span></td></tr><tr><th id=\"L105\"><a href=\"#L105\">105</a></th><td></td></tr><tr><th id=\"L106\"><a href=\"#L106\">106</a></th><td>\u00a0 \u00a0 <span class=\"c\"># In addition, pygtk maps gtk.input_add to _gobject.io_add_watch, and</span></td></tr><tr><th id=\"L107\"><a href=\"#L107\">107</a></th><td>\u00a0 \u00a0 <span class=\"c\"># g_io_add_watch() takes different condition bitfields than</span></td></tr><tr><th id=\"L108\"><a href=\"#L108\">108</a></th><td>\u00a0 \u00a0 <span class=\"c\"># gtk_input_add(). We use g_io_add_watch() here in case pygtk fixes this</span></td></tr><tr><th id=\"L109\"><a href=\"#L109\">109</a></th><td>\u00a0 \u00a0 <span class=\"c\"># bug.</span></td></tr><tr><th id=\"L110\"><a href=\"#L110\">110</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">input_add</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0source<span class=\"p\">,</span>\u00a0condition<span class=\"p\">,</span>\u00a0callback<span class=\"p\">):</span></td></tr><tr><th id=\"L111\"><a href=\"#L111\">111</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>source<span class=\"p\">,</span>\u00a0<span class=\"s\">'fileno'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L112\"><a href=\"#L112\">112</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># handle python objects</span></td></tr><tr><th id=\"L113\"><a href=\"#L113\">113</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">wrapper</span><span class=\"p\">(</span>source<span class=\"p\">,</span>\u00a0condition<span class=\"p\">,</span>\u00a0real_s<span class=\"o\">=</span>source<span class=\"p\">,</span>\u00a0real_cb<span class=\"o\">=</span>callback<span class=\"p\">):</span></td></tr><tr><th id=\"L114\"><a href=\"#L114\">114</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0real_cb<span class=\"p\">(</span>real_s<span class=\"p\">,</span>\u00a0condition<span class=\"p\">)</span></td></tr><tr><th id=\"L115\"><a href=\"#L115\">115</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0gobject<span class=\"o\">.</span>io_add_watch<span class=\"p\">(</span>source<span class=\"o\">.</span>fileno<span class=\"p\">(),</span>\u00a0condition<span class=\"p\">,</span>\u00a0wrapper<span class=\"p\">)</span></td></tr><tr><th id=\"L116\"><a href=\"#L116\">116</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L117\"><a href=\"#L117\">117</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0gobject<span class=\"o\">.</span>io_add_watch<span class=\"p\">(</span>source<span class=\"p\">,</span>\u00a0condition<span class=\"p\">,</span>\u00a0callback<span class=\"p\">)</span></td></tr><tr><th id=\"L118\"><a href=\"#L118\">118</a></th><td></td></tr><tr><th id=\"L119\"><a href=\"#L119\">119</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">addReader</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0reader<span class=\"p\">):</span></td></tr><tr><th id=\"L120\"><a href=\"#L120\">120</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0hasReader<span class=\"p\">(</span>reader<span class=\"p\">):</span></td></tr><tr><th id=\"L121\"><a href=\"#L121\">121</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 reads<span class=\"p\">[</span>reader<span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>input_add<span class=\"p\">(</span>reader<span class=\"p\">,</span>\u00a0INFLAGS<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>callback<span class=\"p\">)</span></td></tr><tr><th id=\"L122\"><a href=\"#L122\">122</a></th><td></td></tr><tr><th id=\"L123\"><a href=\"#L123\">123</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">addWriter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0writer<span class=\"p\">):</span></td></tr><tr><th id=\"L124\"><a href=\"#L124\">124</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0hasWriter<span class=\"p\">(</span>writer<span class=\"p\">):</span></td></tr><tr><th id=\"L125\"><a href=\"#L125\">125</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 writes<span class=\"p\">[</span>writer<span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>input_add<span class=\"p\">(</span>writer<span class=\"p\">,</span>\u00a0OUTFLAGS<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>callback<span class=\"p\">)</span></td></tr><tr><th id=\"L126\"><a href=\"#L126\">126</a></th><td></td></tr><tr><th id=\"L127\"><a href=\"#L127\">127</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">removeAll</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L128\"><a href=\"#L128\">128</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_removeAll<span class=\"p\">(</span>reads<span class=\"p\">,</span>\u00a0writes<span class=\"p\">)</span></td></tr><tr><th id=\"L129\"><a href=\"#L129\">129</a></th><td>\u00a0 \u00a0 </td></tr><tr><th id=\"L130\"><a href=\"#L130\">130</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">removeReader</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0reader<span class=\"p\">):</span></td></tr><tr><th id=\"L131\"><a href=\"#L131\">131</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0hasReader<span class=\"p\">(</span>reader<span class=\"p\">):</span></td></tr><tr><th id=\"L132\"><a href=\"#L132\">132</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gobject<span class=\"o\">.</span>source_remove<span class=\"p\">(</span>reads<span class=\"p\">[</span>reader<span class=\"p\">])</span></td></tr><tr><th id=\"L133\"><a href=\"#L133\">133</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">del</span>\u00a0reads<span class=\"p\">[</span>reader<span class=\"p\">]</span></td></tr><tr><th id=\"L134\"><a href=\"#L134\">134</a></th><td></td></tr><tr><th id=\"L135\"><a href=\"#L135\">135</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">removeWriter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0writer<span class=\"p\">):</span></td></tr><tr><th id=\"L136\"><a href=\"#L136\">136</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0hasWriter<span class=\"p\">(</span>writer<span class=\"p\">):</span></td></tr><tr><th id=\"L137\"><a href=\"#L137\">137</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gobject<span class=\"o\">.</span>source_remove<span class=\"p\">(</span>writes<span class=\"p\">[</span>writer<span class=\"p\">])</span></td></tr><tr><th id=\"L138\"><a href=\"#L138\">138</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">del</span>\u00a0writes<span class=\"p\">[</span>writer<span class=\"p\">]</span></td></tr><tr><th id=\"L139\"><a href=\"#L139\">139</a></th><td></td></tr><tr><th id=\"L140\"><a href=\"#L140\">140</a></th><td>\u00a0 \u00a0 doIterationTimer <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L141\"><a href=\"#L141\">141</a></th><td></td></tr><tr><th id=\"L142\"><a href=\"#L142\">142</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">doIterationTimeout</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>args<span class=\"p\">):</span></td></tr><tr><th id=\"L143\"><a href=\"#L143\">143</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>doIterationTimer <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L144\"><a href=\"#L144\">144</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"mi\">0</span>\u00a0<span class=\"c\"># auto-remove</span></td></tr><tr><th id=\"L145\"><a href=\"#L145\">145</a></th><td>\u00a0 \u00a0 </td></tr><tr><th id=\"L146\"><a href=\"#L146\">146</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">doIteration</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0delay<span class=\"p\">):</span></td></tr><tr><th id=\"L147\"><a href=\"#L147\">147</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># flush some pending events, return if there was something to do</span></td></tr><tr><th id=\"L148\"><a href=\"#L148\">148</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># don't use the usual \"while self.context.pending(): self.context.iteration()\"</span></td></tr><tr><th id=\"L149\"><a href=\"#L149\">149</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># idiom because lots of IO (in particular test_tcp's</span></td></tr><tr><th id=\"L150\"><a href=\"#L150\">150</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># ProperlyCloseFilesTestCase) can keep us from ever exiting.</span></td></tr><tr><th id=\"L151\"><a href=\"#L151\">151</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span>channel<span class=\"o\">=</span><span class=\"s\">'system'</span><span class=\"p\">,</span>\u00a0event<span class=\"o\">=</span><span class=\"s\">'iteration'</span><span class=\"p\">,</span>\u00a0reactor<span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"p\">)</span></td></tr><tr><th id=\"L152\"><a href=\"#L152\">152</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>__pending<span class=\"p\">():</span></td></tr><tr><th id=\"L153\"><a href=\"#L153\">153</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__iteration<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span></td></tr><tr><th id=\"L154\"><a href=\"#L154\">154</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span></td></tr><tr><th id=\"L155\"><a href=\"#L155\">155</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># nothing to do, must delay</span></td></tr><tr><th id=\"L156\"><a href=\"#L156\">156</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0delay <span class=\"o\">==</span>\u00a0<span class=\"mi\">0</span><span class=\"p\">:</span></td></tr><tr><th id=\"L157\"><a href=\"#L157\">157</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"c\"># shouldn't delay, so just return</span></td></tr><tr><th id=\"L158\"><a href=\"#L158\">158</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>doIterationTimer <span class=\"o\">=</span>\u00a0gobject<span class=\"o\">.</span>timeout_add<span class=\"p\">(</span><span class=\"nb\">int</span><span class=\"p\">(</span>delay <span class=\"o\">*</span>\u00a0<span class=\"mi\">1000</span><span class=\"p\">),</span></td></tr><tr><th id=\"L159\"><a href=\"#L159\">159</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>doIterationTimeout<span class=\"p\">)</span></td></tr><tr><th id=\"L160\"><a href=\"#L160\">160</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># This will either wake up from IO or from a timeout.</span></td></tr><tr><th id=\"L161\"><a href=\"#L161\">161</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__iteration<span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\u00a0<span class=\"c\"># block</span></td></tr><tr><th id=\"L162\"><a href=\"#L162\">162</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># note: with the .simulate timer below, delays &gt; 0.1 will always be</span></td></tr><tr><th id=\"L163\"><a href=\"#L163\">163</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># woken up by the .simulate timer</span></td></tr><tr><th id=\"L164\"><a href=\"#L164\">164</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>doIterationTimer<span class=\"p\">:</span></td></tr><tr><th id=\"L165\"><a href=\"#L165\">165</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># if woken by IO, need to cancel the timer</span></td></tr><tr><th id=\"L166\"><a href=\"#L166\">166</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gobject<span class=\"o\">.</span>source_remove<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>doIterationTimer<span class=\"p\">)</span></td></tr><tr><th id=\"L167\"><a href=\"#L167\">167</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>doIterationTimer <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L168\"><a href=\"#L168\">168</a></th><td></td></tr><tr><th id=\"L169\"><a href=\"#L169\">169</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">crash</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L170\"><a href=\"#L170\">170</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__crash<span class=\"p\">()</span></td></tr><tr><th id=\"L171\"><a href=\"#L171\">171</a></th><td></td></tr><tr><th id=\"L172\"><a href=\"#L172\">172</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0installSignalHandlers<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">):</span></td></tr><tr><th id=\"L173\"><a href=\"#L173\">173</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>startRunning<span class=\"p\">(</span>installSignalHandlers<span class=\"o\">=</span>installSignalHandlers<span class=\"p\">)</span></td></tr><tr><th id=\"L174\"><a href=\"#L174\">174</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 gobject<span class=\"o\">.</span>timeout_add<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>simulate<span class=\"p\">)</span></td></tr><tr><th id=\"L175\"><a href=\"#L175\">175</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__run<span class=\"p\">()</span></td></tr><tr><th id=\"L176\"><a href=\"#L176\">176</a></th><td>\u00a0 \u00a0 </td></tr><tr><th id=\"L177\"><a href=\"#L177\">177</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_doReadOrWrite</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0source<span class=\"p\">,</span>\u00a0condition<span class=\"p\">,</span>\u00a0faildict<span class=\"o\">=</span><span class=\"p\">{</span></td></tr><tr><th id=\"L178\"><a href=\"#L178\">178</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 error<span class=\"o\">.</span>ConnectionDone<span class=\"p\">:</span>\u00a0failure<span class=\"o\">.</span>Failure<span class=\"p\">(</span>error<span class=\"o\">.</span>ConnectionDone<span class=\"p\">()),</span></td></tr><tr><th id=\"L179\"><a href=\"#L179\">179</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 error<span class=\"o\">.</span>ConnectionLost<span class=\"p\">:</span>\u00a0failure<span class=\"o\">.</span>Failure<span class=\"p\">(</span>error<span class=\"o\">.</span>ConnectionLost<span class=\"p\">()),</span></td></tr><tr><th id=\"L180\"><a href=\"#L180\">180</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">}):</span></td></tr><tr><th id=\"L181\"><a href=\"#L181\">181</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 why <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L182\"><a href=\"#L182\">182</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 didRead <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L183\"><a href=\"#L183\">183</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0condition <span class=\"o\">&amp;</span>\u00a0POLL_DISCONNECTED <span class=\"ow\">and</span>\u00a0\\</td></tr><tr><th id=\"L184\"><a href=\"#L184\">184</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"ow\">not</span>\u00a0<span class=\"p\">(</span>condition <span class=\"o\">&amp;</span>\u00a0gobject<span class=\"o\">.</span>IO_IN<span class=\"p\">):</span></td></tr><tr><th id=\"L185\"><a href=\"#L185\">185</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 why <span class=\"o\">=</span>\u00a0main<span class=\"o\">.</span>CONNECTION_LOST</td></tr><tr><th id=\"L186\"><a href=\"#L186\">186</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L187\"><a href=\"#L187\">187</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L188\"><a href=\"#L188\">188</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0condition <span class=\"o\">&amp;</span>\u00a0gobject<span class=\"o\">.</span>IO_IN<span class=\"p\">:</span></td></tr><tr><th id=\"L189\"><a href=\"#L189\">189</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 why <span class=\"o\">=</span>\u00a0source<span class=\"o\">.</span>doRead<span class=\"p\">()</span></td></tr><tr><th id=\"L190\"><a href=\"#L190\">190</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 didRead <span class=\"o\">=</span>\u00a0source<span class=\"o\">.</span>doRead</td></tr><tr><th id=\"L191\"><a href=\"#L191\">191</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0why <span class=\"ow\">and</span>\u00a0condition <span class=\"o\">&amp;</span>\u00a0gobject<span class=\"o\">.</span>IO_OUT<span class=\"p\">:</span></td></tr><tr><th id=\"L192\"><a href=\"#L192\">192</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># if doRead caused connectionLost, don't call doWrite</span></td></tr><tr><th id=\"L193\"><a href=\"#L193\">193</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># if doRead is doWrite, don't call it again.</span></td></tr><tr><th id=\"L194\"><a href=\"#L194\">194</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0source<span class=\"o\">.</span>disconnected <span class=\"ow\">and</span>\u00a0source<span class=\"o\">.</span>doWrite <span class=\"o\">!=</span>\u00a0didRead<span class=\"p\">:</span></td></tr><tr><th id=\"L195\"><a href=\"#L195\">195</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 why <span class=\"o\">=</span>\u00a0source<span class=\"o\">.</span>doWrite<span class=\"p\">()</span></td></tr><tr><th id=\"L196\"><a href=\"#L196\">196</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 didRead <span class=\"o\">=</span>\u00a0source<span class=\"o\">.</span>doWrite <span class=\"c\"># if failed it was in write</span></td></tr><tr><th id=\"L197\"><a href=\"#L197\">197</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L198\"><a href=\"#L198\">198</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 why <span class=\"o\">=</span>\u00a0sys<span class=\"o\">.</span>exc_info<span class=\"p\">()[</span><span class=\"mi\">1</span><span class=\"p\">]</span></td></tr><tr><th id=\"L199\"><a href=\"#L199\">199</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'Error In </span><span class=\"si\">%s</span><span class=\"s\">'</span>\u00a0<span class=\"o\">%</span>\u00a0source<span class=\"p\">)</span></td></tr><tr><th id=\"L200\"><a href=\"#L200\">200</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>deferr<span class=\"p\">()</span></td></tr><tr><th id=\"L201\"><a href=\"#L201\">201</a></th><td></td></tr><tr><th id=\"L202\"><a href=\"#L202\">202</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0why<span class=\"p\">:</span></td></tr><tr><th id=\"L203\"><a href=\"#L203\">203</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_disconnectSelectable<span class=\"p\">(</span>source<span class=\"p\">,</span>\u00a0why<span class=\"p\">,</span>\u00a0didRead <span class=\"o\">==</span>\u00a0source<span class=\"o\">.</span>doRead<span class=\"p\">)</span></td></tr><tr><th id=\"L204\"><a href=\"#L204\">204</a></th><td>\u00a0 \u00a0 </td></tr><tr><th id=\"L205\"><a href=\"#L205\">205</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">callback</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0source<span class=\"p\">,</span>\u00a0condition<span class=\"p\">):</span></td></tr><tr><th id=\"L206\"><a href=\"#L206\">206</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>callWithLogger<span class=\"p\">(</span>source<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_doReadOrWrite<span class=\"p\">,</span>\u00a0source<span class=\"p\">,</span>\u00a0condition<span class=\"p\">)</span></td></tr><tr><th id=\"L207\"><a href=\"#L207\">207</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>simulate<span class=\"p\">()</span>\u00a0<span class=\"c\"># fire Twisted timers</span></td></tr><tr><th id=\"L208\"><a href=\"#L208\">208</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"mi\">1</span>\u00a0<span class=\"c\"># 1=don't auto-remove the source</span></td></tr><tr><th id=\"L209\"><a href=\"#L209\">209</a></th><td></td></tr><tr><th id=\"L210\"><a href=\"#L210\">210</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">simulate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L211\"><a href=\"#L211\">211</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Run simulation loops and reschedule callbacks.</span></td></tr><tr><th id=\"L212\"><a href=\"#L212\">212</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L213\"><a href=\"#L213\">213</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">global</span>\u00a0_simtag</td></tr><tr><th id=\"L214\"><a href=\"#L214\">214</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0_simtag <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L215\"><a href=\"#L215\">215</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gobject<span class=\"o\">.</span>source_remove<span class=\"p\">(</span>_simtag<span class=\"p\">)</span></td></tr><tr><th id=\"L216\"><a href=\"#L216\">216</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>runUntilCurrent<span class=\"p\">()</span></td></tr><tr><th id=\"L217\"><a href=\"#L217\">217</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 timeout <span class=\"o\">=</span>\u00a0<span class=\"nb\">min</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>timeout<span class=\"p\">(),</span>\u00a0<span class=\"mf\">0.1</span><span class=\"p\">)</span></td></tr><tr><th id=\"L218\"><a href=\"#L218\">218</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0timeout <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L219\"><a href=\"#L219\">219</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 timeout <span class=\"o\">=</span>\u00a0<span class=\"mf\">0.1</span></td></tr><tr><th id=\"L220\"><a href=\"#L220\">220</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># grumble</span></td></tr><tr><th id=\"L221\"><a href=\"#L221\">221</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 _simtag <span class=\"o\">=</span>\u00a0gobject<span class=\"o\">.</span>timeout_add<span class=\"p\">(</span><span class=\"nb\">int</span><span class=\"p\">(</span>timeout <span class=\"o\">*</span>\u00a0<span class=\"mi\">1010</span><span class=\"p\">),</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>simulate<span class=\"p\">)</span></td></tr><tr><th id=\"L222\"><a href=\"#L222\">222</a></th><td></td></tr><tr><th id=\"L223\"><a href=\"#L223\">223</a></th><td></td></tr><tr><th id=\"L224\"><a href=\"#L224\">224</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">PortableGtkReactor</span><span class=\"p\">(</span>selectreactor<span class=\"o\">.</span>SelectReactor<span class=\"p\">):</span></td></tr><tr><th id=\"L225\"><a href=\"#L225\">225</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Reactor that works on Windows.</span></td></tr><tr><th id=\"L226\"><a href=\"#L226\">226</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L227\"><a href=\"#L227\">227</a></th><td><span class=\"sd\">\u00a0 \u00a0 input_add is not supported on GTK+ for Win32, apparently.</span></td></tr><tr><th id=\"L228\"><a href=\"#L228\">228</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L229\"><a href=\"#L229\">229</a></th><td></td></tr><tr><th id=\"L230\"><a href=\"#L230\">230</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">crash</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L231\"><a href=\"#L231\">231</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"kn\">import</span>\u00a0<span class=\"nn\">gtk</span></td></tr><tr><th id=\"L232\"><a href=\"#L232\">232</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># mainquit is deprecated in newer versions</span></td></tr><tr><th id=\"L233\"><a href=\"#L233\">233</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>gtk<span class=\"p\">,</span>\u00a0<span class=\"s\">'main_quit'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L234\"><a href=\"#L234\">234</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gtk<span class=\"o\">.</span>main_quit<span class=\"p\">()</span></td></tr><tr><th id=\"L235\"><a href=\"#L235\">235</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L236\"><a href=\"#L236\">236</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gtk<span class=\"o\">.</span>mainquit<span class=\"p\">()</span></td></tr><tr><th id=\"L237\"><a href=\"#L237\">237</a></th><td></td></tr><tr><th id=\"L238\"><a href=\"#L238\">238</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0installSignalHandlers<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">):</span></td></tr><tr><th id=\"L239\"><a href=\"#L239\">239</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"kn\">import</span>\u00a0<span class=\"nn\">gtk</span></td></tr><tr><th id=\"L240\"><a href=\"#L240\">240</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>startRunning<span class=\"p\">(</span>installSignalHandlers<span class=\"o\">=</span>installSignalHandlers<span class=\"p\">)</span></td></tr><tr><th id=\"L241\"><a href=\"#L241\">241</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>simulate<span class=\"p\">()</span></td></tr><tr><th id=\"L242\"><a href=\"#L242\">242</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># mainloop is deprecated in newer versions</span></td></tr><tr><th id=\"L243\"><a href=\"#L243\">243</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>gtk<span class=\"p\">,</span>\u00a0<span class=\"s\">'main'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L244\"><a href=\"#L244\">244</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gtk<span class=\"o\">.</span>main<span class=\"p\">()</span></td></tr><tr><th id=\"L245\"><a href=\"#L245\">245</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L246\"><a href=\"#L246\">246</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gtk<span class=\"o\">.</span>mainloop<span class=\"p\">()</span></td></tr><tr><th id=\"L247\"><a href=\"#L247\">247</a></th><td></td></tr><tr><th id=\"L248\"><a href=\"#L248\">248</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">simulate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L249\"><a href=\"#L249\">249</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Run simulation loops and reschedule callbacks.</span></td></tr><tr><th id=\"L250\"><a href=\"#L250\">250</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L251\"><a href=\"#L251\">251</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">global</span>\u00a0_simtag</td></tr><tr><th id=\"L252\"><a href=\"#L252\">252</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0_simtag <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L253\"><a href=\"#L253\">253</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gobject<span class=\"o\">.</span>source_remove<span class=\"p\">(</span>_simtag<span class=\"p\">)</span></td></tr><tr><th id=\"L254\"><a href=\"#L254\">254</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>iterate<span class=\"p\">()</span></td></tr><tr><th id=\"L255\"><a href=\"#L255\">255</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 timeout <span class=\"o\">=</span>\u00a0<span class=\"nb\">min</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>timeout<span class=\"p\">(),</span>\u00a0<span class=\"mf\">0.1</span><span class=\"p\">)</span></td></tr><tr><th id=\"L256\"><a href=\"#L256\">256</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0timeout <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L257\"><a href=\"#L257\">257</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 timeout <span class=\"o\">=</span>\u00a0<span class=\"mf\">0.1</span></td></tr><tr><th id=\"L258\"><a href=\"#L258\">258</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># grumble</span></td></tr><tr><th id=\"L259\"><a href=\"#L259\">259</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 _simtag <span class=\"o\">=</span>\u00a0gobject<span class=\"o\">.</span>timeout_add<span class=\"p\">(</span><span class=\"nb\">int</span><span class=\"p\">(</span>timeout <span class=\"o\">*</span>\u00a0<span class=\"mi\">1010</span><span class=\"p\">),</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>simulate<span class=\"p\">)</span></td></tr><tr><th id=\"L260\"><a href=\"#L260\">260</a></th><td></td></tr><tr><th id=\"L261\"><a href=\"#L261\">261</a></th><td></td></tr><tr><th id=\"L262\"><a href=\"#L262\">262</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">install</span><span class=\"p\">(</span>useGtk<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">):</span></td></tr><tr><th id=\"L263\"><a href=\"#L263\">263</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Configure the twisted mainloop to be run inside the gtk mainloop.</span></td></tr><tr><th id=\"L264\"><a href=\"#L264\">264</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L265\"><a href=\"#L265\">265</a></th><td><span class=\"sd\">\u00a0 \u00a0 @param useGtk: should glib rather than GTK+ event loop be</span></td></tr><tr><th id=\"L266\"><a href=\"#L266\">266</a></th><td><span class=\"sd\">\u00a0 \u00a0 used (this will be slightly faster but does not support GUI).</span></td></tr><tr><th id=\"L267\"><a href=\"#L267\">267</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L268\"><a href=\"#L268\">268</a></th><td>\u00a0 \u00a0 reactor <span class=\"o\">=</span>\u00a0Gtk2Reactor<span class=\"p\">(</span>useGtk<span class=\"p\">)</span></td></tr><tr><th id=\"L269\"><a href=\"#L269\">269</a></th><td>\u00a0 \u00a0 <span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.internet.main</span>\u00a0<span class=\"kn\">import</span>\u00a0installReactor</td></tr><tr><th id=\"L270\"><a href=\"#L270\">270</a></th><td>\u00a0 \u00a0 installReactor<span class=\"p\">(</span>reactor<span class=\"p\">)</span></td></tr><tr><th id=\"L271\"><a href=\"#L271\">271</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0reactor</td></tr><tr><th id=\"L272\"><a href=\"#L272\">272</a></th><td></td></tr><tr><th id=\"L273\"><a href=\"#L273\">273</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">portableInstall</span><span class=\"p\">(</span>useGtk<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">):</span></td></tr><tr><th id=\"L274\"><a href=\"#L274\">274</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Configure the twisted mainloop to be run inside the gtk mainloop.</span></td></tr><tr><th id=\"L275\"><a href=\"#L275\">275</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L276\"><a href=\"#L276\">276</a></th><td>\u00a0 \u00a0 reactor <span class=\"o\">=</span>\u00a0PortableGtkReactor<span class=\"p\">()</span></td></tr><tr><th id=\"L277\"><a href=\"#L277\">277</a></th><td>\u00a0 \u00a0 <span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.internet.main</span>\u00a0<span class=\"kn\">import</span>\u00a0installReactor</td></tr><tr><th id=\"L278\"><a href=\"#L278\">278</a></th><td>\u00a0 \u00a0 installReactor<span class=\"p\">(</span>reactor<span class=\"p\">)</span></td></tr><tr><th id=\"L279\"><a href=\"#L279\">279</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0reactor</td></tr><tr><th id=\"L280\"><a href=\"#L280\">280</a></th><td></td></tr><tr><th id=\"L281\"><a href=\"#L281\">281</a></th><td><span class=\"k\">if</span>\u00a0runtime<span class=\"o\">.</span>platform<span class=\"o\">.</span>getType<span class=\"p\">()</span>\u00a0<span class=\"o\">!=</span>\u00a0<span class=\"s\">'posix'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L282\"><a href=\"#L282\">282</a></th><td>\u00a0 \u00a0 install <span class=\"o\">=</span>\u00a0portableInstall</td></tr></tbody></table>\n\n      </div>\n      <div id=\"anydiff\">\n        <form action=\"/LUCICodeRepository/nomaticIM/diff\" method=\"get\">\n          <div class=\"buttons\">\n            <input type=\"hidden\" name=\"new_path\" value=\"/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py\" />\n            <input type=\"hidden\" name=\"old_path\" value=\"/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py\" />\n            <input type=\"hidden\" name=\"new_rev\" />\n            <input type=\"hidden\" name=\"old_rev\" />\n            <input type=\"submit\" value=\"View changes...\" title=\"Select paths and revs for Diff\" />\n          </div>\n        </form>\n      </div>\n      <div id=\"help\"><strong>Note:</strong> See <a href=\"/LUCICodeRepository/nomaticIM/wiki/TracBrowser\">TracBrowser</a>\n        for help on using the repository browser.</div>\n    </div>\n    <div id=\"altlinks\">\n      <h3>Download in other formats:</h3>\n      <ul>\n        <li class=\"first\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py?format=txt\">Plain Text</a>\n        </li><li class=\"last\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/internet/gtk2reactor.py\">Original Format</a>\n        </li>\n      </ul>\n    </div>\n    </div>\n    <div id=\"footer\" lang=\"en\" xml:lang=\"en\"><hr />\n      <a id=\"tracpowered\" href=\"http://trac.edgewall.org/\"><img src=\"/LUCICodeRepository/nomaticIM/chrome/common/trac_logo_mini.png\" height=\"30\" width=\"107\" alt=\"Trac Powered\" /></a>\n      <p class=\"left\">Powered by <a href=\"/LUCICodeRepository/nomaticIM/about\"><strong>Trac 1.0.1</strong></a><br />\n        By <a href=\"http://www.edgewall.org/\">Edgewall Software</a>.</p>\n      <p class=\"right\">All content copyright 2007-2008 by LUCI <br /><a href=\"http://luci.ics.uci.edu/\">http://luci.ics.uci.edu/</a></p>\n    </div>\n\t\t<div id=\"sitefooter\">\n\t\t\t<script src=\"http://www.google-analytics.com/urchin.js\" type=\"text/javascript\">\n\t\t\t</script>\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t_uacct = \"UA-338915-2\";\n\t\t\t\turchinTracker();\n\t\t\t</script>\n\t\t</div>\n\t</body>\n</html>", "id": 44616.0}