{"text": "Search LoginPreferencesHelp GuideAbout Trac WikiTimelineRoadmapBrowse SourceView TicketsSearch Context Navigation BlameRevision Log source nomatic tags NomaticIM 3 buddy bots src twisted names server py View diff against View revision Visit trunk Last change on this file was 745 checked in by cbaker 7 years ago restructured buddy bot package structure jabber bot can sign on off subversion doesn t support moving files so this will be a big commit sorry File size 6 KB Line 1 test case name twisted names test test names 2 Copyright c 2 1 2 4 Twisted Matrix Laboratories 3 See LICENSE for details 456 7Async DNS server89API Stability Unstable1 11Future plans 12 Better config file format maybe13 Make sure to differentiate between different classes14 notice truncation bit1516Important No additional processing is done on some of the record types 17This violates the most basic RFC and is just plain annoying18for resolvers to deal with Fix it 192 author U Jp Calderone mailto exarkun twistedmatrix com 21 2223from future import nested scopes24import time2526 Twisted imports27from twisted internet import protocol28from twisted names import dns29from twisted python import log3 31import resolve3233class DNSServerFactory protocol ServerFactory 34 protocol dns DNSProtocol35 cache None3637 def init self authorities None caches None clients None verbose 38 resolvers 39 if authorities is not None 4 resolvers extend authorities 41 if caches is not None 42 resolvers extend caches 43 if clients is not None 44 resolvers extend clients 4546 self canRecurse not not clients47 self resolver resolve ResolverChain resolvers 48 self verbose verbose49 if caches 5 self cache caches 1 515253 def buildProtocol self addr 54 p self protocol self 55 p factory self56 return p5758 def connectionMade self protocol 59 pass6 6162 def sendReply self protocol message address 63 if self verbose 1 64 s join str a payload for a in message answers 65 auth join str a payload for a in message authority 66 add join str a payload for a in message additional 67 if not s 68 log msg Replying with no answers 69 else 7 log msg Answers are s 71 log msg Authority is auth 72 log msg Additional is add 7374 if address is None 75 protocol writeMessage message 76 else 77 protocol writeMessage message address 7879 if self verbose 1 8 log msg Processed query in 3f seconds time time message timeReceived 818283 def gotResolverResponse self ans auth add protocol message address 84 message rCode dns OK85 message answers ans86 for x in ans 87 if x isAuthoritative 88 message auth 189 break9 message authority auth91 message additional add92 self sendReply protocol message address 9394 l len ans len auth len add 95 if self verbose 96 log msg Lookup found d record s l l 1 and s or 9798 if self cache and l 99 self cache cacheResult 1 message queries ans auth add 1 1 1 21 31 4 def gotResolverError self failure protocol message address 1 5 if failure check dns DomainError dns AuthoritativeDomainError 1 6 message rCode dns ENAME1 7 else 1 8 message rCode dns ESERVER1 9 log err failure 11 111 self sendReply protocol message address 112 if self verbose 113 log msg Lookup failed 114115116 def handleQuery self message protocol address 117 Discard all but the first query HOO AAH HOOOOO AAAAH118 no other servers implement multi query messages so we won t either 119 query message queries 12 121 return self resolver query query addCallback 122 self gotResolverResponse protocol message address123 addErrback 124 self gotResolverError protocol message address125 126127128 def handleInverseQuery self message protocol address 129 message rCode dns ENOTIMP13 self sendReply protocol message address 131 if self verbose 132 log msg Inverse query from r address 133134135 def handleStatus self message protocol address 136 message rCode dns ENOTIMP137 self sendReply protocol message address 138 if self verbose 139 log msg Status request from r address 14 141142 def handleNotify self message protocol address 143 message rCode dns ENOTIMP144 self sendReply protocol message address 145 if self verbose 146 log msg Notify message from r address 147148149 def handleOther self message protocol address 15 message rCode dns ENOTIMP151 self sendReply protocol message address 152 if self verbose 153 log msg Unknown op code d from r message opCode address 154155156 def messageReceived self message proto address None 157 message timeReceived time time 158159 if self verbose 16 if self verbose 1 161 s join str q for q in message queries 162 elif self verbose 163 s join dns QUERY TYPES get q type UNKNOWN for q in message queries 164165 if not len s 166 log msg Empty query from r address or proto transport getPeer 167 else 168 log msg s query from r s address or proto transport getPeer 16917 message recAv self canRecurse171 message answer 1172173 if not self allowQuery message proto address 174 message rCode dns EREFUSED175 self sendReply proto message address 176 elif message opCode dns OP QUERY 177 self handleQuery message proto address 178 elif message opCode dns OP INVERSE 179 self handleInverseQuery message proto address 18 elif message opCode dns OP STATUS 181 self handleStatus message proto address 182 elif message opCode dns OP NOTIFY 183 self handleNotify message proto address 184 else 185 self handleOther message proto address 186187188 def allowQuery self message protocol address 189 Allow anything but empty queries19 return len message queries Note See TracBrowser for help on using the repository browser Download in other formats Plain Text Original Format Powered by Trac 1 1 By Edgewall Software All content copyright 2 7 2 8 by LUCI http luci ics uci edu ", "_id": "http://djp3-pc2.ics.uci.edu/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py", "title": "\n      server.py in nomatic/tags/nomaticim-0.0.3/buddy_bots/src/twisted/names\n     \u2013 nomatic*im\n    ", "html": "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n  \n  \n\n  \n\n\n  <head>\n\t\t<title>\n      server.py in nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names\n     \u2013 Nomatic*IM\n    </title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" /><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" /><link rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search\" /><link rel=\"help\" href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py?format=txt\" type=\"text/plain\" title=\"Plain Text\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py\" type=\"application/x-python; charset=iso-8859-15\" title=\"Original Format\" /><link rel=\"start\" href=\"/LUCICodeRepository/nomaticIM/wiki\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/code.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/pygments/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/browser.css\" type=\"text/css\" /><link rel=\"shortcut icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link rel=\"icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link type=\"application/opensearchdescription+xml\" rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search/opensearch\" title=\"Search Nomatic*IM\" /><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/jquery.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/babel.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/messages/en_US.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/trac.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/search.js\"></script><script type=\"text/javascript\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/folding.js\"></script><script type=\"text/javascript\">\n      jQuery(document).ready(function($) {\n        $(\".trac-toggledeleted\").show().click(function() {\n                  $(this).siblings().find(\".trac-deleted\").toggle();\n                  return false;\n        }).click();\n        $(\"#jumploc input\").hide();\n        $(\"#jumploc select\").change(function () {\n          this.parentNode.parentNode.submit();\n        });\n          $('#preview table.code').enableCollapsibleColumns($('#preview table.code thead th.content'));\n      });\n    </script>\n\t</head>\n  <body>\n    <div id=\"banner\">\n      <div id=\"header\">\n        <a id=\"logo\" href=\"http://luci.ics.uci.edu/#code\"><img src=\"http://luci.ics.uci.edu/blog/archives/LUCIhorzTight.jpg\" alt=\"LUCI Code Repository\" /></a>\n      </div>\n      <form id=\"search\" action=\"/LUCICodeRepository/nomaticIM/search\" method=\"get\">\n        <div>\n          <label for=\"proj-search\">Search:</label>\n          <input type=\"text\" id=\"proj-search\" name=\"q\" size=\"18\" value=\"\" />\n          <input type=\"submit\" value=\"Search\" />\n        </div>\n      </form>\n      <div id=\"metanav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/login\">Login</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/prefs\">Preferences</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\">Help/Guide</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/about\">About Trac</a></li>\n    </ul>\n  </div>\n    </div>\n    <div id=\"mainnav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/wiki\">Wiki</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/timeline\">Timeline</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/roadmap\">Roadmap</a></li><li class=\"active\"><a href=\"/LUCICodeRepository/nomaticIM/browser\">Browse Source</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/report\">View Tickets</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/search\">Search</a></li>\n    </ul>\n  </div>\n    <div id=\"main\">\n      <div id=\"ctxtnav\" class=\"nav\">\n        <h2>Context Navigation</h2>\n        <ul>\n          <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/trunk/buddy_bots/src/twisted/names/server.py?annotate=blame\" title=\"Annotate each line with the last changed revision (this can be time consuming...)\">Blame</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/log/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py\">Revision Log</a></li>\n        </ul>\n        <hr />\n      </div>\n    <div id=\"content\" class=\"browser\">\n        <h1>\n          \n<a class=\"pathentry first\" href=\"/LUCICodeRepository/nomaticIM/browser?order=name\" title=\"Go to repository root\">source:</a>\n<a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic?order=name\" title=\"View nomatic\">nomatic</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags?order=name\" title=\"View tags\">tags</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3?order=name\" title=\"View NomaticIM-0.0.3\">NomaticIM-0.0.3</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots?order=name\" title=\"View buddy_bots\">buddy_bots</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src?order=name\" title=\"View src\">src</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted?order=name\" title=\"View twisted\">twisted</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names?order=name\" title=\"View names\">names</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py?order=name\" title=\"View server.py\">server.py</a>\n<br style=\"clear: both\" />\n\n        </h1>\n        <div id=\"diffrev\">\n          <form action=\"/LUCICodeRepository/nomaticIM/changeset\" method=\"get\">\n            <div>\n              <label title=\"Show the diff against a specific revision\">\n                View diff against: <input type=\"text\" name=\"old\" size=\"6\" />\n                <input type=\"hidden\" name=\"old_path\" value=\"nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py\" />\n                <input type=\"hidden\" name=\"new\" />\n                <input type=\"hidden\" name=\"new_path\" value=\"nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py\" />\n              </label>\n            </div>\n          </form>\n        </div>\n        <div id=\"jumprev\">\n          <form action=\"\" method=\"get\">\n            <div>\n              <label for=\"rev\">\n                View revision:</label>\n              <input type=\"text\" id=\"rev\" name=\"rev\" size=\"6\" />\n            </div>\n          </form>\n        </div>\n        <div id=\"jumploc\">\n          <form action=\"\" method=\"get\">\n            <div class=\"buttons\">\n              <label for=\"preselected\">Visit:</label>\n              <select id=\"preselected\" name=\"preselected\">\n                <option selected=\"selected\"></option>\n                <optgroup label=\"branches\">\n                  <option value=\"/LUCICodeRepository/nomaticIM/browser/trunk\">trunk</option>\n                </optgroup>\n              </select>\n              <input type=\"submit\" value=\"Go!\" title=\"Jump to the chosen preselected path\" />\n            </div>\n          </form>\n        </div>\n        <div class=\"trac-tags\">\n        </div>\n      <table id=\"info\" summary=\"Revision info\">\n        <tr>\n          <th>\n                <a href=\"/LUCICodeRepository/nomaticIM/changeset/745/nomatic/trunk/buddy_bots/src/twisted/names/server.py\" title=\"View differences\">Last change</a>\n                  on this file was\n                  <a href=\"/LUCICodeRepository/nomaticIM/changeset/745/\" title=\"View changeset 745\">745</a>,\n                  checked in by cbaker, <a class=\"timeline\" href=\"/LUCICodeRepository/nomaticIM/timeline?from=2008-02-18T16%3A15%3A25-08%3A00&amp;precision=second\" title=\"See timeline at Feb 18, 2008, 4:15:25 PM\">7 years ago</a>\n          </th>\n        </tr>\n        <tr>\n          <td class=\"message searchable\">\n              <p>\nrestructured buddy bot package structure. jabber bot can sign on/off. subversion doesn't support moving files so this will be a big commit, sorry<br />\n</p>\n          </td>\n        </tr>\n        <tr><td colspan=\"2\">\n            <strong>File size:</strong>\n            <span title=\"6158 bytes\">6.0 KB</span>\n          </td></tr>\n      </table>\n      <div id=\"preview\" class=\"searchable\">\n        \n  <table class=\"code\"><thead><tr><th class=\"lineno\" title=\"Line numbers\">Line</th><th class=\"content\">\u00a0</th></tr></thead><tbody><tr><th id=\"L1\"><a href=\"#L1\">1</a></th><td><span class=\"c\"># -*- test-case-name: twisted.names.test.test_names -*-</span></td></tr><tr><th id=\"L2\"><a href=\"#L2\">2</a></th><td><span class=\"c\"># Copyright (c) 2001-2004 Twisted Matrix Laboratories.</span></td></tr><tr><th id=\"L3\"><a href=\"#L3\">3</a></th><td><span class=\"c\"># See LICENSE for details.</span></td></tr><tr><th id=\"L4\"><a href=\"#L4\">4</a></th><td></td></tr><tr><th id=\"L5\"><a href=\"#L5\">5</a></th><td></td></tr><tr><th id=\"L6\"><a href=\"#L6\">6</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L7\"><a href=\"#L7\">7</a></th><td><span class=\"sd\">Async DNS server</span></td></tr><tr><th id=\"L8\"><a href=\"#L8\">8</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L9\"><a href=\"#L9\">9</a></th><td><span class=\"sd\">API Stability: Unstable</span></td></tr><tr><th id=\"L10\"><a href=\"#L10\">10</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L11\"><a href=\"#L11\">11</a></th><td><span class=\"sd\">Future plans:</span></td></tr><tr><th id=\"L12\"><a href=\"#L12\">12</a></th><td><span class=\"sd\">\u00a0 \u00a0 - Better config file format maybe</span></td></tr><tr><th id=\"L13\"><a href=\"#L13\">13</a></th><td><span class=\"sd\">\u00a0 \u00a0 - Make sure to differentiate between different classes</span></td></tr><tr><th id=\"L14\"><a href=\"#L14\">14</a></th><td><span class=\"sd\">\u00a0 \u00a0 - notice truncation bit</span></td></tr><tr><th id=\"L15\"><a href=\"#L15\">15</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L16\"><a href=\"#L16\">16</a></th><td><span class=\"sd\">Important: No additional processing is done on some of the record types.</span></td></tr><tr><th id=\"L17\"><a href=\"#L17\">17</a></th><td><span class=\"sd\">This violates the most basic RFC and is just plain annoying</span></td></tr><tr><th id=\"L18\"><a href=\"#L18\">18</a></th><td><span class=\"sd\">for resolvers to deal with.\u00a0 Fix it.</span></td></tr><tr><th id=\"L19\"><a href=\"#L19\">19</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L20\"><a href=\"#L20\">20</a></th><td><span class=\"sd\">@author: U{Jp Calderone &lt;mailto:exarkun@twistedmatrix.com&gt;}</span></td></tr><tr><th id=\"L21\"><a href=\"#L21\">21</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L22\"><a href=\"#L22\">22</a></th><td></td></tr><tr><th id=\"L23\"><a href=\"#L23\">23</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">__future__</span>\u00a0<span class=\"kn\">import</span>\u00a0nested_scopes</td></tr><tr><th id=\"L24\"><a href=\"#L24\">24</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">time</span></td></tr><tr><th id=\"L25\"><a href=\"#L25\">25</a></th><td></td></tr><tr><th id=\"L26\"><a href=\"#L26\">26</a></th><td><span class=\"c\"># Twisted imports</span></td></tr><tr><th id=\"L27\"><a href=\"#L27\">27</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.internet</span>\u00a0<span class=\"kn\">import</span>\u00a0protocol</td></tr><tr><th id=\"L28\"><a href=\"#L28\">28</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.names</span>\u00a0<span class=\"kn\">import</span>\u00a0dns</td></tr><tr><th id=\"L29\"><a href=\"#L29\">29</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.python</span>\u00a0<span class=\"kn\">import</span>\u00a0log</td></tr><tr><th id=\"L30\"><a href=\"#L30\">30</a></th><td></td></tr><tr><th id=\"L31\"><a href=\"#L31\">31</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">resolve</span></td></tr><tr><th id=\"L32\"><a href=\"#L32\">32</a></th><td></td></tr><tr><th id=\"L33\"><a href=\"#L33\">33</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">DNSServerFactory</span><span class=\"p\">(</span>protocol<span class=\"o\">.</span>ServerFactory<span class=\"p\">):</span></td></tr><tr><th id=\"L34\"><a href=\"#L34\">34</a></th><td>\u00a0 \u00a0 protocol <span class=\"o\">=</span>\u00a0dns<span class=\"o\">.</span>DNSProtocol</td></tr><tr><th id=\"L35\"><a href=\"#L35\">35</a></th><td>\u00a0 \u00a0 cache <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L36\"><a href=\"#L36\">36</a></th><td></td></tr><tr><th id=\"L37\"><a href=\"#L37\">37</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0authorities <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">,</span>\u00a0caches <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">,</span>\u00a0clients <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">,</span>\u00a0verbose <span class=\"o\">=</span>\u00a0<span class=\"mi\">0</span><span class=\"p\">):</span></td></tr><tr><th id=\"L38\"><a href=\"#L38\">38</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 resolvers <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L39\"><a href=\"#L39\">39</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0authorities <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L40\"><a href=\"#L40\">40</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 resolvers<span class=\"o\">.</span>extend<span class=\"p\">(</span>authorities<span class=\"p\">)</span></td></tr><tr><th id=\"L41\"><a href=\"#L41\">41</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0caches <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L42\"><a href=\"#L42\">42</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 resolvers<span class=\"o\">.</span>extend<span class=\"p\">(</span>caches<span class=\"p\">)</span></td></tr><tr><th id=\"L43\"><a href=\"#L43\">43</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0clients <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L44\"><a href=\"#L44\">44</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 resolvers<span class=\"o\">.</span>extend<span class=\"p\">(</span>clients<span class=\"p\">)</span></td></tr><tr><th id=\"L45\"><a href=\"#L45\">45</a></th><td></td></tr><tr><th id=\"L46\"><a href=\"#L46\">46</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>canRecurse <span class=\"o\">=</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"ow\">not</span>\u00a0clients</td></tr><tr><th id=\"L47\"><a href=\"#L47\">47</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>resolver <span class=\"o\">=</span>\u00a0resolve<span class=\"o\">.</span>ResolverChain<span class=\"p\">(</span>resolvers<span class=\"p\">)</span></td></tr><tr><th id=\"L48\"><a href=\"#L48\">48</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>verbose <span class=\"o\">=</span>\u00a0verbose</td></tr><tr><th id=\"L49\"><a href=\"#L49\">49</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0caches<span class=\"p\">:</span></td></tr><tr><th id=\"L50\"><a href=\"#L50\">50</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>cache <span class=\"o\">=</span>\u00a0caches<span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span></td></tr><tr><th id=\"L51\"><a href=\"#L51\">51</a></th><td></td></tr><tr><th id=\"L52\"><a href=\"#L52\">52</a></th><td></td></tr><tr><th id=\"L53\"><a href=\"#L53\">53</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">buildProtocol</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0addr<span class=\"p\">):</span></td></tr><tr><th id=\"L54\"><a href=\"#L54\">54</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>protocol<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span></td></tr><tr><th id=\"L55\"><a href=\"#L55\">55</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p<span class=\"o\">.</span>factory <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span></td></tr><tr><th id=\"L56\"><a href=\"#L56\">56</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0p</td></tr><tr><th id=\"L57\"><a href=\"#L57\">57</a></th><td></td></tr><tr><th id=\"L58\"><a href=\"#L58\">58</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connectionMade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0protocol<span class=\"p\">):</span></td></tr><tr><th id=\"L59\"><a href=\"#L59\">59</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L60\"><a href=\"#L60\">60</a></th><td></td></tr><tr><th id=\"L61\"><a href=\"#L61\">61</a></th><td></td></tr><tr><th id=\"L62\"><a href=\"#L62\">62</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">sendReply</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L63\"><a href=\"#L63\">63</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose <span class=\"o\">&gt;</span>\u00a0<span class=\"mi\">1</span><span class=\"p\">:</span></td></tr><tr><th id=\"L64\"><a href=\"#L64\">64</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 s <span class=\"o\">=</span>\u00a0<span class=\"s\">' '</span><span class=\"o\">.</span>join<span class=\"p\">([</span><span class=\"nb\">str</span><span class=\"p\">(</span>a<span class=\"o\">.</span>payload<span class=\"p\">)</span>\u00a0<span class=\"k\">for</span>\u00a0a <span class=\"ow\">in</span>\u00a0message<span class=\"o\">.</span>answers<span class=\"p\">])</span></td></tr><tr><th id=\"L65\"><a href=\"#L65\">65</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 auth <span class=\"o\">=</span>\u00a0<span class=\"s\">' '</span><span class=\"o\">.</span>join<span class=\"p\">([</span><span class=\"nb\">str</span><span class=\"p\">(</span>a<span class=\"o\">.</span>payload<span class=\"p\">)</span>\u00a0<span class=\"k\">for</span>\u00a0a <span class=\"ow\">in</span>\u00a0message<span class=\"o\">.</span>authority<span class=\"p\">])</span></td></tr><tr><th id=\"L66\"><a href=\"#L66\">66</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 add <span class=\"o\">=</span>\u00a0<span class=\"s\">' '</span><span class=\"o\">.</span>join<span class=\"p\">([</span><span class=\"nb\">str</span><span class=\"p\">(</span>a<span class=\"o\">.</span>payload<span class=\"p\">)</span>\u00a0<span class=\"k\">for</span>\u00a0a <span class=\"ow\">in</span>\u00a0message<span class=\"o\">.</span>additional<span class=\"p\">])</span></td></tr><tr><th id=\"L67\"><a href=\"#L67\">67</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0s<span class=\"p\">:</span></td></tr><tr><th id=\"L68\"><a href=\"#L68\">68</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Replying with no answers\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L69\"><a href=\"#L69\">69</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L70\"><a href=\"#L70\">70</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Answers are \"</span>\u00a0<span class=\"o\">+</span>\u00a0s<span class=\"p\">)</span></td></tr><tr><th id=\"L71\"><a href=\"#L71\">71</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Authority is \"</span>\u00a0<span class=\"o\">+</span>\u00a0auth<span class=\"p\">)</span></td></tr><tr><th id=\"L72\"><a href=\"#L72\">72</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Additional is \"</span>\u00a0<span class=\"o\">+</span>\u00a0add<span class=\"p\">)</span></td></tr><tr><th id=\"L73\"><a href=\"#L73\">73</a></th><td></td></tr><tr><th id=\"L74\"><a href=\"#L74\">74</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0address <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L75\"><a href=\"#L75\">75</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 protocol<span class=\"o\">.</span>writeMessage<span class=\"p\">(</span>message<span class=\"p\">)</span></td></tr><tr><th id=\"L76\"><a href=\"#L76\">76</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L77\"><a href=\"#L77\">77</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 protocol<span class=\"o\">.</span>writeMessage<span class=\"p\">(</span>message<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L78\"><a href=\"#L78\">78</a></th><td></td></tr><tr><th id=\"L79\"><a href=\"#L79\">79</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose <span class=\"o\">&gt;</span>\u00a0<span class=\"mi\">1</span><span class=\"p\">:</span></td></tr><tr><th id=\"L80\"><a href=\"#L80\">80</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Processed query in </span><span class=\"si\">%0.3f</span><span class=\"s\">\u00a0seconds\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>time<span class=\"o\">.</span>time<span class=\"p\">()</span>\u00a0<span class=\"o\">-</span>\u00a0message<span class=\"o\">.</span>timeReceived<span class=\"p\">))</span></td></tr><tr><th id=\"L81\"><a href=\"#L81\">81</a></th><td></td></tr><tr><th id=\"L82\"><a href=\"#L82\">82</a></th><td></td></tr><tr><th id=\"L83\"><a href=\"#L83\">83</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">gotResolverResponse</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"p\">(</span>ans<span class=\"p\">,</span>\u00a0auth<span class=\"p\">,</span>\u00a0add<span class=\"p\">),</span>\u00a0protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L84\"><a href=\"#L84\">84</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>rCode <span class=\"o\">=</span>\u00a0dns<span class=\"o\">.</span>OK</td></tr><tr><th id=\"L85\"><a href=\"#L85\">85</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>answers <span class=\"o\">=</span>\u00a0ans</td></tr><tr><th id=\"L86\"><a href=\"#L86\">86</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0x <span class=\"ow\">in</span>\u00a0ans<span class=\"p\">:</span></td></tr><tr><th id=\"L87\"><a href=\"#L87\">87</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0x<span class=\"o\">.</span>isAuthoritative<span class=\"p\">():</span></td></tr><tr><th id=\"L88\"><a href=\"#L88\">88</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>auth <span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L89\"><a href=\"#L89\">89</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">break</span></td></tr><tr><th id=\"L90\"><a href=\"#L90\">90</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>authority <span class=\"o\">=</span>\u00a0auth</td></tr><tr><th id=\"L91\"><a href=\"#L91\">91</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>additional <span class=\"o\">=</span>\u00a0add</td></tr><tr><th id=\"L92\"><a href=\"#L92\">92</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendReply<span class=\"p\">(</span>protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L93\"><a href=\"#L93\">93</a></th><td></td></tr><tr><th id=\"L94\"><a href=\"#L94\">94</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 l <span class=\"o\">=</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>ans<span class=\"p\">)</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>auth<span class=\"p\">)</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>add<span class=\"p\">)</span></td></tr><tr><th id=\"L95\"><a href=\"#L95\">95</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose<span class=\"p\">:</span></td></tr><tr><th id=\"L96\"><a href=\"#L96\">96</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Lookup found </span><span class=\"si\">%d</span><span class=\"s\">\u00a0record</span><span class=\"si\">%s</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>l<span class=\"p\">,</span>\u00a0l <span class=\"o\">!=</span>\u00a0<span class=\"mi\">1</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"s\">\"s\"</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"s\">\"\"</span><span class=\"p\">))</span></td></tr><tr><th id=\"L97\"><a href=\"#L97\">97</a></th><td></td></tr><tr><th id=\"L98\"><a href=\"#L98\">98</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>cache <span class=\"ow\">and</span>\u00a0l<span class=\"p\">:</span></td></tr><tr><th id=\"L99\"><a href=\"#L99\">99</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>cache<span class=\"o\">.</span>cacheResult<span class=\"p\">(</span></td></tr><tr><th id=\"L100\"><a href=\"#L100\">100</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>queries<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span>\u00a0<span class=\"p\">(</span>ans<span class=\"p\">,</span>\u00a0auth<span class=\"p\">,</span>\u00a0add<span class=\"p\">)</span></td></tr><tr><th id=\"L101\"><a href=\"#L101\">101</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">)</span></td></tr><tr><th id=\"L102\"><a href=\"#L102\">102</a></th><td></td></tr><tr><th id=\"L103\"><a href=\"#L103\">103</a></th><td></td></tr><tr><th id=\"L104\"><a href=\"#L104\">104</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">gotResolverError</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0failure<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L105\"><a href=\"#L105\">105</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0failure<span class=\"o\">.</span>check<span class=\"p\">(</span>dns<span class=\"o\">.</span>DomainError<span class=\"p\">,</span>\u00a0dns<span class=\"o\">.</span>AuthoritativeDomainError<span class=\"p\">):</span></td></tr><tr><th id=\"L106\"><a href=\"#L106\">106</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>rCode <span class=\"o\">=</span>\u00a0dns<span class=\"o\">.</span>ENAME</td></tr><tr><th id=\"L107\"><a href=\"#L107\">107</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L108\"><a href=\"#L108\">108</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>rCode <span class=\"o\">=</span>\u00a0dns<span class=\"o\">.</span>ESERVER</td></tr><tr><th id=\"L109\"><a href=\"#L109\">109</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>err<span class=\"p\">(</span>failure<span class=\"p\">)</span></td></tr><tr><th id=\"L110\"><a href=\"#L110\">110</a></th><td></td></tr><tr><th id=\"L111\"><a href=\"#L111\">111</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendReply<span class=\"p\">(</span>protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L112\"><a href=\"#L112\">112</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose<span class=\"p\">:</span></td></tr><tr><th id=\"L113\"><a href=\"#L113\">113</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Lookup failed\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L114\"><a href=\"#L114\">114</a></th><td></td></tr><tr><th id=\"L115\"><a href=\"#L115\">115</a></th><td></td></tr><tr><th id=\"L116\"><a href=\"#L116\">116</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">handleQuery</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L117\"><a href=\"#L117\">117</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Discard all but the first query!\u00a0 HOO-AAH HOOOOO-AAAAH</span></td></tr><tr><th id=\"L118\"><a href=\"#L118\">118</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># (no other servers implement multi-query messages, so we won't either)</span></td></tr><tr><th id=\"L119\"><a href=\"#L119\">119</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 query <span class=\"o\">=</span>\u00a0message<span class=\"o\">.</span>queries<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span></td></tr><tr><th id=\"L120\"><a href=\"#L120\">120</a></th><td></td></tr><tr><th id=\"L121\"><a href=\"#L121\">121</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>resolver<span class=\"o\">.</span>query<span class=\"p\">(</span>query<span class=\"p\">)</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span></td></tr><tr><th id=\"L122\"><a href=\"#L122\">122</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>gotResolverResponse<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address</td></tr><tr><th id=\"L123\"><a href=\"#L123\">123</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">)</span><span class=\"o\">.</span>addErrback<span class=\"p\">(</span></td></tr><tr><th id=\"L124\"><a href=\"#L124\">124</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>gotResolverError<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address</td></tr><tr><th id=\"L125\"><a href=\"#L125\">125</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">)</span></td></tr><tr><th id=\"L126\"><a href=\"#L126\">126</a></th><td></td></tr><tr><th id=\"L127\"><a href=\"#L127\">127</a></th><td></td></tr><tr><th id=\"L128\"><a href=\"#L128\">128</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">handleInverseQuery</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L129\"><a href=\"#L129\">129</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>rCode <span class=\"o\">=</span>\u00a0dns<span class=\"o\">.</span>ENOTIMP</td></tr><tr><th id=\"L130\"><a href=\"#L130\">130</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendReply<span class=\"p\">(</span>protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L131\"><a href=\"#L131\">131</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose<span class=\"p\">:</span></td></tr><tr><th id=\"L132\"><a href=\"#L132\">132</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Inverse query from </span><span class=\"si\">%r</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>address<span class=\"p\">,))</span></td></tr><tr><th id=\"L133\"><a href=\"#L133\">133</a></th><td></td></tr><tr><th id=\"L134\"><a href=\"#L134\">134</a></th><td></td></tr><tr><th id=\"L135\"><a href=\"#L135\">135</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">handleStatus</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L136\"><a href=\"#L136\">136</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>rCode <span class=\"o\">=</span>\u00a0dns<span class=\"o\">.</span>ENOTIMP</td></tr><tr><th id=\"L137\"><a href=\"#L137\">137</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendReply<span class=\"p\">(</span>protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L138\"><a href=\"#L138\">138</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose<span class=\"p\">:</span></td></tr><tr><th id=\"L139\"><a href=\"#L139\">139</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Status request from </span><span class=\"si\">%r</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>address<span class=\"p\">,))</span></td></tr><tr><th id=\"L140\"><a href=\"#L140\">140</a></th><td></td></tr><tr><th id=\"L141\"><a href=\"#L141\">141</a></th><td></td></tr><tr><th id=\"L142\"><a href=\"#L142\">142</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">handleNotify</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L143\"><a href=\"#L143\">143</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>rCode <span class=\"o\">=</span>\u00a0dns<span class=\"o\">.</span>ENOTIMP</td></tr><tr><th id=\"L144\"><a href=\"#L144\">144</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendReply<span class=\"p\">(</span>protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L145\"><a href=\"#L145\">145</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose<span class=\"p\">:</span></td></tr><tr><th id=\"L146\"><a href=\"#L146\">146</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Notify message from </span><span class=\"si\">%r</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>address<span class=\"p\">,))</span></td></tr><tr><th id=\"L147\"><a href=\"#L147\">147</a></th><td></td></tr><tr><th id=\"L148\"><a href=\"#L148\">148</a></th><td></td></tr><tr><th id=\"L149\"><a href=\"#L149\">149</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">handleOther</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L150\"><a href=\"#L150\">150</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>rCode <span class=\"o\">=</span>\u00a0dns<span class=\"o\">.</span>ENOTIMP</td></tr><tr><th id=\"L151\"><a href=\"#L151\">151</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendReply<span class=\"p\">(</span>protocol<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L152\"><a href=\"#L152\">152</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose<span class=\"p\">:</span></td></tr><tr><th id=\"L153\"><a href=\"#L153\">153</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Unknown op code (</span><span class=\"si\">%d</span><span class=\"s\">) from </span><span class=\"si\">%r</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>message<span class=\"o\">.</span>opCode<span class=\"p\">,</span>\u00a0address<span class=\"p\">))</span></td></tr><tr><th id=\"L154\"><a href=\"#L154\">154</a></th><td></td></tr><tr><th id=\"L155\"><a href=\"#L155\">155</a></th><td></td></tr><tr><th id=\"L156\"><a href=\"#L156\">156</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">messageReceived</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0proto<span class=\"p\">,</span>\u00a0address <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">):</span></td></tr><tr><th id=\"L157\"><a href=\"#L157\">157</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>timeReceived <span class=\"o\">=</span>\u00a0time<span class=\"o\">.</span>time<span class=\"p\">()</span></td></tr><tr><th id=\"L158\"><a href=\"#L158\">158</a></th><td></td></tr><tr><th id=\"L159\"><a href=\"#L159\">159</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose<span class=\"p\">:</span></td></tr><tr><th id=\"L160\"><a href=\"#L160\">160</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose <span class=\"o\">&gt;</span>\u00a0<span class=\"mi\">1</span><span class=\"p\">:</span></td></tr><tr><th id=\"L161\"><a href=\"#L161\">161</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 s <span class=\"o\">=</span>\u00a0<span class=\"s\">' '</span><span class=\"o\">.</span>join<span class=\"p\">([</span><span class=\"nb\">str</span><span class=\"p\">(</span>q<span class=\"p\">)</span>\u00a0<span class=\"k\">for</span>\u00a0q <span class=\"ow\">in</span>\u00a0message<span class=\"o\">.</span>queries<span class=\"p\">])</span></td></tr><tr><th id=\"L162\"><a href=\"#L162\">162</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>verbose <span class=\"o\">&gt;</span>\u00a0<span class=\"mi\">0</span><span class=\"p\">:</span></td></tr><tr><th id=\"L163\"><a href=\"#L163\">163</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 s <span class=\"o\">=</span>\u00a0<span class=\"s\">' '</span><span class=\"o\">.</span>join<span class=\"p\">([</span>dns<span class=\"o\">.</span>QUERY_TYPES<span class=\"o\">.</span>get<span class=\"p\">(</span>q<span class=\"o\">.</span>type<span class=\"p\">,</span>\u00a0<span class=\"s\">'UNKNOWN'</span><span class=\"p\">)</span>\u00a0<span class=\"k\">for</span>\u00a0q <span class=\"ow\">in</span>\u00a0message<span class=\"o\">.</span>queries<span class=\"p\">])</span></td></tr><tr><th id=\"L164\"><a href=\"#L164\">164</a></th><td></td></tr><tr><th id=\"L165\"><a href=\"#L165\">165</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>s<span class=\"p\">):</span></td></tr><tr><th id=\"L166\"><a href=\"#L166\">166</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Empty query from </span><span class=\"si\">%r</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">((</span>address <span class=\"ow\">or</span>\u00a0proto<span class=\"o\">.</span>transport<span class=\"o\">.</span>getPeer<span class=\"p\">()),))</span></td></tr><tr><th id=\"L167\"><a href=\"#L167\">167</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L168\"><a href=\"#L168\">168</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"</span><span class=\"si\">%s</span><span class=\"s\">\u00a0query from </span><span class=\"si\">%r</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>s<span class=\"p\">,</span>\u00a0address <span class=\"ow\">or</span>\u00a0proto<span class=\"o\">.</span>transport<span class=\"o\">.</span>getPeer<span class=\"p\">()))</span></td></tr><tr><th id=\"L169\"><a href=\"#L169\">169</a></th><td></td></tr><tr><th id=\"L170\"><a href=\"#L170\">170</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>recAv <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>canRecurse</td></tr><tr><th id=\"L171\"><a href=\"#L171\">171</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>answer <span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L172\"><a href=\"#L172\">172</a></th><td></td></tr><tr><th id=\"L173\"><a href=\"#L173\">173</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>allowQuery<span class=\"p\">(</span>message<span class=\"p\">,</span>\u00a0proto<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L174\"><a href=\"#L174\">174</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 message<span class=\"o\">.</span>rCode <span class=\"o\">=</span>\u00a0dns<span class=\"o\">.</span>EREFUSED</td></tr><tr><th id=\"L175\"><a href=\"#L175\">175</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendReply<span class=\"p\">(</span>proto<span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L176\"><a href=\"#L176\">176</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0message<span class=\"o\">.</span>opCode <span class=\"o\">==</span>\u00a0dns<span class=\"o\">.</span>OP_QUERY<span class=\"p\">:</span></td></tr><tr><th id=\"L177\"><a href=\"#L177\">177</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>handleQuery<span class=\"p\">(</span>message<span class=\"p\">,</span>\u00a0proto<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L178\"><a href=\"#L178\">178</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0message<span class=\"o\">.</span>opCode <span class=\"o\">==</span>\u00a0dns<span class=\"o\">.</span>OP_INVERSE<span class=\"p\">:</span></td></tr><tr><th id=\"L179\"><a href=\"#L179\">179</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>handleInverseQuery<span class=\"p\">(</span>message<span class=\"p\">,</span>\u00a0proto<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L180\"><a href=\"#L180\">180</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0message<span class=\"o\">.</span>opCode <span class=\"o\">==</span>\u00a0dns<span class=\"o\">.</span>OP_STATUS<span class=\"p\">:</span></td></tr><tr><th id=\"L181\"><a href=\"#L181\">181</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>handleStatus<span class=\"p\">(</span>message<span class=\"p\">,</span>\u00a0proto<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L182\"><a href=\"#L182\">182</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0message<span class=\"o\">.</span>opCode <span class=\"o\">==</span>\u00a0dns<span class=\"o\">.</span>OP_NOTIFY<span class=\"p\">:</span></td></tr><tr><th id=\"L183\"><a href=\"#L183\">183</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>handleNotify<span class=\"p\">(</span>message<span class=\"p\">,</span>\u00a0proto<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L184\"><a href=\"#L184\">184</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L185\"><a href=\"#L185\">185</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>handleOther<span class=\"p\">(</span>message<span class=\"p\">,</span>\u00a0proto<span class=\"p\">,</span>\u00a0address<span class=\"p\">)</span></td></tr><tr><th id=\"L186\"><a href=\"#L186\">186</a></th><td></td></tr><tr><th id=\"L187\"><a href=\"#L187\">187</a></th><td></td></tr><tr><th id=\"L188\"><a href=\"#L188\">188</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">allowQuery</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0message<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L189\"><a href=\"#L189\">189</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Allow anything but empty queries</span></td></tr><tr><th id=\"L190\"><a href=\"#L190\">190</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>message<span class=\"o\">.</span>queries<span class=\"p\">)</span></td></tr></tbody></table>\n\n      </div>\n      <div id=\"anydiff\">\n        <form action=\"/LUCICodeRepository/nomaticIM/diff\" method=\"get\">\n          <div class=\"buttons\">\n            <input type=\"hidden\" name=\"new_path\" value=\"/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py\" />\n            <input type=\"hidden\" name=\"old_path\" value=\"/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py\" />\n            <input type=\"hidden\" name=\"new_rev\" />\n            <input type=\"hidden\" name=\"old_rev\" />\n            <input type=\"submit\" value=\"View changes...\" title=\"Select paths and revs for Diff\" />\n          </div>\n        </form>\n      </div>\n      <div id=\"help\"><strong>Note:</strong> See <a href=\"/LUCICodeRepository/nomaticIM/wiki/TracBrowser\">TracBrowser</a>\n        for help on using the repository browser.</div>\n    </div>\n    <div id=\"altlinks\">\n      <h3>Download in other formats:</h3>\n      <ul>\n        <li class=\"first\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py?format=txt\">Plain Text</a>\n        </li><li class=\"last\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/names/server.py\">Original Format</a>\n        </li>\n      </ul>\n    </div>\n    </div>\n    <div id=\"footer\" lang=\"en\" xml:lang=\"en\"><hr />\n      <a id=\"tracpowered\" href=\"http://trac.edgewall.org/\"><img src=\"/LUCICodeRepository/nomaticIM/chrome/common/trac_logo_mini.png\" height=\"30\" width=\"107\" alt=\"Trac Powered\" /></a>\n      <p class=\"left\">Powered by <a href=\"/LUCICodeRepository/nomaticIM/about\"><strong>Trac 1.0.1</strong></a><br />\n        By <a href=\"http://www.edgewall.org/\">Edgewall Software</a>.</p>\n      <p class=\"right\">All content copyright 2007-2008 by LUCI <br /><a href=\"http://luci.ics.uci.edu/\">http://luci.ics.uci.edu/</a></p>\n    </div>\n\t\t<div id=\"sitefooter\">\n\t\t\t<script src=\"http://www.google-analytics.com/urchin.js\" type=\"text/javascript\">\n\t\t\t</script>\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t_uacct = \"UA-338915-2\";\n\t\t\t\turchinTracker();\n\t\t\t</script>\n\t\t</div>\n\t</body>\n</html>", "id": 44580.0}