{"text": "Search LoginPreferencesHelp GuideAbout Trac WikiTimelineRoadmapBrowse SourceView TicketsSearch Context Navigation BlameRevision Log source nomatic tags NomaticIM 3 buddy bots src twisted persisted aot py View diff against View revision Visit trunk Last change on this file was 712 checked in by cbaker 7 years ago First draft of nomatic buddy bots oscar bot is functional if you give it good authentication credentials jabber bot is just an example from the web File size 17 KB Line 1 test case name twisted test test persisted 23 Copyright c 2 1 2 4 Twisted Matrix Laboratories 4 See LICENSE for details 5678 9AOT Abstract Object Trees1 The source code marshallin est abstract object serializin est persister11this side of Marmalade 12 1314import types new string copy reg tokenize re1516from twisted python import reflect log17from twisted persisted import crefutil1819 2 Abstract Object Classes 21 2223 in a getSource means insert variable width indention here 24 see indentify 2526class Named 27 def init self name 28 self name name293 class Class Named 31 def getSource self 32 return Class r self name3334class Function Named 35 def getSource self 36 return Function r self name3738class Module Named 39 def getSource self 4 return Module r self name414243class InstanceMethod 44 def init self name klass inst 45 if not isinstance inst Ref or isinstance inst Instance or isinstance inst Deref 46 raise TypeError s isn t an Instance Ref or Deref inst 47 self name name48 self klass klass49 self instance inst5 51 def getSource self 52 return InstanceMethod r r n s self name self klass prettify self instance 535455class NoStateObj 56 pass57NoStateObj NoStateObj 5859 SIMPLE BUILTINS 6 types StringType types UnicodeType types IntType types FloatType 61 types ComplexType types LongType types NoneType types SliceType 62 types EllipsisType 6364try 65 SIMPLE BUILTINS append types BooleanType 66except AttributeError 67 pass6869class Instance 7 def init self className stateObj NoStateObj state 71 if not isinstance className types StringType 72 raise TypeError s isn t a string className 73 self klass className74 if stateObj is not NoStateObj 75 self state stateObj 76 self stateIsDict 77 else 78 self state state79 self stateIsDict 18 81 def getSource self 82 XXX make state be foo bar instead of a dict 83 if self stateIsDict 84 stateDict self state85 elif isinstance self state Ref and isinstance self state obj types DictType 86 stateDict self state obj87 else 88 stateDict None89 if stateDict is not None 9 try 91 return Instance r s self klass dictToKW stateDict 92 except NonFormattableDict 93 return Instance r s self klass prettify stateDict 94 return Instance r s self klass prettify self state 9596class Ref 9798 def init self args 99 blargh lame 1 if len args 2 1 1 self refnum args 1 2 self obj args 1 1 3 elif not args 1 4 self refnum None1 5 self obj None1 61 7 def setRef self num 1 8 if self refnum 1 9 raise ValueError Error setting id s I already have s num self refnum 11 self refnum num111112 def setObj self obj 113 if self obj 114 raise ValueError Error setting obj s I already have s obj self obj 115 self obj obj116117 def getSource self 118 if self obj is None 119 raise RuntimeError Don t try to display me before setting an object on me 12 if self refnum 121 return Ref d n s self refnum prettify self obj 122 return prettify self obj 123 124125class Deref 126 def init self num 127 self refnum num128129 def getSource self 13 return Deref d self refnum131132 repr getSource133134135class Copyreg 136 def init self loadfunc state 137 self loadfunc loadfunc138 self state state13914 def getSource self 141 return Copyreg r s self loadfunc prettify self state 142143144145 146 Marshalling 147 14814915 def getSource ao 151 Pass me an AO I ll return a nicely formatted source representation 152 return indentify app prettify ao 153154155class NonFormattableDict Exception 156 A dictionary was not formattable 157 158159r re compile a zA Z a zA Z 9 16 161def dictToKW d 162 out 163 items d items 164 items sort 165 for k v in items 166 if not isinstance k types StringType 167 raise NonFormattableDict r ain t a string k 168 if not r match k 169 raise NonFormattableDict r ain t an identifier k 17 out append 171 n s s k prettify v 172 173 return string join out 174175176def prettify obj 177 if hasattr obj getSource 178 return obj getSource 179 else 18 basic type181 t type obj 182183 if t in SIMPLE BUILTINS 184 return repr obj 185186 elif t is types DictType 187 out 188 for k v in obj items 189 out append n s s prettify k prettify v 19 out append len obj and n or 191 return string join out 192193 elif t is types ListType 194 out 195 for x in obj 196 out append n s prettify x 197 out append len obj and n or 198 return string join out 1992 elif t is types TupleType 2 1 out 2 2 for x in obj 2 3 out append n s prettify x 2 4 out append len obj and n or 2 5 return string join out 2 6 else 2 7 raise TypeError Unsupported type s when trying to prettify s t obj 2 82 9def indentify s 21 out 211 stack 212 def eater type val r c l out out stack stack 213 import sys214 sys stdout write val 215 if val in 216 stack append val 217 elif val in 218 stack pop 219 if val 22 out append len stack 221 else 222 out append val 223 l s 224 tokenize tokenize l pop eater 225 return string join out 22622722822923 231 232 Unjelly 233 234235def unjellyFromAOT aot 236 237 Pass me an Abstract Object Tree and I ll unjelly it for you 238 239 return AOTUnjellier unjelly aot 24 241def unjellyFromSource stringOrFile 242 243 Pass me a string of code or a filename that defines an app variable in244 terms of Abstract Objects and I ll execute it and unjelly the resulting245 AOT for you returning a newly unpersisted Application object 246 247248 ns Instance Instance 249 InstanceMethod InstanceMethod 25 Class Class 251 Function Function 252 Module Module 253 Ref Ref 254 Deref Deref 255 Copyreg Copyreg 256 257258 if hasattr stringOrFile read 259 exec stringOrFile read in ns26 else 261 exec stringOrFile in ns262263 if ns has key app 264 return unjellyFromAOT ns app 265 else 266 raise ValueError s needs to define an app it didn t stringOrFile 267268269class AOTUnjellier 27 I handle the unjellying of an Abstract Object Tree 271 See AOTUnjellier unjellyAO272 273 def init self 274 self references 275 self stack 276 self afterUnjelly 277278 279 unjelly helpers copied pretty much directly from marmalade XXX refactor 28 281 def unjellyLater self node 282 Unjelly a node later 283 284 d crefutil Defer 285 self unjellyInto d node 286 return d287288 def unjellyInto self obj loc ao 289 Utility method for unjellying one object into another 29 This automates the handling of backreferences 291 292 o self unjellyAO ao 293 obj loc o294 if isinstance o crefutil NotKnown 295 o addDependant obj loc 296 return o297298 def callAfter self callable result 299 if isinstance result crefutil NotKnown 3 l None 3 1 result addDependant l 1 3 2 else 3 3 l result 3 4 self afterUnjelly append callable l 3 53 6 def unjellyAttribute self instance attrName ao 3 7 XXX this is unused 3 8 Utility method for unjellying into instances of attributes 3 9 31 Use this rather than unjellyAO unless you like surprising bugs 311 Alternatively you can use unjellyInto on your instance s dict 312 313 self unjellyInto instance dict attrName ao 314315 def unjellyAO self ao 316 Unjelly an Abstract Object and everything it contains 317 I return the real object 318 319 self stack append ao 32 t type ao 321 if t is types InstanceType 322 Abstract Objects323 c ao class 324 if c is Module 325 return reflect namedModule ao name 326327 elif c in Class Function or issubclass c type 328 return reflect namedObject ao name 32933 elif c is InstanceMethod 331 im name ao name332 im class reflect namedObject ao klass 333 im self self unjellyAO ao instance 334 if im class dict has key im name 335 if im self is None 336 return getattr im class im name 337 elif isinstance im self crefutil NotKnown 338 return crefutil InstanceMethod im name im self im class 339 else 34 return new instancemethod im class dict im name 341 im self 342 im class 343 else 344 raise instance method changed 345346 elif c is Instance 347 klass reflect namedObject ao klass 348 state self unjellyAO ao state 349 if hasattr klass setstate 35 inst new instance klass 351 self callAfter inst setstate state 352 else 353 inst new instance klass state 354 return inst355356 elif c is Ref 357 o self unjellyAO ao obj THIS IS CHANGING THE REF OMG358 refkey ao refnum359 ref self references get refkey 36 if ref is None 361 self references refkey o362 elif isinstance ref crefutil NotKnown 363 ref resolveDependants o 364 self references refkey o365 elif refkey is None 366 This happens when you re unjellying from an AOT not read from source367 pass368 else 369 raise ValueError Multiple references with the same ID s s s ref refkey ao 37 return o371372 elif c is Deref 373 num ao refnum374 ref self references get num 375 if ref is None 376 der crefutil Dereference num 377 self references num der378 return der379 return ref38 381 elif c is Copyreg 382 loadfunc reflect namedObject ao loadfunc 383 d self unjellyLater ao state addCallback 384 lambda result l apply l result loadfunc 385 return d386387 Types388 389 elif t in SIMPLE BUILTINS 39 return ao391 392 elif t is types ListType 393 l 394 for x in ao 395 l append None 396 self unjellyInto l len l 1 x 397 return l398 399 elif t is types TupleType 4 l 4 1 tuple tuple4 2 for x in ao 4 3 l append None 4 4 if isinstance self unjellyInto l len l 1 x crefutil NotKnown 4 5 tuple crefutil Tuple4 6 return tuple l 4 74 8 elif t is types DictType 4 9 d 41 for k v in ao items 411 kvd crefutil DictKeyAndValue d 412 self unjellyInto kvd k 413 self unjellyInto kvd 1 v 414 return d415416 else 417 raise TypeError Unsupported AOT type s t 418419 del self stack 1 42 421 422 def unjelly self ao 423 try 424 l None 425 self unjellyInto l ao 426 for callable v in self afterUnjelly 427 callable v 428 return l 429 except 43 log msg Error jellying object Stacktrace follows 431 log msg string join map repr self stack n 432 raise433 434 Jelly 435 436437438def jellyToAOT obj 439 Convert an object to an Abstract Object Tree 44 return AOTJellier jelly obj 441442def jellyToSource obj file None 443 444 Pass me an object and optionally a file object 445 I ll convert the object to an AOT either return it if no file was446 specified or write it to the file 447 448449 aot jellyToAOT obj 45 if file 451 file write getSource aot 452 else 453 return getSource aot 454 455456class AOTJellier 457 def init self 458 dict of id obj obj node 459 self prepared 46 self ref id 461 self stack 462463 def prepareForRef self aoref object 464 I prepare an object for later referencing by storing its id 465 and its AORef in a cache 466 self prepared id object aoref467468 def jellyToAO self obj 469 I turn an object into an AOT and return it 47 objType type obj 471 self stack append repr obj 472473 immutable We don t care if these have multiple refs 474 if objType in SIMPLE BUILTINS 475 retval obj476 477 elif objType is types MethodType 478 TODO make methods prefer not to jelly the object internally 479 so that the object will show up where it s referenced first NOT48 by a method 481 retval InstanceMethod obj im func name reflect qual obj im class 482 self jellyToAO obj im self 483 484 elif objType is types ModuleType 485 retval Module obj name 486 487 elif objType is types ClassType 488 retval Class reflect qual obj 48949 elif issubclass objType type 491 retval Class reflect qual obj 492 493 elif objType is types FunctionType 494 retval Function reflect fullFuncName obj 495 496 else mutable gotta watch for refs 497498 Marmalade had the nicety of being able to just stick a reference attribute499 on any Node object that was referenced but in AOT the referenced object5 is inside of a Ref call Ref num obj instead of5 1 objtype reference 1 The problem is especially for built in types 5 2 I can t just assign some attribute to them to give them a refnum So I have5 3 to wrap a Ref around them later that s why I put everything that s5 4 mutable inside one The Ref class will only print the Ref around an5 5 object if it has a Reference explicitly attached 5 65 7 if self prepared has key id obj 5 8 oldRef self prepared id obj 5 9 if oldRef refnum 51 it s been referenced already511 key oldRef refnum512 else 513 it hasn t been referenced yet514 self ref id self ref id 1515 key self ref id516 oldRef setRef key 517 return Deref key 518519 retval Ref 52 self prepareForRef retval obj 521 522 if objType is types ListType 523 retval setObj map self jellyToAO obj hah 524 525 elif objType is types TupleType 526 retval setObj tuple map self jellyToAO obj 527528 elif objType is types DictionaryType 529 d 53 for k v in obj items 531 d self jellyToAO k self jellyToAO v 532 retval setObj d 533534 elif objType is types InstanceType 535 if hasattr obj getstate 536 state self jellyToAO obj getstate 537 else 538 state self jellyToAO obj dict 539 retval setObj Instance reflect qual obj class state 54 541 elif copy reg dispatch table has key objType 542 unpickleFunc state copy reg dispatch table objType obj 543 544 retval setObj Copyreg reflect fullFuncName unpickleFunc 545 self jellyToAO state 546 547 else 548 raise Unsupported type s objType name 54955 del self stack 1 551 return retval552553 def jelly self obj 554 try 555 ao self jellyToAO obj 556 return ao557 except 558 log msg Error jellying object Stacktrace follows 559 log msg string join self stack n 56 raise Note See TracBrowser for help on using the repository browser Download in other formats Plain Text Original Format Powered by Trac 1 1 By Edgewall Software All content copyright 2 7 2 8 by LUCI http luci ics uci edu ", "_id": "http://djp3-pc2.ics.uci.edu/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py", "title": "\n      aot.py in nomatic/tags/nomaticim-0.0.3/buddy_bots/src/twisted/persisted\n     \u2013 nomatic*im\n    ", "html": "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n  \n  \n\n  \n\n\n  <head>\n\t\t<title>\n      aot.py in nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted\n     \u2013 Nomatic*IM\n    </title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" /><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" /><link rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search\" /><link rel=\"help\" href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py?format=txt\" type=\"text/plain\" title=\"Plain Text\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py\" type=\"application/x-python; charset=iso-8859-15\" title=\"Original Format\" /><link rel=\"start\" href=\"/LUCICodeRepository/nomaticIM/wiki\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/code.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/pygments/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/browser.css\" type=\"text/css\" /><link rel=\"shortcut icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link rel=\"icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link type=\"application/opensearchdescription+xml\" rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search/opensearch\" title=\"Search Nomatic*IM\" /><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/jquery.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/babel.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/messages/en_US.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/trac.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/search.js\"></script><script type=\"text/javascript\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/folding.js\"></script><script type=\"text/javascript\">\n      jQuery(document).ready(function($) {\n        $(\".trac-toggledeleted\").show().click(function() {\n                  $(this).siblings().find(\".trac-deleted\").toggle();\n                  return false;\n        }).click();\n        $(\"#jumploc input\").hide();\n        $(\"#jumploc select\").change(function () {\n          this.parentNode.parentNode.submit();\n        });\n          $('#preview table.code').enableCollapsibleColumns($('#preview table.code thead th.content'));\n      });\n    </script>\n\t</head>\n  <body>\n    <div id=\"banner\">\n      <div id=\"header\">\n        <a id=\"logo\" href=\"http://luci.ics.uci.edu/#code\"><img src=\"http://luci.ics.uci.edu/blog/archives/LUCIhorzTight.jpg\" alt=\"LUCI Code Repository\" /></a>\n      </div>\n      <form id=\"search\" action=\"/LUCICodeRepository/nomaticIM/search\" method=\"get\">\n        <div>\n          <label for=\"proj-search\">Search:</label>\n          <input type=\"text\" id=\"proj-search\" name=\"q\" size=\"18\" value=\"\" />\n          <input type=\"submit\" value=\"Search\" />\n        </div>\n      </form>\n      <div id=\"metanav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/login\">Login</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/prefs\">Preferences</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\">Help/Guide</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/about\">About Trac</a></li>\n    </ul>\n  </div>\n    </div>\n    <div id=\"mainnav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/wiki\">Wiki</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/timeline\">Timeline</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/roadmap\">Roadmap</a></li><li class=\"active\"><a href=\"/LUCICodeRepository/nomaticIM/browser\">Browse Source</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/report\">View Tickets</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/search\">Search</a></li>\n    </ul>\n  </div>\n    <div id=\"main\">\n      <div id=\"ctxtnav\" class=\"nav\">\n        <h2>Context Navigation</h2>\n        <ul>\n          <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/trunk/buddy_bots/twisted/persisted/aot.py?annotate=blame\" title=\"Annotate each line with the last changed revision (this can be time consuming...)\">Blame</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/log/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py\">Revision Log</a></li>\n        </ul>\n        <hr />\n      </div>\n    <div id=\"content\" class=\"browser\">\n        <h1>\n          \n<a class=\"pathentry first\" href=\"/LUCICodeRepository/nomaticIM/browser?order=name\" title=\"Go to repository root\">source:</a>\n<a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic?order=name\" title=\"View nomatic\">nomatic</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags?order=name\" title=\"View tags\">tags</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3?order=name\" title=\"View NomaticIM-0.0.3\">NomaticIM-0.0.3</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots?order=name\" title=\"View buddy_bots\">buddy_bots</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src?order=name\" title=\"View src\">src</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted?order=name\" title=\"View twisted\">twisted</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted?order=name\" title=\"View persisted\">persisted</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py?order=name\" title=\"View aot.py\">aot.py</a>\n<br style=\"clear: both\" />\n\n        </h1>\n        <div id=\"diffrev\">\n          <form action=\"/LUCICodeRepository/nomaticIM/changeset\" method=\"get\">\n            <div>\n              <label title=\"Show the diff against a specific revision\">\n                View diff against: <input type=\"text\" name=\"old\" size=\"6\" />\n                <input type=\"hidden\" name=\"old_path\" value=\"nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py\" />\n                <input type=\"hidden\" name=\"new\" />\n                <input type=\"hidden\" name=\"new_path\" value=\"nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py\" />\n              </label>\n            </div>\n          </form>\n        </div>\n        <div id=\"jumprev\">\n          <form action=\"\" method=\"get\">\n            <div>\n              <label for=\"rev\">\n                View revision:</label>\n              <input type=\"text\" id=\"rev\" name=\"rev\" size=\"6\" />\n            </div>\n          </form>\n        </div>\n        <div id=\"jumploc\">\n          <form action=\"\" method=\"get\">\n            <div class=\"buttons\">\n              <label for=\"preselected\">Visit:</label>\n              <select id=\"preselected\" name=\"preselected\">\n                <option selected=\"selected\"></option>\n                <optgroup label=\"branches\">\n                  <option value=\"/LUCICodeRepository/nomaticIM/browser/trunk\">trunk</option>\n                </optgroup>\n              </select>\n              <input type=\"submit\" value=\"Go!\" title=\"Jump to the chosen preselected path\" />\n            </div>\n          </form>\n        </div>\n        <div class=\"trac-tags\">\n        </div>\n      <table id=\"info\" summary=\"Revision info\">\n        <tr>\n          <th>\n                <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/nomatic/trunk/buddy_bots/twisted/persisted/aot.py\" title=\"View differences\">Last change</a>\n                  on this file was\n                  <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/\" title=\"View changeset 712\">712</a>,\n                  checked in by cbaker, <a class=\"timeline\" href=\"/LUCICodeRepository/nomaticIM/timeline?from=2008-02-16T08%3A16%3A53-08%3A00&amp;precision=second\" title=\"See timeline at Feb 16, 2008, 8:16:53 AM\">7 years ago</a>\n          </th>\n        </tr>\n        <tr>\n          <td class=\"message searchable\">\n              <p>\nFirst draft of nomatic buddy bots. oscar_bot is functional if you give it good authentication credentials, jabber_bot is just an example from the web <br />\n</p>\n          </td>\n        </tr>\n        <tr><td colspan=\"2\">\n            <strong>File size:</strong>\n            <span title=\"17434 bytes\">17.0 KB</span>\n          </td></tr>\n      </table>\n      <div id=\"preview\" class=\"searchable\">\n        \n  <table class=\"code\"><thead><tr><th class=\"lineno\" title=\"Line numbers\">Line</th><th class=\"content\">\u00a0</th></tr></thead><tbody><tr><th id=\"L1\"><a href=\"#L1\">1</a></th><td><span class=\"c\"># -*- test-case-name: twisted.test.test_persisted -*-</span></td></tr><tr><th id=\"L2\"><a href=\"#L2\">2</a></th><td></td></tr><tr><th id=\"L3\"><a href=\"#L3\">3</a></th><td><span class=\"c\"># Copyright (c) 2001-2004 Twisted Matrix Laboratories.</span></td></tr><tr><th id=\"L4\"><a href=\"#L4\">4</a></th><td><span class=\"c\"># See LICENSE for details.</span></td></tr><tr><th id=\"L5\"><a href=\"#L5\">5</a></th><td></td></tr><tr><th id=\"L6\"><a href=\"#L6\">6</a></th><td></td></tr><tr><th id=\"L7\"><a href=\"#L7\">7</a></th><td></td></tr><tr><th id=\"L8\"><a href=\"#L8\">8</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L9\"><a href=\"#L9\">9</a></th><td><span class=\"sd\">AOT: Abstract Object Trees</span></td></tr><tr><th id=\"L10\"><a href=\"#L10\">10</a></th><td><span class=\"sd\">The source-code-marshallin'est abstract-object-serializin'est persister</span></td></tr><tr><th id=\"L11\"><a href=\"#L11\">11</a></th><td><span class=\"sd\">this side of Marmalade!</span></td></tr><tr><th id=\"L12\"><a href=\"#L12\">12</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L13\"><a href=\"#L13\">13</a></th><td></td></tr><tr><th id=\"L14\"><a href=\"#L14\">14</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">types</span><span class=\"o\">,</span>\u00a0<span class=\"nn\">new</span><span class=\"o\">,</span>\u00a0<span class=\"nn\">string</span><span class=\"o\">,</span>\u00a0<span class=\"nn\">copy_reg</span><span class=\"o\">,</span>\u00a0<span class=\"nn\">tokenize</span><span class=\"o\">,</span>\u00a0<span class=\"nn\">re</span></td></tr><tr><th id=\"L15\"><a href=\"#L15\">15</a></th><td></td></tr><tr><th id=\"L16\"><a href=\"#L16\">16</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.python</span>\u00a0<span class=\"kn\">import</span>\u00a0reflect<span class=\"p\">,</span>\u00a0log</td></tr><tr><th id=\"L17\"><a href=\"#L17\">17</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.persisted</span>\u00a0<span class=\"kn\">import</span>\u00a0crefutil</td></tr><tr><th id=\"L18\"><a href=\"#L18\">18</a></th><td></td></tr><tr><th id=\"L19\"><a href=\"#L19\">19</a></th><td><span class=\"c\">###########################</span></td></tr><tr><th id=\"L20\"><a href=\"#L20\">20</a></th><td><span class=\"c\"># Abstract Object Classes #</span></td></tr><tr><th id=\"L21\"><a href=\"#L21\">21</a></th><td><span class=\"c\">###########################</span></td></tr><tr><th id=\"L22\"><a href=\"#L22\">22</a></th><td></td></tr><tr><th id=\"L23\"><a href=\"#L23\">23</a></th><td><span class=\"c\">#\"\\0\" in a getSource means \"insert variable-width indention here\".</span></td></tr><tr><th id=\"L24\"><a href=\"#L24\">24</a></th><td><span class=\"c\">#see `indentify'.</span></td></tr><tr><th id=\"L25\"><a href=\"#L25\">25</a></th><td></td></tr><tr><th id=\"L26\"><a href=\"#L26\">26</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Named</span><span class=\"p\">:</span></td></tr><tr><th id=\"L27\"><a href=\"#L27\">27</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0name<span class=\"p\">):</span></td></tr><tr><th id=\"L28\"><a href=\"#L28\">28</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>name <span class=\"o\">=</span>\u00a0name</td></tr><tr><th id=\"L29\"><a href=\"#L29\">29</a></th><td></td></tr><tr><th id=\"L30\"><a href=\"#L30\">30</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Class</span><span class=\"p\">(</span>Named<span class=\"p\">):</span></td></tr><tr><th id=\"L31\"><a href=\"#L31\">31</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">getSource</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L32\"><a href=\"#L32\">32</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"Class(</span><span class=\"si\">%r</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>name</td></tr><tr><th id=\"L33\"><a href=\"#L33\">33</a></th><td></td></tr><tr><th id=\"L34\"><a href=\"#L34\">34</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Function</span><span class=\"p\">(</span>Named<span class=\"p\">):</span></td></tr><tr><th id=\"L35\"><a href=\"#L35\">35</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">getSource</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L36\"><a href=\"#L36\">36</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"Function(</span><span class=\"si\">%r</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>name</td></tr><tr><th id=\"L37\"><a href=\"#L37\">37</a></th><td></td></tr><tr><th id=\"L38\"><a href=\"#L38\">38</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Module</span><span class=\"p\">(</span>Named<span class=\"p\">):</span></td></tr><tr><th id=\"L39\"><a href=\"#L39\">39</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">getSource</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L40\"><a href=\"#L40\">40</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"Module(</span><span class=\"si\">%r</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>name</td></tr><tr><th id=\"L41\"><a href=\"#L41\">41</a></th><td></td></tr><tr><th id=\"L42\"><a href=\"#L42\">42</a></th><td></td></tr><tr><th id=\"L43\"><a href=\"#L43\">43</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">InstanceMethod</span><span class=\"p\">:</span></td></tr><tr><th id=\"L44\"><a href=\"#L44\">44</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0name<span class=\"p\">,</span>\u00a0klass<span class=\"p\">,</span>\u00a0inst<span class=\"p\">):</span></td></tr><tr><th id=\"L45\"><a href=\"#L45\">45</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"p\">(</span><span class=\"nb\">isinstance</span><span class=\"p\">(</span>inst<span class=\"p\">,</span>\u00a0Ref<span class=\"p\">)</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>inst<span class=\"p\">,</span>\u00a0Instance<span class=\"p\">)</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>inst<span class=\"p\">,</span>\u00a0Deref<span class=\"p\">)):</span></td></tr><tr><th id=\"L46\"><a href=\"#L46\">46</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s\">\"</span><span class=\"si\">%s</span><span class=\"s\">\u00a0isn't an Instance, Ref, or Deref!\"</span>\u00a0<span class=\"o\">%</span>\u00a0inst<span class=\"p\">)</span></td></tr><tr><th id=\"L47\"><a href=\"#L47\">47</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>name <span class=\"o\">=</span>\u00a0name</td></tr><tr><th id=\"L48\"><a href=\"#L48\">48</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>klass <span class=\"o\">=</span>\u00a0klass</td></tr><tr><th id=\"L49\"><a href=\"#L49\">49</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>instance <span class=\"o\">=</span>\u00a0inst</td></tr><tr><th id=\"L50\"><a href=\"#L50\">50</a></th><td></td></tr><tr><th id=\"L51\"><a href=\"#L51\">51</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">getSource</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L52\"><a href=\"#L52\">52</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"InstanceMethod(</span><span class=\"si\">%r</span><span class=\"s\">, </span><span class=\"si\">%r</span><span class=\"s\">, </span><span class=\"se\">\\n\\0</span><span class=\"si\">%s</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>name<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>klass<span class=\"p\">,</span>\u00a0prettify<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>instance<span class=\"p\">))</span></td></tr><tr><th id=\"L53\"><a href=\"#L53\">53</a></th><td></td></tr><tr><th id=\"L54\"><a href=\"#L54\">54</a></th><td></td></tr><tr><th id=\"L55\"><a href=\"#L55\">55</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">_NoStateObj</span><span class=\"p\">:</span></td></tr><tr><th id=\"L56\"><a href=\"#L56\">56</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L57\"><a href=\"#L57\">57</a></th><td>NoStateObj <span class=\"o\">=</span>\u00a0_NoStateObj<span class=\"p\">()</span></td></tr><tr><th id=\"L58\"><a href=\"#L58\">58</a></th><td></td></tr><tr><th id=\"L59\"><a href=\"#L59\">59</a></th><td>_SIMPLE_BUILTINS <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span></td></tr><tr><th id=\"L60\"><a href=\"#L60\">60</a></th><td>\u00a0 \u00a0 types<span class=\"o\">.</span>StringType<span class=\"p\">,</span>\u00a0types<span class=\"o\">.</span>UnicodeType<span class=\"p\">,</span>\u00a0types<span class=\"o\">.</span>IntType<span class=\"p\">,</span>\u00a0types<span class=\"o\">.</span>FloatType<span class=\"p\">,</span></td></tr><tr><th id=\"L61\"><a href=\"#L61\">61</a></th><td>\u00a0 \u00a0 types<span class=\"o\">.</span>ComplexType<span class=\"p\">,</span>\u00a0types<span class=\"o\">.</span>LongType<span class=\"p\">,</span>\u00a0types<span class=\"o\">.</span>NoneType<span class=\"p\">,</span>\u00a0types<span class=\"o\">.</span>SliceType<span class=\"p\">,</span></td></tr><tr><th id=\"L62\"><a href=\"#L62\">62</a></th><td>\u00a0 \u00a0 types<span class=\"o\">.</span>EllipsisType<span class=\"p\">]</span></td></tr><tr><th id=\"L63\"><a href=\"#L63\">63</a></th><td></td></tr><tr><th id=\"L64\"><a href=\"#L64\">64</a></th><td><span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L65\"><a href=\"#L65\">65</a></th><td>\u00a0 \u00a0 _SIMPLE_BUILTINS<span class=\"o\">.</span>append<span class=\"p\">(</span>types<span class=\"o\">.</span>BooleanType<span class=\"p\">)</span></td></tr><tr><th id=\"L66\"><a href=\"#L66\">66</a></th><td><span class=\"k\">except</span>\u00a0<span class=\"ne\">AttributeError</span><span class=\"p\">:</span></td></tr><tr><th id=\"L67\"><a href=\"#L67\">67</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L68\"><a href=\"#L68\">68</a></th><td></td></tr><tr><th id=\"L69\"><a href=\"#L69\">69</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Instance</span><span class=\"p\">:</span></td></tr><tr><th id=\"L70\"><a href=\"#L70\">70</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0className<span class=\"p\">,</span>\u00a0__stateObj__<span class=\"o\">=</span>NoStateObj<span class=\"p\">,</span>\u00a0<span class=\"o\">**</span>state<span class=\"p\">):</span></td></tr><tr><th id=\"L71\"><a href=\"#L71\">71</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>className<span class=\"p\">,</span>\u00a0types<span class=\"o\">.</span>StringType<span class=\"p\">):</span></td></tr><tr><th id=\"L72\"><a href=\"#L72\">72</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s\">\"</span><span class=\"si\">%s</span><span class=\"s\">\u00a0isn't a string!\"</span>\u00a0<span class=\"o\">%</span>\u00a0className<span class=\"p\">)</span></td></tr><tr><th id=\"L73\"><a href=\"#L73\">73</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>klass <span class=\"o\">=</span>\u00a0className</td></tr><tr><th id=\"L74\"><a href=\"#L74\">74</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0__stateObj__ <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0NoStateObj<span class=\"p\">:</span></td></tr><tr><th id=\"L75\"><a href=\"#L75\">75</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">=</span>\u00a0__stateObj__</td></tr><tr><th id=\"L76\"><a href=\"#L76\">76</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>stateIsDict <span class=\"o\">=</span>\u00a0<span class=\"mi\">0</span></td></tr><tr><th id=\"L77\"><a href=\"#L77\">77</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L78\"><a href=\"#L78\">78</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">=</span>\u00a0state</td></tr><tr><th id=\"L79\"><a href=\"#L79\">79</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>stateIsDict <span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L80\"><a href=\"#L80\">80</a></th><td></td></tr><tr><th id=\"L81\"><a href=\"#L81\">81</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">getSource</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L82\"><a href=\"#L82\">82</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#XXX make state be foo=bar instead of a dict.</span></td></tr><tr><th id=\"L83\"><a href=\"#L83\">83</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>stateIsDict<span class=\"p\">:</span></td></tr><tr><th id=\"L84\"><a href=\"#L84\">84</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 stateDict <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>state</td></tr><tr><th id=\"L85\"><a href=\"#L85\">85</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>state<span class=\"p\">,</span>\u00a0Ref<span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>state<span class=\"o\">.</span>obj<span class=\"p\">,</span>\u00a0types<span class=\"o\">.</span>DictType<span class=\"p\">):</span></td></tr><tr><th id=\"L86\"><a href=\"#L86\">86</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 stateDict <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>state<span class=\"o\">.</span>obj</td></tr><tr><th id=\"L87\"><a href=\"#L87\">87</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L88\"><a href=\"#L88\">88</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 stateDict <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L89\"><a href=\"#L89\">89</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0stateDict <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L90\"><a href=\"#L90\">90</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L91\"><a href=\"#L91\">91</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"Instance(</span><span class=\"si\">%r</span><span class=\"s\">, </span><span class=\"si\">%s</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>klass<span class=\"p\">,</span>\u00a0dictToKW<span class=\"p\">(</span>stateDict<span class=\"p\">))</span></td></tr><tr><th id=\"L92\"><a href=\"#L92\">92</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0NonFormattableDict<span class=\"p\">:</span></td></tr><tr><th id=\"L93\"><a href=\"#L93\">93</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"Instance(</span><span class=\"si\">%r</span><span class=\"s\">, </span><span class=\"si\">%s</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>klass<span class=\"p\">,</span>\u00a0prettify<span class=\"p\">(</span>stateDict<span class=\"p\">))</span></td></tr><tr><th id=\"L94\"><a href=\"#L94\">94</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"Instance(</span><span class=\"si\">%r</span><span class=\"s\">, </span><span class=\"si\">%s</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>klass<span class=\"p\">,</span>\u00a0prettify<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>state<span class=\"p\">))</span></td></tr><tr><th id=\"L95\"><a href=\"#L95\">95</a></th><td></td></tr><tr><th id=\"L96\"><a href=\"#L96\">96</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Ref</span><span class=\"p\">:</span></td></tr><tr><th id=\"L97\"><a href=\"#L97\">97</a></th><td></td></tr><tr><th id=\"L98\"><a href=\"#L98\">98</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>args<span class=\"p\">):</span></td></tr><tr><th id=\"L99\"><a href=\"#L99\">99</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#blargh, lame.</span></td></tr><tr><th id=\"L100\"><a href=\"#L100\">100</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>args<span class=\"p\">)</span>\u00a0<span class=\"o\">==</span>\u00a0<span class=\"mi\">2</span><span class=\"p\">:</span></td></tr><tr><th id=\"L101\"><a href=\"#L101\">101</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>refnum <span class=\"o\">=</span>\u00a0args<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span></td></tr><tr><th id=\"L102\"><a href=\"#L102\">102</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>obj <span class=\"o\">=</span>\u00a0args<span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span></td></tr><tr><th id=\"L103\"><a href=\"#L103\">103</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"ow\">not</span>\u00a0args<span class=\"p\">:</span></td></tr><tr><th id=\"L104\"><a href=\"#L104\">104</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>refnum <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L105\"><a href=\"#L105\">105</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>obj <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L106\"><a href=\"#L106\">106</a></th><td></td></tr><tr><th id=\"L107\"><a href=\"#L107\">107</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">setRef</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0num<span class=\"p\">):</span></td></tr><tr><th id=\"L108\"><a href=\"#L108\">108</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>refnum<span class=\"p\">:</span></td></tr><tr><th id=\"L109\"><a href=\"#L109\">109</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s\">\"Error setting id </span><span class=\"si\">%s</span><span class=\"s\">, I already have </span><span class=\"si\">%s</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>num<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>refnum<span class=\"p\">))</span></td></tr><tr><th id=\"L110\"><a href=\"#L110\">110</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>refnum <span class=\"o\">=</span>\u00a0num</td></tr><tr><th id=\"L111\"><a href=\"#L111\">111</a></th><td></td></tr><tr><th id=\"L112\"><a href=\"#L112\">112</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">setObj</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0obj<span class=\"p\">):</span></td></tr><tr><th id=\"L113\"><a href=\"#L113\">113</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>obj<span class=\"p\">:</span></td></tr><tr><th id=\"L114\"><a href=\"#L114\">114</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s\">\"Error setting obj </span><span class=\"si\">%s</span><span class=\"s\">, I already have </span><span class=\"si\">%s</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>obj<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>obj<span class=\"p\">))</span></td></tr><tr><th id=\"L115\"><a href=\"#L115\">115</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>obj <span class=\"o\">=</span>\u00a0obj</td></tr><tr><th id=\"L116\"><a href=\"#L116\">116</a></th><td></td></tr><tr><th id=\"L117\"><a href=\"#L117\">117</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">getSource</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L118\"><a href=\"#L118\">118</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>obj <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L119\"><a href=\"#L119\">119</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">RuntimeError</span><span class=\"p\">(</span><span class=\"s\">\"Don't try to display me before setting an object on me!\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L120\"><a href=\"#L120\">120</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>refnum<span class=\"p\">:</span></td></tr><tr><th id=\"L121\"><a href=\"#L121\">121</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"Ref(</span><span class=\"si\">%d</span><span class=\"s\">, </span><span class=\"se\">\\n\\0</span><span class=\"si\">%s</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>refnum<span class=\"p\">,</span>\u00a0prettify<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>obj<span class=\"p\">))</span></td></tr><tr><th id=\"L122\"><a href=\"#L122\">122</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0prettify<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>obj<span class=\"p\">)</span></td></tr><tr><th id=\"L123\"><a href=\"#L123\">123</a></th><td>\u00a0</td></tr><tr><th id=\"L124\"><a href=\"#L124\">124</a></th><td></td></tr><tr><th id=\"L125\"><a href=\"#L125\">125</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Deref</span><span class=\"p\">:</span></td></tr><tr><th id=\"L126\"><a href=\"#L126\">126</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0num<span class=\"p\">):</span></td></tr><tr><th id=\"L127\"><a href=\"#L127\">127</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>refnum <span class=\"o\">=</span>\u00a0num</td></tr><tr><th id=\"L128\"><a href=\"#L128\">128</a></th><td></td></tr><tr><th id=\"L129\"><a href=\"#L129\">129</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">getSource</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L130\"><a href=\"#L130\">130</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"Deref(</span><span class=\"si\">%d</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>refnum</td></tr><tr><th id=\"L131\"><a href=\"#L131\">131</a></th><td></td></tr><tr><th id=\"L132\"><a href=\"#L132\">132</a></th><td>\u00a0 \u00a0 __repr__ <span class=\"o\">=</span>\u00a0getSource</td></tr><tr><th id=\"L133\"><a href=\"#L133\">133</a></th><td></td></tr><tr><th id=\"L134\"><a href=\"#L134\">134</a></th><td></td></tr><tr><th id=\"L135\"><a href=\"#L135\">135</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Copyreg</span><span class=\"p\">:</span></td></tr><tr><th id=\"L136\"><a href=\"#L136\">136</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0loadfunc<span class=\"p\">,</span>\u00a0state<span class=\"p\">):</span></td></tr><tr><th id=\"L137\"><a href=\"#L137\">137</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>loadfunc <span class=\"o\">=</span>\u00a0loadfunc</td></tr><tr><th id=\"L138\"><a href=\"#L138\">138</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">=</span>\u00a0state</td></tr><tr><th id=\"L139\"><a href=\"#L139\">139</a></th><td></td></tr><tr><th id=\"L140\"><a href=\"#L140\">140</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">getSource</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L141\"><a href=\"#L141\">141</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">\"Copyreg(</span><span class=\"si\">%r</span><span class=\"s\">, </span><span class=\"si\">%s</span><span class=\"s\">)\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>loadfunc<span class=\"p\">,</span>\u00a0prettify<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>state<span class=\"p\">))</span></td></tr><tr><th id=\"L142\"><a href=\"#L142\">142</a></th><td></td></tr><tr><th id=\"L143\"><a href=\"#L143\">143</a></th><td></td></tr><tr><th id=\"L144\"><a href=\"#L144\">144</a></th><td></td></tr><tr><th id=\"L145\"><a href=\"#L145\">145</a></th><td><span class=\"c\">###############</span></td></tr><tr><th id=\"L146\"><a href=\"#L146\">146</a></th><td><span class=\"c\"># Marshalling #</span></td></tr><tr><th id=\"L147\"><a href=\"#L147\">147</a></th><td><span class=\"c\">###############</span></td></tr><tr><th id=\"L148\"><a href=\"#L148\">148</a></th><td></td></tr><tr><th id=\"L149\"><a href=\"#L149\">149</a></th><td></td></tr><tr><th id=\"L150\"><a href=\"#L150\">150</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">getSource</span><span class=\"p\">(</span>ao<span class=\"p\">):</span></td></tr><tr><th id=\"L151\"><a href=\"#L151\">151</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Pass me an AO, I'll return a nicely-formatted source representation.\"\"\"</span></td></tr><tr><th id=\"L152\"><a href=\"#L152\">152</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0indentify<span class=\"p\">(</span><span class=\"s\">\"app = \"</span>\u00a0<span class=\"o\">+</span>\u00a0prettify<span class=\"p\">(</span>ao<span class=\"p\">))</span></td></tr><tr><th id=\"L153\"><a href=\"#L153\">153</a></th><td></td></tr><tr><th id=\"L154\"><a href=\"#L154\">154</a></th><td></td></tr><tr><th id=\"L155\"><a href=\"#L155\">155</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">NonFormattableDict</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L156\"><a href=\"#L156\">156</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"A dictionary was not formattable.</span></td></tr><tr><th id=\"L157\"><a href=\"#L157\">157</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L158\"><a href=\"#L158\">158</a></th><td></td></tr><tr><th id=\"L159\"><a href=\"#L159\">159</a></th><td>r <span class=\"o\">=</span>\u00a0re<span class=\"o\">.</span>compile<span class=\"p\">(</span><span class=\"s\">'[a-zA-Z_][a-zA-Z0-9_]*$'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L160\"><a href=\"#L160\">160</a></th><td></td></tr><tr><th id=\"L161\"><a href=\"#L161\">161</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">dictToKW</span><span class=\"p\">(</span>d<span class=\"p\">):</span></td></tr><tr><th id=\"L162\"><a href=\"#L162\">162</a></th><td>\u00a0 \u00a0 out <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L163\"><a href=\"#L163\">163</a></th><td>\u00a0 \u00a0 items <span class=\"o\">=</span>\u00a0d<span class=\"o\">.</span>items<span class=\"p\">()</span></td></tr><tr><th id=\"L164\"><a href=\"#L164\">164</a></th><td>\u00a0 \u00a0 items<span class=\"o\">.</span>sort<span class=\"p\">()</span></td></tr><tr><th id=\"L165\"><a href=\"#L165\">165</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0k<span class=\"p\">,</span>v <span class=\"ow\">in</span>\u00a0items<span class=\"p\">:</span></td></tr><tr><th id=\"L166\"><a href=\"#L166\">166</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>k<span class=\"p\">,</span>\u00a0types<span class=\"o\">.</span>StringType<span class=\"p\">):</span></td></tr><tr><th id=\"L167\"><a href=\"#L167\">167</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0NonFormattableDict<span class=\"p\">(</span><span class=\"s\">\"</span><span class=\"si\">%r</span><span class=\"s\">\u00a0ain't a string\"</span>\u00a0<span class=\"o\">%</span>\u00a0k<span class=\"p\">)</span></td></tr><tr><th id=\"L168\"><a href=\"#L168\">168</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0r<span class=\"o\">.</span>match<span class=\"p\">(</span>k<span class=\"p\">):</span></td></tr><tr><th id=\"L169\"><a href=\"#L169\">169</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0NonFormattableDict<span class=\"p\">(</span><span class=\"s\">\"</span><span class=\"si\">%r</span><span class=\"s\">\u00a0ain't an identifier\"</span>\u00a0<span class=\"o\">%</span>\u00a0k<span class=\"p\">)</span></td></tr><tr><th id=\"L170\"><a href=\"#L170\">170</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 out<span class=\"o\">.</span>append<span class=\"p\">(</span></td></tr><tr><th id=\"L171\"><a href=\"#L171\">171</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"</span><span class=\"se\">\\n\\0</span><span class=\"si\">%s</span><span class=\"s\">=</span><span class=\"si\">%s</span><span class=\"s\">,\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>k<span class=\"p\">,</span>\u00a0prettify<span class=\"p\">(</span>v<span class=\"p\">))</span></td></tr><tr><th id=\"L172\"><a href=\"#L172\">172</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">)</span></td></tr><tr><th id=\"L173\"><a href=\"#L173\">173</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0string<span class=\"o\">.</span>join<span class=\"p\">(</span>out<span class=\"p\">,</span>\u00a0<span class=\"s\">''</span><span class=\"p\">)</span></td></tr><tr><th id=\"L174\"><a href=\"#L174\">174</a></th><td></td></tr><tr><th id=\"L175\"><a href=\"#L175\">175</a></th><td></td></tr><tr><th id=\"L176\"><a href=\"#L176\">176</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">prettify</span><span class=\"p\">(</span>obj<span class=\"p\">):</span></td></tr><tr><th id=\"L177\"><a href=\"#L177\">177</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>obj<span class=\"p\">,</span>\u00a0<span class=\"s\">'getSource'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L178\"><a href=\"#L178\">178</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0obj<span class=\"o\">.</span>getSource<span class=\"p\">()</span></td></tr><tr><th id=\"L179\"><a href=\"#L179\">179</a></th><td>\u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L180\"><a href=\"#L180\">180</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#basic type</span></td></tr><tr><th id=\"L181\"><a href=\"#L181\">181</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 t <span class=\"o\">=</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">(</span>obj<span class=\"p\">)</span></td></tr><tr><th id=\"L182\"><a href=\"#L182\">182</a></th><td></td></tr><tr><th id=\"L183\"><a href=\"#L183\">183</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0t <span class=\"ow\">in</span>\u00a0_SIMPLE_BUILTINS<span class=\"p\">:</span></td></tr><tr><th id=\"L184\"><a href=\"#L184\">184</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">repr</span><span class=\"p\">(</span>obj<span class=\"p\">)</span></td></tr><tr><th id=\"L185\"><a href=\"#L185\">185</a></th><td></td></tr><tr><th id=\"L186\"><a href=\"#L186\">186</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>DictType<span class=\"p\">:</span></td></tr><tr><th id=\"L187\"><a href=\"#L187\">187</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"s\">'{'</span><span class=\"p\">]</span></td></tr><tr><th id=\"L188\"><a href=\"#L188\">188</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0k<span class=\"p\">,</span>v <span class=\"ow\">in</span>\u00a0obj<span class=\"o\">.</span>items<span class=\"p\">():</span></td></tr><tr><th id=\"L189\"><a href=\"#L189\">189</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"s\">'</span><span class=\"se\">\\n\\0</span><span class=\"si\">%s</span><span class=\"s\">: </span><span class=\"si\">%s</span><span class=\"s\">,'</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>prettify<span class=\"p\">(</span>k<span class=\"p\">),</span>\u00a0prettify<span class=\"p\">(</span>v<span class=\"p\">)))</span></td></tr><tr><th id=\"L190\"><a href=\"#L190\">190</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"nb\">len</span><span class=\"p\">(</span>obj<span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"s\">'</span><span class=\"se\">\\n\\0</span><span class=\"s\">}'</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"s\">'}'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L191\"><a href=\"#L191\">191</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0string<span class=\"o\">.</span>join<span class=\"p\">(</span>out<span class=\"p\">,</span>\u00a0<span class=\"s\">''</span><span class=\"p\">)</span></td></tr><tr><th id=\"L192\"><a href=\"#L192\">192</a></th><td></td></tr><tr><th id=\"L193\"><a href=\"#L193\">193</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>ListType<span class=\"p\">:</span></td></tr><tr><th id=\"L194\"><a href=\"#L194\">194</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"s\">\"[\"</span><span class=\"p\">]</span></td></tr><tr><th id=\"L195\"><a href=\"#L195\">195</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0x <span class=\"ow\">in</span>\u00a0obj<span class=\"p\">:</span></td></tr><tr><th id=\"L196\"><a href=\"#L196\">196</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"s\">'</span><span class=\"se\">\\n\\0</span><span class=\"si\">%s</span><span class=\"s\">,'</span>\u00a0<span class=\"o\">%</span>\u00a0prettify<span class=\"p\">(</span>x<span class=\"p\">))</span></td></tr><tr><th id=\"L197\"><a href=\"#L197\">197</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"nb\">len</span><span class=\"p\">(</span>obj<span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"s\">'</span><span class=\"se\">\\n\\0</span><span class=\"s\">]'</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"s\">']'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L198\"><a href=\"#L198\">198</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0string<span class=\"o\">.</span>join<span class=\"p\">(</span>out<span class=\"p\">,</span>\u00a0<span class=\"s\">''</span><span class=\"p\">)</span></td></tr><tr><th id=\"L199\"><a href=\"#L199\">199</a></th><td></td></tr><tr><th id=\"L200\"><a href=\"#L200\">200</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>TupleType<span class=\"p\">:</span></td></tr><tr><th id=\"L201\"><a href=\"#L201\">201</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"s\">\"(\"</span><span class=\"p\">]</span></td></tr><tr><th id=\"L202\"><a href=\"#L202\">202</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0x <span class=\"ow\">in</span>\u00a0obj<span class=\"p\">:</span></td></tr><tr><th id=\"L203\"><a href=\"#L203\">203</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"s\">'</span><span class=\"se\">\\n\\0</span><span class=\"si\">%s</span><span class=\"s\">,'</span>\u00a0<span class=\"o\">%</span>\u00a0prettify<span class=\"p\">(</span>x<span class=\"p\">))</span></td></tr><tr><th id=\"L204\"><a href=\"#L204\">204</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"nb\">len</span><span class=\"p\">(</span>obj<span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"s\">'</span><span class=\"se\">\\n\\0</span><span class=\"s\">)'</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"s\">')'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L205\"><a href=\"#L205\">205</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0string<span class=\"o\">.</span>join<span class=\"p\">(</span>out<span class=\"p\">,</span>\u00a0<span class=\"s\">''</span><span class=\"p\">)</span></td></tr><tr><th id=\"L206\"><a href=\"#L206\">206</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L207\"><a href=\"#L207\">207</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s\">\"Unsupported type </span><span class=\"si\">%s</span><span class=\"s\">\u00a0when trying to prettify </span><span class=\"si\">%s</span><span class=\"s\">.\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>t<span class=\"p\">,</span>\u00a0obj<span class=\"p\">))</span></td></tr><tr><th id=\"L208\"><a href=\"#L208\">208</a></th><td></td></tr><tr><th id=\"L209\"><a href=\"#L209\">209</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">indentify</span><span class=\"p\">(</span>s<span class=\"p\">):</span></td></tr><tr><th id=\"L210\"><a href=\"#L210\">210</a></th><td>\u00a0 \u00a0 out <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L211\"><a href=\"#L211\">211</a></th><td>\u00a0 \u00a0 stack <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L212\"><a href=\"#L212\">212</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">eater</span><span class=\"p\">(</span><span class=\"nb\">type</span><span class=\"p\">,</span>\u00a0val<span class=\"p\">,</span>\u00a0r<span class=\"p\">,</span>\u00a0c<span class=\"p\">,</span>\u00a0l<span class=\"p\">,</span>\u00a0out<span class=\"o\">=</span>out<span class=\"p\">,</span>\u00a0stack<span class=\"o\">=</span>stack<span class=\"p\">):</span></td></tr><tr><th id=\"L213\"><a href=\"#L213\">213</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#import sys</span></td></tr><tr><th id=\"L214\"><a href=\"#L214\">214</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#sys.stdout.write(val)</span></td></tr><tr><th id=\"L215\"><a href=\"#L215\">215</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0val <span class=\"ow\">in</span>\u00a0<span class=\"p\">[</span><span class=\"s\">'['</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'('</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'{'</span><span class=\"p\">]:</span></td></tr><tr><th id=\"L216\"><a href=\"#L216\">216</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 stack<span class=\"o\">.</span>append<span class=\"p\">(</span>val<span class=\"p\">)</span></td></tr><tr><th id=\"L217\"><a href=\"#L217\">217</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0val <span class=\"ow\">in</span>\u00a0<span class=\"p\">[</span><span class=\"s\">']'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">')'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'}'</span><span class=\"p\">]:</span></td></tr><tr><th id=\"L218\"><a href=\"#L218\">218</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 stack<span class=\"o\">.</span>pop<span class=\"p\">()</span></td></tr><tr><th id=\"L219\"><a href=\"#L219\">219</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0val <span class=\"o\">==</span>\u00a0<span class=\"s\">'</span><span class=\"se\">\\0</span><span class=\"s\">'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L220\"><a href=\"#L220\">220</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"s\">'\u00a0 '</span><span class=\"o\">*</span><span class=\"nb\">len</span><span class=\"p\">(</span>stack<span class=\"p\">))</span></td></tr><tr><th id=\"L221\"><a href=\"#L221\">221</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L222\"><a href=\"#L222\">222</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 out<span class=\"o\">.</span>append<span class=\"p\">(</span>val<span class=\"p\">)</span></td></tr><tr><th id=\"L223\"><a href=\"#L223\">223</a></th><td>\u00a0 \u00a0 l <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"s\">''</span><span class=\"p\">,</span>\u00a0s<span class=\"p\">]</span></td></tr><tr><th id=\"L224\"><a href=\"#L224\">224</a></th><td>\u00a0 \u00a0 tokenize<span class=\"o\">.</span>tokenize<span class=\"p\">(</span>l<span class=\"o\">.</span>pop<span class=\"p\">,</span>\u00a0eater<span class=\"p\">)</span></td></tr><tr><th id=\"L225\"><a href=\"#L225\">225</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0string<span class=\"o\">.</span>join<span class=\"p\">(</span>out<span class=\"p\">,</span>\u00a0<span class=\"s\">''</span><span class=\"p\">)</span></td></tr><tr><th id=\"L226\"><a href=\"#L226\">226</a></th><td></td></tr><tr><th id=\"L227\"><a href=\"#L227\">227</a></th><td></td></tr><tr><th id=\"L228\"><a href=\"#L228\">228</a></th><td></td></tr><tr><th id=\"L229\"><a href=\"#L229\">229</a></th><td></td></tr><tr><th id=\"L230\"><a href=\"#L230\">230</a></th><td></td></tr><tr><th id=\"L231\"><a href=\"#L231\">231</a></th><td><span class=\"c\">###########</span></td></tr><tr><th id=\"L232\"><a href=\"#L232\">232</a></th><td><span class=\"c\"># Unjelly #</span></td></tr><tr><th id=\"L233\"><a href=\"#L233\">233</a></th><td><span class=\"c\">###########</span></td></tr><tr><th id=\"L234\"><a href=\"#L234\">234</a></th><td></td></tr><tr><th id=\"L235\"><a href=\"#L235\">235</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">unjellyFromAOT</span><span class=\"p\">(</span>aot<span class=\"p\">):</span></td></tr><tr><th id=\"L236\"><a href=\"#L236\">236</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L237\"><a href=\"#L237\">237</a></th><td><span class=\"sd\">\u00a0 \u00a0 Pass me an Abstract Object Tree, and I'll unjelly it for you.</span></td></tr><tr><th id=\"L238\"><a href=\"#L238\">238</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L239\"><a href=\"#L239\">239</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0AOTUnjellier<span class=\"p\">()</span><span class=\"o\">.</span>unjelly<span class=\"p\">(</span>aot<span class=\"p\">)</span></td></tr><tr><th id=\"L240\"><a href=\"#L240\">240</a></th><td></td></tr><tr><th id=\"L241\"><a href=\"#L241\">241</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">unjellyFromSource</span><span class=\"p\">(</span>stringOrFile<span class=\"p\">):</span></td></tr><tr><th id=\"L242\"><a href=\"#L242\">242</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L243\"><a href=\"#L243\">243</a></th><td><span class=\"sd\">\u00a0 \u00a0 Pass me a string of code or a filename that defines an 'app' variable (in</span></td></tr><tr><th id=\"L244\"><a href=\"#L244\">244</a></th><td><span class=\"sd\">\u00a0 \u00a0 terms of Abstract Objects!), and I'll execute it and unjelly the resulting</span></td></tr><tr><th id=\"L245\"><a href=\"#L245\">245</a></th><td><span class=\"sd\">\u00a0 \u00a0 AOT for you, returning a newly unpersisted Application object!</span></td></tr><tr><th id=\"L246\"><a href=\"#L246\">246</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L247\"><a href=\"#L247\">247</a></th><td></td></tr><tr><th id=\"L248\"><a href=\"#L248\">248</a></th><td>\u00a0 \u00a0 ns <span class=\"o\">=</span>\u00a0<span class=\"p\">{</span><span class=\"s\">\"Instance\"</span><span class=\"p\">:</span>\u00a0Instance<span class=\"p\">,</span></td></tr><tr><th id=\"L249\"><a href=\"#L249\">249</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"InstanceMethod\"</span><span class=\"p\">:</span>\u00a0InstanceMethod<span class=\"p\">,</span></td></tr><tr><th id=\"L250\"><a href=\"#L250\">250</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"Class\"</span><span class=\"p\">:</span>\u00a0Class<span class=\"p\">,</span></td></tr><tr><th id=\"L251\"><a href=\"#L251\">251</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"Function\"</span><span class=\"p\">:</span>\u00a0Function<span class=\"p\">,</span></td></tr><tr><th id=\"L252\"><a href=\"#L252\">252</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"Module\"</span><span class=\"p\">:</span>\u00a0Module<span class=\"p\">,</span></td></tr><tr><th id=\"L253\"><a href=\"#L253\">253</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"Ref\"</span><span class=\"p\">:</span>\u00a0Ref<span class=\"p\">,</span></td></tr><tr><th id=\"L254\"><a href=\"#L254\">254</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"Deref\"</span><span class=\"p\">:</span>\u00a0Deref<span class=\"p\">,</span></td></tr><tr><th id=\"L255\"><a href=\"#L255\">255</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"Copyreg\"</span><span class=\"p\">:</span>\u00a0Copyreg<span class=\"p\">,</span></td></tr><tr><th id=\"L256\"><a href=\"#L256\">256</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">}</span></td></tr><tr><th id=\"L257\"><a href=\"#L257\">257</a></th><td></td></tr><tr><th id=\"L258\"><a href=\"#L258\">258</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>stringOrFile<span class=\"p\">,</span>\u00a0<span class=\"s\">\"read\"</span><span class=\"p\">):</span></td></tr><tr><th id=\"L259\"><a href=\"#L259\">259</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">exec</span>\u00a0stringOrFile<span class=\"o\">.</span>read<span class=\"p\">()</span>\u00a0<span class=\"ow\">in</span>\u00a0ns</td></tr><tr><th id=\"L260\"><a href=\"#L260\">260</a></th><td>\u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L261\"><a href=\"#L261\">261</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">exec</span>\u00a0stringOrFile <span class=\"ow\">in</span>\u00a0ns</td></tr><tr><th id=\"L262\"><a href=\"#L262\">262</a></th><td></td></tr><tr><th id=\"L263\"><a href=\"#L263\">263</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0ns<span class=\"o\">.</span>has_key<span class=\"p\">(</span><span class=\"s\">'app'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L264\"><a href=\"#L264\">264</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0unjellyFromAOT<span class=\"p\">(</span>ns<span class=\"p\">[</span><span class=\"s\">'app'</span><span class=\"p\">])</span></td></tr><tr><th id=\"L265\"><a href=\"#L265\">265</a></th><td>\u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L266\"><a href=\"#L266\">266</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s\">\"</span><span class=\"si\">%s</span><span class=\"s\">\u00a0needs to define an 'app', it didn't!\"</span>\u00a0<span class=\"o\">%</span>\u00a0stringOrFile<span class=\"p\">)</span></td></tr><tr><th id=\"L267\"><a href=\"#L267\">267</a></th><td></td></tr><tr><th id=\"L268\"><a href=\"#L268\">268</a></th><td></td></tr><tr><th id=\"L269\"><a href=\"#L269\">269</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">AOTUnjellier</span><span class=\"p\">:</span></td></tr><tr><th id=\"L270\"><a href=\"#L270\">270</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"I handle the unjellying of an Abstract Object Tree.</span></td></tr><tr><th id=\"L271\"><a href=\"#L271\">271</a></th><td><span class=\"sd\">\u00a0 \u00a0 See AOTUnjellier.unjellyAO</span></td></tr><tr><th id=\"L272\"><a href=\"#L272\">272</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L273\"><a href=\"#L273\">273</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L274\"><a href=\"#L274\">274</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>references <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L275\"><a href=\"#L275\">275</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>stack <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L276\"><a href=\"#L276\">276</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>afterUnjelly <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L277\"><a href=\"#L277\">277</a></th><td></td></tr><tr><th id=\"L278\"><a href=\"#L278\">278</a></th><td>\u00a0 \u00a0 <span class=\"c\">##</span></td></tr><tr><th id=\"L279\"><a href=\"#L279\">279</a></th><td>\u00a0 \u00a0 <span class=\"c\"># unjelly helpers (copied pretty much directly from marmalade XXX refactor)</span></td></tr><tr><th id=\"L280\"><a href=\"#L280\">280</a></th><td>\u00a0 \u00a0 <span class=\"c\">##</span></td></tr><tr><th id=\"L281\"><a href=\"#L281\">281</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">unjellyLater</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0node<span class=\"p\">):</span></td></tr><tr><th id=\"L282\"><a href=\"#L282\">282</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Unjelly a node, later.</span></td></tr><tr><th id=\"L283\"><a href=\"#L283\">283</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L284\"><a href=\"#L284\">284</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0crefutil<span class=\"o\">.</span>_Defer<span class=\"p\">()</span></td></tr><tr><th id=\"L285\"><a href=\"#L285\">285</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>unjellyInto<span class=\"p\">(</span>d<span class=\"p\">,</span>\u00a0<span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0node<span class=\"p\">)</span></td></tr><tr><th id=\"L286\"><a href=\"#L286\">286</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L287\"><a href=\"#L287\">287</a></th><td></td></tr><tr><th id=\"L288\"><a href=\"#L288\">288</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">unjellyInto</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0obj<span class=\"p\">,</span>\u00a0loc<span class=\"p\">,</span>\u00a0ao<span class=\"p\">):</span></td></tr><tr><th id=\"L289\"><a href=\"#L289\">289</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Utility method for unjellying one object into another.</span></td></tr><tr><th id=\"L290\"><a href=\"#L290\">290</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 This automates the handling of backreferences.</span></td></tr><tr><th id=\"L291\"><a href=\"#L291\">291</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L292\"><a href=\"#L292\">292</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 o <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>unjellyAO<span class=\"p\">(</span>ao<span class=\"p\">)</span></td></tr><tr><th id=\"L293\"><a href=\"#L293\">293</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 obj<span class=\"p\">[</span>loc<span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0o</td></tr><tr><th id=\"L294\"><a href=\"#L294\">294</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>o<span class=\"p\">,</span>\u00a0crefutil<span class=\"o\">.</span>NotKnown<span class=\"p\">):</span></td></tr><tr><th id=\"L295\"><a href=\"#L295\">295</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 o<span class=\"o\">.</span>addDependant<span class=\"p\">(</span>obj<span class=\"p\">,</span>\u00a0loc<span class=\"p\">)</span></td></tr><tr><th id=\"L296\"><a href=\"#L296\">296</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0o</td></tr><tr><th id=\"L297\"><a href=\"#L297\">297</a></th><td></td></tr><tr><th id=\"L298\"><a href=\"#L298\">298</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">callAfter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"nb\">callable</span><span class=\"p\">,</span>\u00a0result<span class=\"p\">):</span></td></tr><tr><th id=\"L299\"><a href=\"#L299\">299</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>result<span class=\"p\">,</span>\u00a0crefutil<span class=\"o\">.</span>NotKnown<span class=\"p\">):</span></td></tr><tr><th id=\"L300\"><a href=\"#L300\">300</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 l <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"bp\">None</span><span class=\"p\">]</span></td></tr><tr><th id=\"L301\"><a href=\"#L301\">301</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result<span class=\"o\">.</span>addDependant<span class=\"p\">(</span>l<span class=\"p\">,</span>\u00a0<span class=\"mi\">1</span><span class=\"p\">)</span></td></tr><tr><th id=\"L302\"><a href=\"#L302\">302</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L303\"><a href=\"#L303\">303</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 l <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span>result<span class=\"p\">]</span></td></tr><tr><th id=\"L304\"><a href=\"#L304\">304</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>afterUnjelly<span class=\"o\">.</span>append<span class=\"p\">((</span><span class=\"nb\">callable</span><span class=\"p\">,</span>\u00a0l<span class=\"p\">))</span></td></tr><tr><th id=\"L305\"><a href=\"#L305\">305</a></th><td></td></tr><tr><th id=\"L306\"><a href=\"#L306\">306</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">unjellyAttribute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0instance<span class=\"p\">,</span>\u00a0attrName<span class=\"p\">,</span>\u00a0ao<span class=\"p\">):</span></td></tr><tr><th id=\"L307\"><a href=\"#L307\">307</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#XXX this is unused????</span></td></tr><tr><th id=\"L308\"><a href=\"#L308\">308</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Utility method for unjellying into instances of attributes.</span></td></tr><tr><th id=\"L309\"><a href=\"#L309\">309</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 </span></td></tr><tr><th id=\"L310\"><a href=\"#L310\">310</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Use this rather than unjellyAO unless you like surprising bugs!</span></td></tr><tr><th id=\"L311\"><a href=\"#L311\">311</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Alternatively, you can use unjellyInto on your instance's __dict__.</span></td></tr><tr><th id=\"L312\"><a href=\"#L312\">312</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L313\"><a href=\"#L313\">313</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>unjellyInto<span class=\"p\">(</span>instance<span class=\"o\">.</span>__dict__<span class=\"p\">,</span>\u00a0attrName<span class=\"p\">,</span>\u00a0ao<span class=\"p\">)</span></td></tr><tr><th id=\"L314\"><a href=\"#L314\">314</a></th><td></td></tr><tr><th id=\"L315\"><a href=\"#L315\">315</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">unjellyAO</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0ao<span class=\"p\">):</span></td></tr><tr><th id=\"L316\"><a href=\"#L316\">316</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Unjelly an Abstract Object and everything it contains.</span></td></tr><tr><th id=\"L317\"><a href=\"#L317\">317</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 I return the real object.</span></td></tr><tr><th id=\"L318\"><a href=\"#L318\">318</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L319\"><a href=\"#L319\">319</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>stack<span class=\"o\">.</span>append<span class=\"p\">(</span>ao<span class=\"p\">)</span></td></tr><tr><th id=\"L320\"><a href=\"#L320\">320</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 t <span class=\"o\">=</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">(</span>ao<span class=\"p\">)</span></td></tr><tr><th id=\"L321\"><a href=\"#L321\">321</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0t <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>InstanceType<span class=\"p\">:</span></td></tr><tr><th id=\"L322\"><a href=\"#L322\">322</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#Abstract Objects</span></td></tr><tr><th id=\"L323\"><a href=\"#L323\">323</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 c <span class=\"o\">=</span>\u00a0ao<span class=\"o\">.</span>__class__</td></tr><tr><th id=\"L324\"><a href=\"#L324\">324</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0c <span class=\"ow\">is</span>\u00a0Module<span class=\"p\">:</span></td></tr><tr><th id=\"L325\"><a href=\"#L325\">325</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0reflect<span class=\"o\">.</span>namedModule<span class=\"p\">(</span>ao<span class=\"o\">.</span>name<span class=\"p\">)</span></td></tr><tr><th id=\"L326\"><a href=\"#L326\">326</a></th><td></td></tr><tr><th id=\"L327\"><a href=\"#L327\">327</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0c <span class=\"ow\">in</span>\u00a0<span class=\"p\">[</span>Class<span class=\"p\">,</span>\u00a0Function<span class=\"p\">]</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"nb\">issubclass</span><span class=\"p\">(</span>c<span class=\"p\">,</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">):</span></td></tr><tr><th id=\"L328\"><a href=\"#L328\">328</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0reflect<span class=\"o\">.</span>namedObject<span class=\"p\">(</span>ao<span class=\"o\">.</span>name<span class=\"p\">)</span></td></tr><tr><th id=\"L329\"><a href=\"#L329\">329</a></th><td></td></tr><tr><th id=\"L330\"><a href=\"#L330\">330</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0c <span class=\"ow\">is</span>\u00a0InstanceMethod<span class=\"p\">:</span></td></tr><tr><th id=\"L331\"><a href=\"#L331\">331</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 im_name <span class=\"o\">=</span>\u00a0ao<span class=\"o\">.</span>name</td></tr><tr><th id=\"L332\"><a href=\"#L332\">332</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 im_class <span class=\"o\">=</span>\u00a0reflect<span class=\"o\">.</span>namedObject<span class=\"p\">(</span>ao<span class=\"o\">.</span>klass<span class=\"p\">)</span></td></tr><tr><th id=\"L333\"><a href=\"#L333\">333</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 im_self <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>unjellyAO<span class=\"p\">(</span>ao<span class=\"o\">.</span>instance<span class=\"p\">)</span></td></tr><tr><th id=\"L334\"><a href=\"#L334\">334</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0im_class<span class=\"o\">.</span>__dict__<span class=\"o\">.</span>has_key<span class=\"p\">(</span>im_name<span class=\"p\">):</span></td></tr><tr><th id=\"L335\"><a href=\"#L335\">335</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0im_self <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L336\"><a href=\"#L336\">336</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>im_class<span class=\"p\">,</span>\u00a0im_name<span class=\"p\">)</span></td></tr><tr><th id=\"L337\"><a href=\"#L337\">337</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>im_self<span class=\"p\">,</span>\u00a0crefutil<span class=\"o\">.</span>NotKnown<span class=\"p\">):</span></td></tr><tr><th id=\"L338\"><a href=\"#L338\">338</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0crefutil<span class=\"o\">.</span>_InstanceMethod<span class=\"p\">(</span>im_name<span class=\"p\">,</span>\u00a0im_self<span class=\"p\">,</span>\u00a0im_class<span class=\"p\">)</span></td></tr><tr><th id=\"L339\"><a href=\"#L339\">339</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L340\"><a href=\"#L340\">340</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0new<span class=\"o\">.</span>instancemethod<span class=\"p\">(</span>im_class<span class=\"o\">.</span>__dict__<span class=\"p\">[</span>im_name<span class=\"p\">],</span></td></tr><tr><th id=\"L341\"><a href=\"#L341\">341</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 im_self<span class=\"p\">,</span></td></tr><tr><th id=\"L342\"><a href=\"#L342\">342</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 im_class<span class=\"p\">)</span></td></tr><tr><th id=\"L343\"><a href=\"#L343\">343</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L344\"><a href=\"#L344\">344</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"s\">\"instance method changed\"</span></td></tr><tr><th id=\"L345\"><a href=\"#L345\">345</a></th><td></td></tr><tr><th id=\"L346\"><a href=\"#L346\">346</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0c <span class=\"ow\">is</span>\u00a0Instance<span class=\"p\">:</span></td></tr><tr><th id=\"L347\"><a href=\"#L347\">347</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 klass <span class=\"o\">=</span>\u00a0reflect<span class=\"o\">.</span>namedObject<span class=\"p\">(</span>ao<span class=\"o\">.</span>klass<span class=\"p\">)</span></td></tr><tr><th id=\"L348\"><a href=\"#L348\">348</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 state <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>unjellyAO<span class=\"p\">(</span>ao<span class=\"o\">.</span>state<span class=\"p\">)</span></td></tr><tr><th id=\"L349\"><a href=\"#L349\">349</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>klass<span class=\"p\">,</span>\u00a0<span class=\"s\">\"__setstate__\"</span><span class=\"p\">):</span></td></tr><tr><th id=\"L350\"><a href=\"#L350\">350</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 inst <span class=\"o\">=</span>\u00a0new<span class=\"o\">.</span>instance<span class=\"p\">(</span>klass<span class=\"p\">,</span>\u00a0<span class=\"p\">{})</span></td></tr><tr><th id=\"L351\"><a href=\"#L351\">351</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>callAfter<span class=\"p\">(</span>inst<span class=\"o\">.</span>__setstate__<span class=\"p\">,</span>\u00a0state<span class=\"p\">)</span></td></tr><tr><th id=\"L352\"><a href=\"#L352\">352</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L353\"><a href=\"#L353\">353</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 inst <span class=\"o\">=</span>\u00a0new<span class=\"o\">.</span>instance<span class=\"p\">(</span>klass<span class=\"p\">,</span>\u00a0state<span class=\"p\">)</span></td></tr><tr><th id=\"L354\"><a href=\"#L354\">354</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0inst</td></tr><tr><th id=\"L355\"><a href=\"#L355\">355</a></th><td></td></tr><tr><th id=\"L356\"><a href=\"#L356\">356</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0c <span class=\"ow\">is</span>\u00a0Ref<span class=\"p\">:</span></td></tr><tr><th id=\"L357\"><a href=\"#L357\">357</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 o <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>unjellyAO<span class=\"p\">(</span>ao<span class=\"o\">.</span>obj<span class=\"p\">)</span>\u00a0<span class=\"c\">#THIS IS CHANGING THE REF OMG</span></td></tr><tr><th id=\"L358\"><a href=\"#L358\">358</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 refkey <span class=\"o\">=</span>\u00a0ao<span class=\"o\">.</span>refnum</td></tr><tr><th id=\"L359\"><a href=\"#L359\">359</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ref <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>references<span class=\"o\">.</span>get<span class=\"p\">(</span>refkey<span class=\"p\">)</span></td></tr><tr><th id=\"L360\"><a href=\"#L360\">360</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0ref <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L361\"><a href=\"#L361\">361</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>references<span class=\"p\">[</span>refkey<span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0o</td></tr><tr><th id=\"L362\"><a href=\"#L362\">362</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>ref<span class=\"p\">,</span>\u00a0crefutil<span class=\"o\">.</span>NotKnown<span class=\"p\">):</span></td></tr><tr><th id=\"L363\"><a href=\"#L363\">363</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ref<span class=\"o\">.</span>resolveDependants<span class=\"p\">(</span>o<span class=\"p\">)</span></td></tr><tr><th id=\"L364\"><a href=\"#L364\">364</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>references<span class=\"p\">[</span>refkey<span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0o</td></tr><tr><th id=\"L365\"><a href=\"#L365\">365</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0refkey <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L366\"><a href=\"#L366\">366</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># This happens when you're unjellying from an AOT not read from source</span></td></tr><tr><th id=\"L367\"><a href=\"#L367\">367</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L368\"><a href=\"#L368\">368</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L369\"><a href=\"#L369\">369</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s\">\"Multiple references with the same ID: </span><span class=\"si\">%s</span><span class=\"s\">, </span><span class=\"si\">%s</span><span class=\"s\">, </span><span class=\"si\">%s</span><span class=\"s\">!\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>ref<span class=\"p\">,</span>\u00a0refkey<span class=\"p\">,</span>\u00a0ao<span class=\"p\">))</span></td></tr><tr><th id=\"L370\"><a href=\"#L370\">370</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0o</td></tr><tr><th id=\"L371\"><a href=\"#L371\">371</a></th><td></td></tr><tr><th id=\"L372\"><a href=\"#L372\">372</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0c <span class=\"ow\">is</span>\u00a0Deref<span class=\"p\">:</span></td></tr><tr><th id=\"L373\"><a href=\"#L373\">373</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 num <span class=\"o\">=</span>\u00a0ao<span class=\"o\">.</span>refnum</td></tr><tr><th id=\"L374\"><a href=\"#L374\">374</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ref <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>references<span class=\"o\">.</span>get<span class=\"p\">(</span>num<span class=\"p\">)</span></td></tr><tr><th id=\"L375\"><a href=\"#L375\">375</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0ref <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L376\"><a href=\"#L376\">376</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 der <span class=\"o\">=</span>\u00a0crefutil<span class=\"o\">.</span>_Dereference<span class=\"p\">(</span>num<span class=\"p\">)</span></td></tr><tr><th id=\"L377\"><a href=\"#L377\">377</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>references<span class=\"p\">[</span>num<span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0der</td></tr><tr><th id=\"L378\"><a href=\"#L378\">378</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0der</td></tr><tr><th id=\"L379\"><a href=\"#L379\">379</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0ref</td></tr><tr><th id=\"L380\"><a href=\"#L380\">380</a></th><td></td></tr><tr><th id=\"L381\"><a href=\"#L381\">381</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0c <span class=\"ow\">is</span>\u00a0Copyreg<span class=\"p\">:</span></td></tr><tr><th id=\"L382\"><a href=\"#L382\">382</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 loadfunc <span class=\"o\">=</span>\u00a0reflect<span class=\"o\">.</span>namedObject<span class=\"p\">(</span>ao<span class=\"o\">.</span>loadfunc<span class=\"p\">)</span></td></tr><tr><th id=\"L383\"><a href=\"#L383\">383</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>unjellyLater<span class=\"p\">(</span>ao<span class=\"o\">.</span>state<span class=\"p\">)</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span></td></tr><tr><th id=\"L384\"><a href=\"#L384\">384</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">lambda</span>\u00a0result<span class=\"p\">,</span>\u00a0_l<span class=\"p\">:</span>\u00a0<span class=\"nb\">apply</span><span class=\"p\">(</span>_l<span class=\"p\">,</span>\u00a0result<span class=\"p\">),</span>\u00a0loadfunc<span class=\"p\">)</span></td></tr><tr><th id=\"L385\"><a href=\"#L385\">385</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L386\"><a href=\"#L386\">386</a></th><td></td></tr><tr><th id=\"L387\"><a href=\"#L387\">387</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#Types</span></td></tr><tr><th id=\"L388\"><a href=\"#L388\">388</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L389\"><a href=\"#L389\">389</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"ow\">in</span>\u00a0_SIMPLE_BUILTINS<span class=\"p\">:</span></td></tr><tr><th id=\"L390\"><a href=\"#L390\">390</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0ao</td></tr><tr><th id=\"L391\"><a href=\"#L391\">391</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L392\"><a href=\"#L392\">392</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>ListType<span class=\"p\">:</span></td></tr><tr><th id=\"L393\"><a href=\"#L393\">393</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 l <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L394\"><a href=\"#L394\">394</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0x <span class=\"ow\">in</span>\u00a0ao<span class=\"p\">:</span></td></tr><tr><th id=\"L395\"><a href=\"#L395\">395</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 l<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L396\"><a href=\"#L396\">396</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>unjellyInto<span class=\"p\">(</span>l<span class=\"p\">,</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>l<span class=\"p\">)</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">,</span>\u00a0x<span class=\"p\">)</span></td></tr><tr><th id=\"L397\"><a href=\"#L397\">397</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0l</td></tr><tr><th id=\"L398\"><a href=\"#L398\">398</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L399\"><a href=\"#L399\">399</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>TupleType<span class=\"p\">:</span></td></tr><tr><th id=\"L400\"><a href=\"#L400\">400</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 l <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L401\"><a href=\"#L401\">401</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 tuple_ <span class=\"o\">=</span>\u00a0<span class=\"nb\">tuple</span></td></tr><tr><th id=\"L402\"><a href=\"#L402\">402</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0x <span class=\"ow\">in</span>\u00a0ao<span class=\"p\">:</span></td></tr><tr><th id=\"L403\"><a href=\"#L403\">403</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 l<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L404\"><a href=\"#L404\">404</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>unjellyInto<span class=\"p\">(</span>l<span class=\"p\">,</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>l<span class=\"p\">)</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">,</span>\u00a0x<span class=\"p\">),</span>\u00a0crefutil<span class=\"o\">.</span>NotKnown<span class=\"p\">):</span></td></tr><tr><th id=\"L405\"><a href=\"#L405\">405</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 tuple_ <span class=\"o\">=</span>\u00a0crefutil<span class=\"o\">.</span>_Tuple</td></tr><tr><th id=\"L406\"><a href=\"#L406\">406</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0tuple_<span class=\"p\">(</span>l<span class=\"p\">)</span></td></tr><tr><th id=\"L407\"><a href=\"#L407\">407</a></th><td></td></tr><tr><th id=\"L408\"><a href=\"#L408\">408</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>DictType<span class=\"p\">:</span></td></tr><tr><th id=\"L409\"><a href=\"#L409\">409</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L410\"><a href=\"#L410\">410</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0k<span class=\"p\">,</span>v <span class=\"ow\">in</span>\u00a0ao<span class=\"o\">.</span>items<span class=\"p\">():</span></td></tr><tr><th id=\"L411\"><a href=\"#L411\">411</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 kvd <span class=\"o\">=</span>\u00a0crefutil<span class=\"o\">.</span>_DictKeyAndValue<span class=\"p\">(</span>d<span class=\"p\">)</span></td></tr><tr><th id=\"L412\"><a href=\"#L412\">412</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>unjellyInto<span class=\"p\">(</span>kvd<span class=\"p\">,</span>\u00a0<span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0k<span class=\"p\">)</span></td></tr><tr><th id=\"L413\"><a href=\"#L413\">413</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>unjellyInto<span class=\"p\">(</span>kvd<span class=\"p\">,</span>\u00a0<span class=\"mi\">1</span><span class=\"p\">,</span>\u00a0v<span class=\"p\">)</span></td></tr><tr><th id=\"L414\"><a href=\"#L414\">414</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L415\"><a href=\"#L415\">415</a></th><td></td></tr><tr><th id=\"L416\"><a href=\"#L416\">416</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L417\"><a href=\"#L417\">417</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s\">\"Unsupported AOT type: </span><span class=\"si\">%s</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0t<span class=\"p\">)</span></td></tr><tr><th id=\"L418\"><a href=\"#L418\">418</a></th><td></td></tr><tr><th id=\"L419\"><a href=\"#L419\">419</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">del</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>stack<span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span></td></tr><tr><th id=\"L420\"><a href=\"#L420\">420</a></th><td></td></tr><tr><th id=\"L421\"><a href=\"#L421\">421</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L422\"><a href=\"#L422\">422</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">unjelly</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0ao<span class=\"p\">):</span></td></tr><tr><th id=\"L423\"><a href=\"#L423\">423</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L424\"><a href=\"#L424\">424</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 l <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"bp\">None</span><span class=\"p\">]</span></td></tr><tr><th id=\"L425\"><a href=\"#L425\">425</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>unjellyInto<span class=\"p\">(</span>l<span class=\"p\">,</span>\u00a0<span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0ao<span class=\"p\">)</span></td></tr><tr><th id=\"L426\"><a href=\"#L426\">426</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0<span class=\"nb\">callable</span><span class=\"p\">,</span>\u00a0v <span class=\"ow\">in</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>afterUnjelly<span class=\"p\">:</span></td></tr><tr><th id=\"L427\"><a href=\"#L427\">427</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"nb\">callable</span><span class=\"p\">(</span>v<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span></td></tr><tr><th id=\"L428\"><a href=\"#L428\">428</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0l<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span></td></tr><tr><th id=\"L429\"><a href=\"#L429\">429</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L430\"><a href=\"#L430\">430</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Error jellying object! Stacktrace follows::\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L431\"><a href=\"#L431\">431</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span>string<span class=\"o\">.</span>join<span class=\"p\">(</span><span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"nb\">repr</span><span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>stack<span class=\"p\">),</span>\u00a0<span class=\"s\">\"</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">))</span></td></tr><tr><th id=\"L432\"><a href=\"#L432\">432</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span></td></tr><tr><th id=\"L433\"><a href=\"#L433\">433</a></th><td><span class=\"c\">#########</span></td></tr><tr><th id=\"L434\"><a href=\"#L434\">434</a></th><td><span class=\"c\"># Jelly #</span></td></tr><tr><th id=\"L435\"><a href=\"#L435\">435</a></th><td><span class=\"c\">#########</span></td></tr><tr><th id=\"L436\"><a href=\"#L436\">436</a></th><td></td></tr><tr><th id=\"L437\"><a href=\"#L437\">437</a></th><td></td></tr><tr><th id=\"L438\"><a href=\"#L438\">438</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">jellyToAOT</span><span class=\"p\">(</span>obj<span class=\"p\">):</span></td></tr><tr><th id=\"L439\"><a href=\"#L439\">439</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Convert an object to an Abstract Object Tree.\"\"\"</span></td></tr><tr><th id=\"L440\"><a href=\"#L440\">440</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0AOTJellier<span class=\"p\">()</span><span class=\"o\">.</span>jelly<span class=\"p\">(</span>obj<span class=\"p\">)</span></td></tr><tr><th id=\"L441\"><a href=\"#L441\">441</a></th><td></td></tr><tr><th id=\"L442\"><a href=\"#L442\">442</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">jellyToSource</span><span class=\"p\">(</span>obj<span class=\"p\">,</span>\u00a0<span class=\"nb\">file</span><span class=\"o\">=</span><span class=\"bp\">None</span><span class=\"p\">):</span></td></tr><tr><th id=\"L443\"><a href=\"#L443\">443</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L444\"><a href=\"#L444\">444</a></th><td><span class=\"sd\">\u00a0 \u00a0 Pass me an object and, optionally, a file object.</span></td></tr><tr><th id=\"L445\"><a href=\"#L445\">445</a></th><td><span class=\"sd\">\u00a0 \u00a0 I'll convert the object to an AOT either return it (if no file was</span></td></tr><tr><th id=\"L446\"><a href=\"#L446\">446</a></th><td><span class=\"sd\">\u00a0 \u00a0 specified) or write it to the file.</span></td></tr><tr><th id=\"L447\"><a href=\"#L447\">447</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L448\"><a href=\"#L448\">448</a></th><td></td></tr><tr><th id=\"L449\"><a href=\"#L449\">449</a></th><td>\u00a0 \u00a0 aot <span class=\"o\">=</span>\u00a0jellyToAOT<span class=\"p\">(</span>obj<span class=\"p\">)</span></td></tr><tr><th id=\"L450\"><a href=\"#L450\">450</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">file</span><span class=\"p\">:</span></td></tr><tr><th id=\"L451\"><a href=\"#L451\">451</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"nb\">file</span><span class=\"o\">.</span>write<span class=\"p\">(</span>getSource<span class=\"p\">(</span>aot<span class=\"p\">))</span></td></tr><tr><th id=\"L452\"><a href=\"#L452\">452</a></th><td>\u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L453\"><a href=\"#L453\">453</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0getSource<span class=\"p\">(</span>aot<span class=\"p\">)</span></td></tr><tr><th id=\"L454\"><a href=\"#L454\">454</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L455\"><a href=\"#L455\">455</a></th><td></td></tr><tr><th id=\"L456\"><a href=\"#L456\">456</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">AOTJellier</span><span class=\"p\">:</span></td></tr><tr><th id=\"L457\"><a href=\"#L457\">457</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L458\"><a href=\"#L458\">458</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># dict of {id(obj): (obj, node)}</span></td></tr><tr><th id=\"L459\"><a href=\"#L459\">459</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>prepared <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L460\"><a href=\"#L460\">460</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_ref_id <span class=\"o\">=</span>\u00a0<span class=\"mi\">0</span></td></tr><tr><th id=\"L461\"><a href=\"#L461\">461</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>stack <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L462\"><a href=\"#L462\">462</a></th><td></td></tr><tr><th id=\"L463\"><a href=\"#L463\">463</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">prepareForRef</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0aoref<span class=\"p\">,</span>\u00a0<span class=\"nb\">object</span><span class=\"p\">):</span></td></tr><tr><th id=\"L464\"><a href=\"#L464\">464</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"I prepare an object for later referencing, by storing its id()</span></td></tr><tr><th id=\"L465\"><a href=\"#L465\">465</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 and its _AORef in a cache.\"\"\"</span></td></tr><tr><th id=\"L466\"><a href=\"#L466\">466</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>prepared<span class=\"p\">[</span><span class=\"nb\">id</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">)]</span>\u00a0<span class=\"o\">=</span>\u00a0aoref</td></tr><tr><th id=\"L467\"><a href=\"#L467\">467</a></th><td></td></tr><tr><th id=\"L468\"><a href=\"#L468\">468</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">jellyToAO</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0obj<span class=\"p\">):</span></td></tr><tr><th id=\"L469\"><a href=\"#L469\">469</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"I turn an object into an AOT and return it.\"\"\"</span></td></tr><tr><th id=\"L470\"><a href=\"#L470\">470</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 objType <span class=\"o\">=</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">(</span>obj<span class=\"p\">)</span></td></tr><tr><th id=\"L471\"><a href=\"#L471\">471</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>stack<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"nb\">repr</span><span class=\"p\">(</span>obj<span class=\"p\">))</span></td></tr><tr><th id=\"L472\"><a href=\"#L472\">472</a></th><td></td></tr><tr><th id=\"L473\"><a href=\"#L473\">473</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#immutable: We don't care if these have multiple refs!</span></td></tr><tr><th id=\"L474\"><a href=\"#L474\">474</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0objType <span class=\"ow\">in</span>\u00a0_SIMPLE_BUILTINS<span class=\"p\">:</span></td></tr><tr><th id=\"L475\"><a href=\"#L475\">475</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval <span class=\"o\">=</span>\u00a0obj</td></tr><tr><th id=\"L476\"><a href=\"#L476\">476</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L477\"><a href=\"#L477\">477</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0objType <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>MethodType<span class=\"p\">:</span></td></tr><tr><th id=\"L478\"><a href=\"#L478\">478</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># TODO: make methods 'prefer' not to jelly the object internally,</span></td></tr><tr><th id=\"L479\"><a href=\"#L479\">479</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># so that the object will show up where it's referenced first NOT</span></td></tr><tr><th id=\"L480\"><a href=\"#L480\">480</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># by a method.</span></td></tr><tr><th id=\"L481\"><a href=\"#L481\">481</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval <span class=\"o\">=</span>\u00a0InstanceMethod<span class=\"p\">(</span>obj<span class=\"o\">.</span>im_func<span class=\"o\">.</span>__name__<span class=\"p\">,</span>\u00a0reflect<span class=\"o\">.</span>qual<span class=\"p\">(</span>obj<span class=\"o\">.</span>im_class<span class=\"p\">),</span></td></tr><tr><th id=\"L482\"><a href=\"#L482\">482</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>jellyToAO<span class=\"p\">(</span>obj<span class=\"o\">.</span>im_self<span class=\"p\">))</span></td></tr><tr><th id=\"L483\"><a href=\"#L483\">483</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L484\"><a href=\"#L484\">484</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0objType <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>ModuleType<span class=\"p\">:</span></td></tr><tr><th id=\"L485\"><a href=\"#L485\">485</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval <span class=\"o\">=</span>\u00a0Module<span class=\"p\">(</span>obj<span class=\"o\">.</span>__name__<span class=\"p\">)</span></td></tr><tr><th id=\"L486\"><a href=\"#L486\">486</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L487\"><a href=\"#L487\">487</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0objType <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>ClassType<span class=\"p\">:</span></td></tr><tr><th id=\"L488\"><a href=\"#L488\">488</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval <span class=\"o\">=</span>\u00a0Class<span class=\"p\">(</span>reflect<span class=\"o\">.</span>qual<span class=\"p\">(</span>obj<span class=\"p\">))</span></td></tr><tr><th id=\"L489\"><a href=\"#L489\">489</a></th><td></td></tr><tr><th id=\"L490\"><a href=\"#L490\">490</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"nb\">issubclass</span><span class=\"p\">(</span>objType<span class=\"p\">,</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">):</span></td></tr><tr><th id=\"L491\"><a href=\"#L491\">491</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval <span class=\"o\">=</span>\u00a0Class<span class=\"p\">(</span>reflect<span class=\"o\">.</span>qual<span class=\"p\">(</span>obj<span class=\"p\">))</span></td></tr><tr><th id=\"L492\"><a href=\"#L492\">492</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L493\"><a href=\"#L493\">493</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0objType <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>FunctionType<span class=\"p\">:</span></td></tr><tr><th id=\"L494\"><a href=\"#L494\">494</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval <span class=\"o\">=</span>\u00a0Function<span class=\"p\">(</span>reflect<span class=\"o\">.</span>fullFuncName<span class=\"p\">(</span>obj<span class=\"p\">))</span></td></tr><tr><th id=\"L495\"><a href=\"#L495\">495</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L496\"><a href=\"#L496\">496</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span>\u00a0<span class=\"c\">#mutable! gotta watch for refs.</span></td></tr><tr><th id=\"L497\"><a href=\"#L497\">497</a></th><td></td></tr><tr><th id=\"L498\"><a href=\"#L498\">498</a></th><td><span class=\"c\">#Marmalade had the nicety of being able to just stick a 'reference' attribute</span></td></tr><tr><th id=\"L499\"><a href=\"#L499\">499</a></th><td><span class=\"c\">#on any Node object that was referenced, but in AOT, the referenced object</span></td></tr><tr><th id=\"L500\"><a href=\"#L500\">500</a></th><td><span class=\"c\">#is *inside* of a Ref call (Ref(num, obj) instead of</span></td></tr><tr><th id=\"L501\"><a href=\"#L501\">501</a></th><td><span class=\"c\">#&lt;objtype ... reference=\"1\"&gt;). The problem is, especially for built-in types,</span></td></tr><tr><th id=\"L502\"><a href=\"#L502\">502</a></th><td><span class=\"c\">#I can't just assign some attribute to them to give them a refnum. So, I have</span></td></tr><tr><th id=\"L503\"><a href=\"#L503\">503</a></th><td><span class=\"c\">#to \"wrap\" a Ref(..) around them later -- that's why I put *everything* that's</span></td></tr><tr><th id=\"L504\"><a href=\"#L504\">504</a></th><td><span class=\"c\">#mutable inside one. The Ref() class will only print the \"Ref(..)\" around an</span></td></tr><tr><th id=\"L505\"><a href=\"#L505\">505</a></th><td><span class=\"c\">#object if it has a Reference explicitly attached.</span></td></tr><tr><th id=\"L506\"><a href=\"#L506\">506</a></th><td></td></tr><tr><th id=\"L507\"><a href=\"#L507\">507</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>prepared<span class=\"o\">.</span>has_key<span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"p\">(</span>obj<span class=\"p\">)):</span></td></tr><tr><th id=\"L508\"><a href=\"#L508\">508</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 oldRef <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>prepared<span class=\"p\">[</span><span class=\"nb\">id</span><span class=\"p\">(</span>obj<span class=\"p\">)]</span></td></tr><tr><th id=\"L509\"><a href=\"#L509\">509</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0oldRef<span class=\"o\">.</span>refnum<span class=\"p\">:</span></td></tr><tr><th id=\"L510\"><a href=\"#L510\">510</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># it's been referenced already</span></td></tr><tr><th id=\"L511\"><a href=\"#L511\">511</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 key <span class=\"o\">=</span>\u00a0oldRef<span class=\"o\">.</span>refnum</td></tr><tr><th id=\"L512\"><a href=\"#L512\">512</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L513\"><a href=\"#L513\">513</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># it hasn't been referenced yet</span></td></tr><tr><th id=\"L514\"><a href=\"#L514\">514</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_ref_id <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_ref_id <span class=\"o\">+</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L515\"><a href=\"#L515\">515</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 key <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_ref_id</td></tr><tr><th id=\"L516\"><a href=\"#L516\">516</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 oldRef<span class=\"o\">.</span>setRef<span class=\"p\">(</span>key<span class=\"p\">)</span></td></tr><tr><th id=\"L517\"><a href=\"#L517\">517</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0Deref<span class=\"p\">(</span>key<span class=\"p\">)</span></td></tr><tr><th id=\"L518\"><a href=\"#L518\">518</a></th><td></td></tr><tr><th id=\"L519\"><a href=\"#L519\">519</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval <span class=\"o\">=</span>\u00a0Ref<span class=\"p\">()</span></td></tr><tr><th id=\"L520\"><a href=\"#L520\">520</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>prepareForRef<span class=\"p\">(</span>retval<span class=\"p\">,</span>\u00a0obj<span class=\"p\">)</span></td></tr><tr><th id=\"L521\"><a href=\"#L521\">521</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L522\"><a href=\"#L522\">522</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0objType <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>ListType<span class=\"p\">:</span></td></tr><tr><th id=\"L523\"><a href=\"#L523\">523</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval<span class=\"o\">.</span>setObj<span class=\"p\">(</span><span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>jellyToAO<span class=\"p\">,</span>\u00a0obj<span class=\"p\">))</span>\u00a0<span class=\"c\">#hah!</span></td></tr><tr><th id=\"L524\"><a href=\"#L524\">524</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L525\"><a href=\"#L525\">525</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0objType <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>TupleType<span class=\"p\">:</span></td></tr><tr><th id=\"L526\"><a href=\"#L526\">526</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval<span class=\"o\">.</span>setObj<span class=\"p\">(</span><span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>jellyToAO<span class=\"p\">,</span>\u00a0obj<span class=\"p\">)))</span></td></tr><tr><th id=\"L527\"><a href=\"#L527\">527</a></th><td></td></tr><tr><th id=\"L528\"><a href=\"#L528\">528</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0objType <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>DictionaryType<span class=\"p\">:</span></td></tr><tr><th id=\"L529\"><a href=\"#L529\">529</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L530\"><a href=\"#L530\">530</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0k<span class=\"p\">,</span>v <span class=\"ow\">in</span>\u00a0obj<span class=\"o\">.</span>items<span class=\"p\">():</span></td></tr><tr><th id=\"L531\"><a href=\"#L531\">531</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span>jellyToAO<span class=\"p\">(</span>k<span class=\"p\">)]</span>\u00a0<span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>jellyToAO<span class=\"p\">(</span>v<span class=\"p\">)</span></td></tr><tr><th id=\"L532\"><a href=\"#L532\">532</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval<span class=\"o\">.</span>setObj<span class=\"p\">(</span>d<span class=\"p\">)</span></td></tr><tr><th id=\"L533\"><a href=\"#L533\">533</a></th><td></td></tr><tr><th id=\"L534\"><a href=\"#L534\">534</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0objType <span class=\"ow\">is</span>\u00a0types<span class=\"o\">.</span>InstanceType<span class=\"p\">:</span></td></tr><tr><th id=\"L535\"><a href=\"#L535\">535</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>obj<span class=\"p\">,</span>\u00a0<span class=\"s\">\"__getstate__\"</span><span class=\"p\">):</span></td></tr><tr><th id=\"L536\"><a href=\"#L536\">536</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 state <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>jellyToAO<span class=\"p\">(</span>obj<span class=\"o\">.</span>__getstate__<span class=\"p\">())</span></td></tr><tr><th id=\"L537\"><a href=\"#L537\">537</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L538\"><a href=\"#L538\">538</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 state <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>jellyToAO<span class=\"p\">(</span>obj<span class=\"o\">.</span>__dict__<span class=\"p\">)</span></td></tr><tr><th id=\"L539\"><a href=\"#L539\">539</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval<span class=\"o\">.</span>setObj<span class=\"p\">(</span>Instance<span class=\"p\">(</span>reflect<span class=\"o\">.</span>qual<span class=\"p\">(</span>obj<span class=\"o\">.</span>__class__<span class=\"p\">),</span>\u00a0state<span class=\"p\">))</span></td></tr><tr><th id=\"L540\"><a href=\"#L540\">540</a></th><td></td></tr><tr><th id=\"L541\"><a href=\"#L541\">541</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0copy_reg<span class=\"o\">.</span>dispatch_table<span class=\"o\">.</span>has_key<span class=\"p\">(</span>objType<span class=\"p\">):</span></td></tr><tr><th id=\"L542\"><a href=\"#L542\">542</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 unpickleFunc<span class=\"p\">,</span>\u00a0state <span class=\"o\">=</span>\u00a0copy_reg<span class=\"o\">.</span>dispatch_table<span class=\"p\">[</span>objType<span class=\"p\">](</span>obj<span class=\"p\">)</span></td></tr><tr><th id=\"L543\"><a href=\"#L543\">543</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L544\"><a href=\"#L544\">544</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retval<span class=\"o\">.</span>setObj<span class=\"p\">(</span>Copyreg<span class=\"p\">(</span>\u00a0reflect<span class=\"o\">.</span>fullFuncName<span class=\"p\">(</span>unpickleFunc<span class=\"p\">),</span></td></tr><tr><th id=\"L545\"><a href=\"#L545\">545</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>jellyToAO<span class=\"p\">(</span>state<span class=\"p\">)))</span></td></tr><tr><th id=\"L546\"><a href=\"#L546\">546</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L547\"><a href=\"#L547\">547</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L548\"><a href=\"#L548\">548</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"s\">\"Unsupported type: </span><span class=\"si\">%s</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0objType<span class=\"o\">.</span>__name__</td></tr><tr><th id=\"L549\"><a href=\"#L549\">549</a></th><td></td></tr><tr><th id=\"L550\"><a href=\"#L550\">550</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">del</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>stack<span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span></td></tr><tr><th id=\"L551\"><a href=\"#L551\">551</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0retval</td></tr><tr><th id=\"L552\"><a href=\"#L552\">552</a></th><td></td></tr><tr><th id=\"L553\"><a href=\"#L553\">553</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">jelly</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0obj<span class=\"p\">):</span></td></tr><tr><th id=\"L554\"><a href=\"#L554\">554</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L555\"><a href=\"#L555\">555</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ao <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>jellyToAO<span class=\"p\">(</span>obj<span class=\"p\">)</span></td></tr><tr><th id=\"L556\"><a href=\"#L556\">556</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0ao</td></tr><tr><th id=\"L557\"><a href=\"#L557\">557</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L558\"><a href=\"#L558\">558</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Error jellying object! Stacktrace follows::\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L559\"><a href=\"#L559\">559</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span>string<span class=\"o\">.</span>join<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>stack<span class=\"p\">,</span>\u00a0<span class=\"s\">'</span><span class=\"se\">\\n</span><span class=\"s\">'</span><span class=\"p\">))</span></td></tr><tr><th id=\"L560\"><a href=\"#L560\">560</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span></td></tr></tbody></table>\n\n      </div>\n      <div id=\"anydiff\">\n        <form action=\"/LUCICodeRepository/nomaticIM/diff\" method=\"get\">\n          <div class=\"buttons\">\n            <input type=\"hidden\" name=\"new_path\" value=\"/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py\" />\n            <input type=\"hidden\" name=\"old_path\" value=\"/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py\" />\n            <input type=\"hidden\" name=\"new_rev\" />\n            <input type=\"hidden\" name=\"old_rev\" />\n            <input type=\"submit\" value=\"View changes...\" title=\"Select paths and revs for Diff\" />\n          </div>\n        </form>\n      </div>\n      <div id=\"help\"><strong>Note:</strong> See <a href=\"/LUCICodeRepository/nomaticIM/wiki/TracBrowser\">TracBrowser</a>\n        for help on using the repository browser.</div>\n    </div>\n    <div id=\"altlinks\">\n      <h3>Download in other formats:</h3>\n      <ul>\n        <li class=\"first\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py?format=txt\">Plain Text</a>\n        </li><li class=\"last\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.3/buddy_bots/src/twisted/persisted/aot.py\">Original Format</a>\n        </li>\n      </ul>\n    </div>\n    </div>\n    <div id=\"footer\" lang=\"en\" xml:lang=\"en\"><hr />\n      <a id=\"tracpowered\" href=\"http://trac.edgewall.org/\"><img src=\"/LUCICodeRepository/nomaticIM/chrome/common/trac_logo_mini.png\" height=\"30\" width=\"107\" alt=\"Trac Powered\" /></a>\n      <p class=\"left\">Powered by <a href=\"/LUCICodeRepository/nomaticIM/about\"><strong>Trac 1.0.1</strong></a><br />\n        By <a href=\"http://www.edgewall.org/\">Edgewall Software</a>.</p>\n      <p class=\"right\">All content copyright 2007-2008 by LUCI <br /><a href=\"http://luci.ics.uci.edu/\">http://luci.ics.uci.edu/</a></p>\n    </div>\n\t\t<div id=\"sitefooter\">\n\t\t\t<script src=\"http://www.google-analytics.com/urchin.js\" type=\"text/javascript\">\n\t\t\t</script>\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t_uacct = \"UA-338915-2\";\n\t\t\t\turchinTracker();\n\t\t\t</script>\n\t\t</div>\n\t</body>\n</html>", "id": 44623.0}