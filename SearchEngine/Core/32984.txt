{"text": "View Javadoc 1 package swirl workspace security 2 3 import java io IOException 4 import java util ArrayList 5 import java util Collections 6 import java util HashMap 7 import java util HashSet 8 import java util List 9 1 import org apache commons logging Log 11 import org apache commons logging LogFactory 12 import org mortbay http HttpContext 13 import org mortbay http HttpException 14 import org mortbay http HttpRequest 15 import org mortbay http HttpResponse 16 import org mortbay http UserPrincipal 17 import org mortbay http UserRealm 18 import org mortbay http handler AbstractHttpHandler 19 import org mortbay jetty servlet WebApplicationContext 2 21 import swirl workspace common NetUtils 22 import swirl workspace persistence PersistenceManager 23 24 25 DOCUMENT ME 26 27 author bpillet 28 29 public class SwirlSecurityHandler extends AbstractHttpHandler 3 implements SwirlSecurity 31 32 TODO 33 private static final long serialVersionUID 1L 34 35 TODO 36 public static final String KEY swirl security handler 37 38 TODO 39 public static final String HIDDEN METHODS 4 41 TODO 42 public static final String SEE ONLY METHODS 43 44 REPORT PROPFIND 45 SEARCH HEAD 46 OPTIONS 47 48 49 TODO 5 public static final String READ ONLY METHODS GET 51 52 TODO 53 public static final String READ WRITE COPY METHODS 54 55 PROPPATCH 56 COPY DELETE 57 POST PUT 58 LOCK UNLOCK 59 MOVE ACL 6 UNBIND TRACE 61 BIND CONNECT 62 REBIND 63 64 65 TODO 66 public static final String PERSISTENT METHODS 67 68 TODO 69 public static final String LEVELS METHODS 7 71 HIDDEN METHODS 72 SEE ONLY METHODS 73 READ ONLY METHODS 74 READ WRITE COPY METHODS 75 PERSISTENT METHODS 76 77 78 79 8 TODO 81 HashMap levels new HashMap 82 83 TODO 84 HashSet permissions new HashSet 85 86 the logger for this class 87 private Log log LogFactory getLog this getClass 88 89 TODO 9 private UserRealm realm 91 92 93 Creates a new SwirlSecurityHandler object 94 95 public SwirlSecurityHandler 96 97 if log isDebugEnabled 98 99 log debug 1 1 1 1 2 1 3 1 4 TODO 1 5 1 6 param path TODO 1 7 param role TODO 1 8 param securityLevel TODO 1 9 11 throws UnsupportedOperationException TODO 111 112 public void setSecurityLevel String path String role String securityLevel 113 throws UnsupportedOperationException 114 115 if log isDebugEnabled 116 117 log debug setSecurityLevel path role 118 securityLevel 119 12 121 int level SecurityUtils getLevelsIndex securityLevel 122 123 for int i i LEVELS METHODS length i 124 125 String methods LEVELS METHODS i 126 127 for int j j methods length j 128 129 if i level 13 131 grantMethod path methods j role 132 133 else 134 135 revokeMethod path methods j role 136 137 138 139 14 levels put path role securityLevel 141 142 143 144 TODO 145 146 param path TODO 147 param role TODO 148 149 return TODO 15 151 public String getSecurityLevel String path String role 152 153 String ret String levels get path role 154 155 if ret null 156 157 ret SwirlSecurity HIDDEN 158 setSecurityLevel path role ret 159 16 161 if log isDebugEnabled 162 163 log debug getSecurityLevel path role ret 164 165 166 return ret 167 168 169 17 TODO 171 172 param pathInContext TODO 173 param pathParams TODO 174 param request TODO 175 param response TODO 176 177 throws HttpException TODO 178 throws IOException TODO 179 18 public void handle java lang String pathInContext 181 java lang String pathParams HttpRequest request 182 HttpResponse response throws HttpException 183 IOException 184 185 if log isDebugEnabled 186 187 log debug handle nreq method request getMethod 188 nreq path request getEncodedPath 189 19 191 boolean isMe NetUtils isRequestFromMe request 192 193 if log isDebugEnabled 194 195 log debug isRequestFromMe isMe 196 197 198 if isMe 199 2 if request getPath startsWith PersistenceManager BACKUPPREFIX 2 1 request setAuthUser BACKUP 2 2 2 3 else 2 4 request setAuthUser ME 2 5 2 6 2 7 else 2 8 2 9 request setAuthUser OTHERS 21 211 212 UserPrincipal principal request getUserPrincipal 213 214 if log isDebugEnabled 215 216 log debug principal principal 217 218 219 principal realm authenticate request getAuthUser 22 request getAuthUser request 221 222 if log isDebugEnabled 223 224 log debug principal2 principal 225 226 227 request setUserPrincipal principal 228 229 if log isDebugEnabled 23 231 log debug req nauthType request getAuthType 232 nauthUser request getAuthUser 233 nuserPrincipal request getUserPrincipal 234 nis in role me request isUserInRole ME 235 nis in role others request isUserInRole OTHERS 236 237 238 boolean methodAllowed methodAllowed request getEncodedPath 239 request getMethod 24 request getAuthUser 241 String securityLevel getSecurityLevel request getEncodedPath 242 request getAuthUser 243 244 if methodAllowed 245 246 response setStatus 4 3 247 response setReason The method request getMethod 248 is not allowed for user 249 request getAuthUser 25 request setHandled true 251 252 253 254 255 TODO 256 257 param context TODO 258 259 public void initialize HttpContext context 26 261 super initialize context 262 263 HttpContext swirl context getHttpServer getContext swirl 264 swirl setAttribute KEY this 265 266 WebApplicationContext webContext WebApplicationContext context 267 268 to be thread safe wrapped up with synchronize 269 List updateList Collections synchronizedList new ArrayList 5 27 271 webContext setAttribute update list updateList 272 if log isDebugEnabled 273 log debug updateList updateList 274 275 swirl setAttribute update list updateList 276 277 Object updateListMutex new Object 278 webContext setAttribute updateListMutex updateListMutex 279 swirl setAttribute updateListMutex updateListMutex 28 281 if log isDebugEnabled 282 283 log debug initialize 284 285 286 setSecurityLevel slide OTHERS SwirlSecurity READ ONLY 287 realm context getRealm 288 289 if log isDebugEnabled 29 291 log debug realm realm 292 293 294 295 296 TODO 297 298 throws Exception TODO 299 3 public void start throws Exception 3 1 3 2 super start 3 3 3 4 if log isDebugEnabled 3 5 3 6 log debug start 3 7 3 8 3 9 31 311 TODO 312 313 param path TODO 314 param method TODO 315 param role TODO 316 317 private void grantMethod String path String method String role 318 319 permissions add path method role 32 321 322 323 TODO 324 325 param path TODO 326 param method TODO 327 param role TODO 328 329 return TODO 33 331 private boolean methodAllowed String path String method String role 332 333 boolean ret 334 335 if ME equals role 336 337 ret true 338 339 else if path equals slide path equals slide method equals PROPFIND 34 341 ret true 342 343 else if path startsWith PersistenceManager BACKUPPREFIX BACKUP equals role 344 ret true 345 346 else 347 348 ret permissions contains path method role 349 35 351 if log isDebugEnabled 352 353 log debug methodAllowed path method role 354 ret 355 356 357 return ret 358 359 36 361 TODO 362 363 param path TODO 364 param method TODO 365 param role TODO 366 367 private void revokeMethod String path String method String role 368 369 permissions remove path method role 37 371 This page was automatically generated by Maven", "_id": "http://drzaius.ics.uci.edu/~swirl/impromptu-0.20/xref/swirl/workspace/security/SwirlSecurityHandler.html", "title": "swirlsecurityhandler xref", "html": "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n<head>\n<meta http-equiv=\"content-type\" content=\"text/html; charset=ISO-8859-1\" /><title>SwirlSecurityHandler xref</title>\n<link type=\"text/css\" rel=\"stylesheet\" href=\"../../../stylesheet.css\" />\n</head>\n<body>\n<div id=\"overview\"><a href=\"../../../../apidocs/swirl/workspace/security/SwirlSecurityHandler.html\">View Javadoc</a></div><pre>\n\n<a name=\"1\" href=\"#1\">1</a>   <strong>package</strong> <a href=\"../../../swirl/workspace/security/package-summary.html\">swirl.workspace.security</a>;\n<a name=\"2\" href=\"#2\">2</a>   \n<a name=\"3\" href=\"#3\">3</a>   <strong>import</strong> java.io.IOException;\n<a name=\"4\" href=\"#4\">4</a>   <strong>import</strong> java.util.ArrayList;\n<a name=\"5\" href=\"#5\">5</a>   <strong>import</strong> java.util.Collections;\n<a name=\"6\" href=\"#6\">6</a>   <strong>import</strong> java.util.HashMap;\n<a name=\"7\" href=\"#7\">7</a>   <strong>import</strong> java.util.HashSet;\n<a name=\"8\" href=\"#8\">8</a>   <strong>import</strong> java.util.List;\n<a name=\"9\" href=\"#9\">9</a>   \n<a name=\"10\" href=\"#10\">10</a>  <strong>import</strong> org.apache.commons.logging.Log;\n<a name=\"11\" href=\"#11\">11</a>  <strong>import</strong> org.apache.commons.logging.LogFactory;\n<a name=\"12\" href=\"#12\">12</a>  <strong>import</strong> org.mortbay.http.HttpContext;\n<a name=\"13\" href=\"#13\">13</a>  <strong>import</strong> org.mortbay.http.HttpException;\n<a name=\"14\" href=\"#14\">14</a>  <strong>import</strong> org.mortbay.http.HttpRequest;\n<a name=\"15\" href=\"#15\">15</a>  <strong>import</strong> org.mortbay.http.HttpResponse;\n<a name=\"16\" href=\"#16\">16</a>  <strong>import</strong> org.mortbay.http.UserPrincipal;\n<a name=\"17\" href=\"#17\">17</a>  <strong>import</strong> org.mortbay.http.UserRealm;\n<a name=\"18\" href=\"#18\">18</a>  <strong>import</strong> org.mortbay.http.handler.AbstractHttpHandler;\n<a name=\"19\" href=\"#19\">19</a>  <strong>import</strong> org.mortbay.jetty.servlet.WebApplicationContext;\n<a name=\"20\" href=\"#20\">20</a>  \n<a name=\"21\" href=\"#21\">21</a>  <strong>import</strong> swirl.workspace.common.NetUtils;\n<a name=\"22\" href=\"#22\">22</a>  <strong>import</strong> swirl.workspace.persistence.PersistenceManager;\n<a name=\"23\" href=\"#23\">23</a>  \n<a name=\"24\" href=\"#24\">24</a>  <em>/**<em>*</em></em>\n<a name=\"25\" href=\"#25\">25</a>  <em> * DOCUMENT ME!</em>\n<a name=\"26\" href=\"#26\">26</a>  <em> *</em>\n<a name=\"27\" href=\"#27\">27</a>  <em> * @author bpillet</em>\n<a name=\"28\" href=\"#28\">28</a>  <em> */</em>\n<a name=\"29\" href=\"#29\">29</a>  <strong>public</strong> <strong>class</strong> <a href=\"../../../swirl/workspace/security/SwirlSecurityHandler.html\">SwirlSecurityHandler</a> <strong>extends</strong> AbstractHttpHandler\n<a name=\"30\" href=\"#30\">30</a>      implements <a href=\"../../../swirl/workspace/security/SwirlSecurity.html\">SwirlSecurity</a>\n<a name=\"31\" href=\"#31\">31</a>  {\n<a name=\"32\" href=\"#32\">32</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"33\" href=\"#33\">33</a>      <strong>private</strong> <strong>static</strong> <strong>final</strong> <strong>long</strong> serialVersionUID = 1L;\n<a name=\"34\" href=\"#34\">34</a>  \n<a name=\"35\" href=\"#35\">35</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"36\" href=\"#36\">36</a>      <strong>public</strong> <strong>static</strong> <strong>final</strong> String KEY = <span class=\"string\">\"swirl.security.handler\"</span>;\n<a name=\"37\" href=\"#37\">37</a>  \n<a name=\"38\" href=\"#38\">38</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"39\" href=\"#39\">39</a>      <strong>public</strong> <strong>static</strong> <strong>final</strong> String[] HIDDEN_METHODS = {};\n<a name=\"40\" href=\"#40\">40</a>  \n<a name=\"41\" href=\"#41\">41</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"42\" href=\"#42\">42</a>      <strong>public</strong> <strong>static</strong> <strong>final</strong> String[] SEE_ONLY_METHODS = \n<a name=\"43\" href=\"#43\">43</a>                                                      {\n<a name=\"44\" href=\"#44\">44</a>                                                          <span class=\"string\">\"REPORT\"</span>, <span class=\"string\">\"PROPFIND\"</span>,\n<a name=\"45\" href=\"#45\">45</a>                                                          <span class=\"string\">\"SEARCH\"</span>, <span class=\"string\">\"HEAD\"</span>,\n<a name=\"46\" href=\"#46\">46</a>                                                          <span class=\"string\">\"OPTIONS\"</span>\n<a name=\"47\" href=\"#47\">47</a>                                                      };\n<a name=\"48\" href=\"#48\">48</a>  \n<a name=\"49\" href=\"#49\">49</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"50\" href=\"#50\">50</a>      <strong>public</strong> <strong>static</strong> <strong>final</strong> String[] READ_ONLY_METHODS = {<span class=\"string\">\"GET\"</span>};\n<a name=\"51\" href=\"#51\">51</a>  \n<a name=\"52\" href=\"#52\">52</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"53\" href=\"#53\">53</a>      <strong>public</strong> <strong>static</strong> <strong>final</strong> String[] READ_WRITE_COPY_METHODS = \n<a name=\"54\" href=\"#54\">54</a>                                                             {\n<a name=\"55\" href=\"#55\">55</a>                                                                 <span class=\"string\">\"PROPPATCH\"</span>,\n<a name=\"56\" href=\"#56\">56</a>                                                                 <span class=\"string\">\"COPY\"</span>, <span class=\"string\">\"DELETE\"</span>,\n<a name=\"57\" href=\"#57\">57</a>                                                                 <span class=\"string\">\"POST\"</span>, <span class=\"string\">\"PUT\"</span>,\n<a name=\"58\" href=\"#58\">58</a>                                                                 <span class=\"string\">\"LOCK\"</span>, <span class=\"string\">\"UNLOCK\"</span>,\n<a name=\"59\" href=\"#59\">59</a>                                                                 <span class=\"string\">\"MOVE\"</span>, <span class=\"string\">\"ACL\"</span>,\n<a name=\"60\" href=\"#60\">60</a>                                                                 <span class=\"string\">\"UNBIND\"</span>, <span class=\"string\">\"TRACE\"</span>,\n<a name=\"61\" href=\"#61\">61</a>                                                                 <span class=\"string\">\"BIND\"</span>, <span class=\"string\">\"CONNECT\"</span>,\n<a name=\"62\" href=\"#62\">62</a>                                                                 <span class=\"string\">\"REBIND\"</span>\n<a name=\"63\" href=\"#63\">63</a>                                                             };\n<a name=\"64\" href=\"#64\">64</a>  \n<a name=\"65\" href=\"#65\">65</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"66\" href=\"#66\">66</a>      <strong>public</strong> <strong>static</strong> <strong>final</strong> String[] PERSISTENT_METHODS = {};\n<a name=\"67\" href=\"#67\">67</a>  \n<a name=\"68\" href=\"#68\">68</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"69\" href=\"#69\">69</a>      <strong>public</strong> <strong>static</strong> <strong>final</strong> String[][] LEVELS_METHODS = \n<a name=\"70\" href=\"#70\">70</a>                                                      {\n<a name=\"71\" href=\"#71\">71</a>                                                          HIDDEN_METHODS,\n<a name=\"72\" href=\"#72\">72</a>                                                          SEE_ONLY_METHODS,\n<a name=\"73\" href=\"#73\">73</a>                                                          READ_ONLY_METHODS,\n<a name=\"74\" href=\"#74\">74</a>                                                          READ_WRITE_COPY_METHODS,\n<a name=\"75\" href=\"#75\">75</a>                                                          PERSISTENT_METHODS\n<a name=\"76\" href=\"#76\">76</a>                                                      };\n<a name=\"77\" href=\"#77\">77</a>  \n<a name=\"78\" href=\"#78\">78</a>  \n<a name=\"79\" href=\"#79\">79</a>  \n<a name=\"80\" href=\"#80\">80</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"81\" href=\"#81\">81</a>      HashMap levels = <strong>new</strong> HashMap();\n<a name=\"82\" href=\"#82\">82</a>  \n<a name=\"83\" href=\"#83\">83</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"84\" href=\"#84\">84</a>      HashSet permissions = <strong>new</strong> HashSet();\n<a name=\"85\" href=\"#85\">85</a>  \n<a name=\"86\" href=\"#86\">86</a>      <em>/**<em>* the logger for this class */</em></em>\n<a name=\"87\" href=\"#87\">87</a>      <strong>private</strong> Log log = LogFactory.getLog(<strong>this</strong>.getClass());\n<a name=\"88\" href=\"#88\">88</a>  \n<a name=\"89\" href=\"#89\">89</a>      <em>/**<em>* TODO */</em></em>\n<a name=\"90\" href=\"#90\">90</a>      <strong>private</strong> UserRealm realm;\n<a name=\"91\" href=\"#91\">91</a>  \n<a name=\"92\" href=\"#92\">92</a>      <em>/**<em>*</em></em>\n<a name=\"93\" href=\"#93\">93</a>  <em>     * Creates a new SwirlSecurityHandler object.</em>\n<a name=\"94\" href=\"#94\">94</a>  <em>     */</em>\n<a name=\"95\" href=\"#95\">95</a>      <strong>public</strong> <a href=\"../../../swirl/workspace/security/SwirlSecurityHandler.html\">SwirlSecurityHandler</a>()\n<a name=\"96\" href=\"#96\">96</a>      {\n<a name=\"97\" href=\"#97\">97</a>          <strong>if</strong>(log.isDebugEnabled())\n<a name=\"98\" href=\"#98\">98</a>          {\n<a name=\"99\" href=\"#99\">99</a>              log.debug(<span class=\"string\">\"()\"</span>);\n<a name=\"100\" href=\"#100\">100</a>         }\n<a name=\"101\" href=\"#101\">101</a>     }\n<a name=\"102\" href=\"#102\">102</a> \n<a name=\"103\" href=\"#103\">103</a>     <em>/**<em>*</em></em>\n<a name=\"104\" href=\"#104\">104</a> <em>     * TODO</em>\n<a name=\"105\" href=\"#105\">105</a> <em>     *</em>\n<a name=\"106\" href=\"#106\">106</a> <em>     * @param path TODO</em>\n<a name=\"107\" href=\"#107\">107</a> <em>     * @param role TODO</em>\n<a name=\"108\" href=\"#108\">108</a> <em>     * @param securityLevel TODO</em>\n<a name=\"109\" href=\"#109\">109</a> <em>     *</em>\n<a name=\"110\" href=\"#110\">110</a> <em>     * @throws UnsupportedOperationException TODO</em>\n<a name=\"111\" href=\"#111\">111</a> <em>     */</em>\n<a name=\"112\" href=\"#112\">112</a>     <strong>public</strong> <strong>void</strong> setSecurityLevel(String path, String role, String securityLevel)\n<a name=\"113\" href=\"#113\">113</a>                           throws UnsupportedOperationException\n<a name=\"114\" href=\"#114\">114</a>     {\n<a name=\"115\" href=\"#115\">115</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"116\" href=\"#116\">116</a>         {\n<a name=\"117\" href=\"#117\">117</a>             log.debug(<span class=\"string\">\"setSecurityLevel(\"</span> + path + <span class=\"string\">\", \"</span> + role + <span class=\"string\">\", \"</span>\n<a name=\"118\" href=\"#118\">118</a>                       + securityLevel + <span class=\"string\">\")\"</span>);\n<a name=\"119\" href=\"#119\">119</a>         }\n<a name=\"120\" href=\"#120\">120</a> \n<a name=\"121\" href=\"#121\">121</a>         <strong>int</strong> level = SecurityUtils.getLevelsIndex(securityLevel);\n<a name=\"122\" href=\"#122\">122</a> \n<a name=\"123\" href=\"#123\">123</a>         <strong>for</strong>(<strong>int</strong> i = 0; i &lt; LEVELS_METHODS.length; ++i)\n<a name=\"124\" href=\"#124\">124</a>         {\n<a name=\"125\" href=\"#125\">125</a>             String[] methods = LEVELS_METHODS[i];\n<a name=\"126\" href=\"#126\">126</a> \n<a name=\"127\" href=\"#127\">127</a>             <strong>for</strong>(<strong>int</strong> j = 0; j &lt; methods.length; ++j)\n<a name=\"128\" href=\"#128\">128</a>             {\n<a name=\"129\" href=\"#129\">129</a>                 <strong>if</strong>(i &lt;= level)\n<a name=\"130\" href=\"#130\">130</a>                 {\n<a name=\"131\" href=\"#131\">131</a>                     grantMethod(path, methods[j], role);\n<a name=\"132\" href=\"#132\">132</a>                 }\n<a name=\"133\" href=\"#133\">133</a>                 <strong>else</strong>\n<a name=\"134\" href=\"#134\">134</a>                 {\n<a name=\"135\" href=\"#135\">135</a>                     revokeMethod(path, methods[j], role);\n<a name=\"136\" href=\"#136\">136</a>                 }\n<a name=\"137\" href=\"#137\">137</a>             }\n<a name=\"138\" href=\"#138\">138</a>         }\n<a name=\"139\" href=\"#139\">139</a> \n<a name=\"140\" href=\"#140\">140</a>         levels.put(path + role, securityLevel);\n<a name=\"141\" href=\"#141\">141</a>     }\n<a name=\"142\" href=\"#142\">142</a> \n<a name=\"143\" href=\"#143\">143</a>     <em>/**<em>*</em></em>\n<a name=\"144\" href=\"#144\">144</a> <em>     * TODO</em>\n<a name=\"145\" href=\"#145\">145</a> <em>     *</em>\n<a name=\"146\" href=\"#146\">146</a> <em>     * @param path TODO</em>\n<a name=\"147\" href=\"#147\">147</a> <em>     * @param role TODO</em>\n<a name=\"148\" href=\"#148\">148</a> <em>     *</em>\n<a name=\"149\" href=\"#149\">149</a> <em>     * @return TODO</em>\n<a name=\"150\" href=\"#150\">150</a> <em>     */</em>\n<a name=\"151\" href=\"#151\">151</a>     <strong>public</strong> String getSecurityLevel(String path, String role)\n<a name=\"152\" href=\"#152\">152</a>     {\n<a name=\"153\" href=\"#153\">153</a>         String ret = (String)levels.get(path + role);\n<a name=\"154\" href=\"#154\">154</a> \n<a name=\"155\" href=\"#155\">155</a>         <strong>if</strong>(ret == <strong>null</strong>)\n<a name=\"156\" href=\"#156\">156</a>         {\n<a name=\"157\" href=\"#157\">157</a>             ret = SwirlSecurity.HIDDEN;\n<a name=\"158\" href=\"#158\">158</a>             setSecurityLevel(path, role, ret);\n<a name=\"159\" href=\"#159\">159</a>         }\n<a name=\"160\" href=\"#160\">160</a> \n<a name=\"161\" href=\"#161\">161</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"162\" href=\"#162\">162</a>         {\n<a name=\"163\" href=\"#163\">163</a>             log.debug(<span class=\"string\">\"getSecurityLevel(\"</span> + path + <span class=\"string\">\", \"</span> + role + <span class=\"string\">\"): \"</span> + ret);\n<a name=\"164\" href=\"#164\">164</a>         }\n<a name=\"165\" href=\"#165\">165</a> \n<a name=\"166\" href=\"#166\">166</a>         <strong>return</strong> ret;\n<a name=\"167\" href=\"#167\">167</a>     }\n<a name=\"168\" href=\"#168\">168</a> \n<a name=\"169\" href=\"#169\">169</a>     <em>/**<em>*</em></em>\n<a name=\"170\" href=\"#170\">170</a> <em>     * TODO</em>\n<a name=\"171\" href=\"#171\">171</a> <em>     *</em>\n<a name=\"172\" href=\"#172\">172</a> <em>     * @param pathInContext TODO</em>\n<a name=\"173\" href=\"#173\">173</a> <em>     * @param pathParams TODO</em>\n<a name=\"174\" href=\"#174\">174</a> <em>     * @param request TODO</em>\n<a name=\"175\" href=\"#175\">175</a> <em>     * @param response TODO</em>\n<a name=\"176\" href=\"#176\">176</a> <em>     *</em>\n<a name=\"177\" href=\"#177\">177</a> <em>     * @throws HttpException TODO</em>\n<a name=\"178\" href=\"#178\">178</a> <em>     * @throws IOException TODO</em>\n<a name=\"179\" href=\"#179\">179</a> <em>     */</em>\n<a name=\"180\" href=\"#180\">180</a>     <strong>public</strong> <strong>void</strong> handle(java.lang.String pathInContext,\n<a name=\"181\" href=\"#181\">181</a>                        java.lang.String pathParams, HttpRequest request,\n<a name=\"182\" href=\"#182\">182</a>                        HttpResponse response) throws HttpException, \n<a name=\"183\" href=\"#183\">183</a>                                                      IOException\n<a name=\"184\" href=\"#184\">184</a>     {\n<a name=\"185\" href=\"#185\">185</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"186\" href=\"#186\">186</a>         {\n<a name=\"187\" href=\"#187\">187</a>             log.debug(<span class=\"string\">\"handle()\\nreq.method: \"</span> + request.getMethod()\n<a name=\"188\" href=\"#188\">188</a>                       + <span class=\"string\">\"\\nreq.path: \"</span> + request.getEncodedPath());\n<a name=\"189\" href=\"#189\">189</a>         }\n<a name=\"190\" href=\"#190\">190</a> \n<a name=\"191\" href=\"#191\">191</a>         <strong>boolean</strong> isMe = NetUtils.isRequestFromMe(request);\n<a name=\"192\" href=\"#192\">192</a> \n<a name=\"193\" href=\"#193\">193</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"194\" href=\"#194\">194</a>         {\n<a name=\"195\" href=\"#195\">195</a>             log.debug(<span class=\"string\">\"isRequestFromMe: \"</span> + isMe);\n<a name=\"196\" href=\"#196\">196</a>         }\n<a name=\"197\" href=\"#197\">197</a> \n<a name=\"198\" href=\"#198\">198</a>         <strong>if</strong>(isMe)\n<a name=\"199\" href=\"#199\">199</a>         {\n<a name=\"200\" href=\"#200\">200</a> \t\t\t<strong>if</strong> (request.getPath().startsWith(PersistenceManager.BACKUPPREFIX)) {\n<a name=\"201\" href=\"#201\">201</a>        \t\t\trequest.setAuthUser(BACKUP);\n<a name=\"202\" href=\"#202\">202</a>        \t\t}\n<a name=\"203\" href=\"#203\">203</a>        \t\t<strong>else</strong> {\t\t\t\t\t\n<a name=\"204\" href=\"#204\">204</a> \t\t\t\trequest.setAuthUser(ME);\n<a name=\"205\" href=\"#205\">205</a>         \t}\n<a name=\"206\" href=\"#206\">206</a>         }\n<a name=\"207\" href=\"#207\">207</a>         <strong>else</strong>\n<a name=\"208\" href=\"#208\">208</a>         {\n<a name=\"209\" href=\"#209\">209</a>             request.setAuthUser(OTHERS);\n<a name=\"210\" href=\"#210\">210</a>         }\n<a name=\"211\" href=\"#211\">211</a> \n<a name=\"212\" href=\"#212\">212</a>         UserPrincipal principal = request.getUserPrincipal();\n<a name=\"213\" href=\"#213\">213</a> \n<a name=\"214\" href=\"#214\">214</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"215\" href=\"#215\">215</a>         {\n<a name=\"216\" href=\"#216\">216</a>             log.debug(<span class=\"string\">\"principal: \"</span> + principal);\n<a name=\"217\" href=\"#217\">217</a>         }\n<a name=\"218\" href=\"#218\">218</a> \n<a name=\"219\" href=\"#219\">219</a>         principal = realm.authenticate(request.getAuthUser(),\n<a name=\"220\" href=\"#220\">220</a>                                        request.getAuthUser(), request);\n<a name=\"221\" href=\"#221\">221</a> \n<a name=\"222\" href=\"#222\">222</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"223\" href=\"#223\">223</a>         {\n<a name=\"224\" href=\"#224\">224</a>             log.debug(<span class=\"string\">\"principal2: \"</span> + principal);\n<a name=\"225\" href=\"#225\">225</a>         }\n<a name=\"226\" href=\"#226\">226</a> \n<a name=\"227\" href=\"#227\">227</a>         request.setUserPrincipal(principal);\n<a name=\"228\" href=\"#228\">228</a> \n<a name=\"229\" href=\"#229\">229</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"230\" href=\"#230\">230</a>         {\n<a name=\"231\" href=\"#231\">231</a>             log.debug(<span class=\"string\">\"req: \\nauthType: \"</span> + request.getAuthType()\n<a name=\"232\" href=\"#232\">232</a>                       + <span class=\"string\">\"\\nauthUser: \"</span> + request.getAuthUser()\n<a name=\"233\" href=\"#233\">233</a>                       + <span class=\"string\">\"\\nuserPrincipal: \"</span> + request.getUserPrincipal()\n<a name=\"234\" href=\"#234\">234</a>                       + <span class=\"string\">\"\\nis in role me: \"</span> + request.isUserInRole(ME)\n<a name=\"235\" href=\"#235\">235</a>                       + <span class=\"string\">\"\\nis in role others: \"</span> + request.isUserInRole(OTHERS));\n<a name=\"236\" href=\"#236\">236</a>         }\n<a name=\"237\" href=\"#237\">237</a> \n<a name=\"238\" href=\"#238\">238</a>         <strong>boolean</strong> methodAllowed = methodAllowed(request.getEncodedPath(),\n<a name=\"239\" href=\"#239\">239</a>                                               request.getMethod(),\n<a name=\"240\" href=\"#240\">240</a>                                               request.getAuthUser());\n<a name=\"241\" href=\"#241\">241</a>         String securityLevel = getSecurityLevel(request.getEncodedPath(),\n<a name=\"242\" href=\"#242\">242</a>                                                 request.getAuthUser());\n<a name=\"243\" href=\"#243\">243</a> \n<a name=\"244\" href=\"#244\">244</a>         <strong>if</strong>(!methodAllowed)\n<a name=\"245\" href=\"#245\">245</a>         {\n<a name=\"246\" href=\"#246\">246</a>             response.setStatus(403);\n<a name=\"247\" href=\"#247\">247</a>             response.setReason(<span class=\"string\">\"The method \"</span> + request.getMethod()\n<a name=\"248\" href=\"#248\">248</a>                                + <span class=\"string\">\" is not allowed for user \"</span>\n<a name=\"249\" href=\"#249\">249</a>                                + request.getAuthUser());\n<a name=\"250\" href=\"#250\">250</a>             request.setHandled(<strong>true</strong>);\n<a name=\"251\" href=\"#251\">251</a>         }\n<a name=\"252\" href=\"#252\">252</a>     }\n<a name=\"253\" href=\"#253\">253</a> \n<a name=\"254\" href=\"#254\">254</a>     <em>/**<em>*</em></em>\n<a name=\"255\" href=\"#255\">255</a> <em>     * TODO</em>\n<a name=\"256\" href=\"#256\">256</a> <em>     *</em>\n<a name=\"257\" href=\"#257\">257</a> <em>     * @param context TODO</em>\n<a name=\"258\" href=\"#258\">258</a> <em>     */</em>\n<a name=\"259\" href=\"#259\">259</a>     <strong>public</strong> <strong>void</strong> initialize(HttpContext context)\n<a name=\"260\" href=\"#260\">260</a>     {\n<a name=\"261\" href=\"#261\">261</a>         <strong>super</strong>.initialize(context);\n<a name=\"262\" href=\"#262\">262</a> \n<a name=\"263\" href=\"#263\">263</a>         HttpContext swirl = context.getHttpServer().getContext(<span class=\"string\">\"/swirl\"</span>);\n<a name=\"264\" href=\"#264\">264</a>         swirl.setAttribute(KEY, <strong>this</strong>);\n<a name=\"265\" href=\"#265\">265</a>         \n<a name=\"266\" href=\"#266\">266</a> \t\tWebApplicationContext webContext = (WebApplicationContext)context;\n<a name=\"267\" href=\"#267\">267</a> \t\t\n<a name=\"268\" href=\"#268\">268</a> \t\t<em class=\"comment\">// to be thread-safe - wrapped up with synchronize</em>\n<a name=\"269\" href=\"#269\">269</a> \t\tList updateList = Collections.synchronizedList(<strong>new</strong> ArrayList(50));\n<a name=\"270\" href=\"#270\">270</a> \t\t\n<a name=\"271\" href=\"#271\">271</a> \t\twebContext.setAttribute(<span class=\"string\">\"update.list\"</span>, updateList);\n<a name=\"272\" href=\"#272\">272</a> \t\t<strong>if</strong>(log.isDebugEnabled()) {\n<a name=\"273\" href=\"#273\">273</a> \t\t\tlog.debug(<span class=\"string\">\"updateList: \"</span> + updateList);\n<a name=\"274\" href=\"#274\">274</a> \t\t}\n<a name=\"275\" href=\"#275\">275</a> \t\tswirl.setAttribute(<span class=\"string\">\"update.list\"</span>, updateList);\n<a name=\"276\" href=\"#276\">276</a> \t\t\n<a name=\"277\" href=\"#277\">277</a> \t\tObject\tupdateListMutex = <strong>new</strong> Object();\n<a name=\"278\" href=\"#278\">278</a> \t\twebContext.setAttribute(<span class=\"string\">\"updateListMutex\"</span>, updateListMutex);\n<a name=\"279\" href=\"#279\">279</a> \t\tswirl.setAttribute(<span class=\"string\">\"updateListMutex\"</span>, updateListMutex);\n<a name=\"280\" href=\"#280\">280</a> \t\t\n<a name=\"281\" href=\"#281\">281</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"282\" href=\"#282\">282</a>         {\n<a name=\"283\" href=\"#283\">283</a>             log.debug(<span class=\"string\">\"initialize()\"</span>);\n<a name=\"284\" href=\"#284\">284</a>         }\n<a name=\"285\" href=\"#285\">285</a> \n<a name=\"286\" href=\"#286\">286</a>         setSecurityLevel(<span class=\"string\">\"/slide/\"</span>, OTHERS, SwirlSecurity.READ_ONLY);\n<a name=\"287\" href=\"#287\">287</a>         realm = context.getRealm();\n<a name=\"288\" href=\"#288\">288</a> \n<a name=\"289\" href=\"#289\">289</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"290\" href=\"#290\">290</a>         {\n<a name=\"291\" href=\"#291\">291</a>             log.debug(<span class=\"string\">\"realm: \"</span> + realm);\n<a name=\"292\" href=\"#292\">292</a>         }\n<a name=\"293\" href=\"#293\">293</a>     }\n<a name=\"294\" href=\"#294\">294</a> \n<a name=\"295\" href=\"#295\">295</a>     <em>/**<em>*</em></em>\n<a name=\"296\" href=\"#296\">296</a> <em>     * TODO</em>\n<a name=\"297\" href=\"#297\">297</a> <em>     *</em>\n<a name=\"298\" href=\"#298\">298</a> <em>     * @throws Exception TODO</em>\n<a name=\"299\" href=\"#299\">299</a> <em>     */</em>\n<a name=\"300\" href=\"#300\">300</a>     <strong>public</strong> <strong>void</strong> start() throws Exception\n<a name=\"301\" href=\"#301\">301</a>     {\n<a name=\"302\" href=\"#302\">302</a>         <strong>super</strong>.start();\n<a name=\"303\" href=\"#303\">303</a> \n<a name=\"304\" href=\"#304\">304</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"305\" href=\"#305\">305</a>         {\n<a name=\"306\" href=\"#306\">306</a>             log.debug(<span class=\"string\">\"start()\"</span>);\n<a name=\"307\" href=\"#307\">307</a>         }\n<a name=\"308\" href=\"#308\">308</a>     }\n<a name=\"309\" href=\"#309\">309</a> \n<a name=\"310\" href=\"#310\">310</a>     <em>/**<em>*</em></em>\n<a name=\"311\" href=\"#311\">311</a> <em>     * TODO</em>\n<a name=\"312\" href=\"#312\">312</a> <em>     *</em>\n<a name=\"313\" href=\"#313\">313</a> <em>     * @param path TODO</em>\n<a name=\"314\" href=\"#314\">314</a> <em>     * @param method TODO</em>\n<a name=\"315\" href=\"#315\">315</a> <em>     * @param role TODO</em>\n<a name=\"316\" href=\"#316\">316</a> <em>     */</em>\n<a name=\"317\" href=\"#317\">317</a>     <strong>private</strong> <strong>void</strong> grantMethod(String path, String method, String role)\n<a name=\"318\" href=\"#318\">318</a>     {\n<a name=\"319\" href=\"#319\">319</a>         permissions.add(path + method + role);\n<a name=\"320\" href=\"#320\">320</a>     }\n<a name=\"321\" href=\"#321\">321</a> \n<a name=\"322\" href=\"#322\">322</a>     <em>/**<em>*</em></em>\n<a name=\"323\" href=\"#323\">323</a> <em>     * TODO</em>\n<a name=\"324\" href=\"#324\">324</a> <em>     *</em>\n<a name=\"325\" href=\"#325\">325</a> <em>     * @param path TODO</em>\n<a name=\"326\" href=\"#326\">326</a> <em>     * @param method TODO</em>\n<a name=\"327\" href=\"#327\">327</a> <em>     * @param role TODO</em>\n<a name=\"328\" href=\"#328\">328</a> <em>     *</em>\n<a name=\"329\" href=\"#329\">329</a> <em>     * @return TODO</em>\n<a name=\"330\" href=\"#330\">330</a> <em>     */</em>\n<a name=\"331\" href=\"#331\">331</a>     <strong>private</strong> <strong>boolean</strong> methodAllowed(String path, String method, String role)\n<a name=\"332\" href=\"#332\">332</a>     {\n<a name=\"333\" href=\"#333\">333</a>         <strong>boolean</strong> ret;\n<a name=\"334\" href=\"#334\">334</a> \n<a name=\"335\" href=\"#335\">335</a>         <strong>if</strong>(ME.equals(role))\n<a name=\"336\" href=\"#336\">336</a>         {\n<a name=\"337\" href=\"#337\">337</a>             ret = <strong>true</strong>;\n<a name=\"338\" href=\"#338\">338</a>         }\n<a name=\"339\" href=\"#339\">339</a>         <strong>else</strong> <strong>if</strong>((path.equals(<span class=\"string\">\"/slide\"</span>) || path.equals(<span class=\"string\">\"/slide/\"</span>)) &amp;&amp; method.equals(<span class=\"string\">\"PROPFIND\"</span>))\n<a name=\"340\" href=\"#340\">340</a>         {\n<a name=\"341\" href=\"#341\">341</a>         \tret = <strong>true</strong>;\n<a name=\"342\" href=\"#342\">342</a>         }\n<a name=\"343\" href=\"#343\">343</a> \t\t<strong>else</strong> <strong>if</strong> (path.startsWith(PersistenceManager.BACKUPPREFIX) &amp;&amp; BACKUP.equals(role)){\n<a name=\"344\" href=\"#344\">344</a>         \tret = <strong>true</strong>;\n<a name=\"345\" href=\"#345\">345</a>         }\n<a name=\"346\" href=\"#346\">346</a>         <strong>else</strong>\n<a name=\"347\" href=\"#347\">347</a>         {\n<a name=\"348\" href=\"#348\">348</a>             ret = permissions.contains(path + method + role);\n<a name=\"349\" href=\"#349\">349</a>         }\n<a name=\"350\" href=\"#350\">350</a> \n<a name=\"351\" href=\"#351\">351</a>         <strong>if</strong>(log.isDebugEnabled())\n<a name=\"352\" href=\"#352\">352</a>         {\n<a name=\"353\" href=\"#353\">353</a>             log.debug(<span class=\"string\">\"methodAllowed(\"</span> + path + <span class=\"string\">\", \"</span> + method + <span class=\"string\">\", \"</span> + role\n<a name=\"354\" href=\"#354\">354</a>                       + <span class=\"string\">\"): \"</span> + ret);\n<a name=\"355\" href=\"#355\">355</a>         }\n<a name=\"356\" href=\"#356\">356</a> \n<a name=\"357\" href=\"#357\">357</a>         <strong>return</strong> ret;\n<a name=\"358\" href=\"#358\">358</a>     }\n<a name=\"359\" href=\"#359\">359</a> \n<a name=\"360\" href=\"#360\">360</a>     <em>/**<em>*</em></em>\n<a name=\"361\" href=\"#361\">361</a> <em>     * TODO</em>\n<a name=\"362\" href=\"#362\">362</a> <em>     *</em>\n<a name=\"363\" href=\"#363\">363</a> <em>     * @param path TODO</em>\n<a name=\"364\" href=\"#364\">364</a> <em>     * @param method TODO</em>\n<a name=\"365\" href=\"#365\">365</a> <em>     * @param role TODO</em>\n<a name=\"366\" href=\"#366\">366</a> <em>     */</em>\n<a name=\"367\" href=\"#367\">367</a>     <strong>private</strong> <strong>void</strong> revokeMethod(String path, String method, String role)\n<a name=\"368\" href=\"#368\">368</a>     {\n<a name=\"369\" href=\"#369\">369</a>         permissions.remove(path + method + role);\n<a name=\"370\" href=\"#370\">370</a>     }\n<a name=\"371\" href=\"#371\">371</a> }\n</pre>\n<hr/><div id=\"footer\">This page was automatically generated by <a href=\"http://maven.apache.org/\">Maven</a></div></body>\n</html>\n\n", "id": 32984.0}