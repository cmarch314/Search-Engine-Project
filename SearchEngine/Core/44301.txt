{"text": "Search LoginPreferencesHelp GuideAbout Trac WikiTimelineRoadmapBrowse SourceView TicketsSearch Context Navigation BlameRevision Log source nomatic tags NomaticIM 5 buddy bots src zope interface advice py View diff against View revision Visit trunk Last change on this file was 712 checked in by cbaker 7 years ago First draft of nomatic buddy bots oscar bot is functional if you give it good authentication credentials jabber bot is just an example from the web File size 6 8 KB Line 1 2 3 Copyright c 2 3 Zope Corporation and Contributors 4 All Rights Reserved 5 6 This software is subject to the provisions of the Zope Public License 7 Version 2 1 ZPL A copy of the ZPL should accompany this distribution 8 THIS SOFTWARE IS PROVIDED AS IS AND ANY AND ALL EXPRESS OR IMPLIED9 WARRANTIES ARE DISCLAIMED INCLUDING BUT NOT LIMITED TO THE IMPLIED1 WARRANTIES OF TITLE MERCHANTABILITY AGAINST INFRINGEMENT AND FITNESS11 FOR A PARTICULAR PURPOSE 12 13 14 Class advice 1516This module was adapted from protocols advice part of the Python17Enterprise Application Kit PEAK Please notify the PEAK authors18 pje telecommunity com and tsarna sarna org if bugs are found or19Zope specific changes are required so that the PEAK version of this module2 can be kept in sync 2122PEAK is a Python application framework that interoperates with but does23not require Zope 3 and Twisted It provides tools for manipulating UML24models object relational persistence aspect oriented programming and more 25Visit the PEAK home page at http peak telecommunity com for more information 2627 Id advice py 25177 2 4 6 2 13 17 31Z jim 28 293 from types import ClassType FunctionType31import sys3233def getFrameInfo frame 34 Return kind module locals globals for a frame3536 kind is one of exec module class function call or unknown 37 3839 f locals frame f locals4 f globals frame f globals4142 sameNamespace f locals is f globals43 hasModule module in f locals44 hasName name in f globals4546 sameName hasModule and hasName47 sameName sameName and f globals name f locals module 4849 module hasName and sys modules get f globals name or None5 51 namespaceIsModule module and module dict is f globals5253 if not namespaceIsModule 54 some kind of funky exec55 kind exec 56 elif sameNamespace and not hasModule 57 kind module 58 elif sameName and not sameNamespace 59 kind class 6 elif not sameNamespace 61 kind function call 62 else 63 How can you have f locals is f globals and have module set 64 This is probably module level code but with a module variable 65 kind unknown 66 return kind module f locals f globals676869def addClassAdvisor callback depth 2 7 Set up callback to be passed the containing class upon creation7172 This function is designed to be called by an advising function executed73 in a class suite The advising function supplies a callback that it74 wishes to have executed when the containing class is created The75 callback will be given one argument the newly created containing class 76 The return value of the callback will be used in place of the class so77 the callback should return the input if it does not wish to replace the78 class 798 The optional depth argument to this function determines the number of81 frames between this function and the targeted class suite depth 82 defaults to 2 since this skips this function s frame and one calling83 function frame If you use this function from a function called directly84 in the class suite the default will be correct otherwise you will need85 to determine the correct depth yourself 8687 This function works by installing a special class factory function in88 place of the metaclass of the containing class Therefore only89 callbacks after the last metaclass assignment in the containing9 class will be executed Be sure that classes using advising functions91 declare any metaclass first to ensure all callbacks are run 9293 frame sys getframe depth 94 kind module caller locals caller globals getFrameInfo frame 9596 This causes a problem when zope interfaces are used from doctest 97 In these cases kind exec 98 99 if kind class 1 raise SyntaxError 1 1 Advice must be in the body of a class statement 1 2 1 31 4 previousMetaclass caller locals get metaclass 1 5 defaultMetaclass caller globals get metaclass ClassType 1 61 71 8 def advise name bases cdict 1 911 if metaclass in cdict 111 del cdict metaclass 112113 if previousMetaclass is None 114 if bases 115 find best metaclass or use global metaclass if no bases116 meta determineMetaclass bases 117 else 118 meta defaultMetaclass11912 elif isClassAdvisor previousMetaclass 121 special case we can t compute the true metaclass here 122 so we need to invoke the previous metaclass and let it123 figure it out for us and apply its own advice in the process 124 meta previousMetaclass125126 else 127 meta determineMetaclass bases previousMetaclass 128129 newClass meta name bases cdict 13 131 this lets the callback replace the class completely if it wants to132 return callback newClass 133134 introspection data only not used by inner function135 advise previousMetaclass previousMetaclass136 advise callback callback137138 install the advisor139 caller locals metaclass advise14 141142def isClassAdvisor ob 143 True if ob is a class advisor function 144 return isinstance ob FunctionType and hasattr ob previousMetaclass 145146147def determineMetaclass bases explicit mc None 148 Determine metaclass from 1 bases and optional explicit metaclass 14915 meta getattr b class type b for b in bases 151152 if explicit mc is not None 153 The explicit metaclass needs to be verified for compatibility154 as well and allowed to resolve the incompatible bases if any155 meta append explicit mc 156157 if len meta 1 158 easy case159 return meta 16 161 candidates minimalBases meta minimal set of metaclasses162163 if not candidates 164 they re all classic classes165 return ClassType166167 elif len candidates 1 168 We could auto combine but for now we won t 169 raise TypeError Incompatible metatypes bases 17 171 Just one return it172 return candidates 173174175def minimalBases classes 176 Reduce a list of base classes to its ordered minimum equivalent 177178 classes c for c in classes if c is not ClassType 179 candidates 18 181 for m in classes 182 for n in classes 183 if issubclass n m and m is not n 184 break185 else 186 m has no subclasses in classes 187 if m in candidates 188 candidates remove m ensure that we re later in the list189 candidates append m 19 191 return candidates192 Note See TracBrowser for help on using the repository browser Download in other formats Plain Text Original Format Powered by Trac 1 1 By Edgewall Software All content copyright 2 7 2 8 by LUCI http luci ics uci edu ", "_id": "http://djp3-pc2.ics.uci.edu/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py", "title": "\n      advice.py in nomatic/tags/nomaticim-0.0.5/buddy_bots/src/zope/interface\n     \u2013 nomatic*im\n    ", "html": "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n  \n  \n\n  \n\n\n  <head>\n\t\t<title>\n      advice.py in nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface\n     \u2013 Nomatic*IM\n    </title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" /><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" /><link rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search\" /><link rel=\"help\" href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py?format=txt\" type=\"text/plain\" title=\"Plain Text\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py\" type=\"application/x-python; charset=iso-8859-15\" title=\"Original Format\" /><link rel=\"start\" href=\"/LUCICodeRepository/nomaticIM/wiki\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/code.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/pygments/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/browser.css\" type=\"text/css\" /><link rel=\"shortcut icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link rel=\"icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link type=\"application/opensearchdescription+xml\" rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search/opensearch\" title=\"Search Nomatic*IM\" /><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/jquery.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/babel.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/messages/en_US.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/trac.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/search.js\"></script><script type=\"text/javascript\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/folding.js\"></script><script type=\"text/javascript\">\n      jQuery(document).ready(function($) {\n        $(\".trac-toggledeleted\").show().click(function() {\n                  $(this).siblings().find(\".trac-deleted\").toggle();\n                  return false;\n        }).click();\n        $(\"#jumploc input\").hide();\n        $(\"#jumploc select\").change(function () {\n          this.parentNode.parentNode.submit();\n        });\n          $('#preview table.code').enableCollapsibleColumns($('#preview table.code thead th.content'));\n      });\n    </script>\n\t</head>\n  <body>\n    <div id=\"banner\">\n      <div id=\"header\">\n        <a id=\"logo\" href=\"http://luci.ics.uci.edu/#code\"><img src=\"http://luci.ics.uci.edu/blog/archives/LUCIhorzTight.jpg\" alt=\"LUCI Code Repository\" /></a>\n      </div>\n      <form id=\"search\" action=\"/LUCICodeRepository/nomaticIM/search\" method=\"get\">\n        <div>\n          <label for=\"proj-search\">Search:</label>\n          <input type=\"text\" id=\"proj-search\" name=\"q\" size=\"18\" value=\"\" />\n          <input type=\"submit\" value=\"Search\" />\n        </div>\n      </form>\n      <div id=\"metanav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/login\">Login</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/prefs\">Preferences</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\">Help/Guide</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/about\">About Trac</a></li>\n    </ul>\n  </div>\n    </div>\n    <div id=\"mainnav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/wiki\">Wiki</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/timeline\">Timeline</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/roadmap\">Roadmap</a></li><li class=\"active\"><a href=\"/LUCICodeRepository/nomaticIM/browser\">Browse Source</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/report\">View Tickets</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/search\">Search</a></li>\n    </ul>\n  </div>\n    <div id=\"main\">\n      <div id=\"ctxtnav\" class=\"nav\">\n        <h2>Context Navigation</h2>\n        <ul>\n          <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/trunk/buddy_bots/zope/interface/advice.py?annotate=blame\" title=\"Annotate each line with the last changed revision (this can be time consuming...)\">Blame</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/log/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py\">Revision Log</a></li>\n        </ul>\n        <hr />\n      </div>\n    <div id=\"content\" class=\"browser\">\n        <h1>\n          \n<a class=\"pathentry first\" href=\"/LUCICodeRepository/nomaticIM/browser?order=name\" title=\"Go to repository root\">source:</a>\n<a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic?order=name\" title=\"View nomatic\">nomatic</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags?order=name\" title=\"View tags\">tags</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5?order=name\" title=\"View NomaticIM-0.0.5\">NomaticIM-0.0.5</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots?order=name\" title=\"View buddy_bots\">buddy_bots</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src?order=name\" title=\"View src\">src</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope?order=name\" title=\"View zope\">zope</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface?order=name\" title=\"View interface\">interface</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py?order=name\" title=\"View advice.py\">advice.py</a>\n<br style=\"clear: both\" />\n\n        </h1>\n        <div id=\"diffrev\">\n          <form action=\"/LUCICodeRepository/nomaticIM/changeset\" method=\"get\">\n            <div>\n              <label title=\"Show the diff against a specific revision\">\n                View diff against: <input type=\"text\" name=\"old\" size=\"6\" />\n                <input type=\"hidden\" name=\"old_path\" value=\"nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py\" />\n                <input type=\"hidden\" name=\"new\" />\n                <input type=\"hidden\" name=\"new_path\" value=\"nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py\" />\n              </label>\n            </div>\n          </form>\n        </div>\n        <div id=\"jumprev\">\n          <form action=\"\" method=\"get\">\n            <div>\n              <label for=\"rev\">\n                View revision:</label>\n              <input type=\"text\" id=\"rev\" name=\"rev\" size=\"6\" />\n            </div>\n          </form>\n        </div>\n        <div id=\"jumploc\">\n          <form action=\"\" method=\"get\">\n            <div class=\"buttons\">\n              <label for=\"preselected\">Visit:</label>\n              <select id=\"preselected\" name=\"preselected\">\n                <option selected=\"selected\"></option>\n                <optgroup label=\"branches\">\n                  <option value=\"/LUCICodeRepository/nomaticIM/browser/trunk\">trunk</option>\n                </optgroup>\n              </select>\n              <input type=\"submit\" value=\"Go!\" title=\"Jump to the chosen preselected path\" />\n            </div>\n          </form>\n        </div>\n        <div class=\"trac-tags\">\n        </div>\n      <table id=\"info\" summary=\"Revision info\">\n        <tr>\n          <th>\n                <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/nomatic/trunk/buddy_bots/zope/interface/advice.py\" title=\"View differences\">Last change</a>\n                  on this file was\n                  <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/\" title=\"View changeset 712\">712</a>,\n                  checked in by cbaker, <a class=\"timeline\" href=\"/LUCICodeRepository/nomaticIM/timeline?from=2008-02-16T08%3A16%3A53-08%3A00&amp;precision=second\" title=\"See timeline at Feb 16, 2008, 8:16:53 AM\">7 years ago</a>\n          </th>\n        </tr>\n        <tr>\n          <td class=\"message searchable\">\n              <p>\nFirst draft of nomatic buddy bots. oscar_bot is functional if you give it good authentication credentials, jabber_bot is just an example from the web <br />\n</p>\n          </td>\n        </tr>\n        <tr><td colspan=\"2\">\n            <strong>File size:</strong>\n            <span title=\"6954 bytes\">6.8 KB</span>\n          </td></tr>\n      </table>\n      <div id=\"preview\" class=\"searchable\">\n        \n  <table class=\"code\"><thead><tr><th class=\"lineno\" title=\"Line numbers\">Line</th><th class=\"content\">\u00a0</th></tr></thead><tbody><tr><th id=\"L1\"><a href=\"#L1\">1</a></th><td><span class=\"c\">##############################################################################</span></td></tr><tr><th id=\"L2\"><a href=\"#L2\">2</a></th><td><span class=\"c\">#</span></td></tr><tr><th id=\"L3\"><a href=\"#L3\">3</a></th><td><span class=\"c\"># Copyright (c) 2003 Zope Corporation and Contributors.</span></td></tr><tr><th id=\"L4\"><a href=\"#L4\">4</a></th><td><span class=\"c\"># All Rights Reserved.</span></td></tr><tr><th id=\"L5\"><a href=\"#L5\">5</a></th><td><span class=\"c\">#</span></td></tr><tr><th id=\"L6\"><a href=\"#L6\">6</a></th><td><span class=\"c\"># This software is subject to the provisions of the Zope Public License,</span></td></tr><tr><th id=\"L7\"><a href=\"#L7\">7</a></th><td><span class=\"c\"># Version 2.1 (ZPL).\u00a0 A copy of the ZPL should accompany this distribution.</span></td></tr><tr><th id=\"L8\"><a href=\"#L8\">8</a></th><td><span class=\"c\"># THIS SOFTWARE IS PROVIDED \"AS IS\" AND ANY AND ALL EXPRESS OR IMPLIED</span></td></tr><tr><th id=\"L9\"><a href=\"#L9\">9</a></th><td><span class=\"c\"># WARRANTIES ARE DISCLAIMED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span></td></tr><tr><th id=\"L10\"><a href=\"#L10\">10</a></th><td><span class=\"c\"># WARRANTIES OF TITLE, MERCHANTABILITY, AGAINST INFRINGEMENT, AND FITNESS</span></td></tr><tr><th id=\"L11\"><a href=\"#L11\">11</a></th><td><span class=\"c\"># FOR A PARTICULAR PURPOSE.</span></td></tr><tr><th id=\"L12\"><a href=\"#L12\">12</a></th><td><span class=\"c\">#</span></td></tr><tr><th id=\"L13\"><a href=\"#L13\">13</a></th><td><span class=\"c\">##############################################################################</span></td></tr><tr><th id=\"L14\"><a href=\"#L14\">14</a></th><td><span class=\"sd\">\"\"\"Class advice.</span></td></tr><tr><th id=\"L15\"><a href=\"#L15\">15</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L16\"><a href=\"#L16\">16</a></th><td><span class=\"sd\">This module was adapted from 'protocols.advice', part of the Python</span></td></tr><tr><th id=\"L17\"><a href=\"#L17\">17</a></th><td><span class=\"sd\">Enterprise Application Kit (PEAK).\u00a0 Please notify the PEAK authors</span></td></tr><tr><th id=\"L18\"><a href=\"#L18\">18</a></th><td><span class=\"sd\">(pje@telecommunity.com and tsarna@sarna.org) if bugs are found or</span></td></tr><tr><th id=\"L19\"><a href=\"#L19\">19</a></th><td><span class=\"sd\">Zope-specific changes are required, so that the PEAK version of this module</span></td></tr><tr><th id=\"L20\"><a href=\"#L20\">20</a></th><td><span class=\"sd\">can be kept in sync.</span></td></tr><tr><th id=\"L21\"><a href=\"#L21\">21</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L22\"><a href=\"#L22\">22</a></th><td><span class=\"sd\">PEAK is a Python application framework that interoperates with (but does</span></td></tr><tr><th id=\"L23\"><a href=\"#L23\">23</a></th><td><span class=\"sd\">not require) Zope 3 and Twisted.\u00a0 It provides tools for manipulating UML</span></td></tr><tr><th id=\"L24\"><a href=\"#L24\">24</a></th><td><span class=\"sd\">models, object-relational persistence, aspect-oriented programming, and more.</span></td></tr><tr><th id=\"L25\"><a href=\"#L25\">25</a></th><td><span class=\"sd\">Visit the PEAK home page at http://peak.telecommunity.com for more information.</span></td></tr><tr><th id=\"L26\"><a href=\"#L26\">26</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L27\"><a href=\"#L27\">27</a></th><td><span class=\"sd\">$Id: advice.py 25177 2004-06-02 13:17:31Z jim $</span></td></tr><tr><th id=\"L28\"><a href=\"#L28\">28</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L29\"><a href=\"#L29\">29</a></th><td></td></tr><tr><th id=\"L30\"><a href=\"#L30\">30</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">types</span>\u00a0<span class=\"kn\">import</span>\u00a0ClassType<span class=\"p\">,</span>\u00a0FunctionType</td></tr><tr><th id=\"L31\"><a href=\"#L31\">31</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">sys</span></td></tr><tr><th id=\"L32\"><a href=\"#L32\">32</a></th><td></td></tr><tr><th id=\"L33\"><a href=\"#L33\">33</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">getFrameInfo</span><span class=\"p\">(</span>frame<span class=\"p\">):</span></td></tr><tr><th id=\"L34\"><a href=\"#L34\">34</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Return (kind,module,locals,globals) for a frame</span></td></tr><tr><th id=\"L35\"><a href=\"#L35\">35</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L36\"><a href=\"#L36\">36</a></th><td><span class=\"sd\">\u00a0 \u00a0 'kind' is one of \"exec\", \"module\", \"class\", \"function call\", or \"unknown\".</span></td></tr><tr><th id=\"L37\"><a href=\"#L37\">37</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L38\"><a href=\"#L38\">38</a></th><td></td></tr><tr><th id=\"L39\"><a href=\"#L39\">39</a></th><td>\u00a0 \u00a0 f_locals <span class=\"o\">=</span>\u00a0frame<span class=\"o\">.</span>f_locals</td></tr><tr><th id=\"L40\"><a href=\"#L40\">40</a></th><td>\u00a0 \u00a0 f_globals <span class=\"o\">=</span>\u00a0frame<span class=\"o\">.</span>f_globals</td></tr><tr><th id=\"L41\"><a href=\"#L41\">41</a></th><td></td></tr><tr><th id=\"L42\"><a href=\"#L42\">42</a></th><td>\u00a0 \u00a0 sameNamespace <span class=\"o\">=</span>\u00a0f_locals <span class=\"ow\">is</span>\u00a0f_globals</td></tr><tr><th id=\"L43\"><a href=\"#L43\">43</a></th><td>\u00a0 \u00a0 hasModule <span class=\"o\">=</span>\u00a0<span class=\"s\">'__module__'</span>\u00a0<span class=\"ow\">in</span>\u00a0f_locals</td></tr><tr><th id=\"L44\"><a href=\"#L44\">44</a></th><td>\u00a0 \u00a0 hasName <span class=\"o\">=</span>\u00a0<span class=\"s\">'__name__'</span>\u00a0<span class=\"ow\">in</span>\u00a0f_globals</td></tr><tr><th id=\"L45\"><a href=\"#L45\">45</a></th><td></td></tr><tr><th id=\"L46\"><a href=\"#L46\">46</a></th><td>\u00a0 \u00a0 sameName <span class=\"o\">=</span>\u00a0hasModule <span class=\"ow\">and</span>\u00a0hasName</td></tr><tr><th id=\"L47\"><a href=\"#L47\">47</a></th><td>\u00a0 \u00a0 sameName <span class=\"o\">=</span>\u00a0sameName <span class=\"ow\">and</span>\u00a0f_globals<span class=\"p\">[</span><span class=\"s\">'__name__'</span><span class=\"p\">]</span><span class=\"o\">==</span>f_locals<span class=\"p\">[</span><span class=\"s\">'__module__'</span><span class=\"p\">]</span></td></tr><tr><th id=\"L48\"><a href=\"#L48\">48</a></th><td></td></tr><tr><th id=\"L49\"><a href=\"#L49\">49</a></th><td>\u00a0 \u00a0 module <span class=\"o\">=</span>\u00a0hasName <span class=\"ow\">and</span>\u00a0sys<span class=\"o\">.</span>modules<span class=\"o\">.</span>get<span class=\"p\">(</span>f_globals<span class=\"p\">[</span><span class=\"s\">'__name__'</span><span class=\"p\">])</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L50\"><a href=\"#L50\">50</a></th><td></td></tr><tr><th id=\"L51\"><a href=\"#L51\">51</a></th><td>\u00a0 \u00a0 namespaceIsModule <span class=\"o\">=</span>\u00a0module <span class=\"ow\">and</span>\u00a0module<span class=\"o\">.</span>__dict__ <span class=\"ow\">is</span>\u00a0f_globals</td></tr><tr><th id=\"L52\"><a href=\"#L52\">52</a></th><td></td></tr><tr><th id=\"L53\"><a href=\"#L53\">53</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0namespaceIsModule<span class=\"p\">:</span></td></tr><tr><th id=\"L54\"><a href=\"#L54\">54</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># some kind of funky exec</span></td></tr><tr><th id=\"L55\"><a href=\"#L55\">55</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 kind <span class=\"o\">=</span>\u00a0<span class=\"s\">\"exec\"</span></td></tr><tr><th id=\"L56\"><a href=\"#L56\">56</a></th><td>\u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0sameNamespace <span class=\"ow\">and</span>\u00a0<span class=\"ow\">not</span>\u00a0hasModule<span class=\"p\">:</span></td></tr><tr><th id=\"L57\"><a href=\"#L57\">57</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 kind <span class=\"o\">=</span>\u00a0<span class=\"s\">\"module\"</span></td></tr><tr><th id=\"L58\"><a href=\"#L58\">58</a></th><td>\u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0sameName <span class=\"ow\">and</span>\u00a0<span class=\"ow\">not</span>\u00a0sameNamespace<span class=\"p\">:</span></td></tr><tr><th id=\"L59\"><a href=\"#L59\">59</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 kind <span class=\"o\">=</span>\u00a0<span class=\"s\">\"class\"</span></td></tr><tr><th id=\"L60\"><a href=\"#L60\">60</a></th><td>\u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"ow\">not</span>\u00a0sameNamespace<span class=\"p\">:</span></td></tr><tr><th id=\"L61\"><a href=\"#L61\">61</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 kind <span class=\"o\">=</span>\u00a0<span class=\"s\">\"function call\"</span></td></tr><tr><th id=\"L62\"><a href=\"#L62\">62</a></th><td>\u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L63\"><a href=\"#L63\">63</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># How can you have f_locals is f_globals, and have '__module__' set?</span></td></tr><tr><th id=\"L64\"><a href=\"#L64\">64</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># This is probably module-level code, but with a '__module__' variable.</span></td></tr><tr><th id=\"L65\"><a href=\"#L65\">65</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 kind <span class=\"o\">=</span>\u00a0<span class=\"s\">\"unknown\"</span></td></tr><tr><th id=\"L66\"><a href=\"#L66\">66</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0kind<span class=\"p\">,</span>\u00a0module<span class=\"p\">,</span>\u00a0f_locals<span class=\"p\">,</span>\u00a0f_globals</td></tr><tr><th id=\"L67\"><a href=\"#L67\">67</a></th><td></td></tr><tr><th id=\"L68\"><a href=\"#L68\">68</a></th><td></td></tr><tr><th id=\"L69\"><a href=\"#L69\">69</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">addClassAdvisor</span><span class=\"p\">(</span>callback<span class=\"p\">,</span>\u00a0depth<span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">):</span></td></tr><tr><th id=\"L70\"><a href=\"#L70\">70</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Set up 'callback' to be passed the containing class upon creation</span></td></tr><tr><th id=\"L71\"><a href=\"#L71\">71</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L72\"><a href=\"#L72\">72</a></th><td><span class=\"sd\">\u00a0 \u00a0 This function is designed to be called by an \"advising\" function executed</span></td></tr><tr><th id=\"L73\"><a href=\"#L73\">73</a></th><td><span class=\"sd\">\u00a0 \u00a0 in a class suite.\u00a0 The \"advising\" function supplies a callback that it</span></td></tr><tr><th id=\"L74\"><a href=\"#L74\">74</a></th><td><span class=\"sd\">\u00a0 \u00a0 wishes to have executed when the containing class is created.\u00a0 The</span></td></tr><tr><th id=\"L75\"><a href=\"#L75\">75</a></th><td><span class=\"sd\">\u00a0 \u00a0 callback will be given one argument: the newly created containing class.</span></td></tr><tr><th id=\"L76\"><a href=\"#L76\">76</a></th><td><span class=\"sd\">\u00a0 \u00a0 The return value of the callback will be used in place of the class, so</span></td></tr><tr><th id=\"L77\"><a href=\"#L77\">77</a></th><td><span class=\"sd\">\u00a0 \u00a0 the callback should return the input if it does not wish to replace the</span></td></tr><tr><th id=\"L78\"><a href=\"#L78\">78</a></th><td><span class=\"sd\">\u00a0 \u00a0 class.</span></td></tr><tr><th id=\"L79\"><a href=\"#L79\">79</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L80\"><a href=\"#L80\">80</a></th><td><span class=\"sd\">\u00a0 \u00a0 The optional 'depth' argument to this function determines the number of</span></td></tr><tr><th id=\"L81\"><a href=\"#L81\">81</a></th><td><span class=\"sd\">\u00a0 \u00a0 frames between this function and the targeted class suite.\u00a0 'depth'</span></td></tr><tr><th id=\"L82\"><a href=\"#L82\">82</a></th><td><span class=\"sd\">\u00a0 \u00a0 defaults to 2, since this skips this function's frame and one calling</span></td></tr><tr><th id=\"L83\"><a href=\"#L83\">83</a></th><td><span class=\"sd\">\u00a0 \u00a0 function frame.\u00a0 If you use this function from a function called directly</span></td></tr><tr><th id=\"L84\"><a href=\"#L84\">84</a></th><td><span class=\"sd\">\u00a0 \u00a0 in the class suite, the default will be correct, otherwise you will need</span></td></tr><tr><th id=\"L85\"><a href=\"#L85\">85</a></th><td><span class=\"sd\">\u00a0 \u00a0 to determine the correct depth yourself.</span></td></tr><tr><th id=\"L86\"><a href=\"#L86\">86</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L87\"><a href=\"#L87\">87</a></th><td><span class=\"sd\">\u00a0 \u00a0 This function works by installing a special class factory function in</span></td></tr><tr><th id=\"L88\"><a href=\"#L88\">88</a></th><td><span class=\"sd\">\u00a0 \u00a0 place of the '__metaclass__' of the containing class.\u00a0 Therefore, only</span></td></tr><tr><th id=\"L89\"><a href=\"#L89\">89</a></th><td><span class=\"sd\">\u00a0 \u00a0 callbacks *after* the last '__metaclass__' assignment in the containing</span></td></tr><tr><th id=\"L90\"><a href=\"#L90\">90</a></th><td><span class=\"sd\">\u00a0 \u00a0 class will be executed.\u00a0 Be sure that classes using \"advising\" functions</span></td></tr><tr><th id=\"L91\"><a href=\"#L91\">91</a></th><td><span class=\"sd\">\u00a0 \u00a0 declare any '__metaclass__' *first*, to ensure all callbacks are run.\"\"\"</span></td></tr><tr><th id=\"L92\"><a href=\"#L92\">92</a></th><td></td></tr><tr><th id=\"L93\"><a href=\"#L93\">93</a></th><td>\u00a0 \u00a0 frame <span class=\"o\">=</span>\u00a0sys<span class=\"o\">.</span>_getframe<span class=\"p\">(</span>depth<span class=\"p\">)</span></td></tr><tr><th id=\"L94\"><a href=\"#L94\">94</a></th><td>\u00a0 \u00a0 kind<span class=\"p\">,</span>\u00a0module<span class=\"p\">,</span>\u00a0caller_locals<span class=\"p\">,</span>\u00a0caller_globals <span class=\"o\">=</span>\u00a0getFrameInfo<span class=\"p\">(</span>frame<span class=\"p\">)</span></td></tr><tr><th id=\"L95\"><a href=\"#L95\">95</a></th><td></td></tr><tr><th id=\"L96\"><a href=\"#L96\">96</a></th><td>\u00a0 \u00a0 <span class=\"c\"># This causes a problem when zope interfaces are used from doctest.</span></td></tr><tr><th id=\"L97\"><a href=\"#L97\">97</a></th><td>\u00a0 \u00a0 <span class=\"c\"># In these cases, kind == \"exec\".</span></td></tr><tr><th id=\"L98\"><a href=\"#L98\">98</a></th><td>\u00a0 \u00a0 <span class=\"c\">#</span></td></tr><tr><th id=\"L99\"><a href=\"#L99\">99</a></th><td>\u00a0 \u00a0 <span class=\"c\">#if kind != \"class\":</span></td></tr><tr><th id=\"L100\"><a href=\"#L100\">100</a></th><td>\u00a0 \u00a0 <span class=\"c\">#\u00a0 \u00a0 raise SyntaxError(</span></td></tr><tr><th id=\"L101\"><a href=\"#L101\">101</a></th><td>\u00a0 \u00a0 <span class=\"c\">#\u00a0 \u00a0 \u00a0 \u00a0 \"Advice must be in the body of a class statement\"</span></td></tr><tr><th id=\"L102\"><a href=\"#L102\">102</a></th><td>\u00a0 \u00a0 <span class=\"c\">#\u00a0 \u00a0 )</span></td></tr><tr><th id=\"L103\"><a href=\"#L103\">103</a></th><td></td></tr><tr><th id=\"L104\"><a href=\"#L104\">104</a></th><td>\u00a0 \u00a0 previousMetaclass <span class=\"o\">=</span>\u00a0caller_locals<span class=\"o\">.</span>get<span class=\"p\">(</span><span class=\"s\">'__metaclass__'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L105\"><a href=\"#L105\">105</a></th><td>\u00a0 \u00a0 defaultMetaclass\u00a0 <span class=\"o\">=</span>\u00a0caller_globals<span class=\"o\">.</span>get<span class=\"p\">(</span><span class=\"s\">'__metaclass__'</span><span class=\"p\">,</span>\u00a0ClassType<span class=\"p\">)</span></td></tr><tr><th id=\"L106\"><a href=\"#L106\">106</a></th><td></td></tr><tr><th id=\"L107\"><a href=\"#L107\">107</a></th><td></td></tr><tr><th id=\"L108\"><a href=\"#L108\">108</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">advise</span><span class=\"p\">(</span>name<span class=\"p\">,</span>\u00a0bases<span class=\"p\">,</span>\u00a0cdict<span class=\"p\">):</span></td></tr><tr><th id=\"L109\"><a href=\"#L109\">109</a></th><td></td></tr><tr><th id=\"L110\"><a href=\"#L110\">110</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"s\">'__metaclass__'</span>\u00a0<span class=\"ow\">in</span>\u00a0cdict<span class=\"p\">:</span></td></tr><tr><th id=\"L111\"><a href=\"#L111\">111</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">del</span>\u00a0cdict<span class=\"p\">[</span><span class=\"s\">'__metaclass__'</span><span class=\"p\">]</span></td></tr><tr><th id=\"L112\"><a href=\"#L112\">112</a></th><td></td></tr><tr><th id=\"L113\"><a href=\"#L113\">113</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0previousMetaclass <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L114\"><a href=\"#L114\">114</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"k\">if</span>\u00a0bases<span class=\"p\">:</span></td></tr><tr><th id=\"L115\"><a href=\"#L115\">115</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"c\"># find best metaclass or use global __metaclass__ if no bases</span></td></tr><tr><th id=\"L116\"><a href=\"#L116\">116</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0meta <span class=\"o\">=</span>\u00a0determineMetaclass<span class=\"p\">(</span>bases<span class=\"p\">)</span></td></tr><tr><th id=\"L117\"><a href=\"#L117\">117</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L118\"><a href=\"#L118\">118</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0meta <span class=\"o\">=</span>\u00a0defaultMetaclass</td></tr><tr><th id=\"L119\"><a href=\"#L119\">119</a></th><td></td></tr><tr><th id=\"L120\"><a href=\"#L120\">120</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0isClassAdvisor<span class=\"p\">(</span>previousMetaclass<span class=\"p\">):</span></td></tr><tr><th id=\"L121\"><a href=\"#L121\">121</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># special case: we can't compute the \"true\" metaclass here,</span></td></tr><tr><th id=\"L122\"><a href=\"#L122\">122</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># so we need to invoke the previous metaclass and let it</span></td></tr><tr><th id=\"L123\"><a href=\"#L123\">123</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># figure it out for us (and apply its own advice in the process)</span></td></tr><tr><th id=\"L124\"><a href=\"#L124\">124</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 meta <span class=\"o\">=</span>\u00a0previousMetaclass</td></tr><tr><th id=\"L125\"><a href=\"#L125\">125</a></th><td></td></tr><tr><th id=\"L126\"><a href=\"#L126\">126</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L127\"><a href=\"#L127\">127</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 meta <span class=\"o\">=</span>\u00a0determineMetaclass<span class=\"p\">(</span>bases<span class=\"p\">,</span>\u00a0previousMetaclass<span class=\"p\">)</span></td></tr><tr><th id=\"L128\"><a href=\"#L128\">128</a></th><td></td></tr><tr><th id=\"L129\"><a href=\"#L129\">129</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 newClass <span class=\"o\">=</span>\u00a0meta<span class=\"p\">(</span>name<span class=\"p\">,</span>bases<span class=\"p\">,</span>cdict<span class=\"p\">)</span></td></tr><tr><th id=\"L130\"><a href=\"#L130\">130</a></th><td></td></tr><tr><th id=\"L131\"><a href=\"#L131\">131</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># this lets the callback replace the class completely, if it wants to</span></td></tr><tr><th id=\"L132\"><a href=\"#L132\">132</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0callback<span class=\"p\">(</span>newClass<span class=\"p\">)</span></td></tr><tr><th id=\"L133\"><a href=\"#L133\">133</a></th><td></td></tr><tr><th id=\"L134\"><a href=\"#L134\">134</a></th><td>\u00a0 \u00a0 <span class=\"c\"># introspection data only, not used by inner function</span></td></tr><tr><th id=\"L135\"><a href=\"#L135\">135</a></th><td>\u00a0 \u00a0 advise<span class=\"o\">.</span>previousMetaclass <span class=\"o\">=</span>\u00a0previousMetaclass</td></tr><tr><th id=\"L136\"><a href=\"#L136\">136</a></th><td>\u00a0 \u00a0 advise<span class=\"o\">.</span>callback <span class=\"o\">=</span>\u00a0callback</td></tr><tr><th id=\"L137\"><a href=\"#L137\">137</a></th><td></td></tr><tr><th id=\"L138\"><a href=\"#L138\">138</a></th><td>\u00a0 \u00a0 <span class=\"c\"># install the advisor</span></td></tr><tr><th id=\"L139\"><a href=\"#L139\">139</a></th><td>\u00a0 \u00a0 caller_locals<span class=\"p\">[</span><span class=\"s\">'__metaclass__'</span><span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0advise</td></tr><tr><th id=\"L140\"><a href=\"#L140\">140</a></th><td></td></tr><tr><th id=\"L141\"><a href=\"#L141\">141</a></th><td></td></tr><tr><th id=\"L142\"><a href=\"#L142\">142</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">isClassAdvisor</span><span class=\"p\">(</span>ob<span class=\"p\">):</span></td></tr><tr><th id=\"L143\"><a href=\"#L143\">143</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"True if 'ob' is a class advisor function\"\"\"</span></td></tr><tr><th id=\"L144\"><a href=\"#L144\">144</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>ob<span class=\"p\">,</span>FunctionType<span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>ob<span class=\"p\">,</span><span class=\"s\">'previousMetaclass'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L145\"><a href=\"#L145\">145</a></th><td></td></tr><tr><th id=\"L146\"><a href=\"#L146\">146</a></th><td></td></tr><tr><th id=\"L147\"><a href=\"#L147\">147</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">determineMetaclass</span><span class=\"p\">(</span>bases<span class=\"p\">,</span>\u00a0explicit_mc<span class=\"o\">=</span><span class=\"bp\">None</span><span class=\"p\">):</span></td></tr><tr><th id=\"L148\"><a href=\"#L148\">148</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Determine metaclass from 1+ bases and optional explicit __metaclass__\"\"\"</span></td></tr><tr><th id=\"L149\"><a href=\"#L149\">149</a></th><td></td></tr><tr><th id=\"L150\"><a href=\"#L150\">150</a></th><td>\u00a0 \u00a0 meta <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"nb\">getattr</span><span class=\"p\">(</span>b<span class=\"p\">,</span><span class=\"s\">'__class__'</span><span class=\"p\">,</span><span class=\"nb\">type</span><span class=\"p\">(</span>b<span class=\"p\">))</span>\u00a0<span class=\"k\">for</span>\u00a0b <span class=\"ow\">in</span>\u00a0bases<span class=\"p\">]</span></td></tr><tr><th id=\"L151\"><a href=\"#L151\">151</a></th><td></td></tr><tr><th id=\"L152\"><a href=\"#L152\">152</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0explicit_mc <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L153\"><a href=\"#L153\">153</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># The explicit metaclass needs to be verified for compatibility</span></td></tr><tr><th id=\"L154\"><a href=\"#L154\">154</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># as well, and allowed to resolve the incompatible bases, if any</span></td></tr><tr><th id=\"L155\"><a href=\"#L155\">155</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 meta<span class=\"o\">.</span>append<span class=\"p\">(</span>explicit_mc<span class=\"p\">)</span></td></tr><tr><th id=\"L156\"><a href=\"#L156\">156</a></th><td></td></tr><tr><th id=\"L157\"><a href=\"#L157\">157</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>meta<span class=\"p\">)</span><span class=\"o\">==</span><span class=\"mi\">1</span><span class=\"p\">:</span></td></tr><tr><th id=\"L158\"><a href=\"#L158\">158</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># easy case</span></td></tr><tr><th id=\"L159\"><a href=\"#L159\">159</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0meta<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span></td></tr><tr><th id=\"L160\"><a href=\"#L160\">160</a></th><td></td></tr><tr><th id=\"L161\"><a href=\"#L161\">161</a></th><td>\u00a0 \u00a0 candidates <span class=\"o\">=</span>\u00a0minimalBases<span class=\"p\">(</span>meta<span class=\"p\">)</span>\u00a0<span class=\"c\"># minimal set of metaclasses</span></td></tr><tr><th id=\"L162\"><a href=\"#L162\">162</a></th><td></td></tr><tr><th id=\"L163\"><a href=\"#L163\">163</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0candidates<span class=\"p\">:</span></td></tr><tr><th id=\"L164\"><a href=\"#L164\">164</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># they're all \"classic\" classes</span></td></tr><tr><th id=\"L165\"><a href=\"#L165\">165</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0ClassType</td></tr><tr><th id=\"L166\"><a href=\"#L166\">166</a></th><td></td></tr><tr><th id=\"L167\"><a href=\"#L167\">167</a></th><td>\u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>candidates<span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"mi\">1</span><span class=\"p\">:</span></td></tr><tr><th id=\"L168\"><a href=\"#L168\">168</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># We could auto-combine, but for now we won't...</span></td></tr><tr><th id=\"L169\"><a href=\"#L169\">169</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s\">\"Incompatible metatypes\"</span><span class=\"p\">,</span>bases<span class=\"p\">)</span></td></tr><tr><th id=\"L170\"><a href=\"#L170\">170</a></th><td></td></tr><tr><th id=\"L171\"><a href=\"#L171\">171</a></th><td>\u00a0 \u00a0 <span class=\"c\"># Just one, return it</span></td></tr><tr><th id=\"L172\"><a href=\"#L172\">172</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0candidates<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span></td></tr><tr><th id=\"L173\"><a href=\"#L173\">173</a></th><td></td></tr><tr><th id=\"L174\"><a href=\"#L174\">174</a></th><td></td></tr><tr><th id=\"L175\"><a href=\"#L175\">175</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">minimalBases</span><span class=\"p\">(</span>classes<span class=\"p\">):</span></td></tr><tr><th id=\"L176\"><a href=\"#L176\">176</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Reduce a list of base classes to its ordered minimum equivalent\"\"\"</span></td></tr><tr><th id=\"L177\"><a href=\"#L177\">177</a></th><td></td></tr><tr><th id=\"L178\"><a href=\"#L178\">178</a></th><td>\u00a0 \u00a0 classes <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span>c <span class=\"k\">for</span>\u00a0c <span class=\"ow\">in</span>\u00a0classes <span class=\"k\">if</span>\u00a0c <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0ClassType<span class=\"p\">]</span></td></tr><tr><th id=\"L179\"><a href=\"#L179\">179</a></th><td>\u00a0 \u00a0 candidates <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L180\"><a href=\"#L180\">180</a></th><td></td></tr><tr><th id=\"L181\"><a href=\"#L181\">181</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0m <span class=\"ow\">in</span>\u00a0classes<span class=\"p\">:</span></td></tr><tr><th id=\"L182\"><a href=\"#L182\">182</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0n <span class=\"ow\">in</span>\u00a0classes<span class=\"p\">:</span></td></tr><tr><th id=\"L183\"><a href=\"#L183\">183</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">issubclass</span><span class=\"p\">(</span>n<span class=\"p\">,</span>m<span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0m <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0n<span class=\"p\">:</span></td></tr><tr><th id=\"L184\"><a href=\"#L184\">184</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">break</span></td></tr><tr><th id=\"L185\"><a href=\"#L185\">185</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L186\"><a href=\"#L186\">186</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># m has no subclasses in 'classes'</span></td></tr><tr><th id=\"L187\"><a href=\"#L187\">187</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0m <span class=\"ow\">in</span>\u00a0candidates<span class=\"p\">:</span></td></tr><tr><th id=\"L188\"><a href=\"#L188\">188</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 candidates<span class=\"o\">.</span>remove<span class=\"p\">(</span>m<span class=\"p\">)</span>\u00a0 \u00a0 <span class=\"c\"># ensure that we're later in the list</span></td></tr><tr><th id=\"L189\"><a href=\"#L189\">189</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 candidates<span class=\"o\">.</span>append<span class=\"p\">(</span>m<span class=\"p\">)</span></td></tr><tr><th id=\"L190\"><a href=\"#L190\">190</a></th><td></td></tr><tr><th id=\"L191\"><a href=\"#L191\">191</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0candidates</td></tr><tr><th id=\"L192\"><a href=\"#L192\">192</a></th><td></td></tr></tbody></table>\n\n      </div>\n      <div id=\"anydiff\">\n        <form action=\"/LUCICodeRepository/nomaticIM/diff\" method=\"get\">\n          <div class=\"buttons\">\n            <input type=\"hidden\" name=\"new_path\" value=\"/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py\" />\n            <input type=\"hidden\" name=\"old_path\" value=\"/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py\" />\n            <input type=\"hidden\" name=\"new_rev\" />\n            <input type=\"hidden\" name=\"old_rev\" />\n            <input type=\"submit\" value=\"View changes...\" title=\"Select paths and revs for Diff\" />\n          </div>\n        </form>\n      </div>\n      <div id=\"help\"><strong>Note:</strong> See <a href=\"/LUCICodeRepository/nomaticIM/wiki/TracBrowser\">TracBrowser</a>\n        for help on using the repository browser.</div>\n    </div>\n    <div id=\"altlinks\">\n      <h3>Download in other formats:</h3>\n      <ul>\n        <li class=\"first\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py?format=txt\">Plain Text</a>\n        </li><li class=\"last\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/zope/interface/advice.py\">Original Format</a>\n        </li>\n      </ul>\n    </div>\n    </div>\n    <div id=\"footer\" lang=\"en\" xml:lang=\"en\"><hr />\n      <a id=\"tracpowered\" href=\"http://trac.edgewall.org/\"><img src=\"/LUCICodeRepository/nomaticIM/chrome/common/trac_logo_mini.png\" height=\"30\" width=\"107\" alt=\"Trac Powered\" /></a>\n      <p class=\"left\">Powered by <a href=\"/LUCICodeRepository/nomaticIM/about\"><strong>Trac 1.0.1</strong></a><br />\n        By <a href=\"http://www.edgewall.org/\">Edgewall Software</a>.</p>\n      <p class=\"right\">All content copyright 2007-2008 by LUCI <br /><a href=\"http://luci.ics.uci.edu/\">http://luci.ics.uci.edu/</a></p>\n    </div>\n\t\t<div id=\"sitefooter\">\n\t\t\t<script src=\"http://www.google-analytics.com/urchin.js\" type=\"text/javascript\">\n\t\t\t</script>\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t_uacct = \"UA-338915-2\";\n\t\t\t\turchinTracker();\n\t\t\t</script>\n\t\t</div>\n\t</body>\n</html>", "id": 44301.0}