{"text": "Search LoginPreferencesHelp GuideAbout Trac WikiTimelineRoadmapBrowse SourceView TicketsSearch Context Navigation BlameRevision Log source nomatic tags NomaticIM 5 buddy bots src twisted python rebuild py View diff against View revision Visit trunk Last change on this file was 712 checked in by cbaker 7 years ago First draft of nomatic buddy bots oscar bot is functional if you give it good authentication credentials jabber bot is just an example from the web File size 7 4 KB Line 1 test case name twisted test test rebuild 2 Copyright c 2 1 2 4 Twisted Matrix Laboratories 3 See LICENSE for details 456 7 Real reloading support for Python 8 91 System Imports11import sys12import types13import time14import linecache1516 Sibling Imports17import log18import reflect192 lastRebuild time time 212223class Sensitive 2425 A utility mixin that s sensitive to rebuilds 2627 This is a mixin for classes usually those which represent collections of28 callbacks to make sure that their code is up to date before running 29 3 31 lastRebuild lastRebuild3233 def needRebuildUpdate self 34 yn self lastRebuild lastRebuild 35 return yn3637 def rebuildUpToDate self 38 self lastRebuild time time 394 def latestVersionOf self anObject 41 Get the latest version of an object 4243 This can handle just about anything callable instances functions 44 methods and classes 45 46 t type anObject 47 if t types FunctionType 48 return latestFunction anObject 49 elif t types MethodType 5 if anObject im self is None 51 return getattr anObject im class anObject name 52 else 53 return getattr anObject im self anObject name 54 elif t types InstanceType 55 Kick it if it s out of date 56 getattr anObject nothing None 57 return anObject58 elif t types ClassType 59 return latestClass anObject 6 else 61 log msg warning returning anObject 62 return anObject6364 modDictIDMap 6566def latestFunction oldFunc 67 Get the latest version of a function 68 69 This may be CPython specific since I believe jython instantiates a new7 module upon reload 71 dictID id oldFunc func globals 72 module modDictIDMap get dictID 73 if module is None 74 return oldFunc75 return getattr module oldFunc name 767778def latestClass oldClass 79 Get the latest version of a class 8 81 module reflect namedModule oldClass module 82 newClass getattr module oldClass name 83 newBases 84 for base in newClass bases 85 newBases append latestClass base 8687 try 88 This makes old style stuff work89 newClass bases tuple newBases 9 return newClass91 except TypeError 92 ctor getattr newClass metaclass type 93 return ctor newClass name tuple newBases dict newClass dict 949596def updateInstance self 97 Updates an instance to be current98 99 self class latestClass self class 1 1 1def getattr self name 1 2 A getattr method to cause a class to be refreshed 1 3 1 4 if name del 1 5 raise AttributeError Without this Python segfaults 1 6 updateInstance self 1 7 log msg rebuilding stale s instance s reflect qual self class name 1 8 result getattr self name 1 9 return result11 111def rebuild module doLog 1 112 Reload a module and do as much as possible to replace its references 113 114 global lastRebuild115 lastRebuild time time 116 if hasattr module ALLOW TWISTED REBUILD 117 Is this module allowed to be rebuilt 118 if not module ALLOW TWISTED REBUILD 119 raise RuntimeError I am not allowed to be rebuilt 12 if doLog 121 log msg Rebuilding s str module name 122123 Safely handle adapter re registration124 from twisted python import components125 components ALLOW DUPLICATES 1126 127 d module dict 128 modDictIDMap id d module129 newclasses 13 classes 131 functions 132 values 133 if doLog 134 log msg scanning s str module name 135 for k v in d items 136 if type v types ClassType 137 Failure condition instances of classes with buggy138 hash cmp methods referenced at the module level 139 if v module module name 14 classes v 1141 if doLog 142 log logfile write c 143 log logfile flush 144 elif type v types FunctionType 145 if v func globals is module dict 146 functions v 1147 if doLog 148 log logfile write f 149 log logfile flush 15 elif isinstance v type 151 if v module module name 152 newclasses v 1153 if doLog 154 log logfile write o 155 log logfile flush 156157 values update classes 158 values update functions 159 fromOldModule values has key16 newclasses newclasses keys 161 classes classes keys 162 functions functions keys 163164 if doLog 165 log msg 166 log msg reload s str module name 167168 Boom 169 reload module 17 Make sure that my traceback printing will at least be recent 171 linecache clearcache 172173 if doLog 174 log msg cleaning s str module name 175176 for clazz in classes 177 if getattr module clazz name is clazz 178 log msg WARNING class s not replaced by reload reflect qual clazz 179 else 18 if doLog 181 log logfile write x 182 log logfile flush 183 clazz bases 184 clazz dict clear 185 clazz getattr getattr 186 clazz module module name 187 if newclasses 188 import gc189 for nclass in newclasses 19 ga getattr module nclass name 191 if ga is nclass 192 log msg WARNING new class s not replaced by reload reflect qual nclass 193 else 194 for r in gc get referrers nclass 195 if getattr r class None is nclass 196 r class ga197 if doLog 198 log msg 199 log msg fixing s str module name 2 modcount 2 1 for mk mod in sys modules items 2 2 modcount modcount 12 3 if mod module or mod is None 2 4 continue2 52 6 if not hasattr mod file 2 7 It s a builtin module nothing to replace here 2 8 continue2 9 changed 21 211 for k v in mod dict items 212 try 213 hash v 214 except TypeError 215 continue216 if fromOldModule v 217 if type v types ClassType 218 if doLog 219 log logfile write c 22 log logfile flush 221 nv latestClass v 222 else 223 if doLog 224 log logfile write f 225 log logfile flush 226 nv latestFunction v 227 changed 1228 setattr mod k nv 229 else 23 Replace bases of non module classes just to be sure 231 if type v types ClassType 232 for base in v bases 233 if fromOldModule base 234 latestClass v 235 if doLog and not changed and modcount 1 236 log logfile write 237 log logfile flush 238239 components ALLOW DUPLICATES 24 if doLog 241 log msg 242 log msg Rebuilt s str module name 243 return module Note See TracBrowser for help on using the repository browser Download in other formats Plain Text Original Format Powered by Trac 1 1 By Edgewall Software All content copyright 2 7 2 8 by LUCI http luci ics uci edu ", "_id": "http://djp3-pc2.ics.uci.edu/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py", "title": "\n      rebuild.py in nomatic/tags/nomaticim-0.0.5/buddy_bots/src/twisted/python\n     \u2013 nomatic*im\n    ", "html": "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n  \n  \n\n  \n\n\n  <head>\n\t\t<title>\n      rebuild.py in nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python\n     \u2013 Nomatic*IM\n    </title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" /><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" /><link rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search\" /><link rel=\"help\" href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py?format=txt\" type=\"text/plain\" title=\"Plain Text\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py\" type=\"application/x-python; charset=iso-8859-15\" title=\"Original Format\" /><link rel=\"start\" href=\"/LUCICodeRepository/nomaticIM/wiki\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/code.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/pygments/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/browser.css\" type=\"text/css\" /><link rel=\"shortcut icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link rel=\"icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link type=\"application/opensearchdescription+xml\" rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search/opensearch\" title=\"Search Nomatic*IM\" /><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/jquery.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/babel.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/messages/en_US.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/trac.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/search.js\"></script><script type=\"text/javascript\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/folding.js\"></script><script type=\"text/javascript\">\n      jQuery(document).ready(function($) {\n        $(\".trac-toggledeleted\").show().click(function() {\n                  $(this).siblings().find(\".trac-deleted\").toggle();\n                  return false;\n        }).click();\n        $(\"#jumploc input\").hide();\n        $(\"#jumploc select\").change(function () {\n          this.parentNode.parentNode.submit();\n        });\n          $('#preview table.code').enableCollapsibleColumns($('#preview table.code thead th.content'));\n      });\n    </script>\n\t</head>\n  <body>\n    <div id=\"banner\">\n      <div id=\"header\">\n        <a id=\"logo\" href=\"http://luci.ics.uci.edu/#code\"><img src=\"http://luci.ics.uci.edu/blog/archives/LUCIhorzTight.jpg\" alt=\"LUCI Code Repository\" /></a>\n      </div>\n      <form id=\"search\" action=\"/LUCICodeRepository/nomaticIM/search\" method=\"get\">\n        <div>\n          <label for=\"proj-search\">Search:</label>\n          <input type=\"text\" id=\"proj-search\" name=\"q\" size=\"18\" value=\"\" />\n          <input type=\"submit\" value=\"Search\" />\n        </div>\n      </form>\n      <div id=\"metanav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/login\">Login</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/prefs\">Preferences</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\">Help/Guide</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/about\">About Trac</a></li>\n    </ul>\n  </div>\n    </div>\n    <div id=\"mainnav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/wiki\">Wiki</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/timeline\">Timeline</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/roadmap\">Roadmap</a></li><li class=\"active\"><a href=\"/LUCICodeRepository/nomaticIM/browser\">Browse Source</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/report\">View Tickets</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/search\">Search</a></li>\n    </ul>\n  </div>\n    <div id=\"main\">\n      <div id=\"ctxtnav\" class=\"nav\">\n        <h2>Context Navigation</h2>\n        <ul>\n          <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/trunk/buddy_bots/twisted/python/rebuild.py?annotate=blame\" title=\"Annotate each line with the last changed revision (this can be time consuming...)\">Blame</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/log/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py\">Revision Log</a></li>\n        </ul>\n        <hr />\n      </div>\n    <div id=\"content\" class=\"browser\">\n        <h1>\n          \n<a class=\"pathentry first\" href=\"/LUCICodeRepository/nomaticIM/browser?order=name\" title=\"Go to repository root\">source:</a>\n<a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic?order=name\" title=\"View nomatic\">nomatic</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags?order=name\" title=\"View tags\">tags</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5?order=name\" title=\"View NomaticIM-0.0.5\">NomaticIM-0.0.5</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots?order=name\" title=\"View buddy_bots\">buddy_bots</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src?order=name\" title=\"View src\">src</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted?order=name\" title=\"View twisted\">twisted</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python?order=name\" title=\"View python\">python</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py?order=name\" title=\"View rebuild.py\">rebuild.py</a>\n<br style=\"clear: both\" />\n\n        </h1>\n        <div id=\"diffrev\">\n          <form action=\"/LUCICodeRepository/nomaticIM/changeset\" method=\"get\">\n            <div>\n              <label title=\"Show the diff against a specific revision\">\n                View diff against: <input type=\"text\" name=\"old\" size=\"6\" />\n                <input type=\"hidden\" name=\"old_path\" value=\"nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py\" />\n                <input type=\"hidden\" name=\"new\" />\n                <input type=\"hidden\" name=\"new_path\" value=\"nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py\" />\n              </label>\n            </div>\n          </form>\n        </div>\n        <div id=\"jumprev\">\n          <form action=\"\" method=\"get\">\n            <div>\n              <label for=\"rev\">\n                View revision:</label>\n              <input type=\"text\" id=\"rev\" name=\"rev\" size=\"6\" />\n            </div>\n          </form>\n        </div>\n        <div id=\"jumploc\">\n          <form action=\"\" method=\"get\">\n            <div class=\"buttons\">\n              <label for=\"preselected\">Visit:</label>\n              <select id=\"preselected\" name=\"preselected\">\n                <option selected=\"selected\"></option>\n                <optgroup label=\"branches\">\n                  <option value=\"/LUCICodeRepository/nomaticIM/browser/trunk\">trunk</option>\n                </optgroup>\n              </select>\n              <input type=\"submit\" value=\"Go!\" title=\"Jump to the chosen preselected path\" />\n            </div>\n          </form>\n        </div>\n        <div class=\"trac-tags\">\n        </div>\n      <table id=\"info\" summary=\"Revision info\">\n        <tr>\n          <th>\n                <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/nomatic/trunk/buddy_bots/twisted/python/rebuild.py\" title=\"View differences\">Last change</a>\n                  on this file was\n                  <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/\" title=\"View changeset 712\">712</a>,\n                  checked in by cbaker, <a class=\"timeline\" href=\"/LUCICodeRepository/nomaticIM/timeline?from=2008-02-16T08%3A16%3A53-08%3A00&amp;precision=second\" title=\"See timeline at Feb 16, 2008, 8:16:53 AM\">7 years ago</a>\n          </th>\n        </tr>\n        <tr>\n          <td class=\"message searchable\">\n              <p>\nFirst draft of nomatic buddy bots. oscar_bot is functional if you give it good authentication credentials, jabber_bot is just an example from the web <br />\n</p>\n          </td>\n        </tr>\n        <tr><td colspan=\"2\">\n            <strong>File size:</strong>\n            <span title=\"7561 bytes\">7.4 KB</span>\n          </td></tr>\n      </table>\n      <div id=\"preview\" class=\"searchable\">\n        \n  <table class=\"code\"><thead><tr><th class=\"lineno\" title=\"Line numbers\">Line</th><th class=\"content\">\u00a0</th></tr></thead><tbody><tr><th id=\"L1\"><a href=\"#L1\">1</a></th><td><span class=\"c\"># -*- test-case-name: twisted.test.test_rebuild -*-</span></td></tr><tr><th id=\"L2\"><a href=\"#L2\">2</a></th><td><span class=\"c\"># Copyright (c) 2001-2004 Twisted Matrix Laboratories.</span></td></tr><tr><th id=\"L3\"><a href=\"#L3\">3</a></th><td><span class=\"c\"># See LICENSE for details.</span></td></tr><tr><th id=\"L4\"><a href=\"#L4\">4</a></th><td></td></tr><tr><th id=\"L5\"><a href=\"#L5\">5</a></th><td></td></tr><tr><th id=\"L6\"><a href=\"#L6\">6</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L7\"><a href=\"#L7\">7</a></th><td><span class=\"sd\">*Real* reloading support for Python.</span></td></tr><tr><th id=\"L8\"><a href=\"#L8\">8</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L9\"><a href=\"#L9\">9</a></th><td></td></tr><tr><th id=\"L10\"><a href=\"#L10\">10</a></th><td><span class=\"c\"># System Imports</span></td></tr><tr><th id=\"L11\"><a href=\"#L11\">11</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">sys</span></td></tr><tr><th id=\"L12\"><a href=\"#L12\">12</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">types</span></td></tr><tr><th id=\"L13\"><a href=\"#L13\">13</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">time</span></td></tr><tr><th id=\"L14\"><a href=\"#L14\">14</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">linecache</span></td></tr><tr><th id=\"L15\"><a href=\"#L15\">15</a></th><td></td></tr><tr><th id=\"L16\"><a href=\"#L16\">16</a></th><td><span class=\"c\"># Sibling Imports</span></td></tr><tr><th id=\"L17\"><a href=\"#L17\">17</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">log</span></td></tr><tr><th id=\"L18\"><a href=\"#L18\">18</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">reflect</span></td></tr><tr><th id=\"L19\"><a href=\"#L19\">19</a></th><td></td></tr><tr><th id=\"L20\"><a href=\"#L20\">20</a></th><td>lastRebuild <span class=\"o\">=</span>\u00a0time<span class=\"o\">.</span>time<span class=\"p\">()</span></td></tr><tr><th id=\"L21\"><a href=\"#L21\">21</a></th><td></td></tr><tr><th id=\"L22\"><a href=\"#L22\">22</a></th><td></td></tr><tr><th id=\"L23\"><a href=\"#L23\">23</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">Sensitive</span><span class=\"p\">:</span></td></tr><tr><th id=\"L24\"><a href=\"#L24\">24</a></th><td></td></tr><tr><th id=\"L25\"><a href=\"#L25\">25</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"A utility mixin that's sensitive to rebuilds.</span></td></tr><tr><th id=\"L26\"><a href=\"#L26\">26</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L27\"><a href=\"#L27\">27</a></th><td><span class=\"sd\">\u00a0 \u00a0 This is a mixin for classes (usually those which represent collections of</span></td></tr><tr><th id=\"L28\"><a href=\"#L28\">28</a></th><td><span class=\"sd\">\u00a0 \u00a0 callbacks) to make sure that their code is up-to-date before running.</span></td></tr><tr><th id=\"L29\"><a href=\"#L29\">29</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L30\"><a href=\"#L30\">30</a></th><td></td></tr><tr><th id=\"L31\"><a href=\"#L31\">31</a></th><td>\u00a0 \u00a0 lastRebuild <span class=\"o\">=</span>\u00a0lastRebuild</td></tr><tr><th id=\"L32\"><a href=\"#L32\">32</a></th><td></td></tr><tr><th id=\"L33\"><a href=\"#L33\">33</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">needRebuildUpdate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L34\"><a href=\"#L34\">34</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 yn <span class=\"o\">=</span>\u00a0<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>lastRebuild <span class=\"o\">&lt;</span>\u00a0lastRebuild<span class=\"p\">)</span></td></tr><tr><th id=\"L35\"><a href=\"#L35\">35</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0yn</td></tr><tr><th id=\"L36\"><a href=\"#L36\">36</a></th><td></td></tr><tr><th id=\"L37\"><a href=\"#L37\">37</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">rebuildUpToDate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L38\"><a href=\"#L38\">38</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>lastRebuild <span class=\"o\">=</span>\u00a0time<span class=\"o\">.</span>time<span class=\"p\">()</span></td></tr><tr><th id=\"L39\"><a href=\"#L39\">39</a></th><td></td></tr><tr><th id=\"L40\"><a href=\"#L40\">40</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">latestVersionOf</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0anObject<span class=\"p\">):</span></td></tr><tr><th id=\"L41\"><a href=\"#L41\">41</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Get the latest version of an object.</span></td></tr><tr><th id=\"L42\"><a href=\"#L42\">42</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L43\"><a href=\"#L43\">43</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 This can handle just about anything callable; instances, functions,</span></td></tr><tr><th id=\"L44\"><a href=\"#L44\">44</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 methods, and classes.</span></td></tr><tr><th id=\"L45\"><a href=\"#L45\">45</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L46\"><a href=\"#L46\">46</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 t <span class=\"o\">=</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">(</span>anObject<span class=\"p\">)</span></td></tr><tr><th id=\"L47\"><a href=\"#L47\">47</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0t <span class=\"o\">==</span>\u00a0types<span class=\"o\">.</span>FunctionType<span class=\"p\">:</span></td></tr><tr><th id=\"L48\"><a href=\"#L48\">48</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0latestFunction<span class=\"p\">(</span>anObject<span class=\"p\">)</span></td></tr><tr><th id=\"L49\"><a href=\"#L49\">49</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"o\">==</span>\u00a0types<span class=\"o\">.</span>MethodType<span class=\"p\">:</span></td></tr><tr><th id=\"L50\"><a href=\"#L50\">50</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0anObject<span class=\"o\">.</span>im_self <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L51\"><a href=\"#L51\">51</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>anObject<span class=\"o\">.</span>im_class<span class=\"p\">,</span>\u00a0anObject<span class=\"o\">.</span>__name__<span class=\"p\">)</span></td></tr><tr><th id=\"L52\"><a href=\"#L52\">52</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L53\"><a href=\"#L53\">53</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>anObject<span class=\"o\">.</span>im_self<span class=\"p\">,</span>\u00a0anObject<span class=\"o\">.</span>__name__<span class=\"p\">)</span></td></tr><tr><th id=\"L54\"><a href=\"#L54\">54</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"o\">==</span>\u00a0types<span class=\"o\">.</span>InstanceType<span class=\"p\">:</span></td></tr><tr><th id=\"L55\"><a href=\"#L55\">55</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Kick it, if it's out of date.</span></td></tr><tr><th id=\"L56\"><a href=\"#L56\">56</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"nb\">getattr</span><span class=\"p\">(</span>anObject<span class=\"p\">,</span>\u00a0<span class=\"s\">'nothing'</span><span class=\"p\">,</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L57\"><a href=\"#L57\">57</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0anObject</td></tr><tr><th id=\"L58\"><a href=\"#L58\">58</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0t <span class=\"o\">==</span>\u00a0types<span class=\"o\">.</span>ClassType<span class=\"p\">:</span></td></tr><tr><th id=\"L59\"><a href=\"#L59\">59</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0latestClass<span class=\"p\">(</span>anObject<span class=\"p\">)</span></td></tr><tr><th id=\"L60\"><a href=\"#L60\">60</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L61\"><a href=\"#L61\">61</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'warning returning anObject!'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L62\"><a href=\"#L62\">62</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0anObject</td></tr><tr><th id=\"L63\"><a href=\"#L63\">63</a></th><td></td></tr><tr><th id=\"L64\"><a href=\"#L64\">64</a></th><td>_modDictIDMap <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L65\"><a href=\"#L65\">65</a></th><td></td></tr><tr><th id=\"L66\"><a href=\"#L66\">66</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">latestFunction</span><span class=\"p\">(</span>oldFunc<span class=\"p\">):</span></td></tr><tr><th id=\"L67\"><a href=\"#L67\">67</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Get the latest version of a function.</span></td></tr><tr><th id=\"L68\"><a href=\"#L68\">68</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L69\"><a href=\"#L69\">69</a></th><td>\u00a0 \u00a0 <span class=\"c\"># This may be CPython specific, since I believe jython instantiates a new</span></td></tr><tr><th id=\"L70\"><a href=\"#L70\">70</a></th><td>\u00a0 \u00a0 <span class=\"c\"># module upon reload.</span></td></tr><tr><th id=\"L71\"><a href=\"#L71\">71</a></th><td>\u00a0 \u00a0 dictID <span class=\"o\">=</span>\u00a0<span class=\"nb\">id</span><span class=\"p\">(</span>oldFunc<span class=\"o\">.</span>func_globals<span class=\"p\">)</span></td></tr><tr><th id=\"L72\"><a href=\"#L72\">72</a></th><td>\u00a0 \u00a0 module <span class=\"o\">=</span>\u00a0_modDictIDMap<span class=\"o\">.</span>get<span class=\"p\">(</span>dictID<span class=\"p\">)</span></td></tr><tr><th id=\"L73\"><a href=\"#L73\">73</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0module <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L74\"><a href=\"#L74\">74</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0oldFunc</td></tr><tr><th id=\"L75\"><a href=\"#L75\">75</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>module<span class=\"p\">,</span>\u00a0oldFunc<span class=\"o\">.</span>__name__<span class=\"p\">)</span></td></tr><tr><th id=\"L76\"><a href=\"#L76\">76</a></th><td></td></tr><tr><th id=\"L77\"><a href=\"#L77\">77</a></th><td></td></tr><tr><th id=\"L78\"><a href=\"#L78\">78</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">latestClass</span><span class=\"p\">(</span>oldClass<span class=\"p\">):</span></td></tr><tr><th id=\"L79\"><a href=\"#L79\">79</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Get the latest version of a class.</span></td></tr><tr><th id=\"L80\"><a href=\"#L80\">80</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L81\"><a href=\"#L81\">81</a></th><td>\u00a0 \u00a0 module <span class=\"o\">=</span>\u00a0reflect<span class=\"o\">.</span>namedModule<span class=\"p\">(</span>oldClass<span class=\"o\">.</span>__module__<span class=\"p\">)</span></td></tr><tr><th id=\"L82\"><a href=\"#L82\">82</a></th><td>\u00a0 \u00a0 newClass <span class=\"o\">=</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>module<span class=\"p\">,</span>\u00a0oldClass<span class=\"o\">.</span>__name__<span class=\"p\">)</span></td></tr><tr><th id=\"L83\"><a href=\"#L83\">83</a></th><td>\u00a0 \u00a0 newBases <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L84\"><a href=\"#L84\">84</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0base <span class=\"ow\">in</span>\u00a0newClass<span class=\"o\">.</span>__bases__<span class=\"p\">:</span></td></tr><tr><th id=\"L85\"><a href=\"#L85\">85</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 newBases<span class=\"o\">.</span>append<span class=\"p\">(</span>latestClass<span class=\"p\">(</span>base<span class=\"p\">))</span></td></tr><tr><th id=\"L86\"><a href=\"#L86\">86</a></th><td></td></tr><tr><th id=\"L87\"><a href=\"#L87\">87</a></th><td>\u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L88\"><a href=\"#L88\">88</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># This makes old-style stuff work</span></td></tr><tr><th id=\"L89\"><a href=\"#L89\">89</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 newClass<span class=\"o\">.</span>__bases__ <span class=\"o\">=</span>\u00a0<span class=\"nb\">tuple</span><span class=\"p\">(</span>newBases<span class=\"p\">)</span></td></tr><tr><th id=\"L90\"><a href=\"#L90\">90</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0newClass</td></tr><tr><th id=\"L91\"><a href=\"#L91\">91</a></th><td>\u00a0 \u00a0 <span class=\"k\">except</span>\u00a0<span class=\"ne\">TypeError</span><span class=\"p\">:</span></td></tr><tr><th id=\"L92\"><a href=\"#L92\">92</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 ctor <span class=\"o\">=</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>newClass<span class=\"p\">,</span>\u00a0<span class=\"s\">'__metaclass__'</span><span class=\"p\">,</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">)</span></td></tr><tr><th id=\"L93\"><a href=\"#L93\">93</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0ctor<span class=\"p\">(</span>newClass<span class=\"o\">.</span>__name__<span class=\"p\">,</span>\u00a0<span class=\"nb\">tuple</span><span class=\"p\">(</span>newBases<span class=\"p\">),</span>\u00a0<span class=\"nb\">dict</span><span class=\"p\">(</span>newClass<span class=\"o\">.</span>__dict__<span class=\"p\">))</span></td></tr><tr><th id=\"L94\"><a href=\"#L94\">94</a></th><td></td></tr><tr><th id=\"L95\"><a href=\"#L95\">95</a></th><td></td></tr><tr><th id=\"L96\"><a href=\"#L96\">96</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">updateInstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L97\"><a href=\"#L97\">97</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Updates an instance to be current</span></td></tr><tr><th id=\"L98\"><a href=\"#L98\">98</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L99\"><a href=\"#L99\">99</a></th><td>\u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>__class__ <span class=\"o\">=</span>\u00a0latestClass<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>__class__<span class=\"p\">)</span></td></tr><tr><th id=\"L100\"><a href=\"#L100\">100</a></th><td></td></tr><tr><th id=\"L101\"><a href=\"#L101\">101</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">__getattr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0name<span class=\"p\">):</span></td></tr><tr><th id=\"L102\"><a href=\"#L102\">102</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"A getattr method to cause a class to be refreshed.</span></td></tr><tr><th id=\"L103\"><a href=\"#L103\">103</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L104\"><a href=\"#L104\">104</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0name <span class=\"o\">==</span>\u00a0<span class=\"s\">'__del__'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L105\"><a href=\"#L105\">105</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">AttributeError</span><span class=\"p\">(</span><span class=\"s\">\"Without this, Python segfaults.\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L106\"><a href=\"#L106\">106</a></th><td>\u00a0 \u00a0 updateInstance<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span></td></tr><tr><th id=\"L107\"><a href=\"#L107\">107</a></th><td>\u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"(rebuilding stale </span><span class=\"si\">%s</span><span class=\"s\">\u00a0instance (</span><span class=\"si\">%s</span><span class=\"s\">))\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>reflect<span class=\"o\">.</span>qual<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>__class__<span class=\"p\">),</span>\u00a0name<span class=\"p\">))</span></td></tr><tr><th id=\"L108\"><a href=\"#L108\">108</a></th><td>\u00a0 \u00a0 result <span class=\"o\">=</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0name<span class=\"p\">)</span></td></tr><tr><th id=\"L109\"><a href=\"#L109\">109</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0result</td></tr><tr><th id=\"L110\"><a href=\"#L110\">110</a></th><td></td></tr><tr><th id=\"L111\"><a href=\"#L111\">111</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">rebuild</span><span class=\"p\">(</span>module<span class=\"p\">,</span>\u00a0doLog<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">):</span></td></tr><tr><th id=\"L112\"><a href=\"#L112\">112</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Reload a module and do as much as possible to replace its references.</span></td></tr><tr><th id=\"L113\"><a href=\"#L113\">113</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L114\"><a href=\"#L114\">114</a></th><td>\u00a0 \u00a0 <span class=\"k\">global</span>\u00a0lastRebuild</td></tr><tr><th id=\"L115\"><a href=\"#L115\">115</a></th><td>\u00a0 \u00a0 lastRebuild <span class=\"o\">=</span>\u00a0time<span class=\"o\">.</span>time<span class=\"p\">()</span></td></tr><tr><th id=\"L116\"><a href=\"#L116\">116</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>module<span class=\"p\">,</span>\u00a0<span class=\"s\">'ALLOW_TWISTED_REBUILD'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L117\"><a href=\"#L117\">117</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Is this module allowed to be rebuilt?</span></td></tr><tr><th id=\"L118\"><a href=\"#L118\">118</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0module<span class=\"o\">.</span>ALLOW_TWISTED_REBUILD<span class=\"p\">:</span></td></tr><tr><th id=\"L119\"><a href=\"#L119\">119</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">RuntimeError</span><span class=\"p\">,</span>\u00a0<span class=\"s\">\"I am not allowed to be rebuilt.\"</span></td></tr><tr><th id=\"L120\"><a href=\"#L120\">120</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L121\"><a href=\"#L121\">121</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span>\u00a0<span class=\"s\">'Rebuilding </span><span class=\"si\">%s</span><span class=\"s\">...'</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>module<span class=\"o\">.</span>__name__<span class=\"p\">))</span></td></tr><tr><th id=\"L122\"><a href=\"#L122\">122</a></th><td></td></tr><tr><th id=\"L123\"><a href=\"#L123\">123</a></th><td>\u00a0 \u00a0 <span class=\"c\">## Safely handle adapter re-registration</span></td></tr><tr><th id=\"L124\"><a href=\"#L124\">124</a></th><td>\u00a0 \u00a0 <span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.python</span>\u00a0<span class=\"kn\">import</span>\u00a0components</td></tr><tr><th id=\"L125\"><a href=\"#L125\">125</a></th><td>\u00a0 \u00a0 components<span class=\"o\">.</span>ALLOW_DUPLICATES <span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L126\"><a href=\"#L126\">126</a></th><td>\u00a0 \u00a0 </td></tr><tr><th id=\"L127\"><a href=\"#L127\">127</a></th><td>\u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0module<span class=\"o\">.</span>__dict__</td></tr><tr><th id=\"L128\"><a href=\"#L128\">128</a></th><td>\u00a0 \u00a0 _modDictIDMap<span class=\"p\">[</span><span class=\"nb\">id</span><span class=\"p\">(</span>d<span class=\"p\">)]</span>\u00a0<span class=\"o\">=</span>\u00a0module</td></tr><tr><th id=\"L129\"><a href=\"#L129\">129</a></th><td>\u00a0 \u00a0 newclasses <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L130\"><a href=\"#L130\">130</a></th><td>\u00a0 \u00a0 classes <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L131\"><a href=\"#L131\">131</a></th><td>\u00a0 \u00a0 functions <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L132\"><a href=\"#L132\">132</a></th><td>\u00a0 \u00a0 values <span class=\"o\">=</span>\u00a0<span class=\"p\">{}</span></td></tr><tr><th id=\"L133\"><a href=\"#L133\">133</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L134\"><a href=\"#L134\">134</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'\u00a0 (scanning </span><span class=\"si\">%s</span><span class=\"s\">): '</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>module<span class=\"o\">.</span>__name__<span class=\"p\">))</span></td></tr><tr><th id=\"L135\"><a href=\"#L135\">135</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0k<span class=\"p\">,</span>\u00a0v <span class=\"ow\">in</span>\u00a0d<span class=\"o\">.</span>items<span class=\"p\">():</span></td></tr><tr><th id=\"L136\"><a href=\"#L136\">136</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">(</span>v<span class=\"p\">)</span>\u00a0<span class=\"o\">==</span>\u00a0types<span class=\"o\">.</span>ClassType<span class=\"p\">:</span></td></tr><tr><th id=\"L137\"><a href=\"#L137\">137</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Failure condition -- instances of classes with buggy</span></td></tr><tr><th id=\"L138\"><a href=\"#L138\">138</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># __hash__/__cmp__ methods referenced at the module level...</span></td></tr><tr><th id=\"L139\"><a href=\"#L139\">139</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0v<span class=\"o\">.</span>__module__ <span class=\"o\">==</span>\u00a0module<span class=\"o\">.</span>__name__<span class=\"p\">:</span></td></tr><tr><th id=\"L140\"><a href=\"#L140\">140</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 classes<span class=\"p\">[</span>v<span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L141\"><a href=\"#L141\">141</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L142\"><a href=\"#L142\">142</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"s\">\"c\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L143\"><a href=\"#L143\">143</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>flush<span class=\"p\">()</span></td></tr><tr><th id=\"L144\"><a href=\"#L144\">144</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">(</span>v<span class=\"p\">)</span>\u00a0<span class=\"o\">==</span>\u00a0types<span class=\"o\">.</span>FunctionType<span class=\"p\">:</span></td></tr><tr><th id=\"L145\"><a href=\"#L145\">145</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0v<span class=\"o\">.</span>func_globals <span class=\"ow\">is</span>\u00a0module<span class=\"o\">.</span>__dict__<span class=\"p\">:</span></td></tr><tr><th id=\"L146\"><a href=\"#L146\">146</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 functions<span class=\"p\">[</span>v<span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L147\"><a href=\"#L147\">147</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L148\"><a href=\"#L148\">148</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"s\">\"f\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L149\"><a href=\"#L149\">149</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>flush<span class=\"p\">()</span></td></tr><tr><th id=\"L150\"><a href=\"#L150\">150</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>v<span class=\"p\">,</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">):</span></td></tr><tr><th id=\"L151\"><a href=\"#L151\">151</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0v<span class=\"o\">.</span>__module__ <span class=\"o\">==</span>\u00a0module<span class=\"o\">.</span>__name__<span class=\"p\">:</span></td></tr><tr><th id=\"L152\"><a href=\"#L152\">152</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 newclasses<span class=\"p\">[</span>v<span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L153\"><a href=\"#L153\">153</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L154\"><a href=\"#L154\">154</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"s\">\"o\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L155\"><a href=\"#L155\">155</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>flush<span class=\"p\">()</span></td></tr><tr><th id=\"L156\"><a href=\"#L156\">156</a></th><td></td></tr><tr><th id=\"L157\"><a href=\"#L157\">157</a></th><td>\u00a0 \u00a0 values<span class=\"o\">.</span>update<span class=\"p\">(</span>classes<span class=\"p\">)</span></td></tr><tr><th id=\"L158\"><a href=\"#L158\">158</a></th><td>\u00a0 \u00a0 values<span class=\"o\">.</span>update<span class=\"p\">(</span>functions<span class=\"p\">)</span></td></tr><tr><th id=\"L159\"><a href=\"#L159\">159</a></th><td>\u00a0 \u00a0 fromOldModule <span class=\"o\">=</span>\u00a0values<span class=\"o\">.</span>has_key</td></tr><tr><th id=\"L160\"><a href=\"#L160\">160</a></th><td>\u00a0 \u00a0 newclasses <span class=\"o\">=</span>\u00a0newclasses<span class=\"o\">.</span>keys<span class=\"p\">()</span></td></tr><tr><th id=\"L161\"><a href=\"#L161\">161</a></th><td>\u00a0 \u00a0 classes <span class=\"o\">=</span>\u00a0classes<span class=\"o\">.</span>keys<span class=\"p\">()</span></td></tr><tr><th id=\"L162\"><a href=\"#L162\">162</a></th><td>\u00a0 \u00a0 functions <span class=\"o\">=</span>\u00a0functions<span class=\"o\">.</span>keys<span class=\"p\">()</span></td></tr><tr><th id=\"L163\"><a href=\"#L163\">163</a></th><td></td></tr><tr><th id=\"L164\"><a href=\"#L164\">164</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L165\"><a href=\"#L165\">165</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">''</span><span class=\"p\">)</span></td></tr><tr><th id=\"L166\"><a href=\"#L166\">166</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'\u00a0 (reload\u00a0 \u00a0</span><span class=\"si\">%s</span><span class=\"s\">)'</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>module<span class=\"o\">.</span>__name__<span class=\"p\">))</span></td></tr><tr><th id=\"L167\"><a href=\"#L167\">167</a></th><td></td></tr><tr><th id=\"L168\"><a href=\"#L168\">168</a></th><td>\u00a0 \u00a0 <span class=\"c\"># Boom.</span></td></tr><tr><th id=\"L169\"><a href=\"#L169\">169</a></th><td>\u00a0 \u00a0 <span class=\"nb\">reload</span><span class=\"p\">(</span>module<span class=\"p\">)</span></td></tr><tr><th id=\"L170\"><a href=\"#L170\">170</a></th><td>\u00a0 \u00a0 <span class=\"c\"># Make sure that my traceback printing will at least be recent...</span></td></tr><tr><th id=\"L171\"><a href=\"#L171\">171</a></th><td>\u00a0 \u00a0 linecache<span class=\"o\">.</span>clearcache<span class=\"p\">()</span></td></tr><tr><th id=\"L172\"><a href=\"#L172\">172</a></th><td></td></tr><tr><th id=\"L173\"><a href=\"#L173\">173</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L174\"><a href=\"#L174\">174</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'\u00a0 (cleaning </span><span class=\"si\">%s</span><span class=\"s\">): '</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>module<span class=\"o\">.</span>__name__<span class=\"p\">))</span></td></tr><tr><th id=\"L175\"><a href=\"#L175\">175</a></th><td></td></tr><tr><th id=\"L176\"><a href=\"#L176\">176</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0clazz <span class=\"ow\">in</span>\u00a0classes<span class=\"p\">:</span></td></tr><tr><th id=\"L177\"><a href=\"#L177\">177</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>module<span class=\"p\">,</span>\u00a0clazz<span class=\"o\">.</span>__name__<span class=\"p\">)</span>\u00a0<span class=\"ow\">is</span>\u00a0clazz<span class=\"p\">:</span></td></tr><tr><th id=\"L178\"><a href=\"#L178\">178</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"WARNING: class </span><span class=\"si\">%s</span><span class=\"s\">\u00a0not replaced by reload!\"</span>\u00a0<span class=\"o\">%</span>\u00a0reflect<span class=\"o\">.</span>qual<span class=\"p\">(</span>clazz<span class=\"p\">))</span></td></tr><tr><th id=\"L179\"><a href=\"#L179\">179</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L180\"><a href=\"#L180\">180</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L181\"><a href=\"#L181\">181</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"s\">\"x\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L182\"><a href=\"#L182\">182</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>flush<span class=\"p\">()</span></td></tr><tr><th id=\"L183\"><a href=\"#L183\">183</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 clazz<span class=\"o\">.</span>__bases__ <span class=\"o\">=</span>\u00a0<span class=\"p\">()</span></td></tr><tr><th id=\"L184\"><a href=\"#L184\">184</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 clazz<span class=\"o\">.</span>__dict__<span class=\"o\">.</span>clear<span class=\"p\">()</span></td></tr><tr><th id=\"L185\"><a href=\"#L185\">185</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 clazz<span class=\"o\">.</span>__getattr__ <span class=\"o\">=</span>\u00a0__getattr__</td></tr><tr><th id=\"L186\"><a href=\"#L186\">186</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 clazz<span class=\"o\">.</span>__module__ <span class=\"o\">=</span>\u00a0module<span class=\"o\">.</span>__name__</td></tr><tr><th id=\"L187\"><a href=\"#L187\">187</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0newclasses<span class=\"p\">:</span></td></tr><tr><th id=\"L188\"><a href=\"#L188\">188</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"kn\">import</span>\u00a0<span class=\"nn\">gc</span></td></tr><tr><th id=\"L189\"><a href=\"#L189\">189</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0nclass <span class=\"ow\">in</span>\u00a0newclasses<span class=\"p\">:</span></td></tr><tr><th id=\"L190\"><a href=\"#L190\">190</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 ga <span class=\"o\">=</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>module<span class=\"p\">,</span>\u00a0nclass<span class=\"o\">.</span>__name__<span class=\"p\">)</span></td></tr><tr><th id=\"L191\"><a href=\"#L191\">191</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0ga <span class=\"ow\">is</span>\u00a0nclass<span class=\"p\">:</span></td></tr><tr><th id=\"L192\"><a href=\"#L192\">192</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"WARNING: new-class </span><span class=\"si\">%s</span><span class=\"s\">\u00a0not replaced by reload!\"</span>\u00a0<span class=\"o\">%</span>\u00a0reflect<span class=\"o\">.</span>qual<span class=\"p\">(</span>nclass<span class=\"p\">))</span></td></tr><tr><th id=\"L193\"><a href=\"#L193\">193</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L194\"><a href=\"#L194\">194</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0r <span class=\"ow\">in</span>\u00a0gc<span class=\"o\">.</span>get_referrers<span class=\"p\">(</span>nclass<span class=\"p\">):</span></td></tr><tr><th id=\"L195\"><a href=\"#L195\">195</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>r<span class=\"p\">,</span>\u00a0<span class=\"s\">'__class__'</span><span class=\"p\">,</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">)</span>\u00a0<span class=\"ow\">is</span>\u00a0nclass<span class=\"p\">:</span></td></tr><tr><th id=\"L196\"><a href=\"#L196\">196</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 r<span class=\"o\">.</span>__class__ <span class=\"o\">=</span>\u00a0ga</td></tr><tr><th id=\"L197\"><a href=\"#L197\">197</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L198\"><a href=\"#L198\">198</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">''</span><span class=\"p\">)</span></td></tr><tr><th id=\"L199\"><a href=\"#L199\">199</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'\u00a0 (fixing\u00a0 \u00a0</span><span class=\"si\">%s</span><span class=\"s\">): '</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>module<span class=\"o\">.</span>__name__<span class=\"p\">))</span></td></tr><tr><th id=\"L200\"><a href=\"#L200\">200</a></th><td>\u00a0 \u00a0 modcount <span class=\"o\">=</span>\u00a0<span class=\"mi\">0</span></td></tr><tr><th id=\"L201\"><a href=\"#L201\">201</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0mk<span class=\"p\">,</span>\u00a0mod <span class=\"ow\">in</span>\u00a0sys<span class=\"o\">.</span>modules<span class=\"o\">.</span>items<span class=\"p\">():</span></td></tr><tr><th id=\"L202\"><a href=\"#L202\">202</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 modcount <span class=\"o\">=</span>\u00a0modcount <span class=\"o\">+</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L203\"><a href=\"#L203\">203</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0mod <span class=\"o\">==</span>\u00a0module <span class=\"ow\">or</span>\u00a0mod <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L204\"><a href=\"#L204\">204</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">continue</span></td></tr><tr><th id=\"L205\"><a href=\"#L205\">205</a></th><td></td></tr><tr><th id=\"L206\"><a href=\"#L206\">206</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span>mod<span class=\"p\">,</span>\u00a0<span class=\"s\">'__file__'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L207\"><a href=\"#L207\">207</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># It's a builtin module; nothing to replace here.</span></td></tr><tr><th id=\"L208\"><a href=\"#L208\">208</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">continue</span></td></tr><tr><th id=\"L209\"><a href=\"#L209\">209</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 changed <span class=\"o\">=</span>\u00a0<span class=\"mi\">0</span></td></tr><tr><th id=\"L210\"><a href=\"#L210\">210</a></th><td></td></tr><tr><th id=\"L211\"><a href=\"#L211\">211</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0k<span class=\"p\">,</span>\u00a0v <span class=\"ow\">in</span>\u00a0mod<span class=\"o\">.</span>__dict__<span class=\"o\">.</span>items<span class=\"p\">():</span></td></tr><tr><th id=\"L212\"><a href=\"#L212\">212</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L213\"><a href=\"#L213\">213</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"nb\">hash</span><span class=\"p\">(</span>v<span class=\"p\">)</span></td></tr><tr><th id=\"L214\"><a href=\"#L214\">214</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0<span class=\"ne\">TypeError</span><span class=\"p\">:</span></td></tr><tr><th id=\"L215\"><a href=\"#L215\">215</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">continue</span></td></tr><tr><th id=\"L216\"><a href=\"#L216\">216</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0fromOldModule<span class=\"p\">(</span>v<span class=\"p\">):</span></td></tr><tr><th id=\"L217\"><a href=\"#L217\">217</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">(</span>v<span class=\"p\">)</span>\u00a0<span class=\"o\">==</span>\u00a0types<span class=\"o\">.</span>ClassType<span class=\"p\">:</span></td></tr><tr><th id=\"L218\"><a href=\"#L218\">218</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L219\"><a href=\"#L219\">219</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"s\">\"c\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L220\"><a href=\"#L220\">220</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>flush<span class=\"p\">()</span></td></tr><tr><th id=\"L221\"><a href=\"#L221\">221</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 nv <span class=\"o\">=</span>\u00a0latestClass<span class=\"p\">(</span>v<span class=\"p\">)</span></td></tr><tr><th id=\"L222\"><a href=\"#L222\">222</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L223\"><a href=\"#L223\">223</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L224\"><a href=\"#L224\">224</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"s\">\"f\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L225\"><a href=\"#L225\">225</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>flush<span class=\"p\">()</span></td></tr><tr><th id=\"L226\"><a href=\"#L226\">226</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 nv <span class=\"o\">=</span>\u00a0latestFunction<span class=\"p\">(</span>v<span class=\"p\">)</span></td></tr><tr><th id=\"L227\"><a href=\"#L227\">227</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 changed <span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L228\"><a href=\"#L228\">228</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"nb\">setattr</span><span class=\"p\">(</span>mod<span class=\"p\">,</span>\u00a0k<span class=\"p\">,</span>\u00a0nv<span class=\"p\">)</span></td></tr><tr><th id=\"L229\"><a href=\"#L229\">229</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L230\"><a href=\"#L230\">230</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Replace bases of non-module classes just to be sure.</span></td></tr><tr><th id=\"L231\"><a href=\"#L231\">231</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">(</span>v<span class=\"p\">)</span>\u00a0<span class=\"o\">==</span>\u00a0types<span class=\"o\">.</span>ClassType<span class=\"p\">:</span></td></tr><tr><th id=\"L232\"><a href=\"#L232\">232</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0base <span class=\"ow\">in</span>\u00a0v<span class=\"o\">.</span>__bases__<span class=\"p\">:</span></td></tr><tr><th id=\"L233\"><a href=\"#L233\">233</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0fromOldModule<span class=\"p\">(</span>base<span class=\"p\">):</span></td></tr><tr><th id=\"L234\"><a href=\"#L234\">234</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 latestClass<span class=\"p\">(</span>v<span class=\"p\">)</span></td></tr><tr><th id=\"L235\"><a href=\"#L235\">235</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog <span class=\"ow\">and</span>\u00a0<span class=\"ow\">not</span>\u00a0changed <span class=\"ow\">and</span>\u00a0<span class=\"p\">((</span>modcount <span class=\"o\">%</span>\u00a0<span class=\"mi\">10</span><span class=\"p\">)</span>\u00a0<span class=\"o\">==</span><span class=\"mi\">0</span><span class=\"p\">)</span>\u00a0<span class=\"p\">:</span></td></tr><tr><th id=\"L236\"><a href=\"#L236\">236</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"s\">\".\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L237\"><a href=\"#L237\">237</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>logfile<span class=\"o\">.</span>flush<span class=\"p\">()</span></td></tr><tr><th id=\"L238\"><a href=\"#L238\">238</a></th><td></td></tr><tr><th id=\"L239\"><a href=\"#L239\">239</a></th><td>\u00a0 \u00a0 components<span class=\"o\">.</span>ALLOW_DUPLICATES <span class=\"o\">=</span>\u00a0<span class=\"mi\">0</span></td></tr><tr><th id=\"L240\"><a href=\"#L240\">240</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0doLog<span class=\"p\">:</span></td></tr><tr><th id=\"L241\"><a href=\"#L241\">241</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">''</span><span class=\"p\">)</span></td></tr><tr><th id=\"L242\"><a href=\"#L242\">242</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'\u00a0 \u00a0Rebuilt </span><span class=\"si\">%s</span><span class=\"s\">.'</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>module<span class=\"o\">.</span>__name__<span class=\"p\">))</span></td></tr><tr><th id=\"L243\"><a href=\"#L243\">243</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0module</td></tr></tbody></table>\n\n      </div>\n      <div id=\"anydiff\">\n        <form action=\"/LUCICodeRepository/nomaticIM/diff\" method=\"get\">\n          <div class=\"buttons\">\n            <input type=\"hidden\" name=\"new_path\" value=\"/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py\" />\n            <input type=\"hidden\" name=\"old_path\" value=\"/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py\" />\n            <input type=\"hidden\" name=\"new_rev\" />\n            <input type=\"hidden\" name=\"old_rev\" />\n            <input type=\"submit\" value=\"View changes...\" title=\"Select paths and revs for Diff\" />\n          </div>\n        </form>\n      </div>\n      <div id=\"help\"><strong>Note:</strong> See <a href=\"/LUCICodeRepository/nomaticIM/wiki/TracBrowser\">TracBrowser</a>\n        for help on using the repository browser.</div>\n    </div>\n    <div id=\"altlinks\">\n      <h3>Download in other formats:</h3>\n      <ul>\n        <li class=\"first\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py?format=txt\">Plain Text</a>\n        </li><li class=\"last\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.5/buddy_bots/src/twisted/python/rebuild.py\">Original Format</a>\n        </li>\n      </ul>\n    </div>\n    </div>\n    <div id=\"footer\" lang=\"en\" xml:lang=\"en\"><hr />\n      <a id=\"tracpowered\" href=\"http://trac.edgewall.org/\"><img src=\"/LUCICodeRepository/nomaticIM/chrome/common/trac_logo_mini.png\" height=\"30\" width=\"107\" alt=\"Trac Powered\" /></a>\n      <p class=\"left\">Powered by <a href=\"/LUCICodeRepository/nomaticIM/about\"><strong>Trac 1.0.1</strong></a><br />\n        By <a href=\"http://www.edgewall.org/\">Edgewall Software</a>.</p>\n      <p class=\"right\">All content copyright 2007-2008 by LUCI <br /><a href=\"http://luci.ics.uci.edu/\">http://luci.ics.uci.edu/</a></p>\n    </div>\n\t\t<div id=\"sitefooter\">\n\t\t\t<script src=\"http://www.google-analytics.com/urchin.js\" type=\"text/javascript\">\n\t\t\t</script>\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t_uacct = \"UA-338915-2\";\n\t\t\t\turchinTracker();\n\t\t\t</script>\n\t\t</div>\n\t</body>\n</html>", "id": 44458.0}