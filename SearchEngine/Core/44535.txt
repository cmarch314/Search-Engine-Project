{"text": "Search LoginPreferencesHelp GuideAbout Trac WikiTimelineRoadmapBrowse SourceView TicketsSearch Context Navigation BlameRevision Log source nomatic tags NomaticIM 4 buddy bots src twisted protocols ftp py View diff against View revision Visit trunk Last change on this file was 712 checked in by cbaker 7 years ago First draft of nomatic buddy bots oscar bot is functional if you give it good authentication credentials jabber bot is just an example from the web File size 76 7 KB Line 1 test case name twisted test test ftp 2 Copyright c 2 1 2 4 Twisted Matrix Laboratories 3 See LICENSE for details 45 6An FTP protocol implementation78 author U Itamar Shtull Trauring mailto itamarst twistedmatrix com 9 author U Jp Calderone mailto exarkun divmod com 1 author U Andrew Bennetts mailto spiv twistedmatrix com 1112API stability FTPClient is stable FTP and FTPFactory server is unstable 13 1415 System Imports16import os17import time18import re19import operator2 import stat21import errno22import fnmatch2324try 25 import pwd grp26except ImportError 27 pwd grp None2829from zope interface import Interface implements3 31 Twisted Imports32from twisted import copyright33from twisted internet import reactor interfaces protocol error defer34from twisted protocols import basic policies3536from twisted python import log failure filepath3738from twisted cred import error as cred error portal credentials checkers394 constants41 response codes4243RESTART MARKER REPLY 1 44SERVICE READY IN N MINUTES 12 45DATA CNX ALREADY OPEN START XFR 125 46FILE STATUS OK OPEN DATA CNX 15 4748CMD OK 2 1 49TYPE SET OK 2 2 5 ENTERING PORT MODE 2 3 51CMD NOT IMPLMNTD SUPERFLUOUS 2 2 52SYS STATUS OR HELP REPLY 211 53DIR STATUS 212 54FILE STATUS 213 55HELP MSG 214 56NAME SYS TYPE 215 57SVC READY FOR NEW USER 22 1 58WELCOME MSG 22 2 59SVC CLOSING CTRL CNX 221 6 GOODBYE MSG 221 61DATA CNX OPEN NO XFR IN PROGRESS 225 62CLOSING DATA CNX 226 63TXFR COMPLETE OK 226 64ENTERING PASV MODE 227 65ENTERING EPSV MODE 229 66USR LOGGED IN PROCEED 23 1 v1 of code 23 67GUEST LOGGED IN PROCEED 23 2 v2 of code 23 68REQ FILE ACTN COMPLETED OK 25 69PWD REPLY 257 1 7 MKD REPLY 257 2 7172USR NAME OK NEED PASS 331 1 v1 of Code 33173GUEST NAME OK NEED EMAIL 331 2 v2 of code 33174NEED ACCT FOR LOGIN 332 75REQ FILE ACTN PENDING FURTHER INFO 35 7677SVC NOT AVAIL CLOSING CTRL CNX 421 1 78TOO MANY CONNECTIONS 421 2 79CANT OPEN DATA CNX 425 8 CNX CLOSED TXFR ABORTED 426 81REQ ACTN ABRTD FILE UNAVAIL 45 82REQ ACTN ABRTD LOCAL ERR 451 83REQ ACTN ABRTD INSUFF STORAGE 452 8485SYNTAX ERR 5 86SYNTAX ERR IN ARGS 5 1 87CMD NOT IMPLMNTD 5 2 88BAD CMD SEQ 5 3 89CMD NOT IMPLMNTD FOR PARAM 5 4 9 NOT LOGGED IN 53 1 v1 of code 53 please log in91AUTH FAILURE 53 2 v2 of code 53 authorization failure92NEED ACCT FOR STOR 532 93FILE NOT FOUND 55 1 no such file or directory94PERMISSION DENIED 55 2 permission denied95ANON USER DENIED 55 3 anonymous users can t alter filesystem96IS NOT A DIR 55 4 rmd called on a path that is not a directory97REQ ACTN NOT TAKEN 55 5 98PAGE TYPE UNK 551 99EXCEEDED STORAGE ALLOC 552 1 FILENAME NOT ALLOWED 553 1 11 21 3RESPONSE 1 4 1 s 1 5 RESTART MARKER REPLY 11 MARK yyyy mmmm TODO this must be fixed1 6 SERVICE READY IN N MINUTES 12 service ready in s minutes 1 7 DATA CNX ALREADY OPEN START XFR 125 Data connection already open starting transfer 1 8 FILE STATUS OK OPEN DATA CNX 15 File status okay about to open data connection 1 911 2 s 111 CMD OK 2 Command OK 112 TYPE SET OK 2 Type set to s 113 ENTERING PORT MODE 2 PORT OK 114 CMD NOT IMPLMNTD SUPERFLUOUS 2 2 Command not implemented superfluous at this site 115 SYS STATUS OR HELP REPLY 211 System status reply 116 DIR STATUS 212 s 117 FILE STATUS 213 s 118 HELP MSG 214 help s 119 NAME SYS TYPE 215 UNIX Type L8 12 WELCOME MSG 22 s 121 SVC READY FOR NEW USER 22 Service ready 122 GOODBYE MSG 221 Goodbye 123 DATA CNX OPEN NO XFR IN PROGRESS 225 data connection open no transfer in progress 124 CLOSING DATA CNX 226 Abort successful 125 TXFR COMPLETE OK 226 Transfer Complete 126 ENTERING PASV MODE 227 Entering Passive Mode s 127 ENTERING EPSV MODE 229 Entering Extended Passive Mode s where is epsv defined in the rfc s 128 USR LOGGED IN PROCEED 23 User logged in proceed 129 GUEST LOGGED IN PROCEED 23 Anonymous login ok access restrictions apply 13 REQ FILE ACTN COMPLETED OK 25 Requested File Action Completed OK i e CWD completed ok131 PWD REPLY 257 s 132 MKD REPLY 257 s created 133134 3 s 135 userotp 331 Response to s 136 USR NAME OK NEED PASS 331 Password required for s 137 GUEST NAME OK NEED EMAIL 331 Guest login ok type your email address as password 138139 REQ FILE ACTN PENDING FURTHER INFO 35 Requested file action pending further information 14 141 4 s 142 SVC NOT AVAIL CLOSING CTRL CNX 421 Service not available closing control connection 143 TOO MANY CONNECTIONS 421 Too many users right now try again in a few minutes 144 CANT OPEN DATA CNX 425 Can t open data connection 145 CNX CLOSED TXFR ABORTED 426 Transfer aborted Data connection closed 146147 REQ ACTN ABRTD LOCAL ERR 451 Requested action aborted Local error in processing 14814915 5 s 151 SYNTAX ERR 5 Syntax error s 152 SYNTAX ERR IN ARGS 5 1 syntax error in argument s s 153 CMD NOT IMPLMNTD 5 2 Command s not implemented 154 BAD CMD SEQ 5 3 Incorrect sequence of commands s 155 CMD NOT IMPLMNTD FOR PARAM 5 4 Not implemented for parameter s 156 NOT LOGGED IN 53 Please login with USER and PASS 157 AUTH FAILURE 53 Sorry Authentication failed 158 NEED ACCT FOR STOR 532 Need an account for storing files 159 FILE NOT FOUND 55 s No such file or directory 16 PERMISSION DENIED 55 s Permission denied 161 ANON USER DENIED 55 Anonymous users are forbidden to change the filesystem 162 IS NOT A DIR 55 Cannot rmd s is not a directory 163 REQ ACTN NOT TAKEN 55 Requested action not taken s 164 EXCEEDED STORAGE ALLOC 552 Requested file action aborted exceeded file storage allocation 165 FILENAME NOT ALLOWED 553 Requested action not taken file name not allowed 166 167168169class InvalidPath Exception 17 pass171172173def toSegments cwd path 174 175 Normalize a path as represented by a list of strings each176 representing one segment of the path 177 178 if path startswith 179 segs 18 else 181 segs cwd 182183 for s in path split 184 if s or s 185 continue186 elif s 187 if segs 188 segs pop 189 else 19 raise InvalidPath cwd path 191 elif in s or in s 192 raise InvalidPath cwd path 193 else 194 segs append s 195 return segs196197198def errnoToFailure e path 199 if e errno ENOENT or e errno EISDIR 2 return defer fail FileNotFoundError path 2 1 elif e errno EACCES or e errno EPERM 2 2 return defer fail PermissionDeniedError path 2 3 elif e errno ENOTDIR 2 4 return defer fail IsNotADirectoryError path 2 5 else 2 6 return defer fail 2 72 8 Generic VFS exceptions2 9class FilesystemShellException Exception 21 Base for IFTPShell errors 211 212213class NoSuchFile FilesystemShellException 214 pass215216class PermissionDenied FilesystemShellException 217 pass218219class WrongFiletype FilesystemShellException 22 pass221222223 Custom Exceptions 224225class FTPCmdError Exception 226 def init self msg 227 Exception init self msg 228 self errorMessage msg22923 def response self 231 Generate a FTP response message for this error 232 return RESPONSE self errorCode self errorMessage233234235class FileNotFoundError FTPCmdError 236 errorCode FILE NOT FOUND237238239class AnonUserDeniedError FTPCmdError 24 241 Raised when an anonymous user issues a command that will alter the242 filesystem243 244 def init self 245 No message246 FTPCmdError init self None 247248 errorCode ANON USER DENIED24925 251class PermissionDeniedError FTPCmdError 252 253 Raised when access is attempted to a resource to which access is254 not allowed 255 256 errorCode PERMISSION DENIED257258259class IsNotADirectoryError FTPCmdError 26 raised when RMD is called on a path that isn t a directory261 262 errorCode IS NOT A DIR263264class CmdSyntaxError FTPCmdError 265 errorCode SYNTAX ERR266267class CmdArgSyntaxError FTPCmdError 268 errorCode SYNTAX ERR IN ARGS26927 class CmdNotImplementedError FTPCmdError 271 raised when an unimplemented command is given to the server272 273 errorCode CMD NOT IMPLMNTD274275class CmdNotImplementedForArgError FTPCmdError 276 errorCode CMD NOT IMPLMNTD FOR PARAM277278class FTPError Exception 279 pass28 281class FTPTimeoutError Exception 282 pass283284class DTPError Exception 285 pass286287class BogusClientError Exception 288 thrown when a client other than the one we opened this289 DTP connection for attempts to connect or a client attempts to29 get us to connect to an ip that differs from the one where the291 request came from 292 pass293294class PathBelowTLDError FTPCmdError 295 errorCode PERMISSION DENIED296297class ClientDisconnectError Exception 298 pass2993 class PortConnectionError Exception 3 1 pass3 23 3class BadCmdSequenceError FTPCmdError 3 4 raised when a client sends a series of commands in an illogical sequence 3 5 errorCode BAD CMD SEQ3 63 7class AuthorizationError FTPCmdError 3 8 raised when client authentication fails 3 9 errorCode AUTH FAILURE31 311312 Utility Functions 313314def debugDeferred self 315 log msg debugDeferred s str debug True 316317318 DTP Protocol 31932 321 months 322 None 323 Jan Feb Mar Apr May Jun 324 Jul Aug Sep Oct Nov Dec 325326class DTP object protocol Protocol 327 implements interfaces IConsumer 328329 isConnected False33 331 cons None332 onConnLost None333 buffer None334335 def connectionMade self 336 self isConnected True337 self factory deferred callback None 338 self buffer 33934 def connectionLost self reason 341 self isConnected False342 if self onConnLost is not None 343 self onConnLost callback None 344345 def sendLine self line 346 self transport write line r n 347348349 def formatOneListResponse self name size directory permissions hardlinks modified owner group 35 def formatMode mode 351 return join mode 256 n and rwx n 3 or for n in range 9 352353 def formatDate mtime 354 now time gmtime 355 info 356 month months mtime tm mon 357 day mtime tm mday 358 year mtime tm year 359 hour mtime tm hour 36 minute mtime tm min361 362 if now tm year mtime tm year 363 return month s day 2d year 5d info364 else 365 return month s day 2d hour 2d minute 2d info366367 format directory s permissions s hardlinks 4d 368 owner 9s group 9s size 15d date 12s 369 name s 37 371 return format 372 directory directory and d or 373 permissions formatMode permissions 374 hardlinks hardlinks 375 owner owner 8 376 group group 8 377 size size 378 date formatDate time gmtime modified 379 name name 38 381 def sendListResponse self name response 382 self sendLine self formatOneListResponse name response 383384385 Proxy IConsumer to our transport386 def registerProducer self producer streaming 387 return self transport registerProducer producer streaming 388389 def unregisterProducer self 39 self transport unregisterProducer 391 self transport loseConnection 392393 def write self data 394 if self isConnected 395 return self transport write data 396 raise Exception Crap damn crap damn crap damn 397398399 Pretend to be a producer too 4 def conswrite self bytes 4 1 try 4 2 self cons write bytes 4 3 except 4 4 self onConnLost errback 4 54 6 def dataReceived self bytes 4 7 if self cons is not None 4 8 self conswrite bytes 4 9 else 41 self buffer append bytes 411412 def unregConsumer self ignored 413 self cons unregisterProducer 414 self cons None415 del self onConnLost416 return ignored417418 def registerConsumer self cons 419 assert self cons is None42 self cons cons421 self cons registerProducer self True 422 for chunk in self buffer 423 self conswrite chunk 424 self buffer None425 if self isConnected 426 self onConnLost d defer Deferred 427 d addBoth self unregConsumer 428 return d429 else 43 self cons unregisterProducer 431 self cons None432 return defer succeed None 433434 def resumeProducing self 435 self transport resumeProducing 436437 def pauseProducing self 438 self transport pauseProducing 43944 def stopProducing self 441 self transport stopProducing 442443class DTPFactory protocol ClientFactory 444 445 DTP protocol factory 446 447 ivar peerCheck perform checks to make sure the ftp pi s peer is the same448 as the dtp s449 ivar pi a reference to this factory s protocol interpreter45 451452 configuration variables 453 peerCheck False454455 class variables 456 def init self pi peerHost None 457 Constructor458 param pi this factory s protocol interpreter459 param peerHost if peerCheck is True this is the tuple that the46 generated instance will use to perform security checks461 462 self pi pi the protocol interpreter that is using this factory463 self peerHost peerHost the from FTP transport peerHost 464 self deferred defer Deferred deferred will fire when instance is connected465 self deferred addBoth lambda ign delattr self deferred ign 1 466 self delayedCall None467468 def buildProtocol self addr 469 log msg DTPFactory buildProtocol debug True 47 self cancelTimeout 471 if self pi dtpInstance only create one instance472 return473 p DTP 474 p factory self475 p pi self pi476 self pi dtpInstance p477 return p478479 def stopFactory self 48 log msg dtpFactory stopFactory debug True 481 self cancelTimeout 482483 def timeoutFactory self 484 log msg timed out waiting for DTP connection 485 if self deferred 486 d self deferred self deferred None487488 TODO LEFT OFF HERE 48949 d addErrback debugDeferred timeoutFactory firing errback 491 d errback defer TimeoutError 492 self stopFactory 493494 def cancelTimeout self 495 if not self delayedCall called and not self delayedCall cancelled 496 log msg cancelling DTP timeout debug True 497 self delayedCall cancel 498 assert self delayedCall cancelled499 log msg timeout has been cancelled debug True 5 5 1 def setTimeout self seconds 5 2 log msg DTPFactory setTimeout set to s seconds seconds 5 3 self delayedCall reactor callLater seconds self timeoutFactory 5 45 5 def clientConnectionFailed self connector reason 5 6 self deferred errback PortConnectionError reason 5 75 8 FTP PI Protocol Interpreter 5 951 class ASCIIConsumerWrapper object 511 def init self cons 512 self cons cons513 self registerProducer cons registerProducer514 self unregisterProducer cons unregisterProducer515516 assert os linesep r n or len os linesep 1 Unsupported platform yea right like this even exists 517518 if os linesep r n 519 self write cons write52 521 def write self bytes 522 return self cons write bytes replace os linesep r n 523524525class FileConsumer object 526 def init self fObj 527 self fObj fObj528529 def registerProducer self producer streaming 53 self producer producer531 assert streaming532533 def unregisterProducer self 534 self producer None535 self fObj close 536537 def write self bytes 538 self fObj write bytes 53954 541class FTPOverflowProtocol basic LineReceiver 542 FTP mini protocol for when there are too many connections 543 def connectionMade self 544 self sendLine RESPONSE TOO MANY CONNECTIONS 545 self transport loseConnection 546547548class FTP object basic LineReceiver policies TimeoutMixin 549 Protocol Interpreter for the File Transfer Protocol55 551 ivar state The current server state One of L UNAUTH 552 L INAUTH L AUTHED L RENAMING 553554 ivar shell The connected avatar555 ivar binary The transfer mode If false ASCII 556 ivar dtpFactory Generates a single DTP for this session557 ivar dtpPort Port returned from listenTCP558 55956 disconnected False561562 States an FTP can be in563 UNAUTH INAUTH AUTHED RENAMING range 4 564565 how long the DTP waits for a connection566 dtpTimeout 1 567568 portal None569 shell None the avatar57 dtpFactory None generates a single DTP for this session571 dtpPort None object returned from listenTCP572 dtpInstance None573 binary True binary transfers False implies ASCII defaults to True574575576 def reply self key args 577 msg RESPONSE key args578 self sendLine msg 57958 581 def connectionMade self 582 self state self UNAUTH583 self setTimeout self timeOut 584 self reply WELCOME MSG self factory welcomeMessage 585586 def connectionLost self reason 587 if we have a DTP protocol instance running and588 we lose connection to the client s PI kill the589 DTP connection and close the port59 if self dtpFactory 591 self cleanupDTP 592 self setTimeout None 593 if hasattr self shell logout and self shell logout is not None 594 self shell logout 595 self shell None596 self transport None597598 def timeoutConnection self 599 self transport loseConnection 6 6 1 def lineReceived self line 6 2 self resetTimeout 6 3 self pauseProducing 6 46 5 def processFailed err 6 6 if err check FTPCmdError 6 7 self sendLine err value response 6 8 elif err check TypeError and 6 9 err value args find takes exactly 1 61 self reply SYNTAX ERR s requires an argument cmd 611 else 612 log msg Unexpected FTP error 613 log err err 614 self reply REQ ACTN NOT TAKEN internal server error 615616 def processSucceeded result 617 if isinstance result tuple 618 self reply result 619 elif result is not None 62 self reply result 621622 def allDone ignored 623 if not self disconnected 624 self resumeProducing 625626 spaceIndex line find 627 if spaceIndex 1 628 cmd line spaceIndex 629 args line spaceIndex 1 63 else 631 cmd line632 args 633 d defer maybeDeferred self processCommand cmd args 634 d addCallbacks processSucceeded processFailed 635 d addErrback log err 636637 XXX It burnsss638 LineReceiver doesn t let you resumeProducing inside639 lineReceived atm64 from twisted internet import reactor641 reactor callLater d addBoth allDone 642643644 def processCommand self cmd params 645 cmd cmd upper 646647 if self state self UNAUTH 648 if cmd USER 649 return self ftp USER params 65 elif cmd PASS 651 return BAD CMD SEQ USER required before PASS 652 else 653 return NOT LOGGED IN654655 elif self state self INAUTH 656 if cmd PASS 657 return self ftp PASS params 658 else 659 return BAD CMD SEQ PASS required after USER 66 661 elif self state self AUTHED 662 method getattr self ftp cmd None 663 if method is not None 664 return method params 665 return defer fail CmdNotImplementedError cmd 666667 elif self state self RENAMING 668 if cmd RNTO 669 return self ftp RNTO params 67 else 671 return BAD CMD SEQ RNTO required after RNFR 672673674 def ftp USER self username 675 676 First part of login Get the username the peer wants to677 authenticate as 678 679 if not username 68 return defer fail CmdSyntaxError USER requires an argument 681682 self user username683 self state self INAUTH684 if self factory allowAnonymous and self user self factory userAnonymous 685 return GUEST NAME OK NEED EMAIL686 else 687 return USR NAME OK NEED PASS username 688689 TODO add max auth try before timeout from ip 69 TODO need to implement minimal ABOR command691692 def ftp PASS self password 693 694 Second part of login Get the password the peer wants to695 authenticate with 696 697 if self factory allowAnonymous and self user self factory userAnonymous 698 anonymous login699 creds credentials Anonymous 7 reply GUEST LOGGED IN PROCEED7 1 else 7 2 user login7 3 creds credentials UsernamePassword self user password 7 4 reply USR LOGGED IN PROCEED7 5 del self user7 67 7 def cbLogin interface avatar logout 7 8 assert interface is IFTPShell The realm is busted jerk 7 9 self shell avatar71 self logout logout711 self workingDirectory 712 self state self AUTHED713 return reply714715 def ebLogin failure 716 failure trap cred error UnauthorizedLogin cred error UnhandledCredentials 717 self state self UNAUTH718 raise AuthorizationError71972 d self portal login creds None IFTPShell 721 d addCallbacks cbLogin ebLogin 722 return d723724725 def ftp PASV self 726 Request for a passive connection727728 from the rfc 72973 This command requests the server DTP to listen on a data port731 which is not its default data port and to wait for a connection732 rather than initiate one upon receipt of a transfer command The733 response to this command includes the host and port address this734 server is listening on 735 736 if we have a DTP port set up lose it 737 if self dtpFactory is not None 738 cleanupDTP sets dtpFactory to none Later we ll do739 cleanup here or something 74 self cleanupDTP 741 self dtpFactory DTPFactory pi self 742 self dtpFactory setTimeout self dtpTimeout 743 self dtpPort reactor listenTCP self dtpFactory 744745 host self transport getHost host746 port self dtpPort getHost port747 self reply ENTERING PASV MODE encodeHostPort host port 748 return self dtpFactory deferred addCallback lambda ign None 74975 751 def ftp PORT self address 752 addr map int address split 753 ip d d d d tuple addr 4 754 port addr 4 8 addr 5 755756 if we have a DTP port set up lose it 757 if self dtpFactory is not None 758 self cleanupDTP 75976 self dtpFactory DTPFactory pi self peerHost self transport getPeer host 761 self dtpFactory setTimeout self dtpTimeout 762 self dtpPort reactor connectTCP ip port self dtpFactory 763764 def connected ignored 765 return ENTERING PORT MODE766 def connFailed err 767 err trap PortConnectionError 768 return CANT OPEN DATA CNX769 return self dtpFactory deferred addCallbacks connected connFailed 77 771772 def ftp LIST self path 773 This command causes a list to be sent from the server to the774 passive DTP If the pathname specifies a directory or other775 group of files the server should transfer a list of files776 in the specified directory If the pathname specifies a777 file then the server should send current information on the778 file A null argument implies the user s current working or779 default directory 78 781 Uh for now do this retarded thing 782 if self dtpInstance is None or not self dtpInstance isConnected 783 return defer fail BadCmdSequenceError must send PORT or PASV before RETR 784785 bug in konqueror786 if path a 787 path 788 bug in gFTP 2 15789 if path aL 79 path 791 bug in Nautilus 2 1 792 if path L 793 path 794 bug in ange ftp795 if path la 796 path 797798 def gotListing results 799 self reply DATA CNX ALREADY OPEN START XFR 8 for name attrs in results 8 1 self dtpInstance sendListResponse name attrs 8 2 self dtpInstance transport loseConnection 8 3 return TXFR COMPLETE OK 8 48 5 try 8 6 segments toSegments self workingDirectory path 8 7 except InvalidPath e 8 8 return defer fail FileNotFoundError path 8 981 d self shell list 811 segments 812 size directory permissions hardlinks 813 modified owner group 814 d addCallback gotListing 815 return d816817818 def ftp NLST self path 819 XXX why is this check different to ftp RETR ftp STOR 82 if self dtpInstance is None or not self dtpInstance isConnected 821 return defer fail BadCmdSequenceError must send PORT or PASV before RETR 822823 try 824 segments toSegments self workingDirectory path 825 except InvalidPath e 826 return defer fail FileNotFoundError path 827828 def cbList results 829 self reply DATA CNX ALREADY OPEN START XFR 83 for name ignored in results 831 self dtpInstance sendLine name 832 self dtpInstance transport loseConnection 833 return TXFR COMPLETE OK 834835 def cbGlob results 836 self reply DATA CNX ALREADY OPEN START XFR 837 for name ignored in results 838 if fnmatch fnmatch name segments 1 839 self dtpInstance sendLine name 84 self dtpInstance transport loseConnection 841 return TXFR COMPLETE OK 842843 XXX Maybe this globbing is incomplete but who cares 844 Stupid people probably 845 if segments and 846 in segments 1 or in segments 1 or847 in segments 1 and in segments 1 848 d self shell list segments 1 849 d addCallback cbGlob 85 else 851 d self shell list segments 852 d addCallback cbList 853 return d854855856 def ftp CWD self path 857 try 858 segments toSegments self workingDirectory path 859 except InvalidPath e 86 XXX Eh what to fail with here 861 return defer fail FileNotFoundError path 862863 def accessGranted result 864 self workingDirectory segments865 return REQ FILE ACTN COMPLETED OK 866867 return self shell access segments addCallback accessGranted 86886987 def ftp CDUP self 871 return self ftp CWD 872873874 def ftp PWD self 875 return PWD REPLY join self workingDirectory 876877878 def ftp RETR self path 879 if self dtpInstance is None 88 raise BadCmdSequenceError PORT or PASV required before RETR 881882 try 883 newsegs toSegments self workingDirectory path 884 except InvalidPath 885 return defer fail FileNotFoundError path 886887 XXX For now just disable the timeout Later we ll want to888 leave it active and have the DTP connection reset it889 periodically 89 self setTimeout None 891892 Put it back later893 def enableTimeout result 894 self setTimeout self factory timeOut 895 return result896897 And away she goes898 if not self binary 899 cons ASCIIConsumerWrapper self dtpInstance 9 else 9 1 cons self dtpInstance9 29 3 def cbSent result 9 4 return TXFR COMPLETE OK 9 59 6 def ebSent err 9 7 log msg Unexpected error attempting to transmit file to client 9 8 log err err 9 9 return CNX CLOSED TXFR ABORTED 91 911 def cbOpened file 912 Tell them what to doooo913 if self dtpInstance isConnected 914 self reply DATA CNX ALREADY OPEN START XFR 915 else 916 self reply FILE STATUS OK OPEN DATA CNX 917918 d file send cons 919 d addCallbacks cbSent ebSent 92 return d921922 def ebOpened err 923 if not err check PermissionDeniedError FileNotFoundError IsNotADirectoryError 924 log msg Unexpected error attempting to open file for transmission 925 log err err 926 return FILE NOT FOUND join newsegs 927928 d self shell openForReading newsegs 929 d addCallbacks cbOpened ebOpened 93 d addBoth enableTimeout 931932 Pass back Deferred that fires when the transfer is done933 return d934935936 def ftp STOR self path 937 if self dtpInstance is None 938 raise BadCmdSequenceError PORT or PASV required before STOR 93994 try 941 newsegs toSegments self workingDirectory path 942 except InvalidPath 943 return defer fail FileNotFoundError path 944945 XXX For now just disable the timeout Later we ll want to946 leave it active and have the DTP connection reset it947 periodically 948 self setTimeout None 94995 Put it back later951 def enableTimeout result 952 self setTimeout self factory timeOut 953 return result954955 def cbSent result 956 return TXFR COMPLETE OK 957958 def ebSent err 959 log msg Unexpected error receiving file from client 96 log err err 961 return CNX CLOSED TXFR ABORTED 962963 def cbConsumer cons 964 if not self binary 965 cons ASCIIConsumerWrapper cons 966967 d self dtpInstance registerConsumer cons 968 d addCallbacks cbSent ebSent 96997 Tell them what to doooo971 if self dtpInstance isConnected 972 self reply DATA CNX ALREADY OPEN START XFR 973 else 974 self reply FILE STATUS OK OPEN DATA CNX 975976 return d977978 def cbOpened file 979 d file receive 98 d addCallback cbConsumer 981 return d982983 def ebOpened err 984 if not err check PermissionDeniedError FileNotFoundError IsNotADirectoryError 985 log msg Unexpected error attempting to open file for upload 986 log err err 987 return FILE NOT FOUND join newsegs 988989 d self shell openForWriting newsegs 99 d addCallbacks cbOpened ebOpened 991 d addBoth enableTimeout 992993 Pass back Deferred that fires when the transfer is done994 return d995996997 def ftp SIZE self path 998 try 999 newsegs toSegments self workingDirectory path 1 except InvalidPath 1 1 return defer fail FileNotFoundError path 1 21 3 def cbStat size 1 4 return FILE STATUS str size 1 51 6 return self shell stat newsegs size addCallback cbStat 1 71 81 9 def ftp MDTM self path 1 1 try 1 11 newsegs toSegments self workingDirectory path 1 12 except InvalidPath 1 13 return defer fail FileNotFoundError path 1 141 15 def cbStat modified 1 16 return FILE STATUS time strftime Y m d H M S time gmtime modified 1 171 18 return self shell stat newsegs modified addCallback cbStat 1 191 2 1 21 def ftp TYPE self type 1 22 p type upper 1 23 if p 1 24 f getattr self type p None 1 25 if f is not None 1 26 return f p 1 1 27 return self type UNKNOWN p 1 28 return SYNTAX ERR 1 291 3 def type A self code 1 31 if code or code N 1 32 self binary False1 33 return TYPE SET OK A code 1 34 else 1 35 return defer fail CmdArgSyntaxError code 1 361 37 def type I self code 1 38 if code 1 39 self binary True1 4 return TYPE SET OK I 1 41 else 1 42 return defer fail CmdArgSyntaxError code 1 431 44 def type UNKNOWN self code 1 45 return defer fail CmdNotImplementedForArgError code 1 461 471 481 49 def ftp SYST self 1 5 return NAME SYS TYPE1 511 521 53 def ftp STRU self structure 1 54 p structure upper 1 55 if p F 1 56 return CMD OK 1 57 return defer fail CmdNotImplementedForArgError structure 1 581 591 6 def ftp MODE self mode 1 61 p mode upper 1 62 if p S 1 63 return CMD OK 1 64 return defer fail CmdNotImplementedForArgError mode 1 651 661 67 def ftp MKD self path 1 68 try 1 69 newsegs toSegments self workingDirectory path 1 7 except InvalidPath 1 71 return defer fail FileNotFoundError path 1 72 return self shell makeDirectory newsegs addCallback lambda ign MKD REPLY path 1 731 741 75 def ftp RMD self path 1 76 try 1 77 newsegs toSegments self workingDirectory path 1 78 except InvalidPath 1 79 return defer fail FileNotFoundError path 1 8 return self shell removeDirectory newsegs addCallback lambda ign REQ FILE ACTN COMPLETED OK 1 811 821 83 def ftp DELE self path 1 84 try 1 85 newsegs toSegments self workingDirectory path 1 86 except InvalidPath 1 87 return defer fail FileNotFoundError path 1 88 return self shell removeFile newsegs addCallback lambda ign REQ FILE ACTN COMPLETED OK 1 891 9 1 91 def ftp NOOP self 1 92 return CMD OK 1 931 941 95 def ftp RNFR self fromName 1 96 self fromName fromName1 97 self state self RENAMING1 98 return REQ FILE ACTN PENDING FURTHER INFO 1 9911 11 1 def ftp RNTO self toName 11 2 fromName self fromName11 3 del self fromName11 4 self state self AUTHED11 511 6 try 11 7 fromsegs toSegments self workingDirectory fromName 11 8 tosegs toSegments self workingDirectory toName 11 9 except InvalidPath 111 return defer fail FileNotFoundError fromName 1111 return self shell rename fromsegs tosegs addCallback lambda ign REQ FILE ACTN COMPLETED OK 111211131114 def ftp QUIT self 1115 self reply GOODBYE MSG 1116 self transport loseConnection 1117 self disconnected True11181119112 def cleanupDTP self 1121 call when DTP connection exits1122 1123 log msg cleanupDTP debug True 11241125 log msg self dtpPort 1126 dtpPort self dtpPort self dtpPort None1127 if interfaces IListeningPort providedBy dtpPort 1128 dtpPort stopListening 1129 elif interfaces IConnector providedBy dtpPort 113 dtpPort disconnect 1131 else 1132 assert False dtpPort should be an IListeningPort or IConnector instead is r dtpPort 11331134 self dtpFactory stopFactory 1135 self dtpFactory None11361137 if self dtpInstance is not None 1138 self dtpInstance None1139114 1141class FTPFactory policies LimitTotalConnectionsFactory 1142 A factory for producing ftp protocol instances11431144 ivar timeOut the protocol interpreter s idle timeout time in seconds 1145 default is 6 seconds 1146 1147 protocol FTP1148 overflowProtocol FTPOverflowProtocol1149 allowAnonymous True115 userAnonymous anonymous 1151 timeOut 6 11521153 welcomeMessage Twisted s FTP Server copyright version 11541155 def init self portal None userAnonymous anonymous 1156 self portal portal1157 self userAnonymous anonymous 1158 self instances 1159116 def buildProtocol self addr 1161 p policies LimitTotalConnectionsFactory buildProtocol self addr 1162 if p is not None 1163 p wrappedProtocol portal self portal1164 p wrappedProtocol timeOut self timeOut1165 return p11661167 def stopFactory self 1168 make sure ftp instance s timeouts are set to None1169 to avoid reactor complaints117 p setTimeout None for p in self instances if p timeOut is not None 1171 policies LimitTotalConnectionsFactory stopFactory self 11721173 Cred Objects 11741175class IFTPShell Interface 1176 1177 An abstraction of the shell commands used by the FTP protocol for1178 a given user account 1179118 All path names must be absolute 1181 11821183 def makeDirectory path 1184 1185 Create a directory 11861187 param path The path as a list of segments to create1188 type path C list of C unicode 1189119 return A Deferred which fires when the directory has been1191 created or which fails if the directory cannot be created 1192 119311941195 def removeDirectory path 1196 1197 Remove a directory 11981199 param path The path as a list of segments to remove12 type path C list of C unicode 12 112 2 return A Deferred which fires when the directory has been12 3 removed or which fails if the directory cannot be removed 12 4 12 512 612 7 def removeFile path 12 8 12 9 Remove a file 121 1211 param path The path as a list of segments to remove1212 type path C list of C unicode 12131214 return A Deferred which fires when the file has been1215 removed or which fails if the file cannot be removed 1216 121712181219 def rename fromPath toPath 122 1221 Rename a file or directory 12221223 param fromPath The current name of the path 1224 type fromPath C list of C unicode 12251226 param toPath The desired new name of the path 1227 type toPath C list of C unicode 12281229 return A Deferred which fires when the path has been123 renamed or which fails if the path cannot be renamed 1231 123212331234 def access path 1235 1236 Determine whether access to the given path is allowed 12371238 param path The path as a list of segments1239124 return A Deferred which fires with None if access is allowed1241 or which fails with a specific exception type if access is1242 denied 1243 124412451246 def stat path keys 1247 1248 Retrieve information about the given path 1249125 This is like list except it will never return results about1251 child paths 1252 125312541255 def list path keys 1256 1257 Retrieve information about the given path 12581259 If the path represents a non directory the result list should126 have only one entry with information about that non directory 1261 Otherwise the result list should have an element for each1262 child of the directory 12631264 param path The path as a list of segments to list1265 type path C list of C unicode 12661267 param keys A tuple of keys desired in the resulting1268 dictionaries 1269127 return A Deferred which fires with a list of name list 1271 where the name is the name of the entry as a unicode string1272 and each list contains values corresponding to the requested1273 keys The following are possible elements of keys and the1274 values which should be returned for them 12751276 C size size in bytes as an integer this is kinda required 12771278 C directory boolean indicating the type of this entry1279128 C permissions a bitvector see os stat foo st mode 12811282 C hardlinks Number of hard links to this entry12831284 C modified number of seconds since the epoch since entry was1285 modified12861287 C owner string indicating the user owner of this entry12881289 C group string indicating the group owner of this entry129 129112921293 def openForReading path 1294 1295 param path The path as a list of segments to open1296 type path C list of C unicode 12971298 rtype C Deferred which will fire with L IReadFile 1299 13 13 113 2 def openForWriting path 13 3 13 4 param path The path as a list of segments to open13 5 type path C list of C unicode 13 613 7 rtype C Deferred which will fire with L IWriteFile 13 8 13 9131 1311class IReadFile Interface 1312 A file out of which bytes may be read 1313 1314 def send consumer 1315 1316 Produce the contents of the given path to the given consumer This1317 method may only be invoked once on each provider 13181319 type consumer C IConsumer 132 1321 return A Deferred which fires when the file has been1322 consumed completely 1323 132413251326class IWriteFile Interface 1327 A file into which bytes may be written 1328 1329 def receive 133 1331 Create a consumer which will write to this file This method may1332 only be invoked once on each provider 13331334 rtype C Deferred of C IConsumer 1335 133613371338def getgroups uid 1339 Return the primary and supplementary groups for the given UID 134 1341 type uid C int 1342 1343 result 1344 pwent pwd getpwuid uid 13451346 result append pwent pw gid 13471348 for grent in grp getgrall 1349 if pwent pw name in grent gr mem 135 result append grent gr gid 13511352 return result135313541355def testPermissions uid gid spath mode r 1356 1357 checks to see if uid has proper permissions to access path with mode13581359 type uid C int 136 param uid numeric user id13611362 type gid C int 1363 param gid numeric group id13641365 type spath C str 1366 param spath the path on the server to test13671368 type mode C str 1369 param mode r or w read or write 137 1371 rtype C bool 1372 return True if the given credentials have the specified form of1373 access to the given path1374 1375 if mode r 1376 usr stat S IRUSR1377 grp stat S IRGRP1378 oth stat S IROTH1379 amode os R OK138 elif mode w 1381 usr stat S IWUSR1382 grp stat S IWGRP1383 oth stat S IWOTH1384 amode os W OK1385 else 1386 raise ValueError Invalid mode r must specify r or w mode 13871388 access False1389 if os path exists spath 139 if uid 1391 access True1392 else 1393 s os stat spath 1394 if usr s st mode and uid s st uid 1395 access True1396 elif grp s st mode and gid in getgroups uid 1397 access True1398 elif oth s st mode 1399 access True14 14 1 if access 14 2 if not os access spath amode 14 3 access False14 4 log msg Filesystem grants permission to UID d but it is inaccessible to me running as UID d 14 5 uid os getuid 14 6 return access14 714 814 9class FTPAnonymousShell object 141 An anonymous implementation of IFTPShell14111412 type filesystemRoot L twisted python filepath FilePath 1413 ivar filesystemRoot The path which is considered the root of1414 this shell 1415 1416 implements IFTPShell 14171418 def init self filesystemRoot 1419 self filesystemRoot filesystemRoot142 1421 def path self path 1422 return reduce filepath FilePath child path self filesystemRoot 14231424 def makeDirectory self path 1425 return defer fail AnonUserDeniedError 14261427 def removeDirectory self path 1428 return defer fail AnonUserDeniedError 1429143 def removeFile self path 1431 return defer fail AnonUserDeniedError 14321433 def rename self fromPath toPath 1434 return defer fail AnonUserDeniedError 14351436 def receive self path 1437 path self path path 1438 return defer fail AnonUserDeniedError 1439144 def openForReading self path 1441 p self path path 1442 try 1443 f p open rb 1444 except IOError OSError e 1445 return errnoToFailure e errno path 1446 except 1447 return defer fail 1448 else 1449 return defer succeed FileReader f 145 1451 def access self path 1452 p self path path 1453 For now just see if we can os listdir it1454 try 1455 p listdir 1456 except IOError OSError e 1457 return errnoToFailure e errno path 1458 except 1459 return defer fail 146 else 1461 return defer succeed None 14621463 def stat self path keys 1464 p self path path 1465 if p isdir 1466 return defer fail WrongFiletype 1467 else 1468 return self list path keys addCallback lambda res res 1 1469147 def list self path keys 1471 path self path path 1472 if path isdir 1473 entries path listdir 1474 else 1475 entries None 14761477 results 1478 for fName in entries 1479 ent 148 results append fName ent 1481 if keys 1482 if fName is not None 1483 p os path join path path fName 1484 else 1485 p path path1486 try 1487 statResult os stat p 1488 except IOError OSError e 1489 return errnoToFailure e errno path 149 except 1491 return defer fail 14921493 for k in keys 1494 ent append getattr self list k statResult 1495 return defer succeed results 14961497 list size operator attrgetter st size 1498 list permissions operator attrgetter st mode 1499 list hardlinks operator attrgetter st nlink 15 list modified operator attrgetter st mtime 15 115 2 def list owner self st 15 3 if pwd is not None 15 4 try 15 5 return pwd getpwuid st st uid 15 6 except KeyError 15 7 pass15 8 return str st st uid 15 9151 def list group self st 1511 if grp is not None 1512 try 1513 return grp getgrgid st st gid 1514 except KeyError 1515 pass1516 return str st st gid 15171518 def list directory self st 1519 return bool st st mode stat S IFDIR 152 15211522class FileReader object 1523 implements IReadFile 15241525 def init self fObj 1526 self fObj fObj1527 self send False15281529 def close self passthrough 153 self send True1531 self fObj close 1532 return passthrough15331534 def send self consumer 1535 assert not self send Can only call IReadFile send once per instance 1536 self send True1537 d basic FileSender beginFileTransfer self fObj consumer 1538 d addBoth self close 1539 return d154 15411542class FTPShell FTPAnonymousShell 1543 def makeDirectory self path 1544 p self path path 1545 try 1546 p makedirs 1547 except 1548 return defer fail 1549 else 155 return defer succeed None 155115521553 def removeDirectory self path 1554 p self path path 1555 try 1556 os rmdir p path 1557 except 1558 return defer fail 1559 else 156 return defer succeed None 156115621563 def removeFile self path 1564 p self path path 1565 try 1566 p remove 1567 except 1568 return defer fail 1569 else 157 return defer succeed None 157115721573 def rename self fromPath toPath 1574 fp self path fromPath 1575 tp self path toPath 1576 try 1577 os rename fp path tp path 1578 except 1579 return defer fail 158 else 1581 return defer succeed None 158215831584 def openForWriting self path 1585 p self path path 1586 try 1587 fObj p open wb 1588 except 1589 return defer fail 159 return defer succeed FileWriter fObj 159115921593class FileWriter object 1594 implements IWriteFile 15951596 def init self fObj 1597 self fObj fObj1598 self receive False159916 def receive self 16 1 assert not self receive Can only call IWriteFile receive once per instance 16 2 self receive True16 3 FileConsumer will close the file object16 4 return defer succeed FileConsumer self fObj 16 516 616 7class FTPRealm 16 8 16 9 type anonymousRoot L twisted python filepath FilePath 161 ivar anonymousRoot Root of the filesystem to which anonymous1611 users will be granted access 1612 1613 implements portal IRealm 16141615 def init self anonymousRoot 1616 self anonymousRoot filepath FilePath anonymousRoot 16171618 def requestAvatar self avatarId mind interfaces 1619 for iface in interfaces 162 if iface is IFTPShell 1621 if avatarId is checkers ANONYMOUS 1622 avatar FTPAnonymousShell self anonymousRoot 1623 else 1624 avatar FTPShell filepath FilePath home avatarId 1625 return IFTPShell avatar getattr avatar logout lambda None 1626 raise NotImplementedError Only IFTPShell interface is supported by this realm 16271628 FTP CLIENT 1629163 1631 And now for the client 16321633 Notes 1634 Reference http cr yp to ftp html1635 FIXME Does not support pipelining which is not supported by all1636 servers anyway This isn t a functionality limitation just a1637 small performance issue 1638 Only has a rudimentary understanding of FTP response codes although1639 the full response is passed to the caller if they so choose 164 Assumes that USER and PASS should always be sent1641 Always sets TYPE I binary mode 1642 Doesn t understand any of the weird obscure TELNET stuff 377 1643 FIXME Doesn t share any code with the FTPServer16441645class ConnectionLost FTPError 1646 pass16471648class CommandFailed FTPError 1649 pass165 1651class BadResponse FTPError 1652 pass16531654class UnexpectedResponse FTPError 1655 pass16561657class UnexpectedData FTPError 1658 pass1659166 class FTPCommand 1661 def init self text None public 1662 self text text1663 self deferred defer Deferred 1664 self ready 11665 self public public1666 self transferDeferred None16671668 def fail self failure 1669 if self public 167 self deferred errback failure 167116721673class ProtocolWrapper protocol Protocol 1674 def init self original deferred 1675 self original original1676 self deferred deferred1677 def makeConnection self transport 1678 self original makeConnection transport 1679 def dataReceived self data 168 self original dataReceived data 1681 def connectionLost self reason 1682 self original connectionLost reason 1683 Signal that transfer has completed1684 self deferred callback None 168516861687class SenderProtocol protocol Protocol 1688 implements interfaces IFinishableConsumer 1689169 def init self 1691 Fired upon connection1692 self connectedDeferred defer Deferred 16931694 Fired upon disconnection1695 self deferred defer Deferred 16961697 Protocol stuff1698 def dataReceived self data 1699 raise UnexpectedData 17 Received data from the server on a 17 1 send only data connection 17 2 17 317 4 def makeConnection self transport 17 5 protocol Protocol makeConnection self transport 17 6 self connectedDeferred callback self 17 717 8 def connectionLost self reason 17 9 if reason check error ConnectionDone 171 self deferred callback connection done 1711 else 1712 self deferred errback reason 17131714 IFinishableConsumer stuff1715 def write self data 1716 self transport write data 17171718 def registerProducer self producer streaming 1719 172 Register the given producer with our transport 1721 1722 self transport registerProducer producer streaming 17231724 def unregisterProducer self 1725 1726 Unregister the previously registered producer 1727 1728 self transport unregisterProducer 1729173 def finish self 1731 self transport loseConnection 173217331734def decodeHostPort line 1735 Decode an FTP response specifying a host and port 17361737 return a 2 tuple of host port 1738 1739 abcdef re sub 9 line 174 parsed int p strip for p in abcdef split 1741 for x in parsed 1742 if x or x 255 1743 raise ValueError Out of range line x 1744 a b c d e f parsed1745 host s s s s a b c d 1746 port int e 8 int f 1747 return host port17481749def encodeHostPort host port 175 numbers host split str port 8 str port 256 1751 return join numbers 17521753def unwrapFirstError failure 1754 failure trap defer FirstError 1755 return failure value subFailure17561757class FTPDataPortFactory protocol ServerFactory 1758 Factory for data connections that use the PORT command1759176 i e active transfers 1761 1762 noisy 1763 def buildProtocol self addr 1764 This is a bit hackish we already have a Protocol instance 1765 so just return it instead of making a new one1766 FIXME Reject connections from the wrong address port1767 potential security problem 1768 self protocol factory self1769 self port loseConnection 177 return self protocol177117721773class FTPClientBasic basic LineReceiver 1774 Foundations of an FTP client 1775 debug 1776 def init self 1777 self actionQueue 1778 self greeting None1779 self nextDeferred defer Deferred addCallback self cb greeting 178 self nextDeferred addErrback self fail 1781 self response 1782 self failed 17831784 def fail self error 1785 Give an error to any queued deferreds 1786 self fail error 17871788 def fail self error 1789 Errback all queued deferreds 179 if self failed 1791 We re recursing bail out here for simplicity1792 return error1793 self failed 11794 for ftpCommand in self actionQueue 1795 ftpCommand fail failure Failure ConnectionLost FTP connection lost error 1796 return error17971798 def cb greeting self greeting 1799 self greeting greeting18 18 1 def sendLine self line 18 2 Private Sends a line unless line is None 18 3 if line is None 18 4 return18 5 basic LineReceiver sendLine self line 18 618 7 def sendNextCommand self 18 8 Private Processes the next command in the queue 18 9 ftpCommand self popCommandQueue 181 if ftpCommand is None 1811 self nextDeferred None1812 return1813 if not ftpCommand ready 1814 self actionQueue insert ftpCommand 1815 reactor callLater 1 self sendNextCommand 1816 self nextDeferred None1817 return18181819 FIXME this if block doesn t belong in FTPClientBasic it belongs in182 FTPClient 1821 if ftpCommand text PORT 1822 self generatePortCommand ftpCommand 18231824 if self debug 1825 log msg s ftpCommand text 1826 self nextDeferred ftpCommand deferred1827 self sendLine ftpCommand text 18281829 def queueCommand self ftpCommand 183 Add an FTPCommand object to the queue 18311832 If it s the only thing in the queue and we are connected and we aren t1833 waiting for a response of an earlier command the command will be sent1834 immediately 18351836 param ftpCommand an L FTPCommand 1837 1838 self actionQueue append ftpCommand 1839 if len self actionQueue 1 and self transport is not None and184 self nextDeferred is None 1841 self sendNextCommand 18421843 def queueStringCommand self command public 1 1844 Queues a string to be issued as an FTP command18451846 param command string of an FTP command to queue1847 param public a flag intended for internal use by FTPClient Don t1848 change it unless you know what you re doing 1849185 return a L Deferred that will be called when the response to the1851 command has been received 1852 1853 ftpCommand FTPCommand command public 1854 self queueCommand ftpCommand 1855 return ftpCommand deferred18561857 def popCommandQueue self 1858 Return the front element of the command queue or None if empty 1859 if self actionQueue 186 return self actionQueue pop 1861 else 1862 return None18631864 def queueLogin self username password 1865 Login send the username send the password 1866 1867 If the password is C None the PASS command won t be sent Also if1868 the response to the USER command has a response code of 23 User logged1869 in then PASS won t be sent either 187 1871 Prepare the USER command1872 deferreds 1873 userDeferred self queueStringCommand USER username public 1874 deferreds append userDeferred 1875 1876 Prepare the PASS command if a password is given 1877 if password is not None 1878 passwordCmd FTPCommand PASS password public 1879 self queueCommand passwordCmd 188 deferreds append passwordCmd deferred 18811882 Avoid sending PASS if the response to USER is 23 1883 ref http cr yp to ftp user html user 1884 def cancelPasswordIfNotNeeded response 1885 if response startswith 23 1886 No password needed 1887 self actionQueue remove passwordCmd 1888 return response1889 userDeferred addCallback cancelPasswordIfNotNeeded 189 1891 Error handling 1892 for deferred in deferreds 1893 If something goes wrong call fail1894 deferred addErrback self fail 1895 But also swallow the error so we don t cause spurious errors1896 deferred addErrback lambda x None 18971898 def lineReceived self line 1899 Private Parses the response messages from the FTP server 19 Add this line to the current response19 1 if self debug 19 2 log msg s line 19 3 self response append line 19 419 5 Bail out if this isn t the last line of a response19 6 The last line of response starts with 3 digits followed by a space19 7 codeIsValid re match r d 3 line 19 8 if not codeIsValid 19 9 return191 1911 code line 3 19121913 Ignore marks1914 if code 1 1915 return19161917 Check that we were expecting a response1918 if self nextDeferred is None 1919 self fail UnexpectedResponse self response 192 return19211922 Reset the response1923 response self response1924 self response 19251926 Look for a success or error code and call the appropriate callback1927 if code in 2 3 1928 Success1929 self nextDeferred callback response 193 elif code in 4 5 1931 Failure1932 self nextDeferred errback failure Failure CommandFailed response 1933 else 1934 This shouldn t happen unless something screwed up 1935 log msg Server sent invalid response code s code 1936 self nextDeferred errback failure Failure BadResponse response 19371938 Run the next command1939 self sendNextCommand 194 1941 def connectionLost self reason 1942 self fail reason 1943194419451946class PassiveConnectionFactory protocol ClientFactory 1947 noisy False19481949 def init self protoInstance 195 self protoInstance protoInstance19511952 def buildProtocol self ignored 1953 self protoInstance factory self1954 return self protoInstance19551956 def clientConnectionFailed self connector reason 1957 e FTPError Connection Failed reason 1958 self protoInstance deferred errback e 1959196 19611962class FTPClient FTPClientBasic 1963 1964 A Twisted FTP Client19651966 Supports active and passive transfers 19671968 This class is semi stable 1969197 ivar passive See description in init 1971 1972 connectFactory reactor connectTCP19731974 def init self username anonymous 1975 password twisted twistedmatrix com 1976 passive 1 1977 1978 Constructor 1979198 I will login as soon as I receive the welcome message from the server 19811982 param username FTP username1983 param password FTP password1984 param passive flag that controls if I use active or passive data1985 connections You can also change this after construction by1986 assigning to self passive 1987 1988 FTPClientBasic init self 1989 self queueLogin username password 199 1991 self passive passive19921993 def fail self error 1994 1995 Disconnect and also give an error to any queued deferreds 1996 1997 self transport loseConnection 1998 self fail error 19992 def receiveFromConnection self commands protocol 2 1 2 2 Retrieves a file or listing generated by the given command 2 3 feeding it to the given protocol 2 42 5 param command list of strings of FTP commands to execute then receive2 6 the results of e g LIST RETR 2 7 param protocol A L Protocol instance e g an2 8 L FTPFileListProtocol or something that can be adapted to one 2 9 Typically this will be an L IConsumer implemenation 2 1 2 11 return L Deferred 2 12 2 13 protocol interfaces IProtocol protocol 2 14 wrapper ProtocolWrapper protocol defer Deferred 2 15 return self openDataConnection commands wrapper 2 162 17 def queueLogin self username password 2 18 2 19 Login send the username send the password and2 2 set retrieval mode to binary2 21 2 22 FTPClientBasic queueLogin self username password 2 23 d self queueStringCommand TYPE I public 2 24 If something goes wrong call fail2 25 d addErrback self fail 2 26 But also swallow the error so we don t cause spurious errors2 27 d addErrback lambda x None 2 282 29 def sendToConnection self commands 2 3 2 31 XXX2 322 33 return A tuple of two L Deferred s 2 34 L Deferred L IFinishableConsumer You must call2 35 the C finish method on the IFinishableConsumer when the file2 36 is completely transferred 2 37 L Deferred list of control connection responses 2 38 2 39 s SenderProtocol 2 4 r self openDataConnection commands s 2 41 return s connectedDeferred r 2 422 43 def openDataConnection self commands protocol 2 44 2 45 This method returns a DeferredList 2 46 2 47 cmds FTPCommand command public 1 for command in commands 2 48 cmdsDeferred defer DeferredList cmd deferred for cmd in cmds 2 49 fireOnOneErrback True consumeErrors True 2 5 cmdsDeferred addErrback unwrapFirstError 2 512 52 if self passive 2 53 Hack use a mutable object to sneak a variable out of the2 54 scope of doPassive2 55 mutable None 2 56 def doPassive response 2 57 Connect to the port specified in the response to PASV 2 58 host port decodeHostPort response 1 4 2 592 6 f PassiveConnectionFactory protocol 2 61 mutable self connectFactory host port f 2 622 63 pasvCmd FTPCommand PASV 2 64 self queueCommand pasvCmd 2 65 pasvCmd deferred addCallback doPassive addErrback self fail 2 662 67 results cmdsDeferred pasvCmd deferred protocol deferred 2 68 d defer DeferredList results fireOnOneErrback 1 consumeErrors 1 2 69 d addErrback unwrapFirstError 2 7 2 71 Ensure the connection is always closed2 72 def close x m mutable 2 73 m and m disconnect 2 74 return x2 75 d addBoth close 2 762 77 else 2 78 We just place a marker command in the queue and will fill in2 79 the host and port numbers later see generatePortCommand 2 8 portCmd FTPCommand PORT 2 812 82 Ok now we jump through a few hoops here 2 83 This is the problem a transfer is not to be trusted as complete2 84 until we get both the 226 Transfer complete message on the2 85 control connection and the data socket is closed Thus we use2 86 a DeferredList to make sure we only fire the callback at the2 87 right time 2 882 89 portCmd transferDeferred protocol deferred2 9 portCmd protocol protocol2 91 portCmd deferred addErrback portCmd transferDeferred errback 2 92 self queueCommand portCmd 2 932 94 Create dummy functions for the next callback to call 2 95 These will also be replaced with real functions in2 96 generatePortCommand 2 97 portCmd loseConnection lambda result result2 98 portCmd fail lambda error error2 9921 Ensure that the connection always gets closed21 1 cmdsDeferred addErrback lambda e pc portCmd pc fail e or e 21 221 3 results cmdsDeferred portCmd deferred portCmd transferDeferred 21 4 d defer DeferredList results fireOnOneErrback 1 consumeErrors 1 21 5 XXX d addErrback unwrapFirstError but add a test 21 621 7 for cmd in cmds 21 8 self queueCommand cmd 21 9 return d211 2111 def generatePortCommand self portCmd 2112 2113 Private Generates the text of a given PORT command 2114 21152116 The problem is that we don t create the listening port until we need2117 it for various reasons and so we have to muck about to figure out2118 what interface and port it s listening on and then finally we can2119 create the text of the PORT command to send to the FTP server 212 2121 FIXME This method is far too ugly 21222123 FIXME The best solution is probably to only create the data port2124 once per FTPClient and just recycle it for each new download 2125 This should be ok because we don t pipeline commands 21262127 Start listening on a port2128 factory FTPDataPortFactory 2129 factory protocol portCmd protocol213 listener reactor listenTCP factory 2131 factory port listener21322133 Ensure we close the listening port if something goes wrong2134 def listenerFail error listener listener 2135 if listener connected 2136 listener loseConnection 2137 return error2138 portCmd fail listenerFail2139214 Construct crufty FTP magic numbers that represent host port2141 host self transport getHost host2142 port listener getHost port2143 portCmd text PORT encodeHostPort host port 21442145 def escapePath self path 2146 2147 Returns a FTP escaped path replace newlines with nulls 2148 2149 Escape newline characters215 return path replace n 21512152 def retrieveFile self path protocol offset 2153 2154 Retrieve a file from the given path21552156 This method issues the RETR FTP command 21572158 The file is fed into the given Protocol instance The data connection2159 will be passive if self passive is set 216 2161 param path path to file that you wish to receive 2162 param protocol a L Protocol instance 2163 param offset offset to start downloading from21642165 return L Deferred 2166 2167 cmds RETR self escapePath path 2168 if offset 2169 cmds insert REST str offset 217 return self receiveFromConnection cmds protocol 21712172 retr retrieveFile21732174 def storeFile self path offset 2175 2176 Store a file at the given path 21772178 This method issues the STOR FTP command 2179218 return A tuple of two L Deferred s 2181 L Deferred L IFinishableConsumer You must call2182 the C finish method on the IFinishableConsumer when the file2183 is completely transferred 2184 L Deferred list of control connection responses 2185 2186 cmds STOR self escapePath path 2187 if offset 2188 cmds insert REST str offset 2189 return self sendToConnection cmds 219 2191 stor storeFile21922193 def list self path protocol 2194 2195 Retrieve a file listing into the given protocol instance 21962197 This method issues the LIST FTP command 21982199 param path path to get a file listing for 22 param protocol a L Protocol instance probably a22 1 L FTPFileListProtocol instance It can cope with most common file22 2 listing formats 22 322 4 return L Deferred 22 5 22 6 if path is None 22 7 path 22 8 return self receiveFromConnection LIST self escapePath path protocol 22 9221 def nlst self path protocol 2211 2212 Retrieve a short file listing into the given protocol instance 22132214 This method issues the NLST FTP command 22152216 NLST should return a list of filenames one per line 22172218 param path path to get short file listing for 2219 param protocol a L Protocol instance 222 2221 if path is None 2222 path 2223 return self receiveFromConnection NLST self escapePath path protocol 22242225 def cwd self path 2226 2227 Issues the CWD Change Working Directory command It s also2228 available as changeDirectory which parses the result 2229223 return a L Deferred that will be called when done 2231 2232 return self queueStringCommand CWD self escapePath path 22332234 def changeDirectory self path 2235 2236 Change the directory on the server and parse the result to determine2237 if it was successful or not 22382239 type path C str 224 param path The path to which to change 22412242 return a L Deferred which will be called back when the directory2243 change has succeeded or and errbacked if an error occurrs 2244 2245 def cbParse result 2246 try 2247 The only valid code is 25 2248 if int result split 1 25 2249 return True225 else 2251 raise ValueError2252 except IndexError ValueError e 2253 return failure Failure CommandFailed result 2254 return self cwd path addCallback cbParse 22552256 def cdup self 2257 2258 Issues the CDUP Change Directory UP command 2259226 return a L Deferred that will be called when done 2261 2262 return self queueStringCommand CDUP 22632264 def pwd self 2265 2266 Issues the PWD Print Working Directory command 22672268 The L getDirectory does the same job but automatically parses the2269 result 227 2271 return a L Deferred that will be called when done It is up to the2272 caller to interpret the response but the L parsePWDResponse method2273 in this module should work 2274 2275 return self queueStringCommand PWD 22762277 def getDirectory self 2278 2279 Returns the current remote directory 228 2281 return a L Deferred that will be called back with a C str giving2282 the remote directory or which will errback with L CommandFailed 2283 if an error response is returned 2284 2285 def cbParse result 2286 try 2287 The only valid code is 2572288 if int result split 1 257 2289 raise ValueError229 except IndexError ValueError e 2291 return failure Failure CommandFailed result 2292 path parsePWDResponse result 2293 if path is None 2294 return failure Failure CommandFailed result 2295 return path2296 return self pwd addCallback cbParse 22972298 def quit self 2299 23 Issues the QUIT command 23 1 23 2 return self queueStringCommand QUIT 23 323 423 5class FTPFileListProtocol basic LineReceiver 23 6 Parser for standard FTP file listings23 723 8 This is the evil required to match 23 9231 rw r r 1 root other 531 Jan 29 3 26 README23112312 If you need different evil for a wacky FTP server you can2313 override either C fileLinePattern or C parseDirectoryLine 23142315 It populates the instance attribute self files which is a list containing2316 dicts with the following keys examples from the above line 2317 filetype e g d for directories or for an ordinary file2318 perms e g rw r r 2319 nlinks e g 1232 owner e g root 2321 group e g other 2322 size e g 5312323 date e g Jan 29 3 26 2324 filename e g README 2325 linktarget e g some file 23262327 Note that the date value will be formatted differently depending on the2328 date Check U http cr yp to ftp html if you really want to try to parse2329 it 233 2331 ivar files list of dicts describing the files in this listing2332 2333 fileLinePattern re compile 2334 r P filetype P perms 9 s P nlinks d s 2335 r P owner S s P group S s P size d s 2336 r P date s d s d s P filename 2337 r P linktarget r r 2338 2339 delimiter n 234 2341 def init self 2342 self files 23432344 def lineReceived self line 2345 d self parseDirectoryLine line 2346 if d is None 2347 self unknownLine line 2348 else 2349 self addFile d 235 2351 def parseDirectoryLine self line 2352 Return a dictionary of fields or None if line cannot be parsed 23532354 param line line of text expected to contain a directory entry2355 type line str23562357 return dict2358 2359 match self fileLinePattern match line 236 if match is None 2361 return None2362 else 2363 d match groupdict 2364 d filename d filename replace r 2365 d nlinks int d nlinks 2366 d size int d size 2367 if d linktarget 2368 d linktarget d linktarget replace r 2369 return d237 2371 def addFile self info 2372 Append file information dictionary to the list of known files 23732374 Subclasses can override or extend this method to handle file2375 information differently without affecting the parsing of data2376 from the server 23772378 param info dictionary containing the parsed representation2379 of the file information238 type info dict2381 2382 self files append info 23832384 def unknownLine self line 2385 Deal with received lines which could not be parsed as file2386 information 23872388 Subclasses can override this to perform any special processing2389 needed 239 2391 param line unparsable line as received2392 type line str2393 2394 pass23952396def parsePWDResponse response 2397 Returns the path from a response to a PWD command 23982399 Responses typically look like 24 24 1 257 home andrew is current directory 24 224 3 For this example I will return C home andrew 24 424 5 If I can t find the path I return C None 24 6 24 7 match re search response 24 8 if match 24 9 return match groups 241 else 2411 return None Note See TracBrowser for help on using the repository browser Download in other formats Plain Text Original Format Powered by Trac 1 1 By Edgewall Software All content copyright 2 7 2 8 by LUCI http luci ics uci edu ", "_id": "http://djp3-pc2.ics.uci.edu/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py", "title": "\n      ftp.py in nomatic/tags/nomaticim-0.0.4/buddy_bots/src/twisted/protocols\n     \u2013 nomatic*im\n    ", "html": "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n  \n  \n\n  \n\n\n  <head>\n\t\t<title>\n      ftp.py in nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols\n     \u2013 Nomatic*IM\n    </title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" /><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" /><link rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search\" /><link rel=\"help\" href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py?format=txt\" type=\"text/plain\" title=\"Plain Text\" /><link rel=\"alternate\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py\" type=\"application/x-python; charset=iso-8859-15\" title=\"Original Format\" /><link rel=\"start\" href=\"/LUCICodeRepository/nomaticIM/wiki\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/code.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/pygments/trac.css\" type=\"text/css\" /><link rel=\"stylesheet\" href=\"/LUCICodeRepository/nomaticIM/chrome/common/css/browser.css\" type=\"text/css\" /><link rel=\"shortcut icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link rel=\"icon\" href=\"http://luci.ics.uci.edu/logo32by32.gif\" type=\"image/gif\" /><link type=\"application/opensearchdescription+xml\" rel=\"search\" href=\"/LUCICodeRepository/nomaticIM/search/opensearch\" title=\"Search Nomatic*IM\" /><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/jquery.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/babel.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/messages/en_US.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/trac.js\"></script><script type=\"text/javascript\" charset=\"utf-8\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/search.js\"></script><script type=\"text/javascript\" src=\"/LUCICodeRepository/nomaticIM/chrome/common/js/folding.js\"></script><script type=\"text/javascript\">\n      jQuery(document).ready(function($) {\n        $(\".trac-toggledeleted\").show().click(function() {\n                  $(this).siblings().find(\".trac-deleted\").toggle();\n                  return false;\n        }).click();\n        $(\"#jumploc input\").hide();\n        $(\"#jumploc select\").change(function () {\n          this.parentNode.parentNode.submit();\n        });\n          $('#preview table.code').enableCollapsibleColumns($('#preview table.code thead th.content'));\n      });\n    </script>\n\t</head>\n  <body>\n    <div id=\"banner\">\n      <div id=\"header\">\n        <a id=\"logo\" href=\"http://luci.ics.uci.edu/#code\"><img src=\"http://luci.ics.uci.edu/blog/archives/LUCIhorzTight.jpg\" alt=\"LUCI Code Repository\" /></a>\n      </div>\n      <form id=\"search\" action=\"/LUCICodeRepository/nomaticIM/search\" method=\"get\">\n        <div>\n          <label for=\"proj-search\">Search:</label>\n          <input type=\"text\" id=\"proj-search\" name=\"q\" size=\"18\" value=\"\" />\n          <input type=\"submit\" value=\"Search\" />\n        </div>\n      </form>\n      <div id=\"metanav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/login\">Login</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/prefs\">Preferences</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/wiki/TracGuide\">Help/Guide</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/about\">About Trac</a></li>\n    </ul>\n  </div>\n    </div>\n    <div id=\"mainnav\" class=\"nav\">\n    <ul>\n      <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/wiki\">Wiki</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/timeline\">Timeline</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/roadmap\">Roadmap</a></li><li class=\"active\"><a href=\"/LUCICodeRepository/nomaticIM/browser\">Browse Source</a></li><li><a href=\"/LUCICodeRepository/nomaticIM/report\">View Tickets</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/search\">Search</a></li>\n    </ul>\n  </div>\n    <div id=\"main\">\n      <div id=\"ctxtnav\" class=\"nav\">\n        <h2>Context Navigation</h2>\n        <ul>\n          <li class=\"first\"><a href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/trunk/buddy_bots/twisted/protocols/ftp.py?annotate=blame\" title=\"Annotate each line with the last changed revision (this can be time consuming...)\">Blame</a></li><li class=\"last\"><a href=\"/LUCICodeRepository/nomaticIM/log/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py\">Revision Log</a></li>\n        </ul>\n        <hr />\n      </div>\n    <div id=\"content\" class=\"browser\">\n        <h1>\n          \n<a class=\"pathentry first\" href=\"/LUCICodeRepository/nomaticIM/browser?order=name\" title=\"Go to repository root\">source:</a>\n<a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic?order=name\" title=\"View nomatic\">nomatic</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags?order=name\" title=\"View tags\">tags</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.4?order=name\" title=\"View NomaticIM-0.0.4\">NomaticIM-0.0.4</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.4/buddy_bots?order=name\" title=\"View buddy_bots\">buddy_bots</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src?order=name\" title=\"View src\">src</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted?order=name\" title=\"View twisted\">twisted</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols?order=name\" title=\"View protocols\">protocols</a><span class=\"pathentry sep\">/</span><a class=\"pathentry\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py?order=name\" title=\"View ftp.py\">ftp.py</a>\n<br style=\"clear: both\" />\n\n        </h1>\n        <div id=\"diffrev\">\n          <form action=\"/LUCICodeRepository/nomaticIM/changeset\" method=\"get\">\n            <div>\n              <label title=\"Show the diff against a specific revision\">\n                View diff against: <input type=\"text\" name=\"old\" size=\"6\" />\n                <input type=\"hidden\" name=\"old_path\" value=\"nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py\" />\n                <input type=\"hidden\" name=\"new\" />\n                <input type=\"hidden\" name=\"new_path\" value=\"nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py\" />\n              </label>\n            </div>\n          </form>\n        </div>\n        <div id=\"jumprev\">\n          <form action=\"\" method=\"get\">\n            <div>\n              <label for=\"rev\">\n                View revision:</label>\n              <input type=\"text\" id=\"rev\" name=\"rev\" size=\"6\" />\n            </div>\n          </form>\n        </div>\n        <div id=\"jumploc\">\n          <form action=\"\" method=\"get\">\n            <div class=\"buttons\">\n              <label for=\"preselected\">Visit:</label>\n              <select id=\"preselected\" name=\"preselected\">\n                <option selected=\"selected\"></option>\n                <optgroup label=\"branches\">\n                  <option value=\"/LUCICodeRepository/nomaticIM/browser/trunk\">trunk</option>\n                </optgroup>\n              </select>\n              <input type=\"submit\" value=\"Go!\" title=\"Jump to the chosen preselected path\" />\n            </div>\n          </form>\n        </div>\n        <div class=\"trac-tags\">\n        </div>\n      <table id=\"info\" summary=\"Revision info\">\n        <tr>\n          <th>\n                <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/nomatic/trunk/buddy_bots/twisted/protocols/ftp.py\" title=\"View differences\">Last change</a>\n                  on this file was\n                  <a href=\"/LUCICodeRepository/nomaticIM/changeset/712/\" title=\"View changeset 712\">712</a>,\n                  checked in by cbaker, <a class=\"timeline\" href=\"/LUCICodeRepository/nomaticIM/timeline?from=2008-02-16T08%3A16%3A53-08%3A00&amp;precision=second\" title=\"See timeline at Feb 16, 2008, 8:16:53 AM\">7 years ago</a>\n          </th>\n        </tr>\n        <tr>\n          <td class=\"message searchable\">\n              <p>\nFirst draft of nomatic buddy bots. oscar_bot is functional if you give it good authentication credentials, jabber_bot is just an example from the web <br />\n</p>\n          </td>\n        </tr>\n        <tr><td colspan=\"2\">\n            <strong>File size:</strong>\n            <span title=\"78551 bytes\">76.7 KB</span>\n          </td></tr>\n      </table>\n      <div id=\"preview\" class=\"searchable\">\n        \n  <table class=\"code\"><thead><tr><th class=\"lineno\" title=\"Line numbers\">Line</th><th class=\"content\">\u00a0</th></tr></thead><tbody><tr><th id=\"L1\"><a href=\"#L1\">1</a></th><td><span class=\"c\"># -*- test-case-name: twisted.test.test_ftp -*-</span></td></tr><tr><th id=\"L2\"><a href=\"#L2\">2</a></th><td><span class=\"c\"># Copyright (c) 2001-2004 Twisted Matrix Laboratories.</span></td></tr><tr><th id=\"L3\"><a href=\"#L3\">3</a></th><td><span class=\"c\"># See LICENSE for details.</span></td></tr><tr><th id=\"L4\"><a href=\"#L4\">4</a></th><td></td></tr><tr><th id=\"L5\"><a href=\"#L5\">5</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L6\"><a href=\"#L6\">6</a></th><td><span class=\"sd\">An FTP protocol implementation</span></td></tr><tr><th id=\"L7\"><a href=\"#L7\">7</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L8\"><a href=\"#L8\">8</a></th><td><span class=\"sd\">@author: U{Itamar Shtull-Trauring&lt;mailto:itamarst@twistedmatrix.com&gt;}</span></td></tr><tr><th id=\"L9\"><a href=\"#L9\">9</a></th><td><span class=\"sd\">@author: U{Jp Calderone&lt;mailto:exarkun@divmod.com&gt;}</span></td></tr><tr><th id=\"L10\"><a href=\"#L10\">10</a></th><td><span class=\"sd\">@author: U{Andrew Bennetts&lt;mailto:spiv@twistedmatrix.com&gt;}</span></td></tr><tr><th id=\"L11\"><a href=\"#L11\">11</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L12\"><a href=\"#L12\">12</a></th><td><span class=\"sd\">API stability: FTPClient is stable, FTP and FTPFactory (server) is unstable.</span></td></tr><tr><th id=\"L13\"><a href=\"#L13\">13</a></th><td><span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L14\"><a href=\"#L14\">14</a></th><td></td></tr><tr><th id=\"L15\"><a href=\"#L15\">15</a></th><td><span class=\"c\"># System Imports</span></td></tr><tr><th id=\"L16\"><a href=\"#L16\">16</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">os</span></td></tr><tr><th id=\"L17\"><a href=\"#L17\">17</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">time</span></td></tr><tr><th id=\"L18\"><a href=\"#L18\">18</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">re</span></td></tr><tr><th id=\"L19\"><a href=\"#L19\">19</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">operator</span></td></tr><tr><th id=\"L20\"><a href=\"#L20\">20</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">stat</span></td></tr><tr><th id=\"L21\"><a href=\"#L21\">21</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">errno</span></td></tr><tr><th id=\"L22\"><a href=\"#L22\">22</a></th><td><span class=\"kn\">import</span>\u00a0<span class=\"nn\">fnmatch</span></td></tr><tr><th id=\"L23\"><a href=\"#L23\">23</a></th><td></td></tr><tr><th id=\"L24\"><a href=\"#L24\">24</a></th><td><span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L25\"><a href=\"#L25\">25</a></th><td>\u00a0 \u00a0 <span class=\"kn\">import</span>\u00a0<span class=\"nn\">pwd</span><span class=\"o\">,</span>\u00a0<span class=\"nn\">grp</span></td></tr><tr><th id=\"L26\"><a href=\"#L26\">26</a></th><td><span class=\"k\">except</span>\u00a0<span class=\"ne\">ImportError</span><span class=\"p\">:</span></td></tr><tr><th id=\"L27\"><a href=\"#L27\">27</a></th><td>\u00a0 \u00a0 pwd <span class=\"o\">=</span>\u00a0grp <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L28\"><a href=\"#L28\">28</a></th><td></td></tr><tr><th id=\"L29\"><a href=\"#L29\">29</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">zope.interface</span>\u00a0<span class=\"kn\">import</span>\u00a0Interface<span class=\"p\">,</span>\u00a0implements</td></tr><tr><th id=\"L30\"><a href=\"#L30\">30</a></th><td></td></tr><tr><th id=\"L31\"><a href=\"#L31\">31</a></th><td><span class=\"c\"># Twisted Imports</span></td></tr><tr><th id=\"L32\"><a href=\"#L32\">32</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted</span>\u00a0<span class=\"kn\">import</span>\u00a0copyright</td></tr><tr><th id=\"L33\"><a href=\"#L33\">33</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.internet</span>\u00a0<span class=\"kn\">import</span>\u00a0reactor<span class=\"p\">,</span>\u00a0interfaces<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0error<span class=\"p\">,</span>\u00a0defer</td></tr><tr><th id=\"L34\"><a href=\"#L34\">34</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.protocols</span>\u00a0<span class=\"kn\">import</span>\u00a0basic<span class=\"p\">,</span>\u00a0policies</td></tr><tr><th id=\"L35\"><a href=\"#L35\">35</a></th><td></td></tr><tr><th id=\"L36\"><a href=\"#L36\">36</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.python</span>\u00a0<span class=\"kn\">import</span>\u00a0log<span class=\"p\">,</span>\u00a0failure<span class=\"p\">,</span>\u00a0filepath</td></tr><tr><th id=\"L37\"><a href=\"#L37\">37</a></th><td></td></tr><tr><th id=\"L38\"><a href=\"#L38\">38</a></th><td><span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.cred</span>\u00a0<span class=\"kn\">import</span>\u00a0error <span class=\"k\">as</span>\u00a0cred_error<span class=\"p\">,</span>\u00a0portal<span class=\"p\">,</span>\u00a0credentials<span class=\"p\">,</span>\u00a0checkers</td></tr><tr><th id=\"L39\"><a href=\"#L39\">39</a></th><td></td></tr><tr><th id=\"L40\"><a href=\"#L40\">40</a></th><td><span class=\"c\"># constants</span></td></tr><tr><th id=\"L41\"><a href=\"#L41\">41</a></th><td><span class=\"c\"># response codes</span></td></tr><tr><th id=\"L42\"><a href=\"#L42\">42</a></th><td></td></tr><tr><th id=\"L43\"><a href=\"#L43\">43</a></th><td>RESTART_MARKER_REPLY\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"100\"</span></td></tr><tr><th id=\"L44\"><a href=\"#L44\">44</a></th><td>SERVICE_READY_IN_N_MINUTES\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"120\"</span></td></tr><tr><th id=\"L45\"><a href=\"#L45\">45</a></th><td>DATA_CNX_ALREADY_OPEN_START_XFR\u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"125\"</span></td></tr><tr><th id=\"L46\"><a href=\"#L46\">46</a></th><td>FILE_STATUS_OK_OPEN_DATA_CNX\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"150\"</span></td></tr><tr><th id=\"L47\"><a href=\"#L47\">47</a></th><td></td></tr><tr><th id=\"L48\"><a href=\"#L48\">48</a></th><td>CMD_OK\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"200.1\"</span></td></tr><tr><th id=\"L49\"><a href=\"#L49\">49</a></th><td>TYPE_SET_OK\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"200.2\"</span></td></tr><tr><th id=\"L50\"><a href=\"#L50\">50</a></th><td>ENTERING_PORT_MODE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"200.3\"</span></td></tr><tr><th id=\"L51\"><a href=\"#L51\">51</a></th><td>CMD_NOT_IMPLMNTD_SUPERFLUOUS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"202\"</span></td></tr><tr><th id=\"L52\"><a href=\"#L52\">52</a></th><td>SYS_STATUS_OR_HELP_REPLY\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"211\"</span></td></tr><tr><th id=\"L53\"><a href=\"#L53\">53</a></th><td>DIR_STATUS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"212\"</span></td></tr><tr><th id=\"L54\"><a href=\"#L54\">54</a></th><td>FILE_STATUS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"213\"</span></td></tr><tr><th id=\"L55\"><a href=\"#L55\">55</a></th><td>HELP_MSG\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"214\"</span></td></tr><tr><th id=\"L56\"><a href=\"#L56\">56</a></th><td>NAME_SYS_TYPE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"215\"</span></td></tr><tr><th id=\"L57\"><a href=\"#L57\">57</a></th><td>SVC_READY_FOR_NEW_USER\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"220.1\"</span></td></tr><tr><th id=\"L58\"><a href=\"#L58\">58</a></th><td>WELCOME_MSG\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"220.2\"</span></td></tr><tr><th id=\"L59\"><a href=\"#L59\">59</a></th><td>SVC_CLOSING_CTRL_CNX\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"221\"</span></td></tr><tr><th id=\"L60\"><a href=\"#L60\">60</a></th><td>GOODBYE_MSG\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"221\"</span></td></tr><tr><th id=\"L61\"><a href=\"#L61\">61</a></th><td>DATA_CNX_OPEN_NO_XFR_IN_PROGRESS\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"225\"</span></td></tr><tr><th id=\"L62\"><a href=\"#L62\">62</a></th><td>CLOSING_DATA_CNX\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"226\"</span></td></tr><tr><th id=\"L63\"><a href=\"#L63\">63</a></th><td>TXFR_COMPLETE_OK\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"226\"</span></td></tr><tr><th id=\"L64\"><a href=\"#L64\">64</a></th><td>ENTERING_PASV_MODE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"227\"</span></td></tr><tr><th id=\"L65\"><a href=\"#L65\">65</a></th><td>ENTERING_EPSV_MODE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"229\"</span></td></tr><tr><th id=\"L66\"><a href=\"#L66\">66</a></th><td>USR_LOGGED_IN_PROCEED\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"230.1\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># v1 of code 230</span></td></tr><tr><th id=\"L67\"><a href=\"#L67\">67</a></th><td>GUEST_LOGGED_IN_PROCEED\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"230.2\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># v2 of code 230</span></td></tr><tr><th id=\"L68\"><a href=\"#L68\">68</a></th><td>REQ_FILE_ACTN_COMPLETED_OK\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"250\"</span></td></tr><tr><th id=\"L69\"><a href=\"#L69\">69</a></th><td>PWD_REPLY\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"257.1\"</span></td></tr><tr><th id=\"L70\"><a href=\"#L70\">70</a></th><td>MKD_REPLY\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"257.2\"</span></td></tr><tr><th id=\"L71\"><a href=\"#L71\">71</a></th><td></td></tr><tr><th id=\"L72\"><a href=\"#L72\">72</a></th><td>USR_NAME_OK_NEED_PASS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"331.1\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># v1 of Code 331</span></td></tr><tr><th id=\"L73\"><a href=\"#L73\">73</a></th><td>GUEST_NAME_OK_NEED_EMAIL\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"331.2\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># v2 of code 331</span></td></tr><tr><th id=\"L74\"><a href=\"#L74\">74</a></th><td>NEED_ACCT_FOR_LOGIN\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"332\"</span></td></tr><tr><th id=\"L75\"><a href=\"#L75\">75</a></th><td>REQ_FILE_ACTN_PENDING_FURTHER_INFO\u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"350\"</span></td></tr><tr><th id=\"L76\"><a href=\"#L76\">76</a></th><td></td></tr><tr><th id=\"L77\"><a href=\"#L77\">77</a></th><td>SVC_NOT_AVAIL_CLOSING_CTRL_CNX\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"421.1\"</span></td></tr><tr><th id=\"L78\"><a href=\"#L78\">78</a></th><td>TOO_MANY_CONNECTIONS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"421.2\"</span></td></tr><tr><th id=\"L79\"><a href=\"#L79\">79</a></th><td>CANT_OPEN_DATA_CNX\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"425\"</span></td></tr><tr><th id=\"L80\"><a href=\"#L80\">80</a></th><td>CNX_CLOSED_TXFR_ABORTED\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"426\"</span></td></tr><tr><th id=\"L81\"><a href=\"#L81\">81</a></th><td>REQ_ACTN_ABRTD_FILE_UNAVAIL\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"450\"</span></td></tr><tr><th id=\"L82\"><a href=\"#L82\">82</a></th><td>REQ_ACTN_ABRTD_LOCAL_ERR\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"451\"</span></td></tr><tr><th id=\"L83\"><a href=\"#L83\">83</a></th><td>REQ_ACTN_ABRTD_INSUFF_STORAGE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"452\"</span></td></tr><tr><th id=\"L84\"><a href=\"#L84\">84</a></th><td></td></tr><tr><th id=\"L85\"><a href=\"#L85\">85</a></th><td>SYNTAX_ERR\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"500\"</span></td></tr><tr><th id=\"L86\"><a href=\"#L86\">86</a></th><td>SYNTAX_ERR_IN_ARGS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"501\"</span></td></tr><tr><th id=\"L87\"><a href=\"#L87\">87</a></th><td>CMD_NOT_IMPLMNTD\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"502\"</span></td></tr><tr><th id=\"L88\"><a href=\"#L88\">88</a></th><td>BAD_CMD_SEQ\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"503\"</span></td></tr><tr><th id=\"L89\"><a href=\"#L89\">89</a></th><td>CMD_NOT_IMPLMNTD_FOR_PARAM\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"504\"</span></td></tr><tr><th id=\"L90\"><a href=\"#L90\">90</a></th><td>NOT_LOGGED_IN\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"530.1\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># v1 of code 530 - please log in</span></td></tr><tr><th id=\"L91\"><a href=\"#L91\">91</a></th><td>AUTH_FAILURE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"530.2\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># v2 of code 530 - authorization failure</span></td></tr><tr><th id=\"L92\"><a href=\"#L92\">92</a></th><td>NEED_ACCT_FOR_STOR\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"532\"</span></td></tr><tr><th id=\"L93\"><a href=\"#L93\">93</a></th><td>FILE_NOT_FOUND\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"550.1\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># no such file or directory</span></td></tr><tr><th id=\"L94\"><a href=\"#L94\">94</a></th><td>PERMISSION_DENIED\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"550.2\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># permission denied</span></td></tr><tr><th id=\"L95\"><a href=\"#L95\">95</a></th><td>ANON_USER_DENIED\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"550.3\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># anonymous users can't alter filesystem</span></td></tr><tr><th id=\"L96\"><a href=\"#L96\">96</a></th><td>IS_NOT_A_DIR\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"550.4\"</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># rmd called on a path that is not a directory</span></td></tr><tr><th id=\"L97\"><a href=\"#L97\">97</a></th><td>REQ_ACTN_NOT_TAKEN\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"550.5\"</span></td></tr><tr><th id=\"L98\"><a href=\"#L98\">98</a></th><td>PAGE_TYPE_UNK\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"s\">\"551\"</span></td></tr><tr><th id=\"L99\"><a href=\"#L99\">99</a></th><td>EXCEEDED_STORAGE_ALLOC\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"552\"</span></td></tr><tr><th id=\"L100\"><a href=\"#L100\">100</a></th><td>FILENAME_NOT_ALLOWED\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"s\">\"553\"</span></td></tr><tr><th id=\"L101\"><a href=\"#L101\">101</a></th><td></td></tr><tr><th id=\"L102\"><a href=\"#L102\">102</a></th><td></td></tr><tr><th id=\"L103\"><a href=\"#L103\">103</a></th><td>RESPONSE <span class=\"o\">=</span>\u00a0<span class=\"p\">{</span></td></tr><tr><th id=\"L104\"><a href=\"#L104\">104</a></th><td>\u00a0 \u00a0 <span class=\"c\"># -- 100's --</span></td></tr><tr><th id=\"L105\"><a href=\"#L105\">105</a></th><td>\u00a0 \u00a0 RESTART_MARKER_REPLY<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'110 MARK yyyy-mmmm'</span><span class=\"p\">,</span>\u00a0<span class=\"c\"># TODO: this must be fixed</span></td></tr><tr><th id=\"L106\"><a href=\"#L106\">106</a></th><td>\u00a0 \u00a0 SERVICE_READY_IN_N_MINUTES<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'120 service ready in </span><span class=\"si\">%s</span><span class=\"s\">\u00a0minutes'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L107\"><a href=\"#L107\">107</a></th><td>\u00a0 \u00a0 DATA_CNX_ALREADY_OPEN_START_XFR<span class=\"p\">:</span>\u00a0 \u00a0 <span class=\"s\">'125 Data connection already open, starting transfer'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L108\"><a href=\"#L108\">108</a></th><td>\u00a0 \u00a0 FILE_STATUS_OK_OPEN_DATA_CNX<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'150 File status okay; about to open data connection.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L109\"><a href=\"#L109\">109</a></th><td></td></tr><tr><th id=\"L110\"><a href=\"#L110\">110</a></th><td>\u00a0 \u00a0 <span class=\"c\"># -- 200's --</span></td></tr><tr><th id=\"L111\"><a href=\"#L111\">111</a></th><td>\u00a0 \u00a0 CMD_OK<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'200 Command OK'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L112\"><a href=\"#L112\">112</a></th><td>\u00a0 \u00a0 TYPE_SET_OK<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'200 Type set to </span><span class=\"si\">%s</span><span class=\"s\">.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L113\"><a href=\"#L113\">113</a></th><td>\u00a0 \u00a0 ENTERING_PORT_MODE<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'200 PORT OK'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L114\"><a href=\"#L114\">114</a></th><td>\u00a0 \u00a0 CMD_NOT_IMPLMNTD_SUPERFLUOUS<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'202 Command not implemented, superfluous at this site'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L115\"><a href=\"#L115\">115</a></th><td>\u00a0 \u00a0 SYS_STATUS_OR_HELP_REPLY<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'211 System status reply'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L116\"><a href=\"#L116\">116</a></th><td>\u00a0 \u00a0 DIR_STATUS<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'212 </span><span class=\"si\">%s</span><span class=\"s\">'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L117\"><a href=\"#L117\">117</a></th><td>\u00a0 \u00a0 FILE_STATUS<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'213 </span><span class=\"si\">%s</span><span class=\"s\">'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L118\"><a href=\"#L118\">118</a></th><td>\u00a0 \u00a0 HELP_MSG<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'214 help: </span><span class=\"si\">%s</span><span class=\"s\">'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L119\"><a href=\"#L119\">119</a></th><td>\u00a0 \u00a0 NAME_SYS_TYPE<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'215 UNIX Type: L8'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L120\"><a href=\"#L120\">120</a></th><td>\u00a0 \u00a0 WELCOME_MSG<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"220 </span><span class=\"si\">%s</span><span class=\"s\">\"</span><span class=\"p\">,</span></td></tr><tr><th id=\"L121\"><a href=\"#L121\">121</a></th><td>\u00a0 \u00a0 SVC_READY_FOR_NEW_USER<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'220 Service ready'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L122\"><a href=\"#L122\">122</a></th><td>\u00a0 \u00a0 GOODBYE_MSG<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'221 Goodbye.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L123\"><a href=\"#L123\">123</a></th><td>\u00a0 \u00a0 DATA_CNX_OPEN_NO_XFR_IN_PROGRESS<span class=\"p\">:</span>\u00a0 \u00a0<span class=\"s\">'225 data connection open, no transfer in progress'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L124\"><a href=\"#L124\">124</a></th><td>\u00a0 \u00a0 CLOSING_DATA_CNX<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'226 Abort successful'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L125\"><a href=\"#L125\">125</a></th><td>\u00a0 \u00a0 TXFR_COMPLETE_OK<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'226 Transfer Complete.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L126\"><a href=\"#L126\">126</a></th><td>\u00a0 \u00a0 ENTERING_PASV_MODE<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'227 Entering Passive Mode (</span><span class=\"si\">%s</span><span class=\"s\">).'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L127\"><a href=\"#L127\">127</a></th><td>\u00a0 \u00a0 ENTERING_EPSV_MODE<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'229 Entering Extended Passive Mode (|||</span><span class=\"si\">%s</span><span class=\"s\">|).'</span><span class=\"p\">,</span>\u00a0<span class=\"c\"># where is epsv defined in the rfc's?</span></td></tr><tr><th id=\"L128\"><a href=\"#L128\">128</a></th><td>\u00a0 \u00a0 USR_LOGGED_IN_PROCEED<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'230 User logged in, proceed'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L129\"><a href=\"#L129\">129</a></th><td>\u00a0 \u00a0 GUEST_LOGGED_IN_PROCEED<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'230 Anonymous login ok, access restrictions apply.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L130\"><a href=\"#L130\">130</a></th><td>\u00a0 \u00a0 REQ_FILE_ACTN_COMPLETED_OK<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'250 Requested File Action Completed OK'</span><span class=\"p\">,</span>\u00a0<span class=\"c\">#i.e. CWD completed ok</span></td></tr><tr><th id=\"L131\"><a href=\"#L131\">131</a></th><td>\u00a0 \u00a0 PWD_REPLY<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'257 \"</span><span class=\"si\">%s</span><span class=\"s\">\"'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L132\"><a href=\"#L132\">132</a></th><td>\u00a0 \u00a0 MKD_REPLY<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'257 \"</span><span class=\"si\">%s</span><span class=\"s\">\" created'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L133\"><a href=\"#L133\">133</a></th><td></td></tr><tr><th id=\"L134\"><a href=\"#L134\">134</a></th><td>\u00a0 \u00a0 <span class=\"c\"># -- 300's --</span></td></tr><tr><th id=\"L135\"><a href=\"#L135\">135</a></th><td>\u00a0 \u00a0 <span class=\"s\">'userotp'</span><span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'331 Response to </span><span class=\"si\">%s</span><span class=\"s\">.'</span><span class=\"p\">,</span>\u00a0 <span class=\"c\"># ???</span></td></tr><tr><th id=\"L136\"><a href=\"#L136\">136</a></th><td>\u00a0 \u00a0 USR_NAME_OK_NEED_PASS<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'331 Password required for </span><span class=\"si\">%s</span><span class=\"s\">.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L137\"><a href=\"#L137\">137</a></th><td>\u00a0 \u00a0 GUEST_NAME_OK_NEED_EMAIL<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'331 Guest login ok, type your email address as password.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L138\"><a href=\"#L138\">138</a></th><td></td></tr><tr><th id=\"L139\"><a href=\"#L139\">139</a></th><td>\u00a0 \u00a0 REQ_FILE_ACTN_PENDING_FURTHER_INFO<span class=\"p\">:</span>\u00a0<span class=\"s\">'350 Requested file action pending further information.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L140\"><a href=\"#L140\">140</a></th><td></td></tr><tr><th id=\"L141\"><a href=\"#L141\">141</a></th><td><span class=\"c\"># -- 400's --</span></td></tr><tr><th id=\"L142\"><a href=\"#L142\">142</a></th><td>\u00a0 \u00a0 SVC_NOT_AVAIL_CLOSING_CTRL_CNX<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0<span class=\"s\">'421 Service not available, closing control connection.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L143\"><a href=\"#L143\">143</a></th><td>\u00a0 \u00a0 TOO_MANY_CONNECTIONS<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'421 Too many users right now, try again in a few minutes.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L144\"><a href=\"#L144\">144</a></th><td>\u00a0 \u00a0 CANT_OPEN_DATA_CNX<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">\"425 Can't open data connection.\"</span><span class=\"p\">,</span></td></tr><tr><th id=\"L145\"><a href=\"#L145\">145</a></th><td>\u00a0 \u00a0 CNX_CLOSED_TXFR_ABORTED<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'426 Transfer aborted.\u00a0 Data connection closed.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L146\"><a href=\"#L146\">146</a></th><td></td></tr><tr><th id=\"L147\"><a href=\"#L147\">147</a></th><td>\u00a0 \u00a0 REQ_ACTN_ABRTD_LOCAL_ERR<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'451 Requested action aborted. Local error in processing.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L148\"><a href=\"#L148\">148</a></th><td></td></tr><tr><th id=\"L149\"><a href=\"#L149\">149</a></th><td></td></tr><tr><th id=\"L150\"><a href=\"#L150\">150</a></th><td>\u00a0 \u00a0 <span class=\"c\"># -- 500's --</span></td></tr><tr><th id=\"L151\"><a href=\"#L151\">151</a></th><td>\u00a0 \u00a0 SYNTAX_ERR<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">\"500 Syntax error: </span><span class=\"si\">%s</span><span class=\"s\">\"</span><span class=\"p\">,</span></td></tr><tr><th id=\"L152\"><a href=\"#L152\">152</a></th><td>\u00a0 \u00a0 SYNTAX_ERR_IN_ARGS<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'501 syntax error in argument(s) </span><span class=\"si\">%s</span><span class=\"s\">.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L153\"><a href=\"#L153\">153</a></th><td>\u00a0 \u00a0 CMD_NOT_IMPLMNTD<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">\"502 Command '</span><span class=\"si\">%s</span><span class=\"s\">' not implemented\"</span><span class=\"p\">,</span></td></tr><tr><th id=\"L154\"><a href=\"#L154\">154</a></th><td>\u00a0 \u00a0 BAD_CMD_SEQ<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'503 Incorrect sequence of commands: </span><span class=\"si\">%s</span><span class=\"s\">'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L155\"><a href=\"#L155\">155</a></th><td>\u00a0 \u00a0 CMD_NOT_IMPLMNTD_FOR_PARAM<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">\"504 Not implemented for parameter '</span><span class=\"si\">%s</span><span class=\"s\">'.\"</span><span class=\"p\">,</span></td></tr><tr><th id=\"L156\"><a href=\"#L156\">156</a></th><td>\u00a0 \u00a0 NOT_LOGGED_IN<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'530 Please login with USER and PASS.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L157\"><a href=\"#L157\">157</a></th><td>\u00a0 \u00a0 AUTH_FAILURE<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'530 Sorry, Authentication failed.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L158\"><a href=\"#L158\">158</a></th><td>\u00a0 \u00a0 NEED_ACCT_FOR_STOR<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'532 Need an account for storing files'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L159\"><a href=\"#L159\">159</a></th><td>\u00a0 \u00a0 FILE_NOT_FOUND<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'550 </span><span class=\"si\">%s</span><span class=\"s\">: No such file or directory.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L160\"><a href=\"#L160\">160</a></th><td>\u00a0 \u00a0 PERMISSION_DENIED<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'550 </span><span class=\"si\">%s</span><span class=\"s\">: Permission denied.'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L161\"><a href=\"#L161\">161</a></th><td>\u00a0 \u00a0 ANON_USER_DENIED<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'550 Anonymous users are forbidden to change the filesystem'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L162\"><a href=\"#L162\">162</a></th><td>\u00a0 \u00a0 IS_NOT_A_DIR<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'550 Cannot rmd, </span><span class=\"si\">%s</span><span class=\"s\">\u00a0is not a directory'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L163\"><a href=\"#L163\">163</a></th><td>\u00a0 \u00a0 REQ_ACTN_NOT_TAKEN<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'550 Requested action not taken: </span><span class=\"si\">%s</span><span class=\"s\">'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L164\"><a href=\"#L164\">164</a></th><td>\u00a0 \u00a0 EXCEEDED_STORAGE_ALLOC<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'552 Requested file action aborted, exceeded file storage allocation'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L165\"><a href=\"#L165\">165</a></th><td>\u00a0 \u00a0 FILENAME_NOT_ALLOWED<span class=\"p\">:</span>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'553 Requested action not taken, file name not allowed'</span></td></tr><tr><th id=\"L166\"><a href=\"#L166\">166</a></th><td><span class=\"p\">}</span></td></tr><tr><th id=\"L167\"><a href=\"#L167\">167</a></th><td></td></tr><tr><th id=\"L168\"><a href=\"#L168\">168</a></th><td></td></tr><tr><th id=\"L169\"><a href=\"#L169\">169</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">InvalidPath</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L170\"><a href=\"#L170\">170</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L171\"><a href=\"#L171\">171</a></th><td></td></tr><tr><th id=\"L172\"><a href=\"#L172\">172</a></th><td></td></tr><tr><th id=\"L173\"><a href=\"#L173\">173</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">toSegments</span><span class=\"p\">(</span>cwd<span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L174\"><a href=\"#L174\">174</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L175\"><a href=\"#L175\">175</a></th><td><span class=\"sd\">\u00a0 \u00a0 Normalize a path, as represented by a list of strings each</span></td></tr><tr><th id=\"L176\"><a href=\"#L176\">176</a></th><td><span class=\"sd\">\u00a0 \u00a0 representing one segment of the path.</span></td></tr><tr><th id=\"L177\"><a href=\"#L177\">177</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L178\"><a href=\"#L178\">178</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0path<span class=\"o\">.</span>startswith<span class=\"p\">(</span><span class=\"s\">'/'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L179\"><a href=\"#L179\">179</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 segs <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L180\"><a href=\"#L180\">180</a></th><td>\u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L181\"><a href=\"#L181\">181</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 segs <span class=\"o\">=</span>\u00a0cwd<span class=\"p\">[:]</span></td></tr><tr><th id=\"L182\"><a href=\"#L182\">182</a></th><td></td></tr><tr><th id=\"L183\"><a href=\"#L183\">183</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0s <span class=\"ow\">in</span>\u00a0path<span class=\"o\">.</span>split<span class=\"p\">(</span><span class=\"s\">'/'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L184\"><a href=\"#L184\">184</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0s <span class=\"o\">==</span>\u00a0<span class=\"s\">'.'</span>\u00a0<span class=\"ow\">or</span>\u00a0s <span class=\"o\">==</span>\u00a0<span class=\"s\">''</span><span class=\"p\">:</span></td></tr><tr><th id=\"L185\"><a href=\"#L185\">185</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">continue</span></td></tr><tr><th id=\"L186\"><a href=\"#L186\">186</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0s <span class=\"o\">==</span>\u00a0<span class=\"s\">'..'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L187\"><a href=\"#L187\">187</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0segs<span class=\"p\">:</span></td></tr><tr><th id=\"L188\"><a href=\"#L188\">188</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 segs<span class=\"o\">.</span>pop<span class=\"p\">()</span></td></tr><tr><th id=\"L189\"><a href=\"#L189\">189</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L190\"><a href=\"#L190\">190</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0InvalidPath<span class=\"p\">(</span>cwd<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L191\"><a href=\"#L191\">191</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"s\">'</span><span class=\"se\">\\0</span><span class=\"s\">'</span>\u00a0<span class=\"ow\">in</span>\u00a0s <span class=\"ow\">or</span>\u00a0<span class=\"s\">'/'</span>\u00a0<span class=\"ow\">in</span>\u00a0s<span class=\"p\">:</span></td></tr><tr><th id=\"L192\"><a href=\"#L192\">192</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0InvalidPath<span class=\"p\">(</span>cwd<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L193\"><a href=\"#L193\">193</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L194\"><a href=\"#L194\">194</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 segs<span class=\"o\">.</span>append<span class=\"p\">(</span>s<span class=\"p\">)</span></td></tr><tr><th id=\"L195\"><a href=\"#L195\">195</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0segs</td></tr><tr><th id=\"L196\"><a href=\"#L196\">196</a></th><td></td></tr><tr><th id=\"L197\"><a href=\"#L197\">197</a></th><td></td></tr><tr><th id=\"L198\"><a href=\"#L198\">198</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">errnoToFailure</span><span class=\"p\">(</span>e<span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L199\"><a href=\"#L199\">199</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0e <span class=\"o\">==</span>\u00a0errno<span class=\"o\">.</span>ENOENT <span class=\"ow\">or</span>\u00a0e <span class=\"o\">==</span>\u00a0errno<span class=\"o\">.</span>EISDIR<span class=\"p\">:</span></td></tr><tr><th id=\"L200\"><a href=\"#L200\">200</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L201\"><a href=\"#L201\">201</a></th><td>\u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0e <span class=\"o\">==</span>\u00a0errno<span class=\"o\">.</span>EACCES <span class=\"ow\">or</span>\u00a0e <span class=\"o\">==</span>\u00a0errno<span class=\"o\">.</span>EPERM<span class=\"p\">:</span></td></tr><tr><th id=\"L202\"><a href=\"#L202\">202</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>PermissionDeniedError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L203\"><a href=\"#L203\">203</a></th><td>\u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0e <span class=\"o\">==</span>\u00a0errno<span class=\"o\">.</span>ENOTDIR<span class=\"p\">:</span></td></tr><tr><th id=\"L204\"><a href=\"#L204\">204</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>IsNotADirectoryError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L205\"><a href=\"#L205\">205</a></th><td>\u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L206\"><a href=\"#L206\">206</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">()</span></td></tr><tr><th id=\"L207\"><a href=\"#L207\">207</a></th><td></td></tr><tr><th id=\"L208\"><a href=\"#L208\">208</a></th><td><span class=\"c\"># Generic VFS exceptions</span></td></tr><tr><th id=\"L209\"><a href=\"#L209\">209</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FilesystemShellException</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L210\"><a href=\"#L210\">210</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Base for IFTPShell errors.</span></td></tr><tr><th id=\"L211\"><a href=\"#L211\">211</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L212\"><a href=\"#L212\">212</a></th><td></td></tr><tr><th id=\"L213\"><a href=\"#L213\">213</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">NoSuchFile</span><span class=\"p\">(</span>FilesystemShellException<span class=\"p\">):</span></td></tr><tr><th id=\"L214\"><a href=\"#L214\">214</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L215\"><a href=\"#L215\">215</a></th><td></td></tr><tr><th id=\"L216\"><a href=\"#L216\">216</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">PermissionDenied</span><span class=\"p\">(</span>FilesystemShellException<span class=\"p\">):</span></td></tr><tr><th id=\"L217\"><a href=\"#L217\">217</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L218\"><a href=\"#L218\">218</a></th><td></td></tr><tr><th id=\"L219\"><a href=\"#L219\">219</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">WrongFiletype</span><span class=\"p\">(</span>FilesystemShellException<span class=\"p\">):</span></td></tr><tr><th id=\"L220\"><a href=\"#L220\">220</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L221\"><a href=\"#L221\">221</a></th><td></td></tr><tr><th id=\"L222\"><a href=\"#L222\">222</a></th><td></td></tr><tr><th id=\"L223\"><a href=\"#L223\">223</a></th><td><span class=\"c\"># -- Custom Exceptions --</span></td></tr><tr><th id=\"L224\"><a href=\"#L224\">224</a></th><td></td></tr><tr><th id=\"L225\"><a href=\"#L225\">225</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPCmdError</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L226\"><a href=\"#L226\">226</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>msg<span class=\"p\">):</span></td></tr><tr><th id=\"L227\"><a href=\"#L227\">227</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"ne\">Exception</span><span class=\"o\">.</span>__init__<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>msg<span class=\"p\">)</span></td></tr><tr><th id=\"L228\"><a href=\"#L228\">228</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>errorMessage <span class=\"o\">=</span>\u00a0msg</td></tr><tr><th id=\"L229\"><a href=\"#L229\">229</a></th><td></td></tr><tr><th id=\"L230\"><a href=\"#L230\">230</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">response</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L231\"><a href=\"#L231\">231</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Generate a FTP response message for this error.\"\"\"</span></td></tr><tr><th id=\"L232\"><a href=\"#L232\">232</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0RESPONSE<span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span>errorCode<span class=\"p\">]</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>errorMessage</td></tr><tr><th id=\"L233\"><a href=\"#L233\">233</a></th><td></td></tr><tr><th id=\"L234\"><a href=\"#L234\">234</a></th><td></td></tr><tr><th id=\"L235\"><a href=\"#L235\">235</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FileNotFoundError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L236\"><a href=\"#L236\">236</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0FILE_NOT_FOUND</td></tr><tr><th id=\"L237\"><a href=\"#L237\">237</a></th><td></td></tr><tr><th id=\"L238\"><a href=\"#L238\">238</a></th><td></td></tr><tr><th id=\"L239\"><a href=\"#L239\">239</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">AnonUserDeniedError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L240\"><a href=\"#L240\">240</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L241\"><a href=\"#L241\">241</a></th><td><span class=\"sd\">\u00a0 \u00a0 Raised when an anonymous user issues a command that will alter the</span></td></tr><tr><th id=\"L242\"><a href=\"#L242\">242</a></th><td><span class=\"sd\">\u00a0 \u00a0 filesystem</span></td></tr><tr><th id=\"L243\"><a href=\"#L243\">243</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L244\"><a href=\"#L244\">244</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L245\"><a href=\"#L245\">245</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># No message</span></td></tr><tr><th id=\"L246\"><a href=\"#L246\">246</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 FTPCmdError<span class=\"o\">.</span>__init__<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L247\"><a href=\"#L247\">247</a></th><td></td></tr><tr><th id=\"L248\"><a href=\"#L248\">248</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0ANON_USER_DENIED</td></tr><tr><th id=\"L249\"><a href=\"#L249\">249</a></th><td></td></tr><tr><th id=\"L250\"><a href=\"#L250\">250</a></th><td></td></tr><tr><th id=\"L251\"><a href=\"#L251\">251</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">PermissionDeniedError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L252\"><a href=\"#L252\">252</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L253\"><a href=\"#L253\">253</a></th><td><span class=\"sd\">\u00a0 \u00a0 Raised when access is attempted to a resource to which access is</span></td></tr><tr><th id=\"L254\"><a href=\"#L254\">254</a></th><td><span class=\"sd\">\u00a0 \u00a0 not allowed.</span></td></tr><tr><th id=\"L255\"><a href=\"#L255\">255</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L256\"><a href=\"#L256\">256</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0PERMISSION_DENIED</td></tr><tr><th id=\"L257\"><a href=\"#L257\">257</a></th><td></td></tr><tr><th id=\"L258\"><a href=\"#L258\">258</a></th><td></td></tr><tr><th id=\"L259\"><a href=\"#L259\">259</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">IsNotADirectoryError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L260\"><a href=\"#L260\">260</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"raised when RMD is called on a path that isn't a directory</span></td></tr><tr><th id=\"L261\"><a href=\"#L261\">261</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L262\"><a href=\"#L262\">262</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0IS_NOT_A_DIR</td></tr><tr><th id=\"L263\"><a href=\"#L263\">263</a></th><td></td></tr><tr><th id=\"L264\"><a href=\"#L264\">264</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">CmdSyntaxError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L265\"><a href=\"#L265\">265</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0SYNTAX_ERR</td></tr><tr><th id=\"L266\"><a href=\"#L266\">266</a></th><td></td></tr><tr><th id=\"L267\"><a href=\"#L267\">267</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">CmdArgSyntaxError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L268\"><a href=\"#L268\">268</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0SYNTAX_ERR_IN_ARGS</td></tr><tr><th id=\"L269\"><a href=\"#L269\">269</a></th><td></td></tr><tr><th id=\"L270\"><a href=\"#L270\">270</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">CmdNotImplementedError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L271\"><a href=\"#L271\">271</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"raised when an unimplemented command is given to the server</span></td></tr><tr><th id=\"L272\"><a href=\"#L272\">272</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L273\"><a href=\"#L273\">273</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0CMD_NOT_IMPLMNTD</td></tr><tr><th id=\"L274\"><a href=\"#L274\">274</a></th><td></td></tr><tr><th id=\"L275\"><a href=\"#L275\">275</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">CmdNotImplementedForArgError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L276\"><a href=\"#L276\">276</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0CMD_NOT_IMPLMNTD_FOR_PARAM</td></tr><tr><th id=\"L277\"><a href=\"#L277\">277</a></th><td></td></tr><tr><th id=\"L278\"><a href=\"#L278\">278</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPError</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L279\"><a href=\"#L279\">279</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L280\"><a href=\"#L280\">280</a></th><td></td></tr><tr><th id=\"L281\"><a href=\"#L281\">281</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPTimeoutError</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L282\"><a href=\"#L282\">282</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L283\"><a href=\"#L283\">283</a></th><td></td></tr><tr><th id=\"L284\"><a href=\"#L284\">284</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">DTPError</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L285\"><a href=\"#L285\">285</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L286\"><a href=\"#L286\">286</a></th><td></td></tr><tr><th id=\"L287\"><a href=\"#L287\">287</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">BogusClientError</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L288\"><a href=\"#L288\">288</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"thrown when a client other than the one we opened this</span></td></tr><tr><th id=\"L289\"><a href=\"#L289\">289</a></th><td><span class=\"sd\">\u00a0 \u00a0 DTP connection for attempts to connect, or a client attempts to</span></td></tr><tr><th id=\"L290\"><a href=\"#L290\">290</a></th><td><span class=\"sd\">\u00a0 \u00a0 get us to connect to an ip that differs from the one where the</span></td></tr><tr><th id=\"L291\"><a href=\"#L291\">291</a></th><td><span class=\"sd\">\u00a0 \u00a0 request came from\"\"\"</span></td></tr><tr><th id=\"L292\"><a href=\"#L292\">292</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L293\"><a href=\"#L293\">293</a></th><td></td></tr><tr><th id=\"L294\"><a href=\"#L294\">294</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">PathBelowTLDError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L295\"><a href=\"#L295\">295</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0PERMISSION_DENIED</td></tr><tr><th id=\"L296\"><a href=\"#L296\">296</a></th><td></td></tr><tr><th id=\"L297\"><a href=\"#L297\">297</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">ClientDisconnectError</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L298\"><a href=\"#L298\">298</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L299\"><a href=\"#L299\">299</a></th><td></td></tr><tr><th id=\"L300\"><a href=\"#L300\">300</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">PortConnectionError</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span></td></tr><tr><th id=\"L301\"><a href=\"#L301\">301</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L302\"><a href=\"#L302\">302</a></th><td></td></tr><tr><th id=\"L303\"><a href=\"#L303\">303</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">BadCmdSequenceError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L304\"><a href=\"#L304\">304</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"raised when a client sends a series of commands in an illogical sequence\"\"\"</span></td></tr><tr><th id=\"L305\"><a href=\"#L305\">305</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0BAD_CMD_SEQ</td></tr><tr><th id=\"L306\"><a href=\"#L306\">306</a></th><td></td></tr><tr><th id=\"L307\"><a href=\"#L307\">307</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">AuthorizationError</span><span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L308\"><a href=\"#L308\">308</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"raised when client authentication fails\"\"\"</span></td></tr><tr><th id=\"L309\"><a href=\"#L309\">309</a></th><td>\u00a0 \u00a0 errorCode <span class=\"o\">=</span>\u00a0AUTH_FAILURE</td></tr><tr><th id=\"L310\"><a href=\"#L310\">310</a></th><td></td></tr><tr><th id=\"L311\"><a href=\"#L311\">311</a></th><td></td></tr><tr><th id=\"L312\"><a href=\"#L312\">312</a></th><td><span class=\"c\"># -- Utility Functions --</span></td></tr><tr><th id=\"L313\"><a href=\"#L313\">313</a></th><td></td></tr><tr><th id=\"L314\"><a href=\"#L314\">314</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">debugDeferred</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>_<span class=\"p\">):</span></td></tr><tr><th id=\"L315\"><a href=\"#L315\">315</a></th><td>\u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'debugDeferred(): </span><span class=\"si\">%s</span><span class=\"s\">'</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>_<span class=\"p\">),</span>\u00a0debug<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span></td></tr><tr><th id=\"L316\"><a href=\"#L316\">316</a></th><td></td></tr><tr><th id=\"L317\"><a href=\"#L317\">317</a></th><td></td></tr><tr><th id=\"L318\"><a href=\"#L318\">318</a></th><td><span class=\"c\"># -- DTP Protocol --</span></td></tr><tr><th id=\"L319\"><a href=\"#L319\">319</a></th><td></td></tr><tr><th id=\"L320\"><a href=\"#L320\">320</a></th><td></td></tr><tr><th id=\"L321\"><a href=\"#L321\">321</a></th><td>_months <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span></td></tr><tr><th id=\"L322\"><a href=\"#L322\">322</a></th><td>\u00a0 \u00a0 <span class=\"bp\">None</span><span class=\"p\">,</span></td></tr><tr><th id=\"L323\"><a href=\"#L323\">323</a></th><td>\u00a0 \u00a0 <span class=\"s\">'Jan'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'Feb'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'Mar'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'Apr'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'May'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'Jun'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L324\"><a href=\"#L324\">324</a></th><td>\u00a0 \u00a0 <span class=\"s\">'Jul'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'Aug'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'Sep'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'Oct'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'Nov'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'Dec'</span><span class=\"p\">]</span></td></tr><tr><th id=\"L325\"><a href=\"#L325\">325</a></th><td></td></tr><tr><th id=\"L326\"><a href=\"#L326\">326</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">DTP</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">,</span>\u00a0protocol<span class=\"o\">.</span>Protocol<span class=\"p\">):</span></td></tr><tr><th id=\"L327\"><a href=\"#L327\">327</a></th><td>\u00a0 \u00a0 implements<span class=\"p\">(</span>interfaces<span class=\"o\">.</span>IConsumer<span class=\"p\">)</span></td></tr><tr><th id=\"L328\"><a href=\"#L328\">328</a></th><td></td></tr><tr><th id=\"L329\"><a href=\"#L329\">329</a></th><td>\u00a0 \u00a0 isConnected <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L330\"><a href=\"#L330\">330</a></th><td></td></tr><tr><th id=\"L331\"><a href=\"#L331\">331</a></th><td>\u00a0 \u00a0 _cons <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L332\"><a href=\"#L332\">332</a></th><td>\u00a0 \u00a0 _onConnLost <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L333\"><a href=\"#L333\">333</a></th><td>\u00a0 \u00a0 _buffer <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L334\"><a href=\"#L334\">334</a></th><td></td></tr><tr><th id=\"L335\"><a href=\"#L335\">335</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connectionMade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L336\"><a href=\"#L336\">336</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>isConnected <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L337\"><a href=\"#L337\">337</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>factory<span class=\"o\">.</span>deferred<span class=\"o\">.</span>callback<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L338\"><a href=\"#L338\">338</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_buffer <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L339\"><a href=\"#L339\">339</a></th><td></td></tr><tr><th id=\"L340\"><a href=\"#L340\">340</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connectionLost</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0reason<span class=\"p\">):</span></td></tr><tr><th id=\"L341\"><a href=\"#L341\">341</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>isConnected <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L342\"><a href=\"#L342\">342</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_onConnLost <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L343\"><a href=\"#L343\">343</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_onConnLost<span class=\"o\">.</span>callback<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L344\"><a href=\"#L344\">344</a></th><td></td></tr><tr><th id=\"L345\"><a href=\"#L345\">345</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">sendLine</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">):</span></td></tr><tr><th id=\"L346\"><a href=\"#L346\">346</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>write<span class=\"p\">(</span>line <span class=\"o\">+</span>\u00a0<span class=\"s\">'</span><span class=\"se\">\\r\\n</span><span class=\"s\">'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L347\"><a href=\"#L347\">347</a></th><td></td></tr><tr><th id=\"L348\"><a href=\"#L348\">348</a></th><td></td></tr><tr><th id=\"L349\"><a href=\"#L349\">349</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_formatOneListResponse</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0name<span class=\"p\">,</span>\u00a0size<span class=\"p\">,</span>\u00a0directory<span class=\"p\">,</span>\u00a0permissions<span class=\"p\">,</span>\u00a0hardlinks<span class=\"p\">,</span>\u00a0modified<span class=\"p\">,</span>\u00a0owner<span class=\"p\">,</span>\u00a0group<span class=\"p\">):</span></td></tr><tr><th id=\"L350\"><a href=\"#L350\">350</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">formatMode</span><span class=\"p\">(</span>mode<span class=\"p\">):</span></td></tr><tr><th id=\"L351\"><a href=\"#L351\">351</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">''</span><span class=\"o\">.</span>join<span class=\"p\">([</span>mode <span class=\"o\">&amp;</span>\u00a0<span class=\"p\">(</span><span class=\"mi\">256</span>\u00a0<span class=\"o\">&gt;&gt;</span>\u00a0n<span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"s\">'rwx'</span><span class=\"p\">[</span>n <span class=\"o\">%</span>\u00a0<span class=\"mi\">3</span><span class=\"p\">]</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"s\">'-'</span>\u00a0<span class=\"k\">for</span>\u00a0n <span class=\"ow\">in</span>\u00a0<span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">9</span><span class=\"p\">)])</span></td></tr><tr><th id=\"L352\"><a href=\"#L352\">352</a></th><td></td></tr><tr><th id=\"L353\"><a href=\"#L353\">353</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">formatDate</span><span class=\"p\">(</span>mtime<span class=\"p\">):</span></td></tr><tr><th id=\"L354\"><a href=\"#L354\">354</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 now <span class=\"o\">=</span>\u00a0time<span class=\"o\">.</span>gmtime<span class=\"p\">()</span></td></tr><tr><th id=\"L355\"><a href=\"#L355\">355</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 info <span class=\"o\">=</span>\u00a0<span class=\"p\">{</span></td></tr><tr><th id=\"L356\"><a href=\"#L356\">356</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'month'</span><span class=\"p\">:</span>\u00a0_months<span class=\"p\">[</span>mtime<span class=\"o\">.</span>tm_mon<span class=\"p\">],</span></td></tr><tr><th id=\"L357\"><a href=\"#L357\">357</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'day'</span><span class=\"p\">:</span>\u00a0mtime<span class=\"o\">.</span>tm_mday<span class=\"p\">,</span></td></tr><tr><th id=\"L358\"><a href=\"#L358\">358</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'year'</span><span class=\"p\">:</span>\u00a0mtime<span class=\"o\">.</span>tm_year<span class=\"p\">,</span></td></tr><tr><th id=\"L359\"><a href=\"#L359\">359</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'hour'</span><span class=\"p\">:</span>\u00a0mtime<span class=\"o\">.</span>tm_hour<span class=\"p\">,</span></td></tr><tr><th id=\"L360\"><a href=\"#L360\">360</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'minute'</span><span class=\"p\">:</span>\u00a0mtime<span class=\"o\">.</span>tm_min</td></tr><tr><th id=\"L361\"><a href=\"#L361\">361</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">}</span></td></tr><tr><th id=\"L362\"><a href=\"#L362\">362</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0now<span class=\"o\">.</span>tm_year <span class=\"o\">!=</span>\u00a0mtime<span class=\"o\">.</span>tm_year<span class=\"p\">:</span></td></tr><tr><th id=\"L363\"><a href=\"#L363\">363</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">'</span><span class=\"si\">%(month)s</span><span class=\"s\">\u00a0</span><span class=\"si\">%(day)02d</span><span class=\"s\">\u00a0</span><span class=\"si\">%(year)5d</span><span class=\"s\">'</span>\u00a0<span class=\"o\">%</span>\u00a0info</td></tr><tr><th id=\"L364\"><a href=\"#L364\">364</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L365\"><a href=\"#L365\">365</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">'</span><span class=\"si\">%(month)s</span><span class=\"s\">\u00a0</span><span class=\"si\">%(day)02d</span><span class=\"s\">\u00a0</span><span class=\"si\">%(hour)02d</span><span class=\"s\">:</span><span class=\"si\">%(minute)02d</span><span class=\"s\">'</span>\u00a0<span class=\"o\">%</span>\u00a0info</td></tr><tr><th id=\"L366\"><a href=\"#L366\">366</a></th><td></td></tr><tr><th id=\"L367\"><a href=\"#L367\">367</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 format <span class=\"o\">=</span>\u00a0<span class=\"p\">(</span><span class=\"s\">'</span><span class=\"si\">%(directory)s%(permissions)s%(hardlinks)4d</span><span class=\"s\">\u00a0'</span></td></tr><tr><th id=\"L368\"><a href=\"#L368\">368</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'</span><span class=\"si\">%(owner)-9s</span><span class=\"s\">\u00a0</span><span class=\"si\">%(group)-9s</span><span class=\"s\">\u00a0</span><span class=\"si\">%(size)15d</span><span class=\"s\">\u00a0</span><span class=\"si\">%(date)12s</span><span class=\"s\">\u00a0'</span></td></tr><tr><th id=\"L369\"><a href=\"#L369\">369</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'</span><span class=\"si\">%(name)s</span><span class=\"s\">'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L370\"><a href=\"#L370\">370</a></th><td></td></tr><tr><th id=\"L371\"><a href=\"#L371\">371</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0format <span class=\"o\">%</span>\u00a0<span class=\"p\">{</span></td></tr><tr><th id=\"L372\"><a href=\"#L372\">372</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'directory'</span><span class=\"p\">:</span>\u00a0directory <span class=\"ow\">and</span>\u00a0<span class=\"s\">'d'</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"s\">'-'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L373\"><a href=\"#L373\">373</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'permissions'</span><span class=\"p\">:</span>\u00a0formatMode<span class=\"p\">(</span>permissions<span class=\"p\">),</span></td></tr><tr><th id=\"L374\"><a href=\"#L374\">374</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'hardlinks'</span><span class=\"p\">:</span>\u00a0hardlinks<span class=\"p\">,</span></td></tr><tr><th id=\"L375\"><a href=\"#L375\">375</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'owner'</span><span class=\"p\">:</span>\u00a0owner<span class=\"p\">[:</span><span class=\"mi\">8</span><span class=\"p\">],</span></td></tr><tr><th id=\"L376\"><a href=\"#L376\">376</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'group'</span><span class=\"p\">:</span>\u00a0group<span class=\"p\">[:</span><span class=\"mi\">8</span><span class=\"p\">],</span></td></tr><tr><th id=\"L377\"><a href=\"#L377\">377</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'size'</span><span class=\"p\">:</span>\u00a0size<span class=\"p\">,</span></td></tr><tr><th id=\"L378\"><a href=\"#L378\">378</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'date'</span><span class=\"p\">:</span>\u00a0formatDate<span class=\"p\">(</span>time<span class=\"o\">.</span>gmtime<span class=\"p\">(</span>modified<span class=\"p\">)),</span></td></tr><tr><th id=\"L379\"><a href=\"#L379\">379</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'name'</span><span class=\"p\">:</span>\u00a0name<span class=\"p\">}</span></td></tr><tr><th id=\"L380\"><a href=\"#L380\">380</a></th><td></td></tr><tr><th id=\"L381\"><a href=\"#L381\">381</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">sendListResponse</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0name<span class=\"p\">,</span>\u00a0response<span class=\"p\">):</span></td></tr><tr><th id=\"L382\"><a href=\"#L382\">382</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendLine<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>_formatOneListResponse<span class=\"p\">(</span>name<span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>response<span class=\"p\">))</span></td></tr><tr><th id=\"L383\"><a href=\"#L383\">383</a></th><td></td></tr><tr><th id=\"L384\"><a href=\"#L384\">384</a></th><td></td></tr><tr><th id=\"L385\"><a href=\"#L385\">385</a></th><td>\u00a0 \u00a0 <span class=\"c\"># Proxy IConsumer to our transport</span></td></tr><tr><th id=\"L386\"><a href=\"#L386\">386</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">registerProducer</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0producer<span class=\"p\">,</span>\u00a0streaming<span class=\"p\">):</span></td></tr><tr><th id=\"L387\"><a href=\"#L387\">387</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>registerProducer<span class=\"p\">(</span>producer<span class=\"p\">,</span>\u00a0streaming<span class=\"p\">)</span></td></tr><tr><th id=\"L388\"><a href=\"#L388\">388</a></th><td></td></tr><tr><th id=\"L389\"><a href=\"#L389\">389</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">unregisterProducer</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L390\"><a href=\"#L390\">390</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>unregisterProducer<span class=\"p\">()</span></td></tr><tr><th id=\"L391\"><a href=\"#L391\">391</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L392\"><a href=\"#L392\">392</a></th><td></td></tr><tr><th id=\"L393\"><a href=\"#L393\">393</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">write</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0data<span class=\"p\">):</span></td></tr><tr><th id=\"L394\"><a href=\"#L394\">394</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>isConnected<span class=\"p\">:</span></td></tr><tr><th id=\"L395\"><a href=\"#L395\">395</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>write<span class=\"p\">(</span>data<span class=\"p\">)</span></td></tr><tr><th id=\"L396\"><a href=\"#L396\">396</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">Exception</span><span class=\"p\">(</span><span class=\"s\">\"Crap damn crap damn crap damn\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L397\"><a href=\"#L397\">397</a></th><td></td></tr><tr><th id=\"L398\"><a href=\"#L398\">398</a></th><td></td></tr><tr><th id=\"L399\"><a href=\"#L399\">399</a></th><td>\u00a0 \u00a0 <span class=\"c\"># Pretend to be a producer, too.</span></td></tr><tr><th id=\"L400\"><a href=\"#L400\">400</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_conswrite</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"nb\">bytes</span><span class=\"p\">):</span></td></tr><tr><th id=\"L401\"><a href=\"#L401\">401</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L402\"><a href=\"#L402\">402</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_cons<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"nb\">bytes</span><span class=\"p\">)</span></td></tr><tr><th id=\"L403\"><a href=\"#L403\">403</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L404\"><a href=\"#L404\">404</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_onConnLost<span class=\"o\">.</span>errback<span class=\"p\">()</span></td></tr><tr><th id=\"L405\"><a href=\"#L405\">405</a></th><td></td></tr><tr><th id=\"L406\"><a href=\"#L406\">406</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">dataReceived</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"nb\">bytes</span><span class=\"p\">):</span></td></tr><tr><th id=\"L407\"><a href=\"#L407\">407</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_cons <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L408\"><a href=\"#L408\">408</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_conswrite<span class=\"p\">(</span><span class=\"nb\">bytes</span><span class=\"p\">)</span></td></tr><tr><th id=\"L409\"><a href=\"#L409\">409</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L410\"><a href=\"#L410\">410</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_buffer<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"nb\">bytes</span><span class=\"p\">)</span></td></tr><tr><th id=\"L411\"><a href=\"#L411\">411</a></th><td></td></tr><tr><th id=\"L412\"><a href=\"#L412\">412</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_unregConsumer</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0ignored<span class=\"p\">):</span></td></tr><tr><th id=\"L413\"><a href=\"#L413\">413</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_cons<span class=\"o\">.</span>unregisterProducer<span class=\"p\">()</span></td></tr><tr><th id=\"L414\"><a href=\"#L414\">414</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_cons <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L415\"><a href=\"#L415\">415</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">del</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_onConnLost</td></tr><tr><th id=\"L416\"><a href=\"#L416\">416</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0ignored</td></tr><tr><th id=\"L417\"><a href=\"#L417\">417</a></th><td></td></tr><tr><th id=\"L418\"><a href=\"#L418\">418</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">registerConsumer</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0cons<span class=\"p\">):</span></td></tr><tr><th id=\"L419\"><a href=\"#L419\">419</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">assert</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_cons <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L420\"><a href=\"#L420\">420</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_cons <span class=\"o\">=</span>\u00a0cons</td></tr><tr><th id=\"L421\"><a href=\"#L421\">421</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_cons<span class=\"o\">.</span>registerProducer<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"bp\">True</span><span class=\"p\">)</span></td></tr><tr><th id=\"L422\"><a href=\"#L422\">422</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0chunk <span class=\"ow\">in</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_buffer<span class=\"p\">:</span></td></tr><tr><th id=\"L423\"><a href=\"#L423\">423</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_conswrite<span class=\"p\">(</span>chunk<span class=\"p\">)</span></td></tr><tr><th id=\"L424\"><a href=\"#L424\">424</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_buffer <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L425\"><a href=\"#L425\">425</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>isConnected<span class=\"p\">:</span></td></tr><tr><th id=\"L426\"><a href=\"#L426\">426</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_onConnLost <span class=\"o\">=</span>\u00a0d <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>Deferred<span class=\"p\">()</span></td></tr><tr><th id=\"L427\"><a href=\"#L427\">427</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addBoth<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>_unregConsumer<span class=\"p\">)</span></td></tr><tr><th id=\"L428\"><a href=\"#L428\">428</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L429\"><a href=\"#L429\">429</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L430\"><a href=\"#L430\">430</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_cons<span class=\"o\">.</span>unregisterProducer<span class=\"p\">()</span></td></tr><tr><th id=\"L431\"><a href=\"#L431\">431</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_cons <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L432\"><a href=\"#L432\">432</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L433\"><a href=\"#L433\">433</a></th><td></td></tr><tr><th id=\"L434\"><a href=\"#L434\">434</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">resumeProducing</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L435\"><a href=\"#L435\">435</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>resumeProducing<span class=\"p\">()</span></td></tr><tr><th id=\"L436\"><a href=\"#L436\">436</a></th><td></td></tr><tr><th id=\"L437\"><a href=\"#L437\">437</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">pauseProducing</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L438\"><a href=\"#L438\">438</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>pauseProducing<span class=\"p\">()</span></td></tr><tr><th id=\"L439\"><a href=\"#L439\">439</a></th><td></td></tr><tr><th id=\"L440\"><a href=\"#L440\">440</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">stopProducing</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L441\"><a href=\"#L441\">441</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>stopProducing<span class=\"p\">()</span></td></tr><tr><th id=\"L442\"><a href=\"#L442\">442</a></th><td></td></tr><tr><th id=\"L443\"><a href=\"#L443\">443</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">DTPFactory</span><span class=\"p\">(</span>protocol<span class=\"o\">.</span>ClientFactory<span class=\"p\">):</span></td></tr><tr><th id=\"L444\"><a href=\"#L444\">444</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L445\"><a href=\"#L445\">445</a></th><td><span class=\"sd\">\u00a0 \u00a0 DTP protocol factory.</span></td></tr><tr><th id=\"L446\"><a href=\"#L446\">446</a></th><td><span class=\"sd\">\u00a0 \u00a0 </span></td></tr><tr><th id=\"L447\"><a href=\"#L447\">447</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar peerCheck: perform checks to make sure the ftp-pi's peer is the same</span></td></tr><tr><th id=\"L448\"><a href=\"#L448\">448</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 as the dtp's</span></td></tr><tr><th id=\"L449\"><a href=\"#L449\">449</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar pi: a reference to this factory's protocol interpreter</span></td></tr><tr><th id=\"L450\"><a href=\"#L450\">450</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L451\"><a href=\"#L451\">451</a></th><td></td></tr><tr><th id=\"L452\"><a href=\"#L452\">452</a></th><td>\u00a0 \u00a0 <span class=\"c\"># -- configuration variables --</span></td></tr><tr><th id=\"L453\"><a href=\"#L453\">453</a></th><td>\u00a0 \u00a0 peerCheck <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L454\"><a href=\"#L454\">454</a></th><td></td></tr><tr><th id=\"L455\"><a href=\"#L455\">455</a></th><td>\u00a0 \u00a0 <span class=\"c\"># -- class variables --</span></td></tr><tr><th id=\"L456\"><a href=\"#L456\">456</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0pi<span class=\"p\">,</span>\u00a0peerHost<span class=\"o\">=</span><span class=\"bp\">None</span><span class=\"p\">):</span></td></tr><tr><th id=\"L457\"><a href=\"#L457\">457</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Constructor</span></td></tr><tr><th id=\"L458\"><a href=\"#L458\">458</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param pi: this factory's protocol interpreter</span></td></tr><tr><th id=\"L459\"><a href=\"#L459\">459</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param peerHost: if peerCheck is True, this is the tuple that the</span></td></tr><tr><th id=\"L460\"><a href=\"#L460\">460</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 generated instance will use to perform security checks</span></td></tr><tr><th id=\"L461\"><a href=\"#L461\">461</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L462\"><a href=\"#L462\">462</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>pi <span class=\"o\">=</span>\u00a0pi\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># the protocol interpreter that is using this factory</span></td></tr><tr><th id=\"L463\"><a href=\"#L463\">463</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>peerHost <span class=\"o\">=</span>\u00a0peerHost\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># the from FTP.transport.peerHost()</span></td></tr><tr><th id=\"L464\"><a href=\"#L464\">464</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>Deferred<span class=\"p\">()</span>\u00a0 \u00a0 <span class=\"c\"># deferred will fire when instance is connected</span></td></tr><tr><th id=\"L465\"><a href=\"#L465\">465</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred<span class=\"o\">.</span>addBoth<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0ign<span class=\"p\">:</span>\u00a0<span class=\"p\">(</span><span class=\"nb\">delattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'deferred'</span><span class=\"p\">),</span>\u00a0ign<span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">])</span></td></tr><tr><th id=\"L466\"><a href=\"#L466\">466</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>delayedCall <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L467\"><a href=\"#L467\">467</a></th><td></td></tr><tr><th id=\"L468\"><a href=\"#L468\">468</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">buildProtocol</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0addr<span class=\"p\">):</span></td></tr><tr><th id=\"L469\"><a href=\"#L469\">469</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'DTPFactory.buildProtocol'</span><span class=\"p\">,</span>\u00a0debug<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span></td></tr><tr><th id=\"L470\"><a href=\"#L470\">470</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>cancelTimeout<span class=\"p\">()</span></td></tr><tr><th id=\"L471\"><a href=\"#L471\">471</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>pi<span class=\"o\">.</span>dtpInstance<span class=\"p\">:</span>\u00a0 \u00a0<span class=\"c\"># only create one instance</span></td></tr><tr><th id=\"L472\"><a href=\"#L472\">472</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span></td></tr><tr><th id=\"L473\"><a href=\"#L473\">473</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0DTP<span class=\"p\">()</span></td></tr><tr><th id=\"L474\"><a href=\"#L474\">474</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p<span class=\"o\">.</span>factory <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span></td></tr><tr><th id=\"L475\"><a href=\"#L475\">475</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p<span class=\"o\">.</span>pi <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>pi</td></tr><tr><th id=\"L476\"><a href=\"#L476\">476</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>pi<span class=\"o\">.</span>dtpInstance <span class=\"o\">=</span>\u00a0p</td></tr><tr><th id=\"L477\"><a href=\"#L477\">477</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0p</td></tr><tr><th id=\"L478\"><a href=\"#L478\">478</a></th><td></td></tr><tr><th id=\"L479\"><a href=\"#L479\">479</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">stopFactory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L480\"><a href=\"#L480\">480</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'dtpFactory.stopFactory'</span><span class=\"p\">,</span>\u00a0debug<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span></td></tr><tr><th id=\"L481\"><a href=\"#L481\">481</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>cancelTimeout<span class=\"p\">()</span></td></tr><tr><th id=\"L482\"><a href=\"#L482\">482</a></th><td></td></tr><tr><th id=\"L483\"><a href=\"#L483\">483</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">timeoutFactory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L484\"><a href=\"#L484\">484</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'timed out waiting for DTP connection'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L485\"><a href=\"#L485\">485</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>deferred<span class=\"p\">:</span></td></tr><tr><th id=\"L486\"><a href=\"#L486\">486</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>deferred <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>deferred<span class=\"p\">,</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L487\"><a href=\"#L487\">487</a></th><td></td></tr><tr><th id=\"L488\"><a href=\"#L488\">488</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># TODO: LEFT OFF HERE!</span></td></tr><tr><th id=\"L489\"><a href=\"#L489\">489</a></th><td></td></tr><tr><th id=\"L490\"><a href=\"#L490\">490</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addErrback<span class=\"p\">(</span>debugDeferred<span class=\"p\">,</span>\u00a0<span class=\"s\">'timeoutFactory firing errback'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L491\"><a href=\"#L491\">491</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>errback<span class=\"p\">(</span>defer<span class=\"o\">.</span>TimeoutError<span class=\"p\">())</span></td></tr><tr><th id=\"L492\"><a href=\"#L492\">492</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>stopFactory<span class=\"p\">()</span></td></tr><tr><th id=\"L493\"><a href=\"#L493\">493</a></th><td></td></tr><tr><th id=\"L494\"><a href=\"#L494\">494</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cancelTimeout</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L495\"><a href=\"#L495\">495</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>delayedCall<span class=\"o\">.</span>called <span class=\"ow\">and</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>delayedCall<span class=\"o\">.</span>cancelled<span class=\"p\">:</span></td></tr><tr><th id=\"L496\"><a href=\"#L496\">496</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'cancelling DTP timeout'</span><span class=\"p\">,</span>\u00a0debug<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span></td></tr><tr><th id=\"L497\"><a href=\"#L497\">497</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>delayedCall<span class=\"o\">.</span>cancel<span class=\"p\">()</span></td></tr><tr><th id=\"L498\"><a href=\"#L498\">498</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">assert</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>delayedCall<span class=\"o\">.</span>cancelled</td></tr><tr><th id=\"L499\"><a href=\"#L499\">499</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'timeout has been cancelled'</span><span class=\"p\">,</span>\u00a0debug<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span></td></tr><tr><th id=\"L500\"><a href=\"#L500\">500</a></th><td></td></tr><tr><th id=\"L501\"><a href=\"#L501\">501</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">setTimeout</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0seconds<span class=\"p\">):</span></td></tr><tr><th id=\"L502\"><a href=\"#L502\">502</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'DTPFactory.setTimeout set to </span><span class=\"si\">%s</span><span class=\"s\">\u00a0seconds'</span>\u00a0<span class=\"o\">%</span>\u00a0seconds<span class=\"p\">)</span></td></tr><tr><th id=\"L503\"><a href=\"#L503\">503</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>delayedCall <span class=\"o\">=</span>\u00a0reactor<span class=\"o\">.</span>callLater<span class=\"p\">(</span>seconds<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>timeoutFactory<span class=\"p\">)</span></td></tr><tr><th id=\"L504\"><a href=\"#L504\">504</a></th><td></td></tr><tr><th id=\"L505\"><a href=\"#L505\">505</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">clientConnectionFailed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0connector<span class=\"p\">,</span>\u00a0reason<span class=\"p\">):</span></td></tr><tr><th id=\"L506\"><a href=\"#L506\">506</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred<span class=\"o\">.</span>errback<span class=\"p\">(</span>PortConnectionError<span class=\"p\">(</span>reason<span class=\"p\">))</span></td></tr><tr><th id=\"L507\"><a href=\"#L507\">507</a></th><td></td></tr><tr><th id=\"L508\"><a href=\"#L508\">508</a></th><td><span class=\"c\"># -- FTP-PI (Protocol Interpreter) --</span></td></tr><tr><th id=\"L509\"><a href=\"#L509\">509</a></th><td></td></tr><tr><th id=\"L510\"><a href=\"#L510\">510</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">ASCIIConsumerWrapper</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span></td></tr><tr><th id=\"L511\"><a href=\"#L511\">511</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0cons<span class=\"p\">):</span></td></tr><tr><th id=\"L512\"><a href=\"#L512\">512</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>cons <span class=\"o\">=</span>\u00a0cons</td></tr><tr><th id=\"L513\"><a href=\"#L513\">513</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>registerProducer <span class=\"o\">=</span>\u00a0cons<span class=\"o\">.</span>registerProducer</td></tr><tr><th id=\"L514\"><a href=\"#L514\">514</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>unregisterProducer <span class=\"o\">=</span>\u00a0cons<span class=\"o\">.</span>unregisterProducer</td></tr><tr><th id=\"L515\"><a href=\"#L515\">515</a></th><td></td></tr><tr><th id=\"L516\"><a href=\"#L516\">516</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">assert</span>\u00a0os<span class=\"o\">.</span>linesep <span class=\"o\">==</span>\u00a0<span class=\"s\">\"</span><span class=\"se\">\\r\\n</span><span class=\"s\">\"</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"nb\">len</span><span class=\"p\">(</span>os<span class=\"o\">.</span>linesep<span class=\"p\">)</span>\u00a0<span class=\"o\">==</span>\u00a0<span class=\"mi\">1</span><span class=\"p\">,</span>\u00a0<span class=\"s\">\"Unsupported platform (yea right like this even exists)\"</span></td></tr><tr><th id=\"L517\"><a href=\"#L517\">517</a></th><td></td></tr><tr><th id=\"L518\"><a href=\"#L518\">518</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0os<span class=\"o\">.</span>linesep <span class=\"o\">==</span>\u00a0<span class=\"s\">\"</span><span class=\"se\">\\r\\n</span><span class=\"s\">\"</span><span class=\"p\">:</span></td></tr><tr><th id=\"L519\"><a href=\"#L519\">519</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>write <span class=\"o\">=</span>\u00a0cons<span class=\"o\">.</span>write</td></tr><tr><th id=\"L520\"><a href=\"#L520\">520</a></th><td></td></tr><tr><th id=\"L521\"><a href=\"#L521\">521</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">write</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"nb\">bytes</span><span class=\"p\">):</span></td></tr><tr><th id=\"L522\"><a href=\"#L522\">522</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>cons<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"nb\">bytes</span><span class=\"o\">.</span>replace<span class=\"p\">(</span>os<span class=\"o\">.</span>linesep<span class=\"p\">,</span>\u00a0<span class=\"s\">\"</span><span class=\"se\">\\r\\n</span><span class=\"s\">\"</span><span class=\"p\">))</span></td></tr><tr><th id=\"L523\"><a href=\"#L523\">523</a></th><td></td></tr><tr><th id=\"L524\"><a href=\"#L524\">524</a></th><td></td></tr><tr><th id=\"L525\"><a href=\"#L525\">525</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FileConsumer</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span></td></tr><tr><th id=\"L526\"><a href=\"#L526\">526</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0fObj<span class=\"p\">):</span></td></tr><tr><th id=\"L527\"><a href=\"#L527\">527</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>fObj <span class=\"o\">=</span>\u00a0fObj</td></tr><tr><th id=\"L528\"><a href=\"#L528\">528</a></th><td></td></tr><tr><th id=\"L529\"><a href=\"#L529\">529</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">registerProducer</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0producer<span class=\"p\">,</span>\u00a0streaming<span class=\"p\">):</span></td></tr><tr><th id=\"L530\"><a href=\"#L530\">530</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>producer <span class=\"o\">=</span>\u00a0producer</td></tr><tr><th id=\"L531\"><a href=\"#L531\">531</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">assert</span>\u00a0streaming</td></tr><tr><th id=\"L532\"><a href=\"#L532\">532</a></th><td></td></tr><tr><th id=\"L533\"><a href=\"#L533\">533</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">unregisterProducer</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L534\"><a href=\"#L534\">534</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>producer <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L535\"><a href=\"#L535\">535</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>fObj<span class=\"o\">.</span>close<span class=\"p\">()</span></td></tr><tr><th id=\"L536\"><a href=\"#L536\">536</a></th><td></td></tr><tr><th id=\"L537\"><a href=\"#L537\">537</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">write</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"nb\">bytes</span><span class=\"p\">):</span></td></tr><tr><th id=\"L538\"><a href=\"#L538\">538</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>fObj<span class=\"o\">.</span>write<span class=\"p\">(</span><span class=\"nb\">bytes</span><span class=\"p\">)</span></td></tr><tr><th id=\"L539\"><a href=\"#L539\">539</a></th><td></td></tr><tr><th id=\"L540\"><a href=\"#L540\">540</a></th><td></td></tr><tr><th id=\"L541\"><a href=\"#L541\">541</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPOverflowProtocol</span><span class=\"p\">(</span>basic<span class=\"o\">.</span>LineReceiver<span class=\"p\">):</span></td></tr><tr><th id=\"L542\"><a href=\"#L542\">542</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"FTP mini-protocol for when there are too many connections.\"\"\"</span></td></tr><tr><th id=\"L543\"><a href=\"#L543\">543</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connectionMade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L544\"><a href=\"#L544\">544</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendLine<span class=\"p\">(</span>RESPONSE<span class=\"p\">[</span>TOO_MANY_CONNECTIONS<span class=\"p\">])</span></td></tr><tr><th id=\"L545\"><a href=\"#L545\">545</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L546\"><a href=\"#L546\">546</a></th><td></td></tr><tr><th id=\"L547\"><a href=\"#L547\">547</a></th><td></td></tr><tr><th id=\"L548\"><a href=\"#L548\">548</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTP</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">,</span>\u00a0basic<span class=\"o\">.</span>LineReceiver<span class=\"p\">,</span>\u00a0policies<span class=\"o\">.</span>TimeoutMixin<span class=\"p\">):</span></td></tr><tr><th id=\"L549\"><a href=\"#L549\">549</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Protocol Interpreter for the File Transfer Protocol</span></td></tr><tr><th id=\"L550\"><a href=\"#L550\">550</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L551\"><a href=\"#L551\">551</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar state: The current server state.\u00a0 One of L{UNAUTH},</span></td></tr><tr><th id=\"L552\"><a href=\"#L552\">552</a></th><td><span class=\"sd\">\u00a0 \u00a0 L{INAUTH}, L{AUTHED}, L{RENAMING}.</span></td></tr><tr><th id=\"L553\"><a href=\"#L553\">553</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L554\"><a href=\"#L554\">554</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar shell: The connected avatar</span></td></tr><tr><th id=\"L555\"><a href=\"#L555\">555</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar binary: The transfer mode.\u00a0 If false, ASCII.</span></td></tr><tr><th id=\"L556\"><a href=\"#L556\">556</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar dtpFactory: Generates a single DTP for this session</span></td></tr><tr><th id=\"L557\"><a href=\"#L557\">557</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar dtpPort: Port returned from listenTCP</span></td></tr><tr><th id=\"L558\"><a href=\"#L558\">558</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L559\"><a href=\"#L559\">559</a></th><td></td></tr><tr><th id=\"L560\"><a href=\"#L560\">560</a></th><td>\u00a0 \u00a0 disconnected <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L561\"><a href=\"#L561\">561</a></th><td></td></tr><tr><th id=\"L562\"><a href=\"#L562\">562</a></th><td>\u00a0 \u00a0 <span class=\"c\"># States an FTP can be in</span></td></tr><tr><th id=\"L563\"><a href=\"#L563\">563</a></th><td>\u00a0 \u00a0 UNAUTH<span class=\"p\">,</span>\u00a0INAUTH<span class=\"p\">,</span>\u00a0AUTHED<span class=\"p\">,</span>\u00a0RENAMING <span class=\"o\">=</span>\u00a0<span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">)</span></td></tr><tr><th id=\"L564\"><a href=\"#L564\">564</a></th><td></td></tr><tr><th id=\"L565\"><a href=\"#L565\">565</a></th><td>\u00a0 \u00a0 <span class=\"c\"># how long the DTP waits for a connection</span></td></tr><tr><th id=\"L566\"><a href=\"#L566\">566</a></th><td>\u00a0 \u00a0 dtpTimeout <span class=\"o\">=</span>\u00a0<span class=\"mi\">10</span></td></tr><tr><th id=\"L567\"><a href=\"#L567\">567</a></th><td></td></tr><tr><th id=\"L568\"><a href=\"#L568\">568</a></th><td>\u00a0 \u00a0 portal\u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L569\"><a href=\"#L569\">569</a></th><td>\u00a0 \u00a0 shell\u00a0 \u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># the avatar</span></td></tr><tr><th id=\"L570\"><a href=\"#L570\">570</a></th><td>\u00a0 \u00a0 dtpFactory\u00a0 <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># generates a single DTP for this session</span></td></tr><tr><th id=\"L571\"><a href=\"#L571\">571</a></th><td>\u00a0 \u00a0 dtpPort\u00a0 \u00a0 \u00a0<span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># object returned from listenTCP</span></td></tr><tr><th id=\"L572\"><a href=\"#L572\">572</a></th><td>\u00a0 \u00a0 dtpInstance <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L573\"><a href=\"#L573\">573</a></th><td>\u00a0 \u00a0 binary\u00a0 \u00a0 \u00a0 <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span>\u00a0 \u00a0 \u00a0<span class=\"c\"># binary transfers? False implies ASCII. defaults to True</span></td></tr><tr><th id=\"L574\"><a href=\"#L574\">574</a></th><td></td></tr><tr><th id=\"L575\"><a href=\"#L575\">575</a></th><td></td></tr><tr><th id=\"L576\"><a href=\"#L576\">576</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">reply</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0key<span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>args<span class=\"p\">):</span></td></tr><tr><th id=\"L577\"><a href=\"#L577\">577</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 msg <span class=\"o\">=</span>\u00a0RESPONSE<span class=\"p\">[</span>key<span class=\"p\">]</span>\u00a0<span class=\"o\">%</span>\u00a0args</td></tr><tr><th id=\"L578\"><a href=\"#L578\">578</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendLine<span class=\"p\">(</span>msg<span class=\"p\">)</span></td></tr><tr><th id=\"L579\"><a href=\"#L579\">579</a></th><td></td></tr><tr><th id=\"L580\"><a href=\"#L580\">580</a></th><td></td></tr><tr><th id=\"L581\"><a href=\"#L581\">581</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connectionMade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L582\"><a href=\"#L582\">582</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>UNAUTH</td></tr><tr><th id=\"L583\"><a href=\"#L583\">583</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>setTimeout<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>timeOut<span class=\"p\">)</span></td></tr><tr><th id=\"L584\"><a href=\"#L584\">584</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>WELCOME_MSG<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>factory<span class=\"o\">.</span>welcomeMessage<span class=\"p\">)</span></td></tr><tr><th id=\"L585\"><a href=\"#L585\">585</a></th><td></td></tr><tr><th id=\"L586\"><a href=\"#L586\">586</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connectionLost</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0reason<span class=\"p\">):</span></td></tr><tr><th id=\"L587\"><a href=\"#L587\">587</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># if we have a DTP protocol instance running and</span></td></tr><tr><th id=\"L588\"><a href=\"#L588\">588</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># we lose connection to the client's PI, kill the</span></td></tr><tr><th id=\"L589\"><a href=\"#L589\">589</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># DTP connection and close the port</span></td></tr><tr><th id=\"L590\"><a href=\"#L590\">590</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory<span class=\"p\">:</span></td></tr><tr><th id=\"L591\"><a href=\"#L591\">591</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>cleanupDTP<span class=\"p\">()</span></td></tr><tr><th id=\"L592\"><a href=\"#L592\">592</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>setTimeout<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L593\"><a href=\"#L593\">593</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"p\">,</span>\u00a0<span class=\"s\">'logout'</span><span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>logout <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L594\"><a href=\"#L594\">594</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>logout<span class=\"p\">()</span></td></tr><tr><th id=\"L595\"><a href=\"#L595\">595</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>shell <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L596\"><a href=\"#L596\">596</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L597\"><a href=\"#L597\">597</a></th><td></td></tr><tr><th id=\"L598\"><a href=\"#L598\">598</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">timeoutConnection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L599\"><a href=\"#L599\">599</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L600\"><a href=\"#L600\">600</a></th><td></td></tr><tr><th id=\"L601\"><a href=\"#L601\">601</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">lineReceived</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">):</span></td></tr><tr><th id=\"L602\"><a href=\"#L602\">602</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>resetTimeout<span class=\"p\">()</span></td></tr><tr><th id=\"L603\"><a href=\"#L603\">603</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>pauseProducing<span class=\"p\">()</span></td></tr><tr><th id=\"L604\"><a href=\"#L604\">604</a></th><td></td></tr><tr><th id=\"L605\"><a href=\"#L605\">605</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">processFailed</span><span class=\"p\">(</span>err<span class=\"p\">):</span></td></tr><tr><th id=\"L606\"><a href=\"#L606\">606</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0err<span class=\"o\">.</span>check<span class=\"p\">(</span>FTPCmdError<span class=\"p\">):</span></td></tr><tr><th id=\"L607\"><a href=\"#L607\">607</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendLine<span class=\"p\">(</span>err<span class=\"o\">.</span>value<span class=\"o\">.</span>response<span class=\"p\">())</span></td></tr><tr><th id=\"L608\"><a href=\"#L608\">608</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"p\">(</span>err<span class=\"o\">.</span>check<span class=\"p\">(</span><span class=\"ne\">TypeError</span><span class=\"p\">)</span>\u00a0<span class=\"ow\">and</span>\u00a0</td></tr><tr><th id=\"L609\"><a href=\"#L609\">609</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 err<span class=\"o\">.</span>value<span class=\"o\">.</span>args<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span>find<span class=\"p\">(</span><span class=\"s\">'takes exactly'</span><span class=\"p\">)</span>\u00a0<span class=\"o\">!=</span>\u00a0<span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">):</span></td></tr><tr><th id=\"L610\"><a href=\"#L610\">610</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>SYNTAX_ERR<span class=\"p\">,</span>\u00a0<span class=\"s\">\"</span><span class=\"si\">%s</span><span class=\"s\">\u00a0requires an argument.\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>cmd<span class=\"p\">,))</span></td></tr><tr><th id=\"L611\"><a href=\"#L611\">611</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L612\"><a href=\"#L612\">612</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Unexpected FTP error\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L613\"><a href=\"#L613\">613</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>err<span class=\"p\">(</span>err<span class=\"p\">)</span></td></tr><tr><th id=\"L614\"><a href=\"#L614\">614</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>REQ_ACTN_NOT_TAKEN<span class=\"p\">,</span>\u00a0<span class=\"s\">\"internal server error\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L615\"><a href=\"#L615\">615</a></th><td></td></tr><tr><th id=\"L616\"><a href=\"#L616\">616</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">processSucceeded</span><span class=\"p\">(</span>result<span class=\"p\">):</span></td></tr><tr><th id=\"L617\"><a href=\"#L617\">617</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">isinstance</span><span class=\"p\">(</span>result<span class=\"p\">,</span>\u00a0<span class=\"nb\">tuple</span><span class=\"p\">):</span></td></tr><tr><th id=\"L618\"><a href=\"#L618\">618</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span><span class=\"o\">*</span>result<span class=\"p\">)</span></td></tr><tr><th id=\"L619\"><a href=\"#L619\">619</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0result <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L620\"><a href=\"#L620\">620</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>result<span class=\"p\">)</span></td></tr><tr><th id=\"L621\"><a href=\"#L621\">621</a></th><td></td></tr><tr><th id=\"L622\"><a href=\"#L622\">622</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">allDone</span><span class=\"p\">(</span>ignored<span class=\"p\">):</span></td></tr><tr><th id=\"L623\"><a href=\"#L623\">623</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>disconnected<span class=\"p\">:</span></td></tr><tr><th id=\"L624\"><a href=\"#L624\">624</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>resumeProducing<span class=\"p\">()</span></td></tr><tr><th id=\"L625\"><a href=\"#L625\">625</a></th><td></td></tr><tr><th id=\"L626\"><a href=\"#L626\">626</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 spaceIndex <span class=\"o\">=</span>\u00a0line<span class=\"o\">.</span>find<span class=\"p\">(</span><span class=\"s\">' '</span><span class=\"p\">)</span></td></tr><tr><th id=\"L627\"><a href=\"#L627\">627</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0spaceIndex <span class=\"o\">!=</span>\u00a0<span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">:</span></td></tr><tr><th id=\"L628\"><a href=\"#L628\">628</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cmd <span class=\"o\">=</span>\u00a0line<span class=\"p\">[:</span>spaceIndex<span class=\"p\">]</span></td></tr><tr><th id=\"L629\"><a href=\"#L629\">629</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 args <span class=\"o\">=</span>\u00a0<span class=\"p\">(</span>line<span class=\"p\">[</span>spaceIndex <span class=\"o\">+</span>\u00a0<span class=\"mi\">1</span><span class=\"p\">:],)</span></td></tr><tr><th id=\"L630\"><a href=\"#L630\">630</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L631\"><a href=\"#L631\">631</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cmd <span class=\"o\">=</span>\u00a0line</td></tr><tr><th id=\"L632\"><a href=\"#L632\">632</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 args <span class=\"o\">=</span>\u00a0<span class=\"p\">()</span></td></tr><tr><th id=\"L633\"><a href=\"#L633\">633</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>maybeDeferred<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>processCommand<span class=\"p\">,</span>\u00a0cmd<span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>args<span class=\"p\">)</span></td></tr><tr><th id=\"L634\"><a href=\"#L634\">634</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallbacks<span class=\"p\">(</span>processSucceeded<span class=\"p\">,</span>\u00a0processFailed<span class=\"p\">)</span></td></tr><tr><th id=\"L635\"><a href=\"#L635\">635</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addErrback<span class=\"p\">(</span>log<span class=\"o\">.</span>err<span class=\"p\">)</span></td></tr><tr><th id=\"L636\"><a href=\"#L636\">636</a></th><td></td></tr><tr><th id=\"L637\"><a href=\"#L637\">637</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># XXX It burnsss</span></td></tr><tr><th id=\"L638\"><a href=\"#L638\">638</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># LineReceiver doesn't let you resumeProducing inside</span></td></tr><tr><th id=\"L639\"><a href=\"#L639\">639</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># lineReceived atm</span></td></tr><tr><th id=\"L640\"><a href=\"#L640\">640</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"kn\">from</span>\u00a0<span class=\"nn\">twisted.internet</span>\u00a0<span class=\"kn\">import</span>\u00a0reactor</td></tr><tr><th id=\"L641\"><a href=\"#L641\">641</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 reactor<span class=\"o\">.</span>callLater<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0d<span class=\"o\">.</span>addBoth<span class=\"p\">,</span>\u00a0allDone<span class=\"p\">)</span></td></tr><tr><th id=\"L642\"><a href=\"#L642\">642</a></th><td></td></tr><tr><th id=\"L643\"><a href=\"#L643\">643</a></th><td></td></tr><tr><th id=\"L644\"><a href=\"#L644\">644</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">processCommand</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0cmd<span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>params<span class=\"p\">):</span></td></tr><tr><th id=\"L645\"><a href=\"#L645\">645</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 cmd <span class=\"o\">=</span>\u00a0cmd<span class=\"o\">.</span>upper<span class=\"p\">()</span></td></tr><tr><th id=\"L646\"><a href=\"#L646\">646</a></th><td></td></tr><tr><th id=\"L647\"><a href=\"#L647\">647</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">==</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>UNAUTH<span class=\"p\">:</span></td></tr><tr><th id=\"L648\"><a href=\"#L648\">648</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0cmd <span class=\"o\">==</span>\u00a0<span class=\"s\">'USER'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L649\"><a href=\"#L649\">649</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>ftp_USER<span class=\"p\">(</span><span class=\"o\">*</span>params<span class=\"p\">)</span></td></tr><tr><th id=\"L650\"><a href=\"#L650\">650</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0cmd <span class=\"o\">==</span>\u00a0<span class=\"s\">'PASS'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L651\"><a href=\"#L651\">651</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0BAD_CMD_SEQ<span class=\"p\">,</span>\u00a0<span class=\"s\">\"USER required before PASS\"</span></td></tr><tr><th id=\"L652\"><a href=\"#L652\">652</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L653\"><a href=\"#L653\">653</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0NOT_LOGGED_IN</td></tr><tr><th id=\"L654\"><a href=\"#L654\">654</a></th><td></td></tr><tr><th id=\"L655\"><a href=\"#L655\">655</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">==</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>INAUTH<span class=\"p\">:</span></td></tr><tr><th id=\"L656\"><a href=\"#L656\">656</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0cmd <span class=\"o\">==</span>\u00a0<span class=\"s\">'PASS'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L657\"><a href=\"#L657\">657</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>ftp_PASS<span class=\"p\">(</span><span class=\"o\">*</span>params<span class=\"p\">)</span></td></tr><tr><th id=\"L658\"><a href=\"#L658\">658</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L659\"><a href=\"#L659\">659</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0BAD_CMD_SEQ<span class=\"p\">,</span>\u00a0<span class=\"s\">\"PASS required after USER\"</span></td></tr><tr><th id=\"L660\"><a href=\"#L660\">660</a></th><td></td></tr><tr><th id=\"L661\"><a href=\"#L661\">661</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">==</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>AUTHED<span class=\"p\">:</span></td></tr><tr><th id=\"L662\"><a href=\"#L662\">662</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 method <span class=\"o\">=</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"s\">\"ftp_\"</span>\u00a0<span class=\"o\">+</span>\u00a0cmd<span class=\"p\">,</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L663\"><a href=\"#L663\">663</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0method <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L664\"><a href=\"#L664\">664</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0method<span class=\"p\">(</span><span class=\"o\">*</span>params<span class=\"p\">)</span></td></tr><tr><th id=\"L665\"><a href=\"#L665\">665</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>CmdNotImplementedError<span class=\"p\">(</span>cmd<span class=\"p\">))</span></td></tr><tr><th id=\"L666\"><a href=\"#L666\">666</a></th><td></td></tr><tr><th id=\"L667\"><a href=\"#L667\">667</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">==</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>RENAMING<span class=\"p\">:</span></td></tr><tr><th id=\"L668\"><a href=\"#L668\">668</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0cmd <span class=\"o\">==</span>\u00a0<span class=\"s\">'RNTO'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L669\"><a href=\"#L669\">669</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>ftp_RNTO<span class=\"p\">(</span><span class=\"o\">*</span>params<span class=\"p\">)</span></td></tr><tr><th id=\"L670\"><a href=\"#L670\">670</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L671\"><a href=\"#L671\">671</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0BAD_CMD_SEQ<span class=\"p\">,</span>\u00a0<span class=\"s\">\"RNTO required after RNFR\"</span></td></tr><tr><th id=\"L672\"><a href=\"#L672\">672</a></th><td></td></tr><tr><th id=\"L673\"><a href=\"#L673\">673</a></th><td></td></tr><tr><th id=\"L674\"><a href=\"#L674\">674</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_USER</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0username<span class=\"p\">):</span></td></tr><tr><th id=\"L675\"><a href=\"#L675\">675</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L676\"><a href=\"#L676\">676</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 First part of login.\u00a0 Get the username the peer wants to</span></td></tr><tr><th id=\"L677\"><a href=\"#L677\">677</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 authenticate as.</span></td></tr><tr><th id=\"L678\"><a href=\"#L678\">678</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L679\"><a href=\"#L679\">679</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0username<span class=\"p\">:</span></td></tr><tr><th id=\"L680\"><a href=\"#L680\">680</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>CmdSyntaxError<span class=\"p\">(</span><span class=\"s\">'USER requires an argument'</span><span class=\"p\">))</span></td></tr><tr><th id=\"L681\"><a href=\"#L681\">681</a></th><td></td></tr><tr><th id=\"L682\"><a href=\"#L682\">682</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_user <span class=\"o\">=</span>\u00a0username</td></tr><tr><th id=\"L683\"><a href=\"#L683\">683</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>INAUTH</td></tr><tr><th id=\"L684\"><a href=\"#L684\">684</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>factory<span class=\"o\">.</span>allowAnonymous <span class=\"ow\">and</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_user <span class=\"o\">==</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>factory<span class=\"o\">.</span>userAnonymous<span class=\"p\">:</span></td></tr><tr><th id=\"L685\"><a href=\"#L685\">685</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0GUEST_NAME_OK_NEED_EMAIL</td></tr><tr><th id=\"L686\"><a href=\"#L686\">686</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L687\"><a href=\"#L687\">687</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>USR_NAME_OK_NEED_PASS<span class=\"p\">,</span>\u00a0username<span class=\"p\">)</span></td></tr><tr><th id=\"L688\"><a href=\"#L688\">688</a></th><td></td></tr><tr><th id=\"L689\"><a href=\"#L689\">689</a></th><td>\u00a0 \u00a0 <span class=\"c\"># TODO: add max auth try before timeout from ip...</span></td></tr><tr><th id=\"L690\"><a href=\"#L690\">690</a></th><td>\u00a0 \u00a0 <span class=\"c\"># TODO: need to implement minimal ABOR command</span></td></tr><tr><th id=\"L691\"><a href=\"#L691\">691</a></th><td></td></tr><tr><th id=\"L692\"><a href=\"#L692\">692</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_PASS</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0password<span class=\"p\">):</span></td></tr><tr><th id=\"L693\"><a href=\"#L693\">693</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L694\"><a href=\"#L694\">694</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Second part of login.\u00a0 Get the password the peer wants to</span></td></tr><tr><th id=\"L695\"><a href=\"#L695\">695</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 authenticate with.</span></td></tr><tr><th id=\"L696\"><a href=\"#L696\">696</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L697\"><a href=\"#L697\">697</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>factory<span class=\"o\">.</span>allowAnonymous <span class=\"ow\">and</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_user <span class=\"o\">==</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>factory<span class=\"o\">.</span>userAnonymous<span class=\"p\">:</span></td></tr><tr><th id=\"L698\"><a href=\"#L698\">698</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># anonymous login</span></td></tr><tr><th id=\"L699\"><a href=\"#L699\">699</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 creds <span class=\"o\">=</span>\u00a0credentials<span class=\"o\">.</span>Anonymous<span class=\"p\">()</span></td></tr><tr><th id=\"L700\"><a href=\"#L700\">700</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 reply <span class=\"o\">=</span>\u00a0GUEST_LOGGED_IN_PROCEED</td></tr><tr><th id=\"L701\"><a href=\"#L701\">701</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L702\"><a href=\"#L702\">702</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># user login</span></td></tr><tr><th id=\"L703\"><a href=\"#L703\">703</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 creds <span class=\"o\">=</span>\u00a0credentials<span class=\"o\">.</span>UsernamePassword<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>_user<span class=\"p\">,</span>\u00a0password<span class=\"p\">)</span></td></tr><tr><th id=\"L704\"><a href=\"#L704\">704</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 reply <span class=\"o\">=</span>\u00a0USR_LOGGED_IN_PROCEED</td></tr><tr><th id=\"L705\"><a href=\"#L705\">705</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">del</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_user</td></tr><tr><th id=\"L706\"><a href=\"#L706\">706</a></th><td></td></tr><tr><th id=\"L707\"><a href=\"#L707\">707</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_cbLogin</span><span class=\"p\">((</span>interface<span class=\"p\">,</span>\u00a0avatar<span class=\"p\">,</span>\u00a0logout<span class=\"p\">)):</span></td></tr><tr><th id=\"L708\"><a href=\"#L708\">708</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">assert</span>\u00a0interface <span class=\"ow\">is</span>\u00a0IFTPShell<span class=\"p\">,</span>\u00a0<span class=\"s\">\"The realm is busted, jerk.\"</span></td></tr><tr><th id=\"L709\"><a href=\"#L709\">709</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>shell <span class=\"o\">=</span>\u00a0avatar</td></tr><tr><th id=\"L710\"><a href=\"#L710\">710</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>logout <span class=\"o\">=</span>\u00a0logout</td></tr><tr><th id=\"L711\"><a href=\"#L711\">711</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L712\"><a href=\"#L712\">712</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>AUTHED</td></tr><tr><th id=\"L713\"><a href=\"#L713\">713</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0reply</td></tr><tr><th id=\"L714\"><a href=\"#L714\">714</a></th><td></td></tr><tr><th id=\"L715\"><a href=\"#L715\">715</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_ebLogin</span><span class=\"p\">(</span>failure<span class=\"p\">):</span></td></tr><tr><th id=\"L716\"><a href=\"#L716\">716</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 failure<span class=\"o\">.</span>trap<span class=\"p\">(</span>cred_error<span class=\"o\">.</span>UnauthorizedLogin<span class=\"p\">,</span>\u00a0cred_error<span class=\"o\">.</span>UnhandledCredentials<span class=\"p\">)</span></td></tr><tr><th id=\"L717\"><a href=\"#L717\">717</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>UNAUTH</td></tr><tr><th id=\"L718\"><a href=\"#L718\">718</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0AuthorizationError</td></tr><tr><th id=\"L719\"><a href=\"#L719\">719</a></th><td></td></tr><tr><th id=\"L720\"><a href=\"#L720\">720</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>portal<span class=\"o\">.</span>login<span class=\"p\">(</span>creds<span class=\"p\">,</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">,</span>\u00a0IFTPShell<span class=\"p\">)</span></td></tr><tr><th id=\"L721\"><a href=\"#L721\">721</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallbacks<span class=\"p\">(</span>_cbLogin<span class=\"p\">,</span>\u00a0_ebLogin<span class=\"p\">)</span></td></tr><tr><th id=\"L722\"><a href=\"#L722\">722</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L723\"><a href=\"#L723\">723</a></th><td></td></tr><tr><th id=\"L724\"><a href=\"#L724\">724</a></th><td></td></tr><tr><th id=\"L725\"><a href=\"#L725\">725</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_PASV</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L726\"><a href=\"#L726\">726</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Request for a passive connection</span></td></tr><tr><th id=\"L727\"><a href=\"#L727\">727</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L728\"><a href=\"#L728\">728</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 from the rfc::</span></td></tr><tr><th id=\"L729\"><a href=\"#L729\">729</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L730\"><a href=\"#L730\">730</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 This command requests the server-DTP to \\\"listen\\\" on a data port</span></td></tr><tr><th id=\"L731\"><a href=\"#L731\">731</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 (which is not its default data port) and to wait for a connection</span></td></tr><tr><th id=\"L732\"><a href=\"#L732\">732</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 rather than initiate one upon receipt of a transfer command.\u00a0 The</span></td></tr><tr><th id=\"L733\"><a href=\"#L733\">733</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 response to this command includes the host and port address this</span></td></tr><tr><th id=\"L734\"><a href=\"#L734\">734</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 server is listening on.</span></td></tr><tr><th id=\"L735\"><a href=\"#L735\">735</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L736\"><a href=\"#L736\">736</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># if we have a DTP port set up, lose it.</span></td></tr><tr><th id=\"L737\"><a href=\"#L737\">737</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L738\"><a href=\"#L738\">738</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># cleanupDTP sets dtpFactory to none.\u00a0 Later we'll do</span></td></tr><tr><th id=\"L739\"><a href=\"#L739\">739</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># cleanup here or something.</span></td></tr><tr><th id=\"L740\"><a href=\"#L740\">740</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>cleanupDTP<span class=\"p\">()</span></td></tr><tr><th id=\"L741\"><a href=\"#L741\">741</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory <span class=\"o\">=</span>\u00a0DTPFactory<span class=\"p\">(</span>pi<span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"p\">)</span></td></tr><tr><th id=\"L742\"><a href=\"#L742\">742</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory<span class=\"o\">.</span>setTimeout<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>dtpTimeout<span class=\"p\">)</span></td></tr><tr><th id=\"L743\"><a href=\"#L743\">743</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpPort <span class=\"o\">=</span>\u00a0reactor<span class=\"o\">.</span>listenTCP<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory<span class=\"p\">)</span></td></tr><tr><th id=\"L744\"><a href=\"#L744\">744</a></th><td></td></tr><tr><th id=\"L745\"><a href=\"#L745\">745</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 host <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>getHost<span class=\"p\">()</span><span class=\"o\">.</span>host</td></tr><tr><th id=\"L746\"><a href=\"#L746\">746</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 port <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpPort<span class=\"o\">.</span>getHost<span class=\"p\">()</span><span class=\"o\">.</span>port</td></tr><tr><th id=\"L747\"><a href=\"#L747\">747</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>ENTERING_PASV_MODE<span class=\"p\">,</span>\u00a0encodeHostPort<span class=\"p\">(</span>host<span class=\"p\">,</span>\u00a0port<span class=\"p\">))</span></td></tr><tr><th id=\"L748\"><a href=\"#L748\">748</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory<span class=\"o\">.</span>deferred<span class=\"o\">.</span>addCallback<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0ign<span class=\"p\">:</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L749\"><a href=\"#L749\">749</a></th><td></td></tr><tr><th id=\"L750\"><a href=\"#L750\">750</a></th><td></td></tr><tr><th id=\"L751\"><a href=\"#L751\">751</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_PORT</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0address<span class=\"p\">):</span></td></tr><tr><th id=\"L752\"><a href=\"#L752\">752</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 addr <span class=\"o\">=</span>\u00a0<span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"nb\">int</span><span class=\"p\">,</span>\u00a0address<span class=\"o\">.</span>split<span class=\"p\">(</span><span class=\"s\">','</span><span class=\"p\">))</span></td></tr><tr><th id=\"L753\"><a href=\"#L753\">753</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 ip <span class=\"o\">=</span>\u00a0<span class=\"s\">'</span><span class=\"si\">%d</span><span class=\"s\">.</span><span class=\"si\">%d</span><span class=\"s\">.</span><span class=\"si\">%d</span><span class=\"s\">.</span><span class=\"si\">%d</span><span class=\"s\">'</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"nb\">tuple</span><span class=\"p\">(</span>addr<span class=\"p\">[:</span><span class=\"mi\">4</span><span class=\"p\">])</span></td></tr><tr><th id=\"L754\"><a href=\"#L754\">754</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 port <span class=\"o\">=</span>\u00a0addr<span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]</span>\u00a0<span class=\"o\">&lt;&lt;</span>\u00a0<span class=\"mi\">8</span>\u00a0<span class=\"o\">|</span>\u00a0addr<span class=\"p\">[</span><span class=\"mi\">5</span><span class=\"p\">]</span></td></tr><tr><th id=\"L755\"><a href=\"#L755\">755</a></th><td></td></tr><tr><th id=\"L756\"><a href=\"#L756\">756</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># if we have a DTP port set up, lose it.</span></td></tr><tr><th id=\"L757\"><a href=\"#L757\">757</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L758\"><a href=\"#L758\">758</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>cleanupDTP<span class=\"p\">()</span></td></tr><tr><th id=\"L759\"><a href=\"#L759\">759</a></th><td></td></tr><tr><th id=\"L760\"><a href=\"#L760\">760</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory <span class=\"o\">=</span>\u00a0DTPFactory<span class=\"p\">(</span>pi<span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0peerHost<span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>getPeer<span class=\"p\">()</span><span class=\"o\">.</span>host<span class=\"p\">)</span></td></tr><tr><th id=\"L761\"><a href=\"#L761\">761</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory<span class=\"o\">.</span>setTimeout<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>dtpTimeout<span class=\"p\">)</span></td></tr><tr><th id=\"L762\"><a href=\"#L762\">762</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpPort <span class=\"o\">=</span>\u00a0reactor<span class=\"o\">.</span>connectTCP<span class=\"p\">(</span>ip<span class=\"p\">,</span>\u00a0port<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory<span class=\"p\">)</span></td></tr><tr><th id=\"L763\"><a href=\"#L763\">763</a></th><td></td></tr><tr><th id=\"L764\"><a href=\"#L764\">764</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connected</span><span class=\"p\">(</span>ignored<span class=\"p\">):</span></td></tr><tr><th id=\"L765\"><a href=\"#L765\">765</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0ENTERING_PORT_MODE</td></tr><tr><th id=\"L766\"><a href=\"#L766\">766</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connFailed</span><span class=\"p\">(</span>err<span class=\"p\">):</span></td></tr><tr><th id=\"L767\"><a href=\"#L767\">767</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 err<span class=\"o\">.</span>trap<span class=\"p\">(</span>PortConnectionError<span class=\"p\">)</span></td></tr><tr><th id=\"L768\"><a href=\"#L768\">768</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0CANT_OPEN_DATA_CNX</td></tr><tr><th id=\"L769\"><a href=\"#L769\">769</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory<span class=\"o\">.</span>deferred<span class=\"o\">.</span>addCallbacks<span class=\"p\">(</span>connected<span class=\"p\">,</span>\u00a0connFailed<span class=\"p\">)</span></td></tr><tr><th id=\"L770\"><a href=\"#L770\">770</a></th><td></td></tr><tr><th id=\"L771\"><a href=\"#L771\">771</a></th><td></td></tr><tr><th id=\"L772\"><a href=\"#L772\">772</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_LIST</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"o\">=</span><span class=\"s\">''</span><span class=\"p\">):</span></td></tr><tr><th id=\"L773\"><a href=\"#L773\">773</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\" This command causes a list to be sent from the server to the</span></td></tr><tr><th id=\"L774\"><a href=\"#L774\">774</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 passive DTP.\u00a0 If the pathname specifies a directory or other</span></td></tr><tr><th id=\"L775\"><a href=\"#L775\">775</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 group of files, the server should transfer a list of files</span></td></tr><tr><th id=\"L776\"><a href=\"#L776\">776</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 in the specified directory.\u00a0 If the pathname specifies a</span></td></tr><tr><th id=\"L777\"><a href=\"#L777\">777</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 file then the server should send current information on the</span></td></tr><tr><th id=\"L778\"><a href=\"#L778\">778</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 file.\u00a0 A null argument implies the user's current working or</span></td></tr><tr><th id=\"L779\"><a href=\"#L779\">779</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 default directory.</span></td></tr><tr><th id=\"L780\"><a href=\"#L780\">780</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L781\"><a href=\"#L781\">781</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Uh, for now, do this retarded thing.</span></td></tr><tr><th id=\"L782\"><a href=\"#L782\">782</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>isConnected<span class=\"p\">:</span></td></tr><tr><th id=\"L783\"><a href=\"#L783\">783</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>BadCmdSequenceError<span class=\"p\">(</span><span class=\"s\">'must send PORT or PASV before RETR'</span><span class=\"p\">))</span></td></tr><tr><th id=\"L784\"><a href=\"#L784\">784</a></th><td></td></tr><tr><th id=\"L785\"><a href=\"#L785\">785</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># bug in konqueror</span></td></tr><tr><th id=\"L786\"><a href=\"#L786\">786</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0path <span class=\"o\">==</span>\u00a0<span class=\"s\">\"-a\"</span><span class=\"p\">:</span></td></tr><tr><th id=\"L787\"><a href=\"#L787\">787</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path <span class=\"o\">=</span>\u00a0<span class=\"s\">''</span></td></tr><tr><th id=\"L788\"><a href=\"#L788\">788</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># bug in gFTP 2.0.15</span></td></tr><tr><th id=\"L789\"><a href=\"#L789\">789</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0path <span class=\"o\">==</span>\u00a0<span class=\"s\">\"-aL\"</span><span class=\"p\">:</span></td></tr><tr><th id=\"L790\"><a href=\"#L790\">790</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path <span class=\"o\">=</span>\u00a0<span class=\"s\">''</span></td></tr><tr><th id=\"L791\"><a href=\"#L791\">791</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># bug in Nautilus 2.10.0</span></td></tr><tr><th id=\"L792\"><a href=\"#L792\">792</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0path <span class=\"o\">==</span>\u00a0<span class=\"s\">\"-L\"</span><span class=\"p\">:</span></td></tr><tr><th id=\"L793\"><a href=\"#L793\">793</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path <span class=\"o\">=</span>\u00a0<span class=\"s\">''</span></td></tr><tr><th id=\"L794\"><a href=\"#L794\">794</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># bug in ange-ftp</span></td></tr><tr><th id=\"L795\"><a href=\"#L795\">795</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0path <span class=\"o\">==</span>\u00a0<span class=\"s\">\"-la\"</span><span class=\"p\">:</span></td></tr><tr><th id=\"L796\"><a href=\"#L796\">796</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path <span class=\"o\">=</span>\u00a0<span class=\"s\">''</span></td></tr><tr><th id=\"L797\"><a href=\"#L797\">797</a></th><td></td></tr><tr><th id=\"L798\"><a href=\"#L798\">798</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">gotListing</span><span class=\"p\">(</span>results<span class=\"p\">):</span></td></tr><tr><th id=\"L799\"><a href=\"#L799\">799</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>DATA_CNX_ALREADY_OPEN_START_XFR<span class=\"p\">)</span></td></tr><tr><th id=\"L800\"><a href=\"#L800\">800</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0<span class=\"p\">(</span>name<span class=\"p\">,</span>\u00a0attrs<span class=\"p\">)</span>\u00a0<span class=\"ow\">in</span>\u00a0results<span class=\"p\">:</span></td></tr><tr><th id=\"L801\"><a href=\"#L801\">801</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>sendListResponse<span class=\"p\">(</span>name<span class=\"p\">,</span>\u00a0attrs<span class=\"p\">)</span></td></tr><tr><th id=\"L802\"><a href=\"#L802\">802</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>transport<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L803\"><a href=\"#L803\">803</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>TXFR_COMPLETE_OK<span class=\"p\">,)</span></td></tr><tr><th id=\"L804\"><a href=\"#L804\">804</a></th><td></td></tr><tr><th id=\"L805\"><a href=\"#L805\">805</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L806\"><a href=\"#L806\">806</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 segments <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L807\"><a href=\"#L807\">807</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">,</span>\u00a0e<span class=\"p\">:</span></td></tr><tr><th id=\"L808\"><a href=\"#L808\">808</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L809\"><a href=\"#L809\">809</a></th><td></td></tr><tr><th id=\"L810\"><a href=\"#L810\">810</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>list<span class=\"p\">(</span></td></tr><tr><th id=\"L811\"><a href=\"#L811\">811</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 segments<span class=\"p\">,</span></td></tr><tr><th id=\"L812\"><a href=\"#L812\">812</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">(</span><span class=\"s\">'size'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'directory'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'permissions'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'hardlinks'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L813\"><a href=\"#L813\">813</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<span class=\"s\">'modified'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'owner'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'group'</span><span class=\"p\">))</span></td></tr><tr><th id=\"L814\"><a href=\"#L814\">814</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallback<span class=\"p\">(</span>gotListing<span class=\"p\">)</span></td></tr><tr><th id=\"L815\"><a href=\"#L815\">815</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L816\"><a href=\"#L816\">816</a></th><td></td></tr><tr><th id=\"L817\"><a href=\"#L817\">817</a></th><td></td></tr><tr><th id=\"L818\"><a href=\"#L818\">818</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_NLST</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L819\"><a href=\"#L819\">819</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># XXX: why is this check different to ftp_RETR/ftp_STOR?</span></td></tr><tr><th id=\"L820\"><a href=\"#L820\">820</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>isConnected<span class=\"p\">:</span></td></tr><tr><th id=\"L821\"><a href=\"#L821\">821</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>BadCmdSequenceError<span class=\"p\">(</span><span class=\"s\">'must send PORT or PASV before RETR'</span><span class=\"p\">))</span></td></tr><tr><th id=\"L822\"><a href=\"#L822\">822</a></th><td></td></tr><tr><th id=\"L823\"><a href=\"#L823\">823</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L824\"><a href=\"#L824\">824</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 segments <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L825\"><a href=\"#L825\">825</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">,</span>\u00a0e<span class=\"p\">:</span></td></tr><tr><th id=\"L826\"><a href=\"#L826\">826</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L827\"><a href=\"#L827\">827</a></th><td></td></tr><tr><th id=\"L828\"><a href=\"#L828\">828</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbList</span><span class=\"p\">(</span>results<span class=\"p\">):</span></td></tr><tr><th id=\"L829\"><a href=\"#L829\">829</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>DATA_CNX_ALREADY_OPEN_START_XFR<span class=\"p\">)</span></td></tr><tr><th id=\"L830\"><a href=\"#L830\">830</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0<span class=\"p\">(</span>name<span class=\"p\">,</span>\u00a0ignored<span class=\"p\">)</span>\u00a0<span class=\"ow\">in</span>\u00a0results<span class=\"p\">:</span></td></tr><tr><th id=\"L831\"><a href=\"#L831\">831</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>sendLine<span class=\"p\">(</span>name<span class=\"p\">)</span></td></tr><tr><th id=\"L832\"><a href=\"#L832\">832</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>transport<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L833\"><a href=\"#L833\">833</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>TXFR_COMPLETE_OK<span class=\"p\">,)</span></td></tr><tr><th id=\"L834\"><a href=\"#L834\">834</a></th><td></td></tr><tr><th id=\"L835\"><a href=\"#L835\">835</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbGlob</span><span class=\"p\">(</span>results<span class=\"p\">):</span></td></tr><tr><th id=\"L836\"><a href=\"#L836\">836</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>DATA_CNX_ALREADY_OPEN_START_XFR<span class=\"p\">)</span></td></tr><tr><th id=\"L837\"><a href=\"#L837\">837</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0<span class=\"p\">(</span>name<span class=\"p\">,</span>\u00a0ignored<span class=\"p\">)</span>\u00a0<span class=\"ow\">in</span>\u00a0results<span class=\"p\">:</span></td></tr><tr><th id=\"L838\"><a href=\"#L838\">838</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0fnmatch<span class=\"o\">.</span>fnmatch<span class=\"p\">(</span>name<span class=\"p\">,</span>\u00a0segments<span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]):</span></td></tr><tr><th id=\"L839\"><a href=\"#L839\">839</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>sendLine<span class=\"p\">(</span>name<span class=\"p\">)</span></td></tr><tr><th id=\"L840\"><a href=\"#L840\">840</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>transport<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L841\"><a href=\"#L841\">841</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>TXFR_COMPLETE_OK<span class=\"p\">,)</span></td></tr><tr><th id=\"L842\"><a href=\"#L842\">842</a></th><td></td></tr><tr><th id=\"L843\"><a href=\"#L843\">843</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># XXX Maybe this globbing is incomplete, but who cares.</span></td></tr><tr><th id=\"L844\"><a href=\"#L844\">844</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Stupid people probably.</span></td></tr><tr><th id=\"L845\"><a href=\"#L845\">845</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0segments <span class=\"ow\">and</span>\u00a0<span class=\"p\">(</span></td></tr><tr><th id=\"L846\"><a href=\"#L846\">846</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">'*'</span>\u00a0<span class=\"ow\">in</span>\u00a0segments<span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\u00a0<span class=\"ow\">or</span>\u00a0<span class=\"s\">'?'</span>\u00a0<span class=\"ow\">in</span>\u00a0segments<span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\u00a0<span class=\"ow\">or</span></td></tr><tr><th id=\"L847\"><a href=\"#L847\">847</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">(</span><span class=\"s\">'['</span>\u00a0<span class=\"ow\">in</span>\u00a0segments<span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"s\">']'</span>\u00a0<span class=\"ow\">in</span>\u00a0segments<span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">])):</span></td></tr><tr><th id=\"L848\"><a href=\"#L848\">848</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>list<span class=\"p\">(</span>segments<span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">])</span></td></tr><tr><th id=\"L849\"><a href=\"#L849\">849</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallback<span class=\"p\">(</span>cbGlob<span class=\"p\">)</span></td></tr><tr><th id=\"L850\"><a href=\"#L850\">850</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L851\"><a href=\"#L851\">851</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>list<span class=\"p\">(</span>segments<span class=\"p\">)</span></td></tr><tr><th id=\"L852\"><a href=\"#L852\">852</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallback<span class=\"p\">(</span>cbList<span class=\"p\">)</span></td></tr><tr><th id=\"L853\"><a href=\"#L853\">853</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L854\"><a href=\"#L854\">854</a></th><td></td></tr><tr><th id=\"L855\"><a href=\"#L855\">855</a></th><td></td></tr><tr><th id=\"L856\"><a href=\"#L856\">856</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_CWD</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L857\"><a href=\"#L857\">857</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L858\"><a href=\"#L858\">858</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 segments <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L859\"><a href=\"#L859\">859</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">,</span>\u00a0e<span class=\"p\">:</span></td></tr><tr><th id=\"L860\"><a href=\"#L860\">860</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># XXX Eh, what to fail with here?</span></td></tr><tr><th id=\"L861\"><a href=\"#L861\">861</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L862\"><a href=\"#L862\">862</a></th><td></td></tr><tr><th id=\"L863\"><a href=\"#L863\">863</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">accessGranted</span><span class=\"p\">(</span>result<span class=\"p\">):</span></td></tr><tr><th id=\"L864\"><a href=\"#L864\">864</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory <span class=\"o\">=</span>\u00a0segments</td></tr><tr><th id=\"L865\"><a href=\"#L865\">865</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>REQ_FILE_ACTN_COMPLETED_OK<span class=\"p\">,)</span></td></tr><tr><th id=\"L866\"><a href=\"#L866\">866</a></th><td></td></tr><tr><th id=\"L867\"><a href=\"#L867\">867</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>access<span class=\"p\">(</span>segments<span class=\"p\">)</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span>accessGranted<span class=\"p\">)</span></td></tr><tr><th id=\"L868\"><a href=\"#L868\">868</a></th><td></td></tr><tr><th id=\"L869\"><a href=\"#L869\">869</a></th><td></td></tr><tr><th id=\"L870\"><a href=\"#L870\">870</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_CDUP</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L871\"><a href=\"#L871\">871</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>ftp_CWD<span class=\"p\">(</span><span class=\"s\">'..'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L872\"><a href=\"#L872\">872</a></th><td></td></tr><tr><th id=\"L873\"><a href=\"#L873\">873</a></th><td></td></tr><tr><th id=\"L874\"><a href=\"#L874\">874</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_PWD</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L875\"><a href=\"#L875\">875</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>PWD_REPLY<span class=\"p\">,</span>\u00a0<span class=\"s\">'/'</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"s\">'/'</span><span class=\"o\">.</span>join<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">))</span></td></tr><tr><th id=\"L876\"><a href=\"#L876\">876</a></th><td></td></tr><tr><th id=\"L877\"><a href=\"#L877\">877</a></th><td></td></tr><tr><th id=\"L878\"><a href=\"#L878\">878</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_RETR</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L879\"><a href=\"#L879\">879</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L880\"><a href=\"#L880\">880</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0BadCmdSequenceError<span class=\"p\">(</span><span class=\"s\">'PORT or PASV required before RETR'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L881\"><a href=\"#L881\">881</a></th><td></td></tr><tr><th id=\"L882\"><a href=\"#L882\">882</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L883\"><a href=\"#L883\">883</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 newsegs <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L884\"><a href=\"#L884\">884</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">:</span></td></tr><tr><th id=\"L885\"><a href=\"#L885\">885</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L886\"><a href=\"#L886\">886</a></th><td></td></tr><tr><th id=\"L887\"><a href=\"#L887\">887</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># XXX For now, just disable the timeout.\u00a0 Later we'll want to</span></td></tr><tr><th id=\"L888\"><a href=\"#L888\">888</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># leave it active and have the DTP connection reset it</span></td></tr><tr><th id=\"L889\"><a href=\"#L889\">889</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># periodically.</span></td></tr><tr><th id=\"L890\"><a href=\"#L890\">890</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>setTimeout<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L891\"><a href=\"#L891\">891</a></th><td></td></tr><tr><th id=\"L892\"><a href=\"#L892\">892</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Put it back later</span></td></tr><tr><th id=\"L893\"><a href=\"#L893\">893</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">enableTimeout</span><span class=\"p\">(</span>result<span class=\"p\">):</span></td></tr><tr><th id=\"L894\"><a href=\"#L894\">894</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>setTimeout<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>factory<span class=\"o\">.</span>timeOut<span class=\"p\">)</span></td></tr><tr><th id=\"L895\"><a href=\"#L895\">895</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0result</td></tr><tr><th id=\"L896\"><a href=\"#L896\">896</a></th><td></td></tr><tr><th id=\"L897\"><a href=\"#L897\">897</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># And away she goes</span></td></tr><tr><th id=\"L898\"><a href=\"#L898\">898</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>binary<span class=\"p\">:</span></td></tr><tr><th id=\"L899\"><a href=\"#L899\">899</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cons <span class=\"o\">=</span>\u00a0ASCIIConsumerWrapper<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"p\">)</span></td></tr><tr><th id=\"L900\"><a href=\"#L900\">900</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L901\"><a href=\"#L901\">901</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cons <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance</td></tr><tr><th id=\"L902\"><a href=\"#L902\">902</a></th><td></td></tr><tr><th id=\"L903\"><a href=\"#L903\">903</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbSent</span><span class=\"p\">(</span>result<span class=\"p\">):</span></td></tr><tr><th id=\"L904\"><a href=\"#L904\">904</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>TXFR_COMPLETE_OK<span class=\"p\">,)</span></td></tr><tr><th id=\"L905\"><a href=\"#L905\">905</a></th><td></td></tr><tr><th id=\"L906\"><a href=\"#L906\">906</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ebSent</span><span class=\"p\">(</span>err<span class=\"p\">):</span></td></tr><tr><th id=\"L907\"><a href=\"#L907\">907</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Unexpected error attempting to transmit file to client:\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L908\"><a href=\"#L908\">908</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>err<span class=\"p\">(</span>err<span class=\"p\">)</span></td></tr><tr><th id=\"L909\"><a href=\"#L909\">909</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>CNX_CLOSED_TXFR_ABORTED<span class=\"p\">,)</span></td></tr><tr><th id=\"L910\"><a href=\"#L910\">910</a></th><td></td></tr><tr><th id=\"L911\"><a href=\"#L911\">911</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbOpened</span><span class=\"p\">(</span><span class=\"nb\">file</span><span class=\"p\">):</span></td></tr><tr><th id=\"L912\"><a href=\"#L912\">912</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Tell them what to doooo</span></td></tr><tr><th id=\"L913\"><a href=\"#L913\">913</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>isConnected<span class=\"p\">:</span></td></tr><tr><th id=\"L914\"><a href=\"#L914\">914</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>DATA_CNX_ALREADY_OPEN_START_XFR<span class=\"p\">)</span></td></tr><tr><th id=\"L915\"><a href=\"#L915\">915</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L916\"><a href=\"#L916\">916</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>FILE_STATUS_OK_OPEN_DATA_CNX<span class=\"p\">)</span></td></tr><tr><th id=\"L917\"><a href=\"#L917\">917</a></th><td></td></tr><tr><th id=\"L918\"><a href=\"#L918\">918</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"nb\">file</span><span class=\"o\">.</span>send<span class=\"p\">(</span>cons<span class=\"p\">)</span></td></tr><tr><th id=\"L919\"><a href=\"#L919\">919</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallbacks<span class=\"p\">(</span>cbSent<span class=\"p\">,</span>\u00a0ebSent<span class=\"p\">)</span></td></tr><tr><th id=\"L920\"><a href=\"#L920\">920</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L921\"><a href=\"#L921\">921</a></th><td></td></tr><tr><th id=\"L922\"><a href=\"#L922\">922</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ebOpened</span><span class=\"p\">(</span>err<span class=\"p\">):</span></td></tr><tr><th id=\"L923\"><a href=\"#L923\">923</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0err<span class=\"o\">.</span>check<span class=\"p\">(</span>PermissionDeniedError<span class=\"p\">,</span>\u00a0FileNotFoundError<span class=\"p\">,</span>\u00a0IsNotADirectoryError<span class=\"p\">):</span></td></tr><tr><th id=\"L924\"><a href=\"#L924\">924</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Unexpected error attempting to open file for transmission:\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L925\"><a href=\"#L925\">925</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>err<span class=\"p\">(</span>err<span class=\"p\">)</span></td></tr><tr><th id=\"L926\"><a href=\"#L926\">926</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>FILE_NOT_FOUND<span class=\"p\">,</span>\u00a0<span class=\"s\">'/'</span><span class=\"o\">.</span>join<span class=\"p\">(</span>newsegs<span class=\"p\">))</span></td></tr><tr><th id=\"L927\"><a href=\"#L927\">927</a></th><td></td></tr><tr><th id=\"L928\"><a href=\"#L928\">928</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>openForReading<span class=\"p\">(</span>newsegs<span class=\"p\">)</span></td></tr><tr><th id=\"L929\"><a href=\"#L929\">929</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallbacks<span class=\"p\">(</span>cbOpened<span class=\"p\">,</span>\u00a0ebOpened<span class=\"p\">)</span></td></tr><tr><th id=\"L930\"><a href=\"#L930\">930</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addBoth<span class=\"p\">(</span>enableTimeout<span class=\"p\">)</span></td></tr><tr><th id=\"L931\"><a href=\"#L931\">931</a></th><td></td></tr><tr><th id=\"L932\"><a href=\"#L932\">932</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Pass back Deferred that fires when the transfer is done</span></td></tr><tr><th id=\"L933\"><a href=\"#L933\">933</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L934\"><a href=\"#L934\">934</a></th><td></td></tr><tr><th id=\"L935\"><a href=\"#L935\">935</a></th><td></td></tr><tr><th id=\"L936\"><a href=\"#L936\">936</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_STOR</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L937\"><a href=\"#L937\">937</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L938\"><a href=\"#L938\">938</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0BadCmdSequenceError<span class=\"p\">(</span><span class=\"s\">'PORT or PASV required before STOR'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L939\"><a href=\"#L939\">939</a></th><td></td></tr><tr><th id=\"L940\"><a href=\"#L940\">940</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L941\"><a href=\"#L941\">941</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 newsegs <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L942\"><a href=\"#L942\">942</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">:</span></td></tr><tr><th id=\"L943\"><a href=\"#L943\">943</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L944\"><a href=\"#L944\">944</a></th><td></td></tr><tr><th id=\"L945\"><a href=\"#L945\">945</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># XXX For now, just disable the timeout.\u00a0 Later we'll want to</span></td></tr><tr><th id=\"L946\"><a href=\"#L946\">946</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># leave it active and have the DTP connection reset it</span></td></tr><tr><th id=\"L947\"><a href=\"#L947\">947</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># periodically.</span></td></tr><tr><th id=\"L948\"><a href=\"#L948\">948</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>setTimeout<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L949\"><a href=\"#L949\">949</a></th><td></td></tr><tr><th id=\"L950\"><a href=\"#L950\">950</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Put it back later</span></td></tr><tr><th id=\"L951\"><a href=\"#L951\">951</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">enableTimeout</span><span class=\"p\">(</span>result<span class=\"p\">):</span></td></tr><tr><th id=\"L952\"><a href=\"#L952\">952</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>setTimeout<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>factory<span class=\"o\">.</span>timeOut<span class=\"p\">)</span></td></tr><tr><th id=\"L953\"><a href=\"#L953\">953</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0result</td></tr><tr><th id=\"L954\"><a href=\"#L954\">954</a></th><td></td></tr><tr><th id=\"L955\"><a href=\"#L955\">955</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbSent</span><span class=\"p\">(</span>result<span class=\"p\">):</span></td></tr><tr><th id=\"L956\"><a href=\"#L956\">956</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>TXFR_COMPLETE_OK<span class=\"p\">,)</span></td></tr><tr><th id=\"L957\"><a href=\"#L957\">957</a></th><td></td></tr><tr><th id=\"L958\"><a href=\"#L958\">958</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ebSent</span><span class=\"p\">(</span>err<span class=\"p\">):</span></td></tr><tr><th id=\"L959\"><a href=\"#L959\">959</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Unexpected error receiving file from client:\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L960\"><a href=\"#L960\">960</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>err<span class=\"p\">(</span>err<span class=\"p\">)</span></td></tr><tr><th id=\"L961\"><a href=\"#L961\">961</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>CNX_CLOSED_TXFR_ABORTED<span class=\"p\">,)</span></td></tr><tr><th id=\"L962\"><a href=\"#L962\">962</a></th><td></td></tr><tr><th id=\"L963\"><a href=\"#L963\">963</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbConsumer</span><span class=\"p\">(</span>cons<span class=\"p\">):</span></td></tr><tr><th id=\"L964\"><a href=\"#L964\">964</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>binary<span class=\"p\">:</span></td></tr><tr><th id=\"L965\"><a href=\"#L965\">965</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cons <span class=\"o\">=</span>\u00a0ASCIIConsumerWrapper<span class=\"p\">(</span>cons<span class=\"p\">)</span></td></tr><tr><th id=\"L966\"><a href=\"#L966\">966</a></th><td></td></tr><tr><th id=\"L967\"><a href=\"#L967\">967</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>registerConsumer<span class=\"p\">(</span>cons<span class=\"p\">)</span></td></tr><tr><th id=\"L968\"><a href=\"#L968\">968</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallbacks<span class=\"p\">(</span>cbSent<span class=\"p\">,</span>\u00a0ebSent<span class=\"p\">)</span></td></tr><tr><th id=\"L969\"><a href=\"#L969\">969</a></th><td></td></tr><tr><th id=\"L970\"><a href=\"#L970\">970</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Tell them what to doooo</span></td></tr><tr><th id=\"L971\"><a href=\"#L971\">971</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance<span class=\"o\">.</span>isConnected<span class=\"p\">:</span></td></tr><tr><th id=\"L972\"><a href=\"#L972\">972</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>DATA_CNX_ALREADY_OPEN_START_XFR<span class=\"p\">)</span></td></tr><tr><th id=\"L973\"><a href=\"#L973\">973</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L974\"><a href=\"#L974\">974</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>FILE_STATUS_OK_OPEN_DATA_CNX<span class=\"p\">)</span></td></tr><tr><th id=\"L975\"><a href=\"#L975\">975</a></th><td></td></tr><tr><th id=\"L976\"><a href=\"#L976\">976</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L977\"><a href=\"#L977\">977</a></th><td></td></tr><tr><th id=\"L978\"><a href=\"#L978\">978</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbOpened</span><span class=\"p\">(</span><span class=\"nb\">file</span><span class=\"p\">):</span></td></tr><tr><th id=\"L979\"><a href=\"#L979\">979</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"nb\">file</span><span class=\"o\">.</span>receive<span class=\"p\">()</span></td></tr><tr><th id=\"L980\"><a href=\"#L980\">980</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallback<span class=\"p\">(</span>cbConsumer<span class=\"p\">)</span></td></tr><tr><th id=\"L981\"><a href=\"#L981\">981</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L982\"><a href=\"#L982\">982</a></th><td></td></tr><tr><th id=\"L983\"><a href=\"#L983\">983</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ebOpened</span><span class=\"p\">(</span>err<span class=\"p\">):</span></td></tr><tr><th id=\"L984\"><a href=\"#L984\">984</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0err<span class=\"o\">.</span>check<span class=\"p\">(</span>PermissionDeniedError<span class=\"p\">,</span>\u00a0FileNotFoundError<span class=\"p\">,</span>\u00a0IsNotADirectoryError<span class=\"p\">):</span></td></tr><tr><th id=\"L985\"><a href=\"#L985\">985</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Unexpected error attempting to open file for upload:\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L986\"><a href=\"#L986\">986</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>err<span class=\"p\">(</span>err<span class=\"p\">)</span></td></tr><tr><th id=\"L987\"><a href=\"#L987\">987</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>FILE_NOT_FOUND<span class=\"p\">,</span>\u00a0<span class=\"s\">'/'</span><span class=\"o\">.</span>join<span class=\"p\">(</span>newsegs<span class=\"p\">))</span></td></tr><tr><th id=\"L988\"><a href=\"#L988\">988</a></th><td></td></tr><tr><th id=\"L989\"><a href=\"#L989\">989</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>openForWriting<span class=\"p\">(</span>newsegs<span class=\"p\">)</span></td></tr><tr><th id=\"L990\"><a href=\"#L990\">990</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addCallbacks<span class=\"p\">(</span>cbOpened<span class=\"p\">,</span>\u00a0ebOpened<span class=\"p\">)</span></td></tr><tr><th id=\"L991\"><a href=\"#L991\">991</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addBoth<span class=\"p\">(</span>enableTimeout<span class=\"p\">)</span></td></tr><tr><th id=\"L992\"><a href=\"#L992\">992</a></th><td></td></tr><tr><th id=\"L993\"><a href=\"#L993\">993</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Pass back Deferred that fires when the transfer is done</span></td></tr><tr><th id=\"L994\"><a href=\"#L994\">994</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L995\"><a href=\"#L995\">995</a></th><td></td></tr><tr><th id=\"L996\"><a href=\"#L996\">996</a></th><td></td></tr><tr><th id=\"L997\"><a href=\"#L997\">997</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_SIZE</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L998\"><a href=\"#L998\">998</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L999\"><a href=\"#L999\">999</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 newsegs <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L1000\"><a href=\"#L1000\">1000</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">:</span></td></tr><tr><th id=\"L1001\"><a href=\"#L1001\">1001</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L1002\"><a href=\"#L1002\">1002</a></th><td></td></tr><tr><th id=\"L1003\"><a href=\"#L1003\">1003</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbStat</span><span class=\"p\">((</span>size<span class=\"p\">,)):</span></td></tr><tr><th id=\"L1004\"><a href=\"#L1004\">1004</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>FILE_STATUS<span class=\"p\">,</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>size<span class=\"p\">))</span></td></tr><tr><th id=\"L1005\"><a href=\"#L1005\">1005</a></th><td></td></tr><tr><th id=\"L1006\"><a href=\"#L1006\">1006</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>stat<span class=\"p\">(</span>newsegs<span class=\"p\">,</span>\u00a0<span class=\"p\">(</span><span class=\"s\">'size'</span><span class=\"p\">,))</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span>cbStat<span class=\"p\">)</span></td></tr><tr><th id=\"L1007\"><a href=\"#L1007\">1007</a></th><td></td></tr><tr><th id=\"L1008\"><a href=\"#L1008\">1008</a></th><td></td></tr><tr><th id=\"L1009\"><a href=\"#L1009\">1009</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_MDTM</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1010\"><a href=\"#L1010\">1010</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1011\"><a href=\"#L1011\">1011</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 newsegs <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L1012\"><a href=\"#L1012\">1012</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">:</span></td></tr><tr><th id=\"L1013\"><a href=\"#L1013\">1013</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L1014\"><a href=\"#L1014\">1014</a></th><td></td></tr><tr><th id=\"L1015\"><a href=\"#L1015\">1015</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbStat</span><span class=\"p\">((</span>modified<span class=\"p\">,)):</span></td></tr><tr><th id=\"L1016\"><a href=\"#L1016\">1016</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>FILE_STATUS<span class=\"p\">,</span>\u00a0time<span class=\"o\">.</span>strftime<span class=\"p\">(</span><span class=\"s\">'%Y%m</span><span class=\"si\">%d</span><span class=\"s\">%H%M%S'</span><span class=\"p\">,</span>\u00a0time<span class=\"o\">.</span>gmtime<span class=\"p\">(</span>modified<span class=\"p\">)))</span></td></tr><tr><th id=\"L1017\"><a href=\"#L1017\">1017</a></th><td></td></tr><tr><th id=\"L1018\"><a href=\"#L1018\">1018</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>stat<span class=\"p\">(</span>newsegs<span class=\"p\">,</span>\u00a0<span class=\"p\">(</span><span class=\"s\">'modified'</span><span class=\"p\">,))</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span>cbStat<span class=\"p\">)</span></td></tr><tr><th id=\"L1019\"><a href=\"#L1019\">1019</a></th><td></td></tr><tr><th id=\"L1020\"><a href=\"#L1020\">1020</a></th><td></td></tr><tr><th id=\"L1021\"><a href=\"#L1021\">1021</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_TYPE</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"nb\">type</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1022\"><a href=\"#L1022\">1022</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0<span class=\"nb\">type</span><span class=\"o\">.</span>upper<span class=\"p\">()</span></td></tr><tr><th id=\"L1023\"><a href=\"#L1023\">1023</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0p<span class=\"p\">:</span></td></tr><tr><th id=\"L1024\"><a href=\"#L1024\">1024</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 f <span class=\"o\">=</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'type_'</span>\u00a0<span class=\"o\">+</span>\u00a0p<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1025\"><a href=\"#L1025\">1025</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0f <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1026\"><a href=\"#L1026\">1026</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0f<span class=\"p\">(</span>p<span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span></td></tr><tr><th id=\"L1027\"><a href=\"#L1027\">1027</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>type_UNKNOWN<span class=\"p\">(</span>p<span class=\"p\">)</span></td></tr><tr><th id=\"L1028\"><a href=\"#L1028\">1028</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>SYNTAX_ERR<span class=\"p\">,)</span></td></tr><tr><th id=\"L1029\"><a href=\"#L1029\">1029</a></th><td></td></tr><tr><th id=\"L1030\"><a href=\"#L1030\">1030</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">type_A</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0code<span class=\"p\">):</span></td></tr><tr><th id=\"L1031\"><a href=\"#L1031\">1031</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0code <span class=\"o\">==</span>\u00a0<span class=\"s\">''</span>\u00a0<span class=\"ow\">or</span>\u00a0code <span class=\"o\">==</span>\u00a0<span class=\"s\">'N'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1032\"><a href=\"#L1032\">1032</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>binary <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L1033\"><a href=\"#L1033\">1033</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>TYPE_SET_OK<span class=\"p\">,</span>\u00a0<span class=\"s\">'A'</span>\u00a0<span class=\"o\">+</span>\u00a0code<span class=\"p\">)</span></td></tr><tr><th id=\"L1034\"><a href=\"#L1034\">1034</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1035\"><a href=\"#L1035\">1035</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>CmdArgSyntaxError<span class=\"p\">(</span>code<span class=\"p\">))</span></td></tr><tr><th id=\"L1036\"><a href=\"#L1036\">1036</a></th><td></td></tr><tr><th id=\"L1037\"><a href=\"#L1037\">1037</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">type_I</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0code<span class=\"p\">):</span></td></tr><tr><th id=\"L1038\"><a href=\"#L1038\">1038</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0code <span class=\"o\">==</span>\u00a0<span class=\"s\">''</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1039\"><a href=\"#L1039\">1039</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>binary <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1040\"><a href=\"#L1040\">1040</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>TYPE_SET_OK<span class=\"p\">,</span>\u00a0<span class=\"s\">'I'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1041\"><a href=\"#L1041\">1041</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1042\"><a href=\"#L1042\">1042</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>CmdArgSyntaxError<span class=\"p\">(</span>code<span class=\"p\">))</span></td></tr><tr><th id=\"L1043\"><a href=\"#L1043\">1043</a></th><td></td></tr><tr><th id=\"L1044\"><a href=\"#L1044\">1044</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">type_UNKNOWN</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0code<span class=\"p\">):</span></td></tr><tr><th id=\"L1045\"><a href=\"#L1045\">1045</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>CmdNotImplementedForArgError<span class=\"p\">(</span>code<span class=\"p\">))</span></td></tr><tr><th id=\"L1046\"><a href=\"#L1046\">1046</a></th><td></td></tr><tr><th id=\"L1047\"><a href=\"#L1047\">1047</a></th><td></td></tr><tr><th id=\"L1048\"><a href=\"#L1048\">1048</a></th><td></td></tr><tr><th id=\"L1049\"><a href=\"#L1049\">1049</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_SYST</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1050\"><a href=\"#L1050\">1050</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0NAME_SYS_TYPE</td></tr><tr><th id=\"L1051\"><a href=\"#L1051\">1051</a></th><td></td></tr><tr><th id=\"L1052\"><a href=\"#L1052\">1052</a></th><td></td></tr><tr><th id=\"L1053\"><a href=\"#L1053\">1053</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_STRU</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0structure<span class=\"p\">):</span></td></tr><tr><th id=\"L1054\"><a href=\"#L1054\">1054</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0structure<span class=\"o\">.</span>upper<span class=\"p\">()</span></td></tr><tr><th id=\"L1055\"><a href=\"#L1055\">1055</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0p <span class=\"o\">==</span>\u00a0<span class=\"s\">'F'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1056\"><a href=\"#L1056\">1056</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>CMD_OK<span class=\"p\">,)</span></td></tr><tr><th id=\"L1057\"><a href=\"#L1057\">1057</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>CmdNotImplementedForArgError<span class=\"p\">(</span>structure<span class=\"p\">))</span></td></tr><tr><th id=\"L1058\"><a href=\"#L1058\">1058</a></th><td></td></tr><tr><th id=\"L1059\"><a href=\"#L1059\">1059</a></th><td></td></tr><tr><th id=\"L1060\"><a href=\"#L1060\">1060</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_MODE</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0mode<span class=\"p\">):</span></td></tr><tr><th id=\"L1061\"><a href=\"#L1061\">1061</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0mode<span class=\"o\">.</span>upper<span class=\"p\">()</span></td></tr><tr><th id=\"L1062\"><a href=\"#L1062\">1062</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0p <span class=\"o\">==</span>\u00a0<span class=\"s\">'S'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1063\"><a href=\"#L1063\">1063</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>CMD_OK<span class=\"p\">,)</span></td></tr><tr><th id=\"L1064\"><a href=\"#L1064\">1064</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>CmdNotImplementedForArgError<span class=\"p\">(</span>mode<span class=\"p\">))</span></td></tr><tr><th id=\"L1065\"><a href=\"#L1065\">1065</a></th><td></td></tr><tr><th id=\"L1066\"><a href=\"#L1066\">1066</a></th><td></td></tr><tr><th id=\"L1067\"><a href=\"#L1067\">1067</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_MKD</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1068\"><a href=\"#L1068\">1068</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1069\"><a href=\"#L1069\">1069</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 newsegs <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L1070\"><a href=\"#L1070\">1070</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">:</span></td></tr><tr><th id=\"L1071\"><a href=\"#L1071\">1071</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L1072\"><a href=\"#L1072\">1072</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>makeDirectory<span class=\"p\">(</span>newsegs<span class=\"p\">)</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0ign<span class=\"p\">:</span>\u00a0<span class=\"p\">(</span>MKD_REPLY<span class=\"p\">,</span>\u00a0path<span class=\"p\">))</span></td></tr><tr><th id=\"L1073\"><a href=\"#L1073\">1073</a></th><td></td></tr><tr><th id=\"L1074\"><a href=\"#L1074\">1074</a></th><td></td></tr><tr><th id=\"L1075\"><a href=\"#L1075\">1075</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_RMD</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1076\"><a href=\"#L1076\">1076</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1077\"><a href=\"#L1077\">1077</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 newsegs <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L1078\"><a href=\"#L1078\">1078</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">:</span></td></tr><tr><th id=\"L1079\"><a href=\"#L1079\">1079</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L1080\"><a href=\"#L1080\">1080</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>removeDirectory<span class=\"p\">(</span>newsegs<span class=\"p\">)</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0ign<span class=\"p\">:</span>\u00a0<span class=\"p\">(</span>REQ_FILE_ACTN_COMPLETED_OK<span class=\"p\">,))</span></td></tr><tr><th id=\"L1081\"><a href=\"#L1081\">1081</a></th><td></td></tr><tr><th id=\"L1082\"><a href=\"#L1082\">1082</a></th><td></td></tr><tr><th id=\"L1083\"><a href=\"#L1083\">1083</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_DELE</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1084\"><a href=\"#L1084\">1084</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1085\"><a href=\"#L1085\">1085</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 newsegs <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L1086\"><a href=\"#L1086\">1086</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">:</span></td></tr><tr><th id=\"L1087\"><a href=\"#L1087\">1087</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L1088\"><a href=\"#L1088\">1088</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>removeFile<span class=\"p\">(</span>newsegs<span class=\"p\">)</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0ign<span class=\"p\">:</span>\u00a0<span class=\"p\">(</span>REQ_FILE_ACTN_COMPLETED_OK<span class=\"p\">,))</span></td></tr><tr><th id=\"L1089\"><a href=\"#L1089\">1089</a></th><td></td></tr><tr><th id=\"L1090\"><a href=\"#L1090\">1090</a></th><td></td></tr><tr><th id=\"L1091\"><a href=\"#L1091\">1091</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_NOOP</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1092\"><a href=\"#L1092\">1092</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>CMD_OK<span class=\"p\">,)</span></td></tr><tr><th id=\"L1093\"><a href=\"#L1093\">1093</a></th><td></td></tr><tr><th id=\"L1094\"><a href=\"#L1094\">1094</a></th><td></td></tr><tr><th id=\"L1095\"><a href=\"#L1095\">1095</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_RNFR</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0fromName<span class=\"p\">):</span></td></tr><tr><th id=\"L1096\"><a href=\"#L1096\">1096</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_fromName <span class=\"o\">=</span>\u00a0fromName</td></tr><tr><th id=\"L1097\"><a href=\"#L1097\">1097</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>RENAMING</td></tr><tr><th id=\"L1098\"><a href=\"#L1098\">1098</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>REQ_FILE_ACTN_PENDING_FURTHER_INFO<span class=\"p\">,)</span></td></tr><tr><th id=\"L1099\"><a href=\"#L1099\">1099</a></th><td></td></tr><tr><th id=\"L1100\"><a href=\"#L1100\">1100</a></th><td></td></tr><tr><th id=\"L1101\"><a href=\"#L1101\">1101</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_RNTO</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0toName<span class=\"p\">):</span></td></tr><tr><th id=\"L1102\"><a href=\"#L1102\">1102</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 fromName <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_fromName</td></tr><tr><th id=\"L1103\"><a href=\"#L1103\">1103</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">del</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_fromName</td></tr><tr><th id=\"L1104\"><a href=\"#L1104\">1104</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>state <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>AUTHED</td></tr><tr><th id=\"L1105\"><a href=\"#L1105\">1105</a></th><td></td></tr><tr><th id=\"L1106\"><a href=\"#L1106\">1106</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1107\"><a href=\"#L1107\">1107</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fromsegs <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0fromName<span class=\"p\">)</span></td></tr><tr><th id=\"L1108\"><a href=\"#L1108\">1108</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 tosegs <span class=\"o\">=</span>\u00a0toSegments<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>workingDirectory<span class=\"p\">,</span>\u00a0toName<span class=\"p\">)</span></td></tr><tr><th id=\"L1109\"><a href=\"#L1109\">1109</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0InvalidPath<span class=\"p\">:</span></td></tr><tr><th id=\"L1110\"><a href=\"#L1110\">1110</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>FileNotFoundError<span class=\"p\">(</span>fromName<span class=\"p\">))</span></td></tr><tr><th id=\"L1111\"><a href=\"#L1111\">1111</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>shell<span class=\"o\">.</span>rename<span class=\"p\">(</span>fromsegs<span class=\"p\">,</span>\u00a0tosegs<span class=\"p\">)</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0ign<span class=\"p\">:</span>\u00a0<span class=\"p\">(</span>REQ_FILE_ACTN_COMPLETED_OK<span class=\"p\">,))</span></td></tr><tr><th id=\"L1112\"><a href=\"#L1112\">1112</a></th><td></td></tr><tr><th id=\"L1113\"><a href=\"#L1113\">1113</a></th><td></td></tr><tr><th id=\"L1114\"><a href=\"#L1114\">1114</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">ftp_QUIT</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1115\"><a href=\"#L1115\">1115</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>reply<span class=\"p\">(</span>GOODBYE_MSG<span class=\"p\">)</span></td></tr><tr><th id=\"L1116\"><a href=\"#L1116\">1116</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L1117\"><a href=\"#L1117\">1117</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>disconnected <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1118\"><a href=\"#L1118\">1118</a></th><td></td></tr><tr><th id=\"L1119\"><a href=\"#L1119\">1119</a></th><td></td></tr><tr><th id=\"L1120\"><a href=\"#L1120\">1120</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cleanupDTP</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1121\"><a href=\"#L1121\">1121</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"call when DTP connection exits</span></td></tr><tr><th id=\"L1122\"><a href=\"#L1122\">1122</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1123\"><a href=\"#L1123\">1123</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'cleanupDTP'</span><span class=\"p\">,</span>\u00a0debug<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1124\"><a href=\"#L1124\">1124</a></th><td></td></tr><tr><th id=\"L1125\"><a href=\"#L1125\">1125</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>dtpPort<span class=\"p\">)</span></td></tr><tr><th id=\"L1126\"><a href=\"#L1126\">1126</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 dtpPort<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpPort <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpPort<span class=\"p\">,</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L1127\"><a href=\"#L1127\">1127</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0interfaces<span class=\"o\">.</span>IListeningPort<span class=\"o\">.</span>providedBy<span class=\"p\">(</span>dtpPort<span class=\"p\">):</span></td></tr><tr><th id=\"L1128\"><a href=\"#L1128\">1128</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 dtpPort<span class=\"o\">.</span>stopListening<span class=\"p\">()</span></td></tr><tr><th id=\"L1129\"><a href=\"#L1129\">1129</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0interfaces<span class=\"o\">.</span>IConnector<span class=\"o\">.</span>providedBy<span class=\"p\">(</span>dtpPort<span class=\"p\">):</span></td></tr><tr><th id=\"L1130\"><a href=\"#L1130\">1130</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 dtpPort<span class=\"o\">.</span>disconnect<span class=\"p\">()</span></td></tr><tr><th id=\"L1131\"><a href=\"#L1131\">1131</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1132\"><a href=\"#L1132\">1132</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">assert</span>\u00a0<span class=\"bp\">False</span><span class=\"p\">,</span>\u00a0<span class=\"s\">\"dtpPort should be an IListeningPort or IConnector, instead is </span><span class=\"si\">%r</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>dtpPort<span class=\"p\">,)</span></td></tr><tr><th id=\"L1133\"><a href=\"#L1133\">1133</a></th><td></td></tr><tr><th id=\"L1134\"><a href=\"#L1134\">1134</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory<span class=\"o\">.</span>stopFactory<span class=\"p\">()</span></td></tr><tr><th id=\"L1135\"><a href=\"#L1135\">1135</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpFactory <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L1136\"><a href=\"#L1136\">1136</a></th><td></td></tr><tr><th id=\"L1137\"><a href=\"#L1137\">1137</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1138\"><a href=\"#L1138\">1138</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>dtpInstance <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L1139\"><a href=\"#L1139\">1139</a></th><td></td></tr><tr><th id=\"L1140\"><a href=\"#L1140\">1140</a></th><td></td></tr><tr><th id=\"L1141\"><a href=\"#L1141\">1141</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPFactory</span><span class=\"p\">(</span>policies<span class=\"o\">.</span>LimitTotalConnectionsFactory<span class=\"p\">):</span></td></tr><tr><th id=\"L1142\"><a href=\"#L1142\">1142</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"A factory for producing ftp protocol instances</span></td></tr><tr><th id=\"L1143\"><a href=\"#L1143\">1143</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1144\"><a href=\"#L1144\">1144</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar timeOut: the protocol interpreter's idle timeout time in seconds,</span></td></tr><tr><th id=\"L1145\"><a href=\"#L1145\">1145</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 default is 600 seconds.</span></td></tr><tr><th id=\"L1146\"><a href=\"#L1146\">1146</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1147\"><a href=\"#L1147\">1147</a></th><td>\u00a0 \u00a0 protocol <span class=\"o\">=</span>\u00a0FTP</td></tr><tr><th id=\"L1148\"><a href=\"#L1148\">1148</a></th><td>\u00a0 \u00a0 overflowProtocol <span class=\"o\">=</span>\u00a0FTPOverflowProtocol</td></tr><tr><th id=\"L1149\"><a href=\"#L1149\">1149</a></th><td>\u00a0 \u00a0 allowAnonymous <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1150\"><a href=\"#L1150\">1150</a></th><td>\u00a0 \u00a0 userAnonymous <span class=\"o\">=</span>\u00a0<span class=\"s\">'anonymous'</span></td></tr><tr><th id=\"L1151\"><a href=\"#L1151\">1151</a></th><td>\u00a0 \u00a0 timeOut <span class=\"o\">=</span>\u00a0<span class=\"mi\">600</span></td></tr><tr><th id=\"L1152\"><a href=\"#L1152\">1152</a></th><td></td></tr><tr><th id=\"L1153\"><a href=\"#L1153\">1153</a></th><td>\u00a0 \u00a0 welcomeMessage <span class=\"o\">=</span>\u00a0<span class=\"s\">\"Twisted </span><span class=\"si\">%s</span><span class=\"s\">\u00a0FTP Server\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>copyright<span class=\"o\">.</span>version<span class=\"p\">,)</span></td></tr><tr><th id=\"L1154\"><a href=\"#L1154\">1154</a></th><td></td></tr><tr><th id=\"L1155\"><a href=\"#L1155\">1155</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0portal<span class=\"o\">=</span><span class=\"bp\">None</span><span class=\"p\">,</span>\u00a0userAnonymous<span class=\"o\">=</span><span class=\"s\">'anonymous'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1156\"><a href=\"#L1156\">1156</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>portal <span class=\"o\">=</span>\u00a0portal</td></tr><tr><th id=\"L1157\"><a href=\"#L1157\">1157</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>userAnonymous <span class=\"o\">=</span>\u00a0<span class=\"s\">'anonymous'</span></td></tr><tr><th id=\"L1158\"><a href=\"#L1158\">1158</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>instances <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L1159\"><a href=\"#L1159\">1159</a></th><td></td></tr><tr><th id=\"L1160\"><a href=\"#L1160\">1160</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">buildProtocol</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0addr<span class=\"p\">):</span></td></tr><tr><th id=\"L1161\"><a href=\"#L1161\">1161</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0policies<span class=\"o\">.</span>LimitTotalConnectionsFactory<span class=\"o\">.</span>buildProtocol<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0addr<span class=\"p\">)</span></td></tr><tr><th id=\"L1162\"><a href=\"#L1162\">1162</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0p <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1163\"><a href=\"#L1163\">1163</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 p<span class=\"o\">.</span>wrappedProtocol<span class=\"o\">.</span>portal <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>portal</td></tr><tr><th id=\"L1164\"><a href=\"#L1164\">1164</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 p<span class=\"o\">.</span>wrappedProtocol<span class=\"o\">.</span>timeOut <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>timeOut</td></tr><tr><th id=\"L1165\"><a href=\"#L1165\">1165</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0p</td></tr><tr><th id=\"L1166\"><a href=\"#L1166\">1166</a></th><td></td></tr><tr><th id=\"L1167\"><a href=\"#L1167\">1167</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">stopFactory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1168\"><a href=\"#L1168\">1168</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># make sure ftp instance's timeouts are set to None</span></td></tr><tr><th id=\"L1169\"><a href=\"#L1169\">1169</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># to avoid reactor complaints</span></td></tr><tr><th id=\"L1170\"><a href=\"#L1170\">1170</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">[</span>p<span class=\"o\">.</span>setTimeout<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span>\u00a0<span class=\"k\">for</span>\u00a0p <span class=\"ow\">in</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>instances <span class=\"k\">if</span>\u00a0p<span class=\"o\">.</span>timeOut <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">]</span></td></tr><tr><th id=\"L1171\"><a href=\"#L1171\">1171</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 policies<span class=\"o\">.</span>LimitTotalConnectionsFactory<span class=\"o\">.</span>stopFactory<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1172\"><a href=\"#L1172\">1172</a></th><td></td></tr><tr><th id=\"L1173\"><a href=\"#L1173\">1173</a></th><td><span class=\"c\"># -- Cred Objects --</span></td></tr><tr><th id=\"L1174\"><a href=\"#L1174\">1174</a></th><td></td></tr><tr><th id=\"L1175\"><a href=\"#L1175\">1175</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">IFTPShell</span><span class=\"p\">(</span>Interface<span class=\"p\">):</span></td></tr><tr><th id=\"L1176\"><a href=\"#L1176\">1176</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1177\"><a href=\"#L1177\">1177</a></th><td><span class=\"sd\">\u00a0 \u00a0 An abstraction of the shell commands used by the FTP protocol for</span></td></tr><tr><th id=\"L1178\"><a href=\"#L1178\">1178</a></th><td><span class=\"sd\">\u00a0 \u00a0 a given user account.</span></td></tr><tr><th id=\"L1179\"><a href=\"#L1179\">1179</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1180\"><a href=\"#L1180\">1180</a></th><td><span class=\"sd\">\u00a0 \u00a0 All path names must be absolute.</span></td></tr><tr><th id=\"L1181\"><a href=\"#L1181\">1181</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1182\"><a href=\"#L1182\">1182</a></th><td></td></tr><tr><th id=\"L1183\"><a href=\"#L1183\">1183</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">makeDirectory</span><span class=\"p\">(</span>path<span class=\"p\">):</span></td></tr><tr><th id=\"L1184\"><a href=\"#L1184\">1184</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1185\"><a href=\"#L1185\">1185</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Create a directory.</span></td></tr><tr><th id=\"L1186\"><a href=\"#L1186\">1186</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1187\"><a href=\"#L1187\">1187</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: The path, as a list of segments, to create</span></td></tr><tr><th id=\"L1188\"><a href=\"#L1188\">1188</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type path: C{list} of C{unicode}</span></td></tr><tr><th id=\"L1189\"><a href=\"#L1189\">1189</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1190\"><a href=\"#L1190\">1190</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: A Deferred which fires when the directory has been</span></td></tr><tr><th id=\"L1191\"><a href=\"#L1191\">1191</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 created, or which fails if the directory cannot be created.</span></td></tr><tr><th id=\"L1192\"><a href=\"#L1192\">1192</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1193\"><a href=\"#L1193\">1193</a></th><td></td></tr><tr><th id=\"L1194\"><a href=\"#L1194\">1194</a></th><td></td></tr><tr><th id=\"L1195\"><a href=\"#L1195\">1195</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">removeDirectory</span><span class=\"p\">(</span>path<span class=\"p\">):</span></td></tr><tr><th id=\"L1196\"><a href=\"#L1196\">1196</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1197\"><a href=\"#L1197\">1197</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Remove a directory.</span></td></tr><tr><th id=\"L1198\"><a href=\"#L1198\">1198</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1199\"><a href=\"#L1199\">1199</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: The path, as a list of segments, to remove</span></td></tr><tr><th id=\"L1200\"><a href=\"#L1200\">1200</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type path: C{list} of C{unicode}</span></td></tr><tr><th id=\"L1201\"><a href=\"#L1201\">1201</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1202\"><a href=\"#L1202\">1202</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: A Deferred which fires when the directory has been</span></td></tr><tr><th id=\"L1203\"><a href=\"#L1203\">1203</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 removed, or which fails if the directory cannot be removed.</span></td></tr><tr><th id=\"L1204\"><a href=\"#L1204\">1204</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1205\"><a href=\"#L1205\">1205</a></th><td></td></tr><tr><th id=\"L1206\"><a href=\"#L1206\">1206</a></th><td></td></tr><tr><th id=\"L1207\"><a href=\"#L1207\">1207</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">removeFile</span><span class=\"p\">(</span>path<span class=\"p\">):</span></td></tr><tr><th id=\"L1208\"><a href=\"#L1208\">1208</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1209\"><a href=\"#L1209\">1209</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Remove a file.</span></td></tr><tr><th id=\"L1210\"><a href=\"#L1210\">1210</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1211\"><a href=\"#L1211\">1211</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: The path, as a list of segments, to remove</span></td></tr><tr><th id=\"L1212\"><a href=\"#L1212\">1212</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type path: C{list} of C{unicode}</span></td></tr><tr><th id=\"L1213\"><a href=\"#L1213\">1213</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1214\"><a href=\"#L1214\">1214</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: A Deferred which fires when the file has been</span></td></tr><tr><th id=\"L1215\"><a href=\"#L1215\">1215</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 removed, or which fails if the file cannot be removed.</span></td></tr><tr><th id=\"L1216\"><a href=\"#L1216\">1216</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1217\"><a href=\"#L1217\">1217</a></th><td></td></tr><tr><th id=\"L1218\"><a href=\"#L1218\">1218</a></th><td></td></tr><tr><th id=\"L1219\"><a href=\"#L1219\">1219</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">rename</span><span class=\"p\">(</span>fromPath<span class=\"p\">,</span>\u00a0toPath<span class=\"p\">):</span></td></tr><tr><th id=\"L1220\"><a href=\"#L1220\">1220</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1221\"><a href=\"#L1221\">1221</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Rename a file or directory.</span></td></tr><tr><th id=\"L1222\"><a href=\"#L1222\">1222</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1223\"><a href=\"#L1223\">1223</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param fromPath: The current name of the path.</span></td></tr><tr><th id=\"L1224\"><a href=\"#L1224\">1224</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type fromPath: C{list} of C{unicode}</span></td></tr><tr><th id=\"L1225\"><a href=\"#L1225\">1225</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1226\"><a href=\"#L1226\">1226</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param toPath: The desired new name of the path.</span></td></tr><tr><th id=\"L1227\"><a href=\"#L1227\">1227</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type toPath: C{list} of C{unicode}</span></td></tr><tr><th id=\"L1228\"><a href=\"#L1228\">1228</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1229\"><a href=\"#L1229\">1229</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: A Deferred which fires when the path has been</span></td></tr><tr><th id=\"L1230\"><a href=\"#L1230\">1230</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 renamed, or which fails if the path cannot be renamed.</span></td></tr><tr><th id=\"L1231\"><a href=\"#L1231\">1231</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1232\"><a href=\"#L1232\">1232</a></th><td></td></tr><tr><th id=\"L1233\"><a href=\"#L1233\">1233</a></th><td></td></tr><tr><th id=\"L1234\"><a href=\"#L1234\">1234</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">access</span><span class=\"p\">(</span>path<span class=\"p\">):</span></td></tr><tr><th id=\"L1235\"><a href=\"#L1235\">1235</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1236\"><a href=\"#L1236\">1236</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Determine whether access to the given path is allowed.</span></td></tr><tr><th id=\"L1237\"><a href=\"#L1237\">1237</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1238\"><a href=\"#L1238\">1238</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: The path, as a list of segments</span></td></tr><tr><th id=\"L1239\"><a href=\"#L1239\">1239</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1240\"><a href=\"#L1240\">1240</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: A Deferred which fires with None if access is allowed</span></td></tr><tr><th id=\"L1241\"><a href=\"#L1241\">1241</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 or which fails with a specific exception type if access is</span></td></tr><tr><th id=\"L1242\"><a href=\"#L1242\">1242</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 denied.</span></td></tr><tr><th id=\"L1243\"><a href=\"#L1243\">1243</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1244\"><a href=\"#L1244\">1244</a></th><td></td></tr><tr><th id=\"L1245\"><a href=\"#L1245\">1245</a></th><td></td></tr><tr><th id=\"L1246\"><a href=\"#L1246\">1246</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">stat</span><span class=\"p\">(</span>path<span class=\"p\">,</span>\u00a0keys<span class=\"o\">=</span><span class=\"p\">()):</span></td></tr><tr><th id=\"L1247\"><a href=\"#L1247\">1247</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1248\"><a href=\"#L1248\">1248</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Retrieve information about the given path.</span></td></tr><tr><th id=\"L1249\"><a href=\"#L1249\">1249</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1250\"><a href=\"#L1250\">1250</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 This is like list, except it will never return results about</span></td></tr><tr><th id=\"L1251\"><a href=\"#L1251\">1251</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 child paths.</span></td></tr><tr><th id=\"L1252\"><a href=\"#L1252\">1252</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1253\"><a href=\"#L1253\">1253</a></th><td></td></tr><tr><th id=\"L1254\"><a href=\"#L1254\">1254</a></th><td></td></tr><tr><th id=\"L1255\"><a href=\"#L1255\">1255</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">list</span><span class=\"p\">(</span>path<span class=\"p\">,</span>\u00a0keys<span class=\"o\">=</span><span class=\"p\">()):</span></td></tr><tr><th id=\"L1256\"><a href=\"#L1256\">1256</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1257\"><a href=\"#L1257\">1257</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Retrieve information about the given path.</span></td></tr><tr><th id=\"L1258\"><a href=\"#L1258\">1258</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1259\"><a href=\"#L1259\">1259</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 If the path represents a non-directory, the result list should</span></td></tr><tr><th id=\"L1260\"><a href=\"#L1260\">1260</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 have only one entry with information about that non-directory.</span></td></tr><tr><th id=\"L1261\"><a href=\"#L1261\">1261</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Otherwise, the result list should have an element for each</span></td></tr><tr><th id=\"L1262\"><a href=\"#L1262\">1262</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 child of the directory.</span></td></tr><tr><th id=\"L1263\"><a href=\"#L1263\">1263</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1264\"><a href=\"#L1264\">1264</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: The path, as a list of segments, to list</span></td></tr><tr><th id=\"L1265\"><a href=\"#L1265\">1265</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type path: C{list} of C{unicode}</span></td></tr><tr><th id=\"L1266\"><a href=\"#L1266\">1266</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1267\"><a href=\"#L1267\">1267</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param keys: A tuple of keys desired in the resulting</span></td></tr><tr><th id=\"L1268\"><a href=\"#L1268\">1268</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 dictionaries.</span></td></tr><tr><th id=\"L1269\"><a href=\"#L1269\">1269</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1270\"><a href=\"#L1270\">1270</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: A Deferred which fires with a list of (name, list),</span></td></tr><tr><th id=\"L1271\"><a href=\"#L1271\">1271</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 where the name is the name of the entry as a unicode string</span></td></tr><tr><th id=\"L1272\"><a href=\"#L1272\">1272</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 and each list contains values corresponding to the requested</span></td></tr><tr><th id=\"L1273\"><a href=\"#L1273\">1273</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 keys.\u00a0 The following are possible elements of keys, and the</span></td></tr><tr><th id=\"L1274\"><a href=\"#L1274\">1274</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 values which should be returned for them:</span></td></tr><tr><th id=\"L1275\"><a href=\"#L1275\">1275</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1276\"><a href=\"#L1276\">1276</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - C{'size'}: size in bytes, as an integer (this is kinda required)</span></td></tr><tr><th id=\"L1277\"><a href=\"#L1277\">1277</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1278\"><a href=\"#L1278\">1278</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - C{'directory'}: boolean indicating the type of this entry</span></td></tr><tr><th id=\"L1279\"><a href=\"#L1279\">1279</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1280\"><a href=\"#L1280\">1280</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - C{'permissions'}: a bitvector (see os.stat(foo).st_mode)</span></td></tr><tr><th id=\"L1281\"><a href=\"#L1281\">1281</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1282\"><a href=\"#L1282\">1282</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - C{'hardlinks'}: Number of hard links to this entry</span></td></tr><tr><th id=\"L1283\"><a href=\"#L1283\">1283</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1284\"><a href=\"#L1284\">1284</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - C{'modified'}: number of seconds since the epoch since entry was</span></td></tr><tr><th id=\"L1285\"><a href=\"#L1285\">1285</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 modified</span></td></tr><tr><th id=\"L1286\"><a href=\"#L1286\">1286</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1287\"><a href=\"#L1287\">1287</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - C{'owner'}: string indicating the user owner of this entry</span></td></tr><tr><th id=\"L1288\"><a href=\"#L1288\">1288</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1289\"><a href=\"#L1289\">1289</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - C{'group'}: string indicating the group owner of this entry</span></td></tr><tr><th id=\"L1290\"><a href=\"#L1290\">1290</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1291\"><a href=\"#L1291\">1291</a></th><td></td></tr><tr><th id=\"L1292\"><a href=\"#L1292\">1292</a></th><td></td></tr><tr><th id=\"L1293\"><a href=\"#L1293\">1293</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">openForReading</span><span class=\"p\">(</span>path<span class=\"p\">):</span></td></tr><tr><th id=\"L1294\"><a href=\"#L1294\">1294</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1295\"><a href=\"#L1295\">1295</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: The path, as a list of segments, to open</span></td></tr><tr><th id=\"L1296\"><a href=\"#L1296\">1296</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type path: C{list} of C{unicode}</span></td></tr><tr><th id=\"L1297\"><a href=\"#L1297\">1297</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1298\"><a href=\"#L1298\">1298</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @rtype: C{Deferred} which will fire with L{IReadFile}</span></td></tr><tr><th id=\"L1299\"><a href=\"#L1299\">1299</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1300\"><a href=\"#L1300\">1300</a></th><td></td></tr><tr><th id=\"L1301\"><a href=\"#L1301\">1301</a></th><td></td></tr><tr><th id=\"L1302\"><a href=\"#L1302\">1302</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">openForWriting</span><span class=\"p\">(</span>path<span class=\"p\">):</span></td></tr><tr><th id=\"L1303\"><a href=\"#L1303\">1303</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1304\"><a href=\"#L1304\">1304</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: The path, as a list of segments, to open</span></td></tr><tr><th id=\"L1305\"><a href=\"#L1305\">1305</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type path: C{list} of C{unicode}</span></td></tr><tr><th id=\"L1306\"><a href=\"#L1306\">1306</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1307\"><a href=\"#L1307\">1307</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @rtype: C{Deferred} which will fire with L{IWriteFile}</span></td></tr><tr><th id=\"L1308\"><a href=\"#L1308\">1308</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1309\"><a href=\"#L1309\">1309</a></th><td></td></tr><tr><th id=\"L1310\"><a href=\"#L1310\">1310</a></th><td></td></tr><tr><th id=\"L1311\"><a href=\"#L1311\">1311</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">IReadFile</span><span class=\"p\">(</span>Interface<span class=\"p\">):</span></td></tr><tr><th id=\"L1312\"><a href=\"#L1312\">1312</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"A file out of which bytes may be read.</span></td></tr><tr><th id=\"L1313\"><a href=\"#L1313\">1313</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1314\"><a href=\"#L1314\">1314</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">send</span><span class=\"p\">(</span>consumer<span class=\"p\">):</span></td></tr><tr><th id=\"L1315\"><a href=\"#L1315\">1315</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1316\"><a href=\"#L1316\">1316</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Produce the contents of the given path to the given consumer.\u00a0 This</span></td></tr><tr><th id=\"L1317\"><a href=\"#L1317\">1317</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 method may only be invoked once on each provider.</span></td></tr><tr><th id=\"L1318\"><a href=\"#L1318\">1318</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1319\"><a href=\"#L1319\">1319</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type consumer: C{IConsumer}</span></td></tr><tr><th id=\"L1320\"><a href=\"#L1320\">1320</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1321\"><a href=\"#L1321\">1321</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: A Deferred which fires when the file has been</span></td></tr><tr><th id=\"L1322\"><a href=\"#L1322\">1322</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 consumed completely.</span></td></tr><tr><th id=\"L1323\"><a href=\"#L1323\">1323</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1324\"><a href=\"#L1324\">1324</a></th><td></td></tr><tr><th id=\"L1325\"><a href=\"#L1325\">1325</a></th><td></td></tr><tr><th id=\"L1326\"><a href=\"#L1326\">1326</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">IWriteFile</span><span class=\"p\">(</span>Interface<span class=\"p\">):</span></td></tr><tr><th id=\"L1327\"><a href=\"#L1327\">1327</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"A file into which bytes may be written.</span></td></tr><tr><th id=\"L1328\"><a href=\"#L1328\">1328</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1329\"><a href=\"#L1329\">1329</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">receive</span><span class=\"p\">():</span></td></tr><tr><th id=\"L1330\"><a href=\"#L1330\">1330</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1331\"><a href=\"#L1331\">1331</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Create a consumer which will write to this file.\u00a0 This method may</span></td></tr><tr><th id=\"L1332\"><a href=\"#L1332\">1332</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 only be invoked once on each provider.</span></td></tr><tr><th id=\"L1333\"><a href=\"#L1333\">1333</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1334\"><a href=\"#L1334\">1334</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @rtype: C{Deferred} of C{IConsumer}</span></td></tr><tr><th id=\"L1335\"><a href=\"#L1335\">1335</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1336\"><a href=\"#L1336\">1336</a></th><td></td></tr><tr><th id=\"L1337\"><a href=\"#L1337\">1337</a></th><td></td></tr><tr><th id=\"L1338\"><a href=\"#L1338\">1338</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">_getgroups</span><span class=\"p\">(</span>uid<span class=\"p\">):</span></td></tr><tr><th id=\"L1339\"><a href=\"#L1339\">1339</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Return the primary and supplementary groups for the given UID.</span></td></tr><tr><th id=\"L1340\"><a href=\"#L1340\">1340</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1341\"><a href=\"#L1341\">1341</a></th><td><span class=\"sd\">\u00a0 \u00a0 @type uid: C{int}</span></td></tr><tr><th id=\"L1342\"><a href=\"#L1342\">1342</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1343\"><a href=\"#L1343\">1343</a></th><td>\u00a0 \u00a0 result <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L1344\"><a href=\"#L1344\">1344</a></th><td>\u00a0 \u00a0 pwent <span class=\"o\">=</span>\u00a0pwd<span class=\"o\">.</span>getpwuid<span class=\"p\">(</span>uid<span class=\"p\">)</span></td></tr><tr><th id=\"L1345\"><a href=\"#L1345\">1345</a></th><td></td></tr><tr><th id=\"L1346\"><a href=\"#L1346\">1346</a></th><td>\u00a0 \u00a0 result<span class=\"o\">.</span>append<span class=\"p\">(</span>pwent<span class=\"o\">.</span>pw_gid<span class=\"p\">)</span></td></tr><tr><th id=\"L1347\"><a href=\"#L1347\">1347</a></th><td></td></tr><tr><th id=\"L1348\"><a href=\"#L1348\">1348</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0grent <span class=\"ow\">in</span>\u00a0grp<span class=\"o\">.</span>getgrall<span class=\"p\">():</span></td></tr><tr><th id=\"L1349\"><a href=\"#L1349\">1349</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0pwent<span class=\"o\">.</span>pw_name <span class=\"ow\">in</span>\u00a0grent<span class=\"o\">.</span>gr_mem<span class=\"p\">:</span></td></tr><tr><th id=\"L1350\"><a href=\"#L1350\">1350</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result<span class=\"o\">.</span>append<span class=\"p\">(</span>grent<span class=\"o\">.</span>gr_gid<span class=\"p\">)</span></td></tr><tr><th id=\"L1351\"><a href=\"#L1351\">1351</a></th><td></td></tr><tr><th id=\"L1352\"><a href=\"#L1352\">1352</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0result</td></tr><tr><th id=\"L1353\"><a href=\"#L1353\">1353</a></th><td></td></tr><tr><th id=\"L1354\"><a href=\"#L1354\">1354</a></th><td></td></tr><tr><th id=\"L1355\"><a href=\"#L1355\">1355</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">_testPermissions</span><span class=\"p\">(</span>uid<span class=\"p\">,</span>\u00a0gid<span class=\"p\">,</span>\u00a0spath<span class=\"p\">,</span>\u00a0mode<span class=\"o\">=</span><span class=\"s\">'r'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1356\"><a href=\"#L1356\">1356</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1357\"><a href=\"#L1357\">1357</a></th><td><span class=\"sd\">\u00a0 \u00a0 checks to see if uid has proper permissions to access path with mode</span></td></tr><tr><th id=\"L1358\"><a href=\"#L1358\">1358</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1359\"><a href=\"#L1359\">1359</a></th><td><span class=\"sd\">\u00a0 \u00a0 @type uid: C{int}</span></td></tr><tr><th id=\"L1360\"><a href=\"#L1360\">1360</a></th><td><span class=\"sd\">\u00a0 \u00a0 @param uid: numeric user id</span></td></tr><tr><th id=\"L1361\"><a href=\"#L1361\">1361</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1362\"><a href=\"#L1362\">1362</a></th><td><span class=\"sd\">\u00a0 \u00a0 @type gid: C{int}</span></td></tr><tr><th id=\"L1363\"><a href=\"#L1363\">1363</a></th><td><span class=\"sd\">\u00a0 \u00a0 @param gid: numeric group id</span></td></tr><tr><th id=\"L1364\"><a href=\"#L1364\">1364</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1365\"><a href=\"#L1365\">1365</a></th><td><span class=\"sd\">\u00a0 \u00a0 @type spath: C{str}</span></td></tr><tr><th id=\"L1366\"><a href=\"#L1366\">1366</a></th><td><span class=\"sd\">\u00a0 \u00a0 @param spath: the path on the server to test</span></td></tr><tr><th id=\"L1367\"><a href=\"#L1367\">1367</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1368\"><a href=\"#L1368\">1368</a></th><td><span class=\"sd\">\u00a0 \u00a0 @type mode: C{str}</span></td></tr><tr><th id=\"L1369\"><a href=\"#L1369\">1369</a></th><td><span class=\"sd\">\u00a0 \u00a0 @param mode: 'r' or 'w' (read or write)</span></td></tr><tr><th id=\"L1370\"><a href=\"#L1370\">1370</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1371\"><a href=\"#L1371\">1371</a></th><td><span class=\"sd\">\u00a0 \u00a0 @rtype: C{bool}</span></td></tr><tr><th id=\"L1372\"><a href=\"#L1372\">1372</a></th><td><span class=\"sd\">\u00a0 \u00a0 @return: True if the given credentials have the specified form of</span></td></tr><tr><th id=\"L1373\"><a href=\"#L1373\">1373</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 access to the given path</span></td></tr><tr><th id=\"L1374\"><a href=\"#L1374\">1374</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1375\"><a href=\"#L1375\">1375</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0mode <span class=\"o\">==</span>\u00a0<span class=\"s\">'r'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1376\"><a href=\"#L1376\">1376</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 usr <span class=\"o\">=</span>\u00a0stat<span class=\"o\">.</span>S_IRUSR</td></tr><tr><th id=\"L1377\"><a href=\"#L1377\">1377</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 grp <span class=\"o\">=</span>\u00a0stat<span class=\"o\">.</span>S_IRGRP</td></tr><tr><th id=\"L1378\"><a href=\"#L1378\">1378</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 oth <span class=\"o\">=</span>\u00a0stat<span class=\"o\">.</span>S_IROTH</td></tr><tr><th id=\"L1379\"><a href=\"#L1379\">1379</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 amode <span class=\"o\">=</span>\u00a0os<span class=\"o\">.</span>R_OK</td></tr><tr><th id=\"L1380\"><a href=\"#L1380\">1380</a></th><td>\u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0mode <span class=\"o\">==</span>\u00a0<span class=\"s\">'w'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1381\"><a href=\"#L1381\">1381</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 usr <span class=\"o\">=</span>\u00a0stat<span class=\"o\">.</span>S_IWUSR</td></tr><tr><th id=\"L1382\"><a href=\"#L1382\">1382</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 grp <span class=\"o\">=</span>\u00a0stat<span class=\"o\">.</span>S_IWGRP</td></tr><tr><th id=\"L1383\"><a href=\"#L1383\">1383</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 oth <span class=\"o\">=</span>\u00a0stat<span class=\"o\">.</span>S_IWOTH</td></tr><tr><th id=\"L1384\"><a href=\"#L1384\">1384</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 amode <span class=\"o\">=</span>\u00a0os<span class=\"o\">.</span>W_OK</td></tr><tr><th id=\"L1385\"><a href=\"#L1385\">1385</a></th><td>\u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1386\"><a href=\"#L1386\">1386</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s\">\"Invalid mode </span><span class=\"si\">%r</span><span class=\"s\">: must specify 'r' or 'w'\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>mode<span class=\"p\">,))</span></td></tr><tr><th id=\"L1387\"><a href=\"#L1387\">1387</a></th><td></td></tr><tr><th id=\"L1388\"><a href=\"#L1388\">1388</a></th><td>\u00a0 \u00a0 access <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L1389\"><a href=\"#L1389\">1389</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0os<span class=\"o\">.</span>path<span class=\"o\">.</span>exists<span class=\"p\">(</span>spath<span class=\"p\">):</span></td></tr><tr><th id=\"L1390\"><a href=\"#L1390\">1390</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0uid <span class=\"o\">==</span>\u00a0<span class=\"mi\">0</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1391\"><a href=\"#L1391\">1391</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 access <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1392\"><a href=\"#L1392\">1392</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1393\"><a href=\"#L1393\">1393</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 s <span class=\"o\">=</span>\u00a0os<span class=\"o\">.</span>stat<span class=\"p\">(</span>spath<span class=\"p\">)</span></td></tr><tr><th id=\"L1394\"><a href=\"#L1394\">1394</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0usr <span class=\"o\">&amp;</span>\u00a0s<span class=\"o\">.</span>st_mode <span class=\"ow\">and</span>\u00a0uid <span class=\"o\">==</span>\u00a0s<span class=\"o\">.</span>st_uid<span class=\"p\">:</span></td></tr><tr><th id=\"L1395\"><a href=\"#L1395\">1395</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 access <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1396\"><a href=\"#L1396\">1396</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0grp <span class=\"o\">&amp;</span>\u00a0s<span class=\"o\">.</span>st_mode <span class=\"ow\">and</span>\u00a0gid <span class=\"ow\">in</span>\u00a0_getgroups<span class=\"p\">(</span>uid<span class=\"p\">):</span></td></tr><tr><th id=\"L1397\"><a href=\"#L1397\">1397</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 access <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1398\"><a href=\"#L1398\">1398</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0oth <span class=\"o\">&amp;</span>\u00a0s<span class=\"o\">.</span>st_mode<span class=\"p\">:</span></td></tr><tr><th id=\"L1399\"><a href=\"#L1399\">1399</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 access <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1400\"><a href=\"#L1400\">1400</a></th><td></td></tr><tr><th id=\"L1401\"><a href=\"#L1401\">1401</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0access<span class=\"p\">:</span></td></tr><tr><th id=\"L1402\"><a href=\"#L1402\">1402</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0os<span class=\"o\">.</span>access<span class=\"p\">(</span>spath<span class=\"p\">,</span>\u00a0amode<span class=\"p\">):</span></td></tr><tr><th id=\"L1403\"><a href=\"#L1403\">1403</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 access <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L1404\"><a href=\"#L1404\">1404</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">\"Filesystem grants permission to UID </span><span class=\"si\">%d</span><span class=\"s\">\u00a0but it is inaccessible to me running as UID </span><span class=\"si\">%d</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span></td></tr><tr><th id=\"L1405\"><a href=\"#L1405\">1405</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 uid<span class=\"p\">,</span>\u00a0os<span class=\"o\">.</span>getuid<span class=\"p\">()))</span></td></tr><tr><th id=\"L1406\"><a href=\"#L1406\">1406</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0access</td></tr><tr><th id=\"L1407\"><a href=\"#L1407\">1407</a></th><td></td></tr><tr><th id=\"L1408\"><a href=\"#L1408\">1408</a></th><td></td></tr><tr><th id=\"L1409\"><a href=\"#L1409\">1409</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPAnonymousShell</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1410\"><a href=\"#L1410\">1410</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"An anonymous implementation of IFTPShell</span></td></tr><tr><th id=\"L1411\"><a href=\"#L1411\">1411</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1412\"><a href=\"#L1412\">1412</a></th><td><span class=\"sd\">\u00a0 \u00a0 @type filesystemRoot: L{twisted.python.filepath.FilePath}</span></td></tr><tr><th id=\"L1413\"><a href=\"#L1413\">1413</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar filesystemRoot: The path which is considered the root of</span></td></tr><tr><th id=\"L1414\"><a href=\"#L1414\">1414</a></th><td><span class=\"sd\">\u00a0 \u00a0 this shell.</span></td></tr><tr><th id=\"L1415\"><a href=\"#L1415\">1415</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1416\"><a href=\"#L1416\">1416</a></th><td>\u00a0 \u00a0 implements<span class=\"p\">(</span>IFTPShell<span class=\"p\">)</span></td></tr><tr><th id=\"L1417\"><a href=\"#L1417\">1417</a></th><td></td></tr><tr><th id=\"L1418\"><a href=\"#L1418\">1418</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0filesystemRoot<span class=\"p\">):</span></td></tr><tr><th id=\"L1419\"><a href=\"#L1419\">1419</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>filesystemRoot <span class=\"o\">=</span>\u00a0filesystemRoot</td></tr><tr><th id=\"L1420\"><a href=\"#L1420\">1420</a></th><td></td></tr><tr><th id=\"L1421\"><a href=\"#L1421\">1421</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1422\"><a href=\"#L1422\">1422</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">reduce</span><span class=\"p\">(</span>filepath<span class=\"o\">.</span>FilePath<span class=\"o\">.</span>child<span class=\"p\">,</span>\u00a0path<span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>filesystemRoot<span class=\"p\">)</span></td></tr><tr><th id=\"L1423\"><a href=\"#L1423\">1423</a></th><td></td></tr><tr><th id=\"L1424\"><a href=\"#L1424\">1424</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">makeDirectory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1425\"><a href=\"#L1425\">1425</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>AnonUserDeniedError<span class=\"p\">())</span></td></tr><tr><th id=\"L1426\"><a href=\"#L1426\">1426</a></th><td></td></tr><tr><th id=\"L1427\"><a href=\"#L1427\">1427</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">removeDirectory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1428\"><a href=\"#L1428\">1428</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>AnonUserDeniedError<span class=\"p\">())</span></td></tr><tr><th id=\"L1429\"><a href=\"#L1429\">1429</a></th><td></td></tr><tr><th id=\"L1430\"><a href=\"#L1430\">1430</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">removeFile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1431\"><a href=\"#L1431\">1431</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>AnonUserDeniedError<span class=\"p\">())</span></td></tr><tr><th id=\"L1432\"><a href=\"#L1432\">1432</a></th><td></td></tr><tr><th id=\"L1433\"><a href=\"#L1433\">1433</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">rename</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0fromPath<span class=\"p\">,</span>\u00a0toPath<span class=\"p\">):</span></td></tr><tr><th id=\"L1434\"><a href=\"#L1434\">1434</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>AnonUserDeniedError<span class=\"p\">())</span></td></tr><tr><th id=\"L1435\"><a href=\"#L1435\">1435</a></th><td></td></tr><tr><th id=\"L1436\"><a href=\"#L1436\">1436</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">receive</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1437\"><a href=\"#L1437\">1437</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 path <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1438\"><a href=\"#L1438\">1438</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>AnonUserDeniedError<span class=\"p\">())</span></td></tr><tr><th id=\"L1439\"><a href=\"#L1439\">1439</a></th><td></td></tr><tr><th id=\"L1440\"><a href=\"#L1440\">1440</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">openForReading</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1441\"><a href=\"#L1441\">1441</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1442\"><a href=\"#L1442\">1442</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1443\"><a href=\"#L1443\">1443</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 f <span class=\"o\">=</span>\u00a0p<span class=\"o\">.</span>open<span class=\"p\">(</span><span class=\"s\">'rb'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1444\"><a href=\"#L1444\">1444</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0<span class=\"p\">(</span><span class=\"ne\">IOError</span><span class=\"p\">,</span>\u00a0<span class=\"ne\">OSError</span><span class=\"p\">),</span>\u00a0e<span class=\"p\">:</span></td></tr><tr><th id=\"L1445\"><a href=\"#L1445\">1445</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0errnoToFailure<span class=\"p\">(</span>e<span class=\"o\">.</span>errno<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L1446\"><a href=\"#L1446\">1446</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1447\"><a href=\"#L1447\">1447</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">()</span></td></tr><tr><th id=\"L1448\"><a href=\"#L1448\">1448</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1449\"><a href=\"#L1449\">1449</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span>_FileReader<span class=\"p\">(</span>f<span class=\"p\">))</span></td></tr><tr><th id=\"L1450\"><a href=\"#L1450\">1450</a></th><td></td></tr><tr><th id=\"L1451\"><a href=\"#L1451\">1451</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">access</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1452\"><a href=\"#L1452\">1452</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1453\"><a href=\"#L1453\">1453</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># For now, just see if we can os.listdir() it</span></td></tr><tr><th id=\"L1454\"><a href=\"#L1454\">1454</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1455\"><a href=\"#L1455\">1455</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 p<span class=\"o\">.</span>listdir<span class=\"p\">()</span></td></tr><tr><th id=\"L1456\"><a href=\"#L1456\">1456</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0<span class=\"p\">(</span><span class=\"ne\">IOError</span><span class=\"p\">,</span>\u00a0<span class=\"ne\">OSError</span><span class=\"p\">),</span>\u00a0e<span class=\"p\">:</span></td></tr><tr><th id=\"L1457\"><a href=\"#L1457\">1457</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0errnoToFailure<span class=\"p\">(</span>e<span class=\"o\">.</span>errno<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L1458\"><a href=\"#L1458\">1458</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1459\"><a href=\"#L1459\">1459</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">()</span></td></tr><tr><th id=\"L1460\"><a href=\"#L1460\">1460</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1461\"><a href=\"#L1461\">1461</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1462\"><a href=\"#L1462\">1462</a></th><td></td></tr><tr><th id=\"L1463\"><a href=\"#L1463\">1463</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">stat</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">,</span>\u00a0keys<span class=\"o\">=</span><span class=\"p\">()):</span></td></tr><tr><th id=\"L1464\"><a href=\"#L1464\">1464</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1465\"><a href=\"#L1465\">1465</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0p<span class=\"o\">.</span>isdir<span class=\"p\">():</span></td></tr><tr><th id=\"L1466\"><a href=\"#L1466\">1466</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">(</span>WrongFiletype<span class=\"p\">())</span></td></tr><tr><th id=\"L1467\"><a href=\"#L1467\">1467</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1468\"><a href=\"#L1468\">1468</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>list<span class=\"p\">(</span>path<span class=\"p\">,</span>\u00a0keys<span class=\"p\">)</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0res<span class=\"p\">:</span>\u00a0res<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">1</span><span class=\"p\">])</span></td></tr><tr><th id=\"L1469\"><a href=\"#L1469\">1469</a></th><td></td></tr><tr><th id=\"L1470\"><a href=\"#L1470\">1470</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">,</span>\u00a0keys<span class=\"o\">=</span><span class=\"p\">()):</span></td></tr><tr><th id=\"L1471\"><a href=\"#L1471\">1471</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 path <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1472\"><a href=\"#L1472\">1472</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0path<span class=\"o\">.</span>isdir<span class=\"p\">():</span></td></tr><tr><th id=\"L1473\"><a href=\"#L1473\">1473</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 entries <span class=\"o\">=</span>\u00a0path<span class=\"o\">.</span>listdir<span class=\"p\">()</span></td></tr><tr><th id=\"L1474\"><a href=\"#L1474\">1474</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1475\"><a href=\"#L1475\">1475</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 entries <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"bp\">None</span><span class=\"p\">]</span></td></tr><tr><th id=\"L1476\"><a href=\"#L1476\">1476</a></th><td></td></tr><tr><th id=\"L1477\"><a href=\"#L1477\">1477</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 results <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L1478\"><a href=\"#L1478\">1478</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0fName <span class=\"ow\">in</span>\u00a0entries<span class=\"p\">:</span></td></tr><tr><th id=\"L1479\"><a href=\"#L1479\">1479</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ent <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L1480\"><a href=\"#L1480\">1480</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 results<span class=\"o\">.</span>append<span class=\"p\">((</span>fName<span class=\"p\">,</span>\u00a0ent<span class=\"p\">))</span></td></tr><tr><th id=\"L1481\"><a href=\"#L1481\">1481</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0keys<span class=\"p\">:</span></td></tr><tr><th id=\"L1482\"><a href=\"#L1482\">1482</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0fName <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1483\"><a href=\"#L1483\">1483</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0os<span class=\"o\">.</span>path<span class=\"o\">.</span>join<span class=\"p\">(</span>path<span class=\"o\">.</span>path<span class=\"p\">,</span>\u00a0fName<span class=\"p\">)</span></td></tr><tr><th id=\"L1484\"><a href=\"#L1484\">1484</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1485\"><a href=\"#L1485\">1485</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0path<span class=\"o\">.</span>path</td></tr><tr><th id=\"L1486\"><a href=\"#L1486\">1486</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1487\"><a href=\"#L1487\">1487</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 statResult <span class=\"o\">=</span>\u00a0os<span class=\"o\">.</span>stat<span class=\"p\">(</span>p<span class=\"p\">)</span></td></tr><tr><th id=\"L1488\"><a href=\"#L1488\">1488</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0<span class=\"p\">(</span><span class=\"ne\">IOError</span><span class=\"p\">,</span>\u00a0<span class=\"ne\">OSError</span><span class=\"p\">),</span>\u00a0e<span class=\"p\">:</span></td></tr><tr><th id=\"L1489\"><a href=\"#L1489\">1489</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0errnoToFailure<span class=\"p\">(</span>e<span class=\"o\">.</span>errno<span class=\"p\">,</span>\u00a0path<span class=\"p\">)</span></td></tr><tr><th id=\"L1490\"><a href=\"#L1490\">1490</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1491\"><a href=\"#L1491\">1491</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">()</span></td></tr><tr><th id=\"L1492\"><a href=\"#L1492\">1492</a></th><td></td></tr><tr><th id=\"L1493\"><a href=\"#L1493\">1493</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0k <span class=\"ow\">in</span>\u00a0keys<span class=\"p\">:</span></td></tr><tr><th id=\"L1494\"><a href=\"#L1494\">1494</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ent<span class=\"o\">.</span>append<span class=\"p\">(</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'_list_'</span>\u00a0<span class=\"o\">+</span>\u00a0k<span class=\"p\">)(</span>statResult<span class=\"p\">))</span></td></tr><tr><th id=\"L1495\"><a href=\"#L1495\">1495</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span>results<span class=\"p\">)</span></td></tr><tr><th id=\"L1496\"><a href=\"#L1496\">1496</a></th><td></td></tr><tr><th id=\"L1497\"><a href=\"#L1497\">1497</a></th><td>\u00a0 \u00a0 _list_size <span class=\"o\">=</span>\u00a0operator<span class=\"o\">.</span>attrgetter<span class=\"p\">(</span><span class=\"s\">'st_size'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1498\"><a href=\"#L1498\">1498</a></th><td>\u00a0 \u00a0 _list_permissions <span class=\"o\">=</span>\u00a0operator<span class=\"o\">.</span>attrgetter<span class=\"p\">(</span><span class=\"s\">'st_mode'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1499\"><a href=\"#L1499\">1499</a></th><td>\u00a0 \u00a0 _list_hardlinks <span class=\"o\">=</span>\u00a0operator<span class=\"o\">.</span>attrgetter<span class=\"p\">(</span><span class=\"s\">'st_nlink'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1500\"><a href=\"#L1500\">1500</a></th><td>\u00a0 \u00a0 _list_modified <span class=\"o\">=</span>\u00a0operator<span class=\"o\">.</span>attrgetter<span class=\"p\">(</span><span class=\"s\">'st_mtime'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1501\"><a href=\"#L1501\">1501</a></th><td></td></tr><tr><th id=\"L1502\"><a href=\"#L1502\">1502</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_list_owner</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0st<span class=\"p\">):</span></td></tr><tr><th id=\"L1503\"><a href=\"#L1503\">1503</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0pwd <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1504\"><a href=\"#L1504\">1504</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1505\"><a href=\"#L1505\">1505</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0pwd<span class=\"o\">.</span>getpwuid<span class=\"p\">(</span>st<span class=\"o\">.</span>st_uid<span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span></td></tr><tr><th id=\"L1506\"><a href=\"#L1506\">1506</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0<span class=\"ne\">KeyError</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1507\"><a href=\"#L1507\">1507</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L1508\"><a href=\"#L1508\">1508</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>st<span class=\"o\">.</span>st_uid<span class=\"p\">)</span></td></tr><tr><th id=\"L1509\"><a href=\"#L1509\">1509</a></th><td></td></tr><tr><th id=\"L1510\"><a href=\"#L1510\">1510</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_list_group</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0st<span class=\"p\">):</span></td></tr><tr><th id=\"L1511\"><a href=\"#L1511\">1511</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0grp <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1512\"><a href=\"#L1512\">1512</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1513\"><a href=\"#L1513\">1513</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0grp<span class=\"o\">.</span>getgrgid<span class=\"p\">(</span>st<span class=\"o\">.</span>st_gid<span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span></td></tr><tr><th id=\"L1514\"><a href=\"#L1514\">1514</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0<span class=\"ne\">KeyError</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1515\"><a href=\"#L1515\">1515</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L1516\"><a href=\"#L1516\">1516</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>st<span class=\"o\">.</span>st_gid<span class=\"p\">)</span></td></tr><tr><th id=\"L1517\"><a href=\"#L1517\">1517</a></th><td></td></tr><tr><th id=\"L1518\"><a href=\"#L1518\">1518</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_list_directory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0st<span class=\"p\">):</span></td></tr><tr><th id=\"L1519\"><a href=\"#L1519\">1519</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"nb\">bool</span><span class=\"p\">(</span>st<span class=\"o\">.</span>st_mode <span class=\"o\">&amp;</span>\u00a0stat<span class=\"o\">.</span>S_IFDIR<span class=\"p\">)</span></td></tr><tr><th id=\"L1520\"><a href=\"#L1520\">1520</a></th><td></td></tr><tr><th id=\"L1521\"><a href=\"#L1521\">1521</a></th><td></td></tr><tr><th id=\"L1522\"><a href=\"#L1522\">1522</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">_FileReader</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1523\"><a href=\"#L1523\">1523</a></th><td>\u00a0 \u00a0 implements<span class=\"p\">(</span>IReadFile<span class=\"p\">)</span></td></tr><tr><th id=\"L1524\"><a href=\"#L1524\">1524</a></th><td></td></tr><tr><th id=\"L1525\"><a href=\"#L1525\">1525</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0fObj<span class=\"p\">):</span></td></tr><tr><th id=\"L1526\"><a href=\"#L1526\">1526</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>fObj <span class=\"o\">=</span>\u00a0fObj</td></tr><tr><th id=\"L1527\"><a href=\"#L1527\">1527</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_send <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L1528\"><a href=\"#L1528\">1528</a></th><td></td></tr><tr><th id=\"L1529\"><a href=\"#L1529\">1529</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_close</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0passthrough<span class=\"p\">):</span></td></tr><tr><th id=\"L1530\"><a href=\"#L1530\">1530</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_send <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1531\"><a href=\"#L1531\">1531</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>fObj<span class=\"o\">.</span>close<span class=\"p\">()</span></td></tr><tr><th id=\"L1532\"><a href=\"#L1532\">1532</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0passthrough</td></tr><tr><th id=\"L1533\"><a href=\"#L1533\">1533</a></th><td></td></tr><tr><th id=\"L1534\"><a href=\"#L1534\">1534</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">send</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0consumer<span class=\"p\">):</span></td></tr><tr><th id=\"L1535\"><a href=\"#L1535\">1535</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">assert</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_send<span class=\"p\">,</span>\u00a0<span class=\"s\">\"Can only call IReadFile.send *once* per instance\"</span></td></tr><tr><th id=\"L1536\"><a href=\"#L1536\">1536</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_send <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1537\"><a href=\"#L1537\">1537</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0basic<span class=\"o\">.</span>FileSender<span class=\"p\">()</span><span class=\"o\">.</span>beginFileTransfer<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>fObj<span class=\"p\">,</span>\u00a0consumer<span class=\"p\">)</span></td></tr><tr><th id=\"L1538\"><a href=\"#L1538\">1538</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addBoth<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>_close<span class=\"p\">)</span></td></tr><tr><th id=\"L1539\"><a href=\"#L1539\">1539</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L1540\"><a href=\"#L1540\">1540</a></th><td></td></tr><tr><th id=\"L1541\"><a href=\"#L1541\">1541</a></th><td></td></tr><tr><th id=\"L1542\"><a href=\"#L1542\">1542</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPShell</span><span class=\"p\">(</span>FTPAnonymousShell<span class=\"p\">):</span></td></tr><tr><th id=\"L1543\"><a href=\"#L1543\">1543</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">makeDirectory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1544\"><a href=\"#L1544\">1544</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1545\"><a href=\"#L1545\">1545</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1546\"><a href=\"#L1546\">1546</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 p<span class=\"o\">.</span>makedirs<span class=\"p\">()</span></td></tr><tr><th id=\"L1547\"><a href=\"#L1547\">1547</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1548\"><a href=\"#L1548\">1548</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">()</span></td></tr><tr><th id=\"L1549\"><a href=\"#L1549\">1549</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1550\"><a href=\"#L1550\">1550</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1551\"><a href=\"#L1551\">1551</a></th><td></td></tr><tr><th id=\"L1552\"><a href=\"#L1552\">1552</a></th><td></td></tr><tr><th id=\"L1553\"><a href=\"#L1553\">1553</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">removeDirectory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1554\"><a href=\"#L1554\">1554</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1555\"><a href=\"#L1555\">1555</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1556\"><a href=\"#L1556\">1556</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 os<span class=\"o\">.</span>rmdir<span class=\"p\">(</span>p<span class=\"o\">.</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1557\"><a href=\"#L1557\">1557</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1558\"><a href=\"#L1558\">1558</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">()</span></td></tr><tr><th id=\"L1559\"><a href=\"#L1559\">1559</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1560\"><a href=\"#L1560\">1560</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1561\"><a href=\"#L1561\">1561</a></th><td></td></tr><tr><th id=\"L1562\"><a href=\"#L1562\">1562</a></th><td></td></tr><tr><th id=\"L1563\"><a href=\"#L1563\">1563</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">removeFile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1564\"><a href=\"#L1564\">1564</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1565\"><a href=\"#L1565\">1565</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1566\"><a href=\"#L1566\">1566</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 p<span class=\"o\">.</span>remove<span class=\"p\">()</span></td></tr><tr><th id=\"L1567\"><a href=\"#L1567\">1567</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1568\"><a href=\"#L1568\">1568</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">()</span></td></tr><tr><th id=\"L1569\"><a href=\"#L1569\">1569</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1570\"><a href=\"#L1570\">1570</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1571\"><a href=\"#L1571\">1571</a></th><td></td></tr><tr><th id=\"L1572\"><a href=\"#L1572\">1572</a></th><td></td></tr><tr><th id=\"L1573\"><a href=\"#L1573\">1573</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">rename</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0fromPath<span class=\"p\">,</span>\u00a0toPath<span class=\"p\">):</span></td></tr><tr><th id=\"L1574\"><a href=\"#L1574\">1574</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 fp <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>fromPath<span class=\"p\">)</span></td></tr><tr><th id=\"L1575\"><a href=\"#L1575\">1575</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 tp <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>toPath<span class=\"p\">)</span></td></tr><tr><th id=\"L1576\"><a href=\"#L1576\">1576</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1577\"><a href=\"#L1577\">1577</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 os<span class=\"o\">.</span>rename<span class=\"p\">(</span>fp<span class=\"o\">.</span>path<span class=\"p\">,</span>\u00a0tp<span class=\"o\">.</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1578\"><a href=\"#L1578\">1578</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1579\"><a href=\"#L1579\">1579</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">()</span></td></tr><tr><th id=\"L1580\"><a href=\"#L1580\">1580</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1581\"><a href=\"#L1581\">1581</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1582\"><a href=\"#L1582\">1582</a></th><td></td></tr><tr><th id=\"L1583\"><a href=\"#L1583\">1583</a></th><td></td></tr><tr><th id=\"L1584\"><a href=\"#L1584\">1584</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">openForWriting</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L1585\"><a href=\"#L1585\">1585</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 p <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_path<span class=\"p\">(</span>path<span class=\"p\">)</span></td></tr><tr><th id=\"L1586\"><a href=\"#L1586\">1586</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1587\"><a href=\"#L1587\">1587</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fObj <span class=\"o\">=</span>\u00a0p<span class=\"o\">.</span>open<span class=\"p\">(</span><span class=\"s\">'wb'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1588\"><a href=\"#L1588\">1588</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1589\"><a href=\"#L1589\">1589</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>fail<span class=\"p\">()</span></td></tr><tr><th id=\"L1590\"><a href=\"#L1590\">1590</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span>_FileWriter<span class=\"p\">(</span>fObj<span class=\"p\">))</span></td></tr><tr><th id=\"L1591\"><a href=\"#L1591\">1591</a></th><td></td></tr><tr><th id=\"L1592\"><a href=\"#L1592\">1592</a></th><td></td></tr><tr><th id=\"L1593\"><a href=\"#L1593\">1593</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">_FileWriter</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1594\"><a href=\"#L1594\">1594</a></th><td>\u00a0 \u00a0 implements<span class=\"p\">(</span>IWriteFile<span class=\"p\">)</span></td></tr><tr><th id=\"L1595\"><a href=\"#L1595\">1595</a></th><td></td></tr><tr><th id=\"L1596\"><a href=\"#L1596\">1596</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0fObj<span class=\"p\">):</span></td></tr><tr><th id=\"L1597\"><a href=\"#L1597\">1597</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>fObj <span class=\"o\">=</span>\u00a0fObj</td></tr><tr><th id=\"L1598\"><a href=\"#L1598\">1598</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_receive <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L1599\"><a href=\"#L1599\">1599</a></th><td></td></tr><tr><th id=\"L1600\"><a href=\"#L1600\">1600</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">receive</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1601\"><a href=\"#L1601\">1601</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">assert</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_receive<span class=\"p\">,</span>\u00a0<span class=\"s\">\"Can only call IWriteFile.receive *once* per instance\"</span></td></tr><tr><th id=\"L1602\"><a href=\"#L1602\">1602</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_receive <span class=\"o\">=</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L1603\"><a href=\"#L1603\">1603</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># FileConsumer will close the file object</span></td></tr><tr><th id=\"L1604\"><a href=\"#L1604\">1604</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0defer<span class=\"o\">.</span>succeed<span class=\"p\">(</span>FileConsumer<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>fObj<span class=\"p\">))</span></td></tr><tr><th id=\"L1605\"><a href=\"#L1605\">1605</a></th><td></td></tr><tr><th id=\"L1606\"><a href=\"#L1606\">1606</a></th><td></td></tr><tr><th id=\"L1607\"><a href=\"#L1607\">1607</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPRealm</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1608\"><a href=\"#L1608\">1608</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1609\"><a href=\"#L1609\">1609</a></th><td><span class=\"sd\">\u00a0 \u00a0 @type anonymousRoot: L{twisted.python.filepath.FilePath}</span></td></tr><tr><th id=\"L1610\"><a href=\"#L1610\">1610</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar anonymousRoot: Root of the filesystem to which anonymous</span></td></tr><tr><th id=\"L1611\"><a href=\"#L1611\">1611</a></th><td><span class=\"sd\">\u00a0 \u00a0 users will be granted access.</span></td></tr><tr><th id=\"L1612\"><a href=\"#L1612\">1612</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1613\"><a href=\"#L1613\">1613</a></th><td>\u00a0 \u00a0 implements<span class=\"p\">(</span>portal<span class=\"o\">.</span>IRealm<span class=\"p\">)</span></td></tr><tr><th id=\"L1614\"><a href=\"#L1614\">1614</a></th><td></td></tr><tr><th id=\"L1615\"><a href=\"#L1615\">1615</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0anonymousRoot<span class=\"p\">):</span></td></tr><tr><th id=\"L1616\"><a href=\"#L1616\">1616</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>anonymousRoot <span class=\"o\">=</span>\u00a0filepath<span class=\"o\">.</span>FilePath<span class=\"p\">(</span>anonymousRoot<span class=\"p\">)</span></td></tr><tr><th id=\"L1617\"><a href=\"#L1617\">1617</a></th><td></td></tr><tr><th id=\"L1618\"><a href=\"#L1618\">1618</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">requestAvatar</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0avatarId<span class=\"p\">,</span>\u00a0mind<span class=\"p\">,</span>\u00a0<span class=\"o\">*</span>interfaces<span class=\"p\">):</span></td></tr><tr><th id=\"L1619\"><a href=\"#L1619\">1619</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0iface <span class=\"ow\">in</span>\u00a0interfaces<span class=\"p\">:</span></td></tr><tr><th id=\"L1620\"><a href=\"#L1620\">1620</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0iface <span class=\"ow\">is</span>\u00a0IFTPShell<span class=\"p\">:</span></td></tr><tr><th id=\"L1621\"><a href=\"#L1621\">1621</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0avatarId <span class=\"ow\">is</span>\u00a0checkers<span class=\"o\">.</span>ANONYMOUS<span class=\"p\">:</span></td></tr><tr><th id=\"L1622\"><a href=\"#L1622\">1622</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 avatar <span class=\"o\">=</span>\u00a0FTPAnonymousShell<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>anonymousRoot<span class=\"p\">)</span></td></tr><tr><th id=\"L1623\"><a href=\"#L1623\">1623</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1624\"><a href=\"#L1624\">1624</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 avatar <span class=\"o\">=</span>\u00a0FTPShell<span class=\"p\">(</span>filepath<span class=\"o\">.</span>FilePath<span class=\"p\">(</span><span class=\"s\">\"/home/\"</span>\u00a0<span class=\"o\">+</span>\u00a0avatarId<span class=\"p\">))</span></td></tr><tr><th id=\"L1625\"><a href=\"#L1625\">1625</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0IFTPShell<span class=\"p\">,</span>\u00a0avatar<span class=\"p\">,</span>\u00a0<span class=\"nb\">getattr</span><span class=\"p\">(</span>avatar<span class=\"p\">,</span>\u00a0<span class=\"s\">'logout'</span><span class=\"p\">,</span>\u00a0<span class=\"k\">lambda</span><span class=\"p\">:</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1626\"><a href=\"#L1626\">1626</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">NotImplementedError</span><span class=\"p\">(</span><span class=\"s\">\"Only IFTPShell interface is supported by this realm\"</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1627\"><a href=\"#L1627\">1627</a></th><td></td></tr><tr><th id=\"L1628\"><a href=\"#L1628\">1628</a></th><td><span class=\"c\"># --- FTP CLIENT\u00a0 -------------------------------------------------------------</span></td></tr><tr><th id=\"L1629\"><a href=\"#L1629\">1629</a></th><td></td></tr><tr><th id=\"L1630\"><a href=\"#L1630\">1630</a></th><td><span class=\"c\">####</span></td></tr><tr><th id=\"L1631\"><a href=\"#L1631\">1631</a></th><td><span class=\"c\"># And now for the client...</span></td></tr><tr><th id=\"L1632\"><a href=\"#L1632\">1632</a></th><td></td></tr><tr><th id=\"L1633\"><a href=\"#L1633\">1633</a></th><td><span class=\"c\"># Notes:</span></td></tr><tr><th id=\"L1634\"><a href=\"#L1634\">1634</a></th><td><span class=\"c\">#\u00a0 \u00a0* Reference: http://cr.yp.to/ftp.html</span></td></tr><tr><th id=\"L1635\"><a href=\"#L1635\">1635</a></th><td><span class=\"c\">#\u00a0 \u00a0* FIXME: Does not support pipelining (which is not supported by all</span></td></tr><tr><th id=\"L1636\"><a href=\"#L1636\">1636</a></th><td><span class=\"c\">#\u00a0 \u00a0 \u00a0servers anyway).\u00a0 This isn't a functionality limitation, just a</span></td></tr><tr><th id=\"L1637\"><a href=\"#L1637\">1637</a></th><td><span class=\"c\">#\u00a0 \u00a0 \u00a0small performance issue.</span></td></tr><tr><th id=\"L1638\"><a href=\"#L1638\">1638</a></th><td><span class=\"c\">#\u00a0 \u00a0* Only has a rudimentary understanding of FTP response codes (although</span></td></tr><tr><th id=\"L1639\"><a href=\"#L1639\">1639</a></th><td><span class=\"c\">#\u00a0 \u00a0 \u00a0the full response is passed to the caller if they so choose).</span></td></tr><tr><th id=\"L1640\"><a href=\"#L1640\">1640</a></th><td><span class=\"c\">#\u00a0 \u00a0* Assumes that USER and PASS should always be sent</span></td></tr><tr><th id=\"L1641\"><a href=\"#L1641\">1641</a></th><td><span class=\"c\">#\u00a0 \u00a0* Always sets TYPE I\u00a0 (binary mode)</span></td></tr><tr><th id=\"L1642\"><a href=\"#L1642\">1642</a></th><td><span class=\"c\">#\u00a0 \u00a0* Doesn't understand any of the weird, obscure TELNET stuff (\\377...)</span></td></tr><tr><th id=\"L1643\"><a href=\"#L1643\">1643</a></th><td><span class=\"c\">#\u00a0 \u00a0* FIXME: Doesn't share any code with the FTPServer</span></td></tr><tr><th id=\"L1644\"><a href=\"#L1644\">1644</a></th><td></td></tr><tr><th id=\"L1645\"><a href=\"#L1645\">1645</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">ConnectionLost</span><span class=\"p\">(</span>FTPError<span class=\"p\">):</span></td></tr><tr><th id=\"L1646\"><a href=\"#L1646\">1646</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L1647\"><a href=\"#L1647\">1647</a></th><td></td></tr><tr><th id=\"L1648\"><a href=\"#L1648\">1648</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">CommandFailed</span><span class=\"p\">(</span>FTPError<span class=\"p\">):</span></td></tr><tr><th id=\"L1649\"><a href=\"#L1649\">1649</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L1650\"><a href=\"#L1650\">1650</a></th><td></td></tr><tr><th id=\"L1651\"><a href=\"#L1651\">1651</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">BadResponse</span><span class=\"p\">(</span>FTPError<span class=\"p\">):</span></td></tr><tr><th id=\"L1652\"><a href=\"#L1652\">1652</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L1653\"><a href=\"#L1653\">1653</a></th><td></td></tr><tr><th id=\"L1654\"><a href=\"#L1654\">1654</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">UnexpectedResponse</span><span class=\"p\">(</span>FTPError<span class=\"p\">):</span></td></tr><tr><th id=\"L1655\"><a href=\"#L1655\">1655</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L1656\"><a href=\"#L1656\">1656</a></th><td></td></tr><tr><th id=\"L1657\"><a href=\"#L1657\">1657</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">UnexpectedData</span><span class=\"p\">(</span>FTPError<span class=\"p\">):</span></td></tr><tr><th id=\"L1658\"><a href=\"#L1658\">1658</a></th><td>\u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L1659\"><a href=\"#L1659\">1659</a></th><td></td></tr><tr><th id=\"L1660\"><a href=\"#L1660\">1660</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPCommand</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1661\"><a href=\"#L1661\">1661</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0text<span class=\"o\">=</span><span class=\"bp\">None</span><span class=\"p\">,</span>\u00a0public<span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1662\"><a href=\"#L1662\">1662</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>text <span class=\"o\">=</span>\u00a0text</td></tr><tr><th id=\"L1663\"><a href=\"#L1663\">1663</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>Deferred<span class=\"p\">()</span></td></tr><tr><th id=\"L1664\"><a href=\"#L1664\">1664</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>ready <span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L1665\"><a href=\"#L1665\">1665</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>public <span class=\"o\">=</span>\u00a0public</td></tr><tr><th id=\"L1666\"><a href=\"#L1666\">1666</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transferDeferred <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L1667\"><a href=\"#L1667\">1667</a></th><td></td></tr><tr><th id=\"L1668\"><a href=\"#L1668\">1668</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0failure<span class=\"p\">):</span></td></tr><tr><th id=\"L1669\"><a href=\"#L1669\">1669</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>public<span class=\"p\">:</span></td></tr><tr><th id=\"L1670\"><a href=\"#L1670\">1670</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred<span class=\"o\">.</span>errback<span class=\"p\">(</span>failure<span class=\"p\">)</span></td></tr><tr><th id=\"L1671\"><a href=\"#L1671\">1671</a></th><td></td></tr><tr><th id=\"L1672\"><a href=\"#L1672\">1672</a></th><td></td></tr><tr><th id=\"L1673\"><a href=\"#L1673\">1673</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">ProtocolWrapper</span><span class=\"p\">(</span>protocol<span class=\"o\">.</span>Protocol<span class=\"p\">):</span></td></tr><tr><th id=\"L1674\"><a href=\"#L1674\">1674</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0original<span class=\"p\">,</span>\u00a0deferred<span class=\"p\">):</span></td></tr><tr><th id=\"L1675\"><a href=\"#L1675\">1675</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>original <span class=\"o\">=</span>\u00a0original</td></tr><tr><th id=\"L1676\"><a href=\"#L1676\">1676</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred <span class=\"o\">=</span>\u00a0deferred</td></tr><tr><th id=\"L1677\"><a href=\"#L1677\">1677</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">makeConnection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0transport<span class=\"p\">):</span></td></tr><tr><th id=\"L1678\"><a href=\"#L1678\">1678</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>original<span class=\"o\">.</span>makeConnection<span class=\"p\">(</span>transport<span class=\"p\">)</span></td></tr><tr><th id=\"L1679\"><a href=\"#L1679\">1679</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">dataReceived</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0data<span class=\"p\">):</span></td></tr><tr><th id=\"L1680\"><a href=\"#L1680\">1680</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>original<span class=\"o\">.</span>dataReceived<span class=\"p\">(</span>data<span class=\"p\">)</span></td></tr><tr><th id=\"L1681\"><a href=\"#L1681\">1681</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connectionLost</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0reason<span class=\"p\">):</span></td></tr><tr><th id=\"L1682\"><a href=\"#L1682\">1682</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>original<span class=\"o\">.</span>connectionLost<span class=\"p\">(</span>reason<span class=\"p\">)</span></td></tr><tr><th id=\"L1683\"><a href=\"#L1683\">1683</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Signal that transfer has completed</span></td></tr><tr><th id=\"L1684\"><a href=\"#L1684\">1684</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred<span class=\"o\">.</span>callback<span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1685\"><a href=\"#L1685\">1685</a></th><td></td></tr><tr><th id=\"L1686\"><a href=\"#L1686\">1686</a></th><td></td></tr><tr><th id=\"L1687\"><a href=\"#L1687\">1687</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">SenderProtocol</span><span class=\"p\">(</span>protocol<span class=\"o\">.</span>Protocol<span class=\"p\">):</span></td></tr><tr><th id=\"L1688\"><a href=\"#L1688\">1688</a></th><td>\u00a0 \u00a0 implements<span class=\"p\">(</span>interfaces<span class=\"o\">.</span>IFinishableConsumer<span class=\"p\">)</span></td></tr><tr><th id=\"L1689\"><a href=\"#L1689\">1689</a></th><td></td></tr><tr><th id=\"L1690\"><a href=\"#L1690\">1690</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1691\"><a href=\"#L1691\">1691</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Fired upon connection</span></td></tr><tr><th id=\"L1692\"><a href=\"#L1692\">1692</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>connectedDeferred <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>Deferred<span class=\"p\">()</span></td></tr><tr><th id=\"L1693\"><a href=\"#L1693\">1693</a></th><td></td></tr><tr><th id=\"L1694\"><a href=\"#L1694\">1694</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Fired upon disconnection</span></td></tr><tr><th id=\"L1695\"><a href=\"#L1695\">1695</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>Deferred<span class=\"p\">()</span></td></tr><tr><th id=\"L1696\"><a href=\"#L1696\">1696</a></th><td></td></tr><tr><th id=\"L1697\"><a href=\"#L1697\">1697</a></th><td>\u00a0 \u00a0 <span class=\"c\">#Protocol stuff</span></td></tr><tr><th id=\"L1698\"><a href=\"#L1698\">1698</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">dataReceived</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0data<span class=\"p\">):</span></td></tr><tr><th id=\"L1699\"><a href=\"#L1699\">1699</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0UnexpectedData<span class=\"p\">(</span></td></tr><tr><th id=\"L1700\"><a href=\"#L1700\">1700</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"Received data from the server on a \"</span></td></tr><tr><th id=\"L1701\"><a href=\"#L1701\">1701</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">\"send-only data-connection\"</span></td></tr><tr><th id=\"L1702\"><a href=\"#L1702\">1702</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"p\">)</span></td></tr><tr><th id=\"L1703\"><a href=\"#L1703\">1703</a></th><td></td></tr><tr><th id=\"L1704\"><a href=\"#L1704\">1704</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">makeConnection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0transport<span class=\"p\">):</span></td></tr><tr><th id=\"L1705\"><a href=\"#L1705\">1705</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 protocol<span class=\"o\">.</span>Protocol<span class=\"o\">.</span>makeConnection<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0transport<span class=\"p\">)</span></td></tr><tr><th id=\"L1706\"><a href=\"#L1706\">1706</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>connectedDeferred<span class=\"o\">.</span>callback<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1707\"><a href=\"#L1707\">1707</a></th><td></td></tr><tr><th id=\"L1708\"><a href=\"#L1708\">1708</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connectionLost</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0reason<span class=\"p\">):</span></td></tr><tr><th id=\"L1709\"><a href=\"#L1709\">1709</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0reason<span class=\"o\">.</span>check<span class=\"p\">(</span>error<span class=\"o\">.</span>ConnectionDone<span class=\"p\">):</span></td></tr><tr><th id=\"L1710\"><a href=\"#L1710\">1710</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred<span class=\"o\">.</span>callback<span class=\"p\">(</span><span class=\"s\">'connection done'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1711\"><a href=\"#L1711\">1711</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1712\"><a href=\"#L1712\">1712</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>deferred<span class=\"o\">.</span>errback<span class=\"p\">(</span>reason<span class=\"p\">)</span></td></tr><tr><th id=\"L1713\"><a href=\"#L1713\">1713</a></th><td></td></tr><tr><th id=\"L1714\"><a href=\"#L1714\">1714</a></th><td>\u00a0 \u00a0 <span class=\"c\">#IFinishableConsumer stuff</span></td></tr><tr><th id=\"L1715\"><a href=\"#L1715\">1715</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">write</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0data<span class=\"p\">):</span></td></tr><tr><th id=\"L1716\"><a href=\"#L1716\">1716</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>write<span class=\"p\">(</span>data<span class=\"p\">)</span></td></tr><tr><th id=\"L1717\"><a href=\"#L1717\">1717</a></th><td></td></tr><tr><th id=\"L1718\"><a href=\"#L1718\">1718</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">registerProducer</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0producer<span class=\"p\">,</span>\u00a0streaming<span class=\"p\">):</span></td></tr><tr><th id=\"L1719\"><a href=\"#L1719\">1719</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1720\"><a href=\"#L1720\">1720</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Register the given producer with our transport.</span></td></tr><tr><th id=\"L1721\"><a href=\"#L1721\">1721</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1722\"><a href=\"#L1722\">1722</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>registerProducer<span class=\"p\">(</span>producer<span class=\"p\">,</span>\u00a0streaming<span class=\"p\">)</span></td></tr><tr><th id=\"L1723\"><a href=\"#L1723\">1723</a></th><td></td></tr><tr><th id=\"L1724\"><a href=\"#L1724\">1724</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">unregisterProducer</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1725\"><a href=\"#L1725\">1725</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1726\"><a href=\"#L1726\">1726</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Unregister the previously registered producer.</span></td></tr><tr><th id=\"L1727\"><a href=\"#L1727\">1727</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1728\"><a href=\"#L1728\">1728</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>unregisterProducer<span class=\"p\">()</span></td></tr><tr><th id=\"L1729\"><a href=\"#L1729\">1729</a></th><td></td></tr><tr><th id=\"L1730\"><a href=\"#L1730\">1730</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">finish</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1731\"><a href=\"#L1731\">1731</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L1732\"><a href=\"#L1732\">1732</a></th><td></td></tr><tr><th id=\"L1733\"><a href=\"#L1733\">1733</a></th><td></td></tr><tr><th id=\"L1734\"><a href=\"#L1734\">1734</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">decodeHostPort</span><span class=\"p\">(</span>line<span class=\"p\">):</span></td></tr><tr><th id=\"L1735\"><a href=\"#L1735\">1735</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Decode an FTP response specifying a host and port.</span></td></tr><tr><th id=\"L1736\"><a href=\"#L1736\">1736</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1737\"><a href=\"#L1737\">1737</a></th><td><span class=\"sd\">\u00a0 \u00a0 @return: a 2-tuple of (host, port).</span></td></tr><tr><th id=\"L1738\"><a href=\"#L1738\">1738</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1739\"><a href=\"#L1739\">1739</a></th><td>\u00a0 \u00a0 abcdef <span class=\"o\">=</span>\u00a0re<span class=\"o\">.</span>sub<span class=\"p\">(</span><span class=\"s\">'[^0-9, ]'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">''</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">)</span></td></tr><tr><th id=\"L1740\"><a href=\"#L1740\">1740</a></th><td>\u00a0 \u00a0 parsed <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">(</span>p<span class=\"o\">.</span>strip<span class=\"p\">())</span>\u00a0<span class=\"k\">for</span>\u00a0p <span class=\"ow\">in</span>\u00a0abcdef<span class=\"o\">.</span>split<span class=\"p\">(</span><span class=\"s\">','</span><span class=\"p\">)]</span></td></tr><tr><th id=\"L1741\"><a href=\"#L1741\">1741</a></th><td>\u00a0 \u00a0 <span class=\"k\">for</span>\u00a0x <span class=\"ow\">in</span>\u00a0parsed<span class=\"p\">:</span></td></tr><tr><th id=\"L1742\"><a href=\"#L1742\">1742</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0x <span class=\"o\">&lt;</span>\u00a0<span class=\"mi\">0</span>\u00a0<span class=\"ow\">or</span>\u00a0x <span class=\"o\">&gt;</span>\u00a0<span class=\"mi\">255</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1743\"><a href=\"#L1743\">1743</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s\">\"Out of range\"</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">,</span>\u00a0x<span class=\"p\">)</span></td></tr><tr><th id=\"L1744\"><a href=\"#L1744\">1744</a></th><td>\u00a0 \u00a0 a<span class=\"p\">,</span>\u00a0b<span class=\"p\">,</span>\u00a0c<span class=\"p\">,</span>\u00a0d<span class=\"p\">,</span>\u00a0e<span class=\"p\">,</span>\u00a0f <span class=\"o\">=</span>\u00a0parsed</td></tr><tr><th id=\"L1745\"><a href=\"#L1745\">1745</a></th><td>\u00a0 \u00a0 host <span class=\"o\">=</span>\u00a0<span class=\"s\">\"</span><span class=\"si\">%s</span><span class=\"s\">.</span><span class=\"si\">%s</span><span class=\"s\">.</span><span class=\"si\">%s</span><span class=\"s\">.</span><span class=\"si\">%s</span><span class=\"s\">\"</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>a<span class=\"p\">,</span>\u00a0b<span class=\"p\">,</span>\u00a0c<span class=\"p\">,</span>\u00a0d<span class=\"p\">)</span></td></tr><tr><th id=\"L1746\"><a href=\"#L1746\">1746</a></th><td>\u00a0 \u00a0 port <span class=\"o\">=</span>\u00a0<span class=\"p\">(</span><span class=\"nb\">int</span><span class=\"p\">(</span>e<span class=\"p\">)</span>\u00a0<span class=\"o\">&lt;&lt;</span>\u00a0<span class=\"mi\">8</span><span class=\"p\">)</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"nb\">int</span><span class=\"p\">(</span>f<span class=\"p\">)</span></td></tr><tr><th id=\"L1747\"><a href=\"#L1747\">1747</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0host<span class=\"p\">,</span>\u00a0port</td></tr><tr><th id=\"L1748\"><a href=\"#L1748\">1748</a></th><td></td></tr><tr><th id=\"L1749\"><a href=\"#L1749\">1749</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">encodeHostPort</span><span class=\"p\">(</span>host<span class=\"p\">,</span>\u00a0port<span class=\"p\">):</span></td></tr><tr><th id=\"L1750\"><a href=\"#L1750\">1750</a></th><td>\u00a0 \u00a0 numbers <span class=\"o\">=</span>\u00a0host<span class=\"o\">.</span>split<span class=\"p\">(</span><span class=\"s\">'.'</span><span class=\"p\">)</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">(</span>port <span class=\"o\">&gt;&gt;</span>\u00a0<span class=\"mi\">8</span><span class=\"p\">),</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>port <span class=\"o\">%</span>\u00a0<span class=\"mi\">256</span><span class=\"p\">)]</span></td></tr><tr><th id=\"L1751\"><a href=\"#L1751\">1751</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"s\">','</span><span class=\"o\">.</span>join<span class=\"p\">(</span>numbers<span class=\"p\">)</span></td></tr><tr><th id=\"L1752\"><a href=\"#L1752\">1752</a></th><td></td></tr><tr><th id=\"L1753\"><a href=\"#L1753\">1753</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">_unwrapFirstError</span><span class=\"p\">(</span>failure<span class=\"p\">):</span></td></tr><tr><th id=\"L1754\"><a href=\"#L1754\">1754</a></th><td>\u00a0 \u00a0 failure<span class=\"o\">.</span>trap<span class=\"p\">(</span>defer<span class=\"o\">.</span>FirstError<span class=\"p\">)</span></td></tr><tr><th id=\"L1755\"><a href=\"#L1755\">1755</a></th><td>\u00a0 \u00a0 <span class=\"k\">return</span>\u00a0failure<span class=\"o\">.</span>value<span class=\"o\">.</span>subFailure</td></tr><tr><th id=\"L1756\"><a href=\"#L1756\">1756</a></th><td></td></tr><tr><th id=\"L1757\"><a href=\"#L1757\">1757</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPDataPortFactory</span><span class=\"p\">(</span>protocol<span class=\"o\">.</span>ServerFactory<span class=\"p\">):</span></td></tr><tr><th id=\"L1758\"><a href=\"#L1758\">1758</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Factory for data connections that use the PORT command</span></td></tr><tr><th id=\"L1759\"><a href=\"#L1759\">1759</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1760\"><a href=\"#L1760\">1760</a></th><td><span class=\"sd\">\u00a0 \u00a0 (i.e. \"active\" transfers)</span></td></tr><tr><th id=\"L1761\"><a href=\"#L1761\">1761</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1762\"><a href=\"#L1762\">1762</a></th><td>\u00a0 \u00a0 noisy <span class=\"o\">=</span>\u00a0<span class=\"mi\">0</span></td></tr><tr><th id=\"L1763\"><a href=\"#L1763\">1763</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">buildProtocol</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0addr<span class=\"p\">):</span></td></tr><tr><th id=\"L1764\"><a href=\"#L1764\">1764</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># This is a bit hackish -- we already have a Protocol instance,</span></td></tr><tr><th id=\"L1765\"><a href=\"#L1765\">1765</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># so just return it instead of making a new one</span></td></tr><tr><th id=\"L1766\"><a href=\"#L1766\">1766</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># FIXME: Reject connections from the wrong address/port</span></td></tr><tr><th id=\"L1767\"><a href=\"#L1767\">1767</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#\u00a0 \u00a0 \u00a0 \u00a0 (potential security problem)</span></td></tr><tr><th id=\"L1768\"><a href=\"#L1768\">1768</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>protocol<span class=\"o\">.</span>factory <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span></td></tr><tr><th id=\"L1769\"><a href=\"#L1769\">1769</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>port<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L1770\"><a href=\"#L1770\">1770</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>protocol</td></tr><tr><th id=\"L1771\"><a href=\"#L1771\">1771</a></th><td></td></tr><tr><th id=\"L1772\"><a href=\"#L1772\">1772</a></th><td></td></tr><tr><th id=\"L1773\"><a href=\"#L1773\">1773</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPClientBasic</span><span class=\"p\">(</span>basic<span class=\"o\">.</span>LineReceiver<span class=\"p\">):</span></td></tr><tr><th id=\"L1774\"><a href=\"#L1774\">1774</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Foundations of an FTP client.\"\"\"</span></td></tr><tr><th id=\"L1775\"><a href=\"#L1775\">1775</a></th><td>\u00a0 \u00a0 debug <span class=\"o\">=</span>\u00a0<span class=\"mi\">0</span></td></tr><tr><th id=\"L1776\"><a href=\"#L1776\">1776</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1777\"><a href=\"#L1777\">1777</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>actionQueue <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L1778\"><a href=\"#L1778\">1778</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>greeting <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L1779\"><a href=\"#L1779\">1779</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>Deferred<span class=\"p\">()</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>_cb_greeting<span class=\"p\">)</span></td></tr><tr><th id=\"L1780\"><a href=\"#L1780\">1780</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred<span class=\"o\">.</span>addErrback<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>fail<span class=\"p\">)</span></td></tr><tr><th id=\"L1781\"><a href=\"#L1781\">1781</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>response <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L1782\"><a href=\"#L1782\">1782</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_failed <span class=\"o\">=</span>\u00a0<span class=\"mi\">0</span></td></tr><tr><th id=\"L1783\"><a href=\"#L1783\">1783</a></th><td></td></tr><tr><th id=\"L1784\"><a href=\"#L1784\">1784</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0error<span class=\"p\">):</span></td></tr><tr><th id=\"L1785\"><a href=\"#L1785\">1785</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Give an error to any queued deferreds.\"\"\"</span></td></tr><tr><th id=\"L1786\"><a href=\"#L1786\">1786</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_fail<span class=\"p\">(</span>error<span class=\"p\">)</span></td></tr><tr><th id=\"L1787\"><a href=\"#L1787\">1787</a></th><td></td></tr><tr><th id=\"L1788\"><a href=\"#L1788\">1788</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0error<span class=\"p\">):</span></td></tr><tr><th id=\"L1789\"><a href=\"#L1789\">1789</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Errback all queued deferreds.\"\"\"</span></td></tr><tr><th id=\"L1790\"><a href=\"#L1790\">1790</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_failed<span class=\"p\">:</span></td></tr><tr><th id=\"L1791\"><a href=\"#L1791\">1791</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># We're recursing; bail out here for simplicity</span></td></tr><tr><th id=\"L1792\"><a href=\"#L1792\">1792</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0error</td></tr><tr><th id=\"L1793\"><a href=\"#L1793\">1793</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_failed <span class=\"o\">=</span>\u00a0<span class=\"mi\">1</span></td></tr><tr><th id=\"L1794\"><a href=\"#L1794\">1794</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0ftpCommand <span class=\"ow\">in</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>actionQueue<span class=\"p\">:</span></td></tr><tr><th id=\"L1795\"><a href=\"#L1795\">1795</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ftpCommand<span class=\"o\">.</span>fail<span class=\"p\">(</span>failure<span class=\"o\">.</span>Failure<span class=\"p\">(</span>ConnectionLost<span class=\"p\">(</span><span class=\"s\">'FTP connection lost'</span><span class=\"p\">,</span>\u00a0error<span class=\"p\">)))</span></td></tr><tr><th id=\"L1796\"><a href=\"#L1796\">1796</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0error</td></tr><tr><th id=\"L1797\"><a href=\"#L1797\">1797</a></th><td></td></tr><tr><th id=\"L1798\"><a href=\"#L1798\">1798</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_cb_greeting</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0greeting<span class=\"p\">):</span></td></tr><tr><th id=\"L1799\"><a href=\"#L1799\">1799</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>greeting <span class=\"o\">=</span>\u00a0greeting</td></tr><tr><th id=\"L1800\"><a href=\"#L1800\">1800</a></th><td></td></tr><tr><th id=\"L1801\"><a href=\"#L1801\">1801</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">sendLine</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">):</span></td></tr><tr><th id=\"L1802\"><a href=\"#L1802\">1802</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"(Private) Sends a line, unless line is None.\"\"\"</span></td></tr><tr><th id=\"L1803\"><a href=\"#L1803\">1803</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0line <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1804\"><a href=\"#L1804\">1804</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span></td></tr><tr><th id=\"L1805\"><a href=\"#L1805\">1805</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 basic<span class=\"o\">.</span>LineReceiver<span class=\"o\">.</span>sendLine<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">)</span></td></tr><tr><th id=\"L1806\"><a href=\"#L1806\">1806</a></th><td></td></tr><tr><th id=\"L1807\"><a href=\"#L1807\">1807</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">sendNextCommand</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1808\"><a href=\"#L1808\">1808</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"(Private) Processes the next command in the queue.\"\"\"</span></td></tr><tr><th id=\"L1809\"><a href=\"#L1809\">1809</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 ftpCommand <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>popCommandQueue<span class=\"p\">()</span></td></tr><tr><th id=\"L1810\"><a href=\"#L1810\">1810</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0ftpCommand <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1811\"><a href=\"#L1811\">1811</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L1812\"><a href=\"#L1812\">1812</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span></td></tr><tr><th id=\"L1813\"><a href=\"#L1813\">1813</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0ftpCommand<span class=\"o\">.</span>ready<span class=\"p\">:</span></td></tr><tr><th id=\"L1814\"><a href=\"#L1814\">1814</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>actionQueue<span class=\"o\">.</span>insert<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0ftpCommand<span class=\"p\">)</span></td></tr><tr><th id=\"L1815\"><a href=\"#L1815\">1815</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 reactor<span class=\"o\">.</span>callLater<span class=\"p\">(</span><span class=\"mf\">1.0</span><span class=\"p\">,</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>sendNextCommand<span class=\"p\">)</span></td></tr><tr><th id=\"L1816\"><a href=\"#L1816\">1816</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred <span class=\"o\">=</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L1817\"><a href=\"#L1817\">1817</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span></td></tr><tr><th id=\"L1818\"><a href=\"#L1818\">1818</a></th><td></td></tr><tr><th id=\"L1819\"><a href=\"#L1819\">1819</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># FIXME: this if block doesn't belong in FTPClientBasic, it belongs in</span></td></tr><tr><th id=\"L1820\"><a href=\"#L1820\">1820</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#\u00a0 \u00a0 \u00a0 \u00a0 FTPClient.</span></td></tr><tr><th id=\"L1821\"><a href=\"#L1821\">1821</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0ftpCommand<span class=\"o\">.</span>text <span class=\"o\">==</span>\u00a0<span class=\"s\">'PORT'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1822\"><a href=\"#L1822\">1822</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>generatePortCommand<span class=\"p\">(</span>ftpCommand<span class=\"p\">)</span></td></tr><tr><th id=\"L1823\"><a href=\"#L1823\">1823</a></th><td></td></tr><tr><th id=\"L1824\"><a href=\"#L1824\">1824</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>debug<span class=\"p\">:</span></td></tr><tr><th id=\"L1825\"><a href=\"#L1825\">1825</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'&lt;-- </span><span class=\"si\">%s</span><span class=\"s\">'</span>\u00a0<span class=\"o\">%</span>\u00a0ftpCommand<span class=\"o\">.</span>text<span class=\"p\">)</span></td></tr><tr><th id=\"L1826\"><a href=\"#L1826\">1826</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred <span class=\"o\">=</span>\u00a0ftpCommand<span class=\"o\">.</span>deferred</td></tr><tr><th id=\"L1827\"><a href=\"#L1827\">1827</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendLine<span class=\"p\">(</span>ftpCommand<span class=\"o\">.</span>text<span class=\"p\">)</span></td></tr><tr><th id=\"L1828\"><a href=\"#L1828\">1828</a></th><td></td></tr><tr><th id=\"L1829\"><a href=\"#L1829\">1829</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">queueCommand</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0ftpCommand<span class=\"p\">):</span></td></tr><tr><th id=\"L1830\"><a href=\"#L1830\">1830</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Add an FTPCommand object to the queue.</span></td></tr><tr><th id=\"L1831\"><a href=\"#L1831\">1831</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1832\"><a href=\"#L1832\">1832</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 If it's the only thing in the queue, and we are connected and we aren't</span></td></tr><tr><th id=\"L1833\"><a href=\"#L1833\">1833</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 waiting for a response of an earlier command, the command will be sent</span></td></tr><tr><th id=\"L1834\"><a href=\"#L1834\">1834</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 immediately.</span></td></tr><tr><th id=\"L1835\"><a href=\"#L1835\">1835</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1836\"><a href=\"#L1836\">1836</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param ftpCommand: an L{FTPCommand}</span></td></tr><tr><th id=\"L1837\"><a href=\"#L1837\">1837</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1838\"><a href=\"#L1838\">1838</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>actionQueue<span class=\"o\">.</span>append<span class=\"p\">(</span>ftpCommand<span class=\"p\">)</span></td></tr><tr><th id=\"L1839\"><a href=\"#L1839\">1839</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"p\">(</span><span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>actionQueue<span class=\"p\">)</span>\u00a0<span class=\"o\">==</span>\u00a0<span class=\"mi\">1</span>\u00a0<span class=\"ow\">and</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>transport <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span>\u00a0<span class=\"ow\">and</span></td></tr><tr><th id=\"L1840\"><a href=\"#L1840\">1840</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1841\"><a href=\"#L1841\">1841</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendNextCommand<span class=\"p\">()</span></td></tr><tr><th id=\"L1842\"><a href=\"#L1842\">1842</a></th><td></td></tr><tr><th id=\"L1843\"><a href=\"#L1843\">1843</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">queueStringCommand</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0command<span class=\"p\">,</span>\u00a0public<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1844\"><a href=\"#L1844\">1844</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Queues a string to be issued as an FTP command</span></td></tr><tr><th id=\"L1845\"><a href=\"#L1845\">1845</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1846\"><a href=\"#L1846\">1846</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param command: string of an FTP command to queue</span></td></tr><tr><th id=\"L1847\"><a href=\"#L1847\">1847</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param public: a flag intended for internal use by FTPClient.\u00a0 Don't</span></td></tr><tr><th id=\"L1848\"><a href=\"#L1848\">1848</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 change it unless you know what you're doing.</span></td></tr><tr><th id=\"L1849\"><a href=\"#L1849\">1849</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1850\"><a href=\"#L1850\">1850</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: a L{Deferred} that will be called when the response to the</span></td></tr><tr><th id=\"L1851\"><a href=\"#L1851\">1851</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 command has been received.</span></td></tr><tr><th id=\"L1852\"><a href=\"#L1852\">1852</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1853\"><a href=\"#L1853\">1853</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 ftpCommand <span class=\"o\">=</span>\u00a0FTPCommand<span class=\"p\">(</span>command<span class=\"p\">,</span>\u00a0public<span class=\"p\">)</span></td></tr><tr><th id=\"L1854\"><a href=\"#L1854\">1854</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>queueCommand<span class=\"p\">(</span>ftpCommand<span class=\"p\">)</span></td></tr><tr><th id=\"L1855\"><a href=\"#L1855\">1855</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0ftpCommand<span class=\"o\">.</span>deferred</td></tr><tr><th id=\"L1856\"><a href=\"#L1856\">1856</a></th><td></td></tr><tr><th id=\"L1857\"><a href=\"#L1857\">1857</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">popCommandQueue</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1858\"><a href=\"#L1858\">1858</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Return the front element of the command queue, or None if empty.\"\"\"</span></td></tr><tr><th id=\"L1859\"><a href=\"#L1859\">1859</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>actionQueue<span class=\"p\">:</span></td></tr><tr><th id=\"L1860\"><a href=\"#L1860\">1860</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>actionQueue<span class=\"o\">.</span>pop<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1861\"><a href=\"#L1861\">1861</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1862\"><a href=\"#L1862\">1862</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L1863\"><a href=\"#L1863\">1863</a></th><td></td></tr><tr><th id=\"L1864\"><a href=\"#L1864\">1864</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">queueLogin</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0username<span class=\"p\">,</span>\u00a0password<span class=\"p\">):</span></td></tr><tr><th id=\"L1865\"><a href=\"#L1865\">1865</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Login: send the username, send the password.</span></td></tr><tr><th id=\"L1866\"><a href=\"#L1866\">1866</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 </span></td></tr><tr><th id=\"L1867\"><a href=\"#L1867\">1867</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 If the password is C{None}, the PASS command won't be sent.\u00a0 Also, if</span></td></tr><tr><th id=\"L1868\"><a href=\"#L1868\">1868</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 the response to the USER command has a response code of 230 (User logged</span></td></tr><tr><th id=\"L1869\"><a href=\"#L1869\">1869</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 in), then PASS won't be sent either.</span></td></tr><tr><th id=\"L1870\"><a href=\"#L1870\">1870</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1871\"><a href=\"#L1871\">1871</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Prepare the USER command</span></td></tr><tr><th id=\"L1872\"><a href=\"#L1872\">1872</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 deferreds <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L1873\"><a href=\"#L1873\">1873</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 userDeferred <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>queueStringCommand<span class=\"p\">(</span><span class=\"s\">'USER '</span>\u00a0<span class=\"o\">+</span>\u00a0username<span class=\"p\">,</span>\u00a0public<span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1874\"><a href=\"#L1874\">1874</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 deferreds<span class=\"o\">.</span>append<span class=\"p\">(</span>userDeferred<span class=\"p\">)</span></td></tr><tr><th id=\"L1875\"><a href=\"#L1875\">1875</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L1876\"><a href=\"#L1876\">1876</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Prepare the PASS command (if a password is given)</span></td></tr><tr><th id=\"L1877\"><a href=\"#L1877\">1877</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0password <span class=\"ow\">is</span>\u00a0<span class=\"ow\">not</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1878\"><a href=\"#L1878\">1878</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 passwordCmd <span class=\"o\">=</span>\u00a0FTPCommand<span class=\"p\">(</span><span class=\"s\">'PASS '</span>\u00a0<span class=\"o\">+</span>\u00a0password<span class=\"p\">,</span>\u00a0public<span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1879\"><a href=\"#L1879\">1879</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>queueCommand<span class=\"p\">(</span>passwordCmd<span class=\"p\">)</span></td></tr><tr><th id=\"L1880\"><a href=\"#L1880\">1880</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 deferreds<span class=\"o\">.</span>append<span class=\"p\">(</span>passwordCmd<span class=\"o\">.</span>deferred<span class=\"p\">)</span></td></tr><tr><th id=\"L1881\"><a href=\"#L1881\">1881</a></th><td></td></tr><tr><th id=\"L1882\"><a href=\"#L1882\">1882</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Avoid sending PASS if the response to USER is 230.</span></td></tr><tr><th id=\"L1883\"><a href=\"#L1883\">1883</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># (ref: http://cr.yp.to/ftp/user.html#user)</span></td></tr><tr><th id=\"L1884\"><a href=\"#L1884\">1884</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cancelPasswordIfNotNeeded</span><span class=\"p\">(</span>response<span class=\"p\">):</span></td></tr><tr><th id=\"L1885\"><a href=\"#L1885\">1885</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0response<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span>startswith<span class=\"p\">(</span><span class=\"s\">'230'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1886\"><a href=\"#L1886\">1886</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># No password needed!</span></td></tr><tr><th id=\"L1887\"><a href=\"#L1887\">1887</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>actionQueue<span class=\"o\">.</span>remove<span class=\"p\">(</span>passwordCmd<span class=\"p\">)</span></td></tr><tr><th id=\"L1888\"><a href=\"#L1888\">1888</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0response</td></tr><tr><th id=\"L1889\"><a href=\"#L1889\">1889</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 userDeferred<span class=\"o\">.</span>addCallback<span class=\"p\">(</span>cancelPasswordIfNotNeeded<span class=\"p\">)</span></td></tr><tr><th id=\"L1890\"><a href=\"#L1890\">1890</a></th><td></td></tr><tr><th id=\"L1891\"><a href=\"#L1891\">1891</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Error handling.</span></td></tr><tr><th id=\"L1892\"><a href=\"#L1892\">1892</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0deferred <span class=\"ow\">in</span>\u00a0deferreds<span class=\"p\">:</span></td></tr><tr><th id=\"L1893\"><a href=\"#L1893\">1893</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># If something goes wrong, call fail</span></td></tr><tr><th id=\"L1894\"><a href=\"#L1894\">1894</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 deferred<span class=\"o\">.</span>addErrback<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>fail<span class=\"p\">)</span></td></tr><tr><th id=\"L1895\"><a href=\"#L1895\">1895</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># But also swallow the error, so we don't cause spurious errors</span></td></tr><tr><th id=\"L1896\"><a href=\"#L1896\">1896</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 deferred<span class=\"o\">.</span>addErrback<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0x<span class=\"p\">:</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1897\"><a href=\"#L1897\">1897</a></th><td></td></tr><tr><th id=\"L1898\"><a href=\"#L1898\">1898</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">lineReceived</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">):</span></td></tr><tr><th id=\"L1899\"><a href=\"#L1899\">1899</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"(Private) Parses the response messages from the FTP server.\"\"\"</span></td></tr><tr><th id=\"L1900\"><a href=\"#L1900\">1900</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Add this line to the current response</span></td></tr><tr><th id=\"L1901\"><a href=\"#L1901\">1901</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>debug<span class=\"p\">:</span></td></tr><tr><th id=\"L1902\"><a href=\"#L1902\">1902</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'--&gt; </span><span class=\"si\">%s</span><span class=\"s\">'</span>\u00a0<span class=\"o\">%</span>\u00a0line<span class=\"p\">)</span></td></tr><tr><th id=\"L1903\"><a href=\"#L1903\">1903</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>response<span class=\"o\">.</span>append<span class=\"p\">(</span>line<span class=\"p\">)</span></td></tr><tr><th id=\"L1904\"><a href=\"#L1904\">1904</a></th><td></td></tr><tr><th id=\"L1905\"><a href=\"#L1905\">1905</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Bail out if this isn't the last line of a response</span></td></tr><tr><th id=\"L1906\"><a href=\"#L1906\">1906</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># The last line of response starts with 3 digits followed by a space</span></td></tr><tr><th id=\"L1907\"><a href=\"#L1907\">1907</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 codeIsValid <span class=\"o\">=</span>\u00a0re<span class=\"o\">.</span>match<span class=\"p\">(</span><span class=\"s\">r'\\d{3} '</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">)</span></td></tr><tr><th id=\"L1908\"><a href=\"#L1908\">1908</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"ow\">not</span>\u00a0codeIsValid<span class=\"p\">:</span></td></tr><tr><th id=\"L1909\"><a href=\"#L1909\">1909</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span></td></tr><tr><th id=\"L1910\"><a href=\"#L1910\">1910</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 </td></tr><tr><th id=\"L1911\"><a href=\"#L1911\">1911</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 code <span class=\"o\">=</span>\u00a0line<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"mi\">3</span><span class=\"p\">]</span></td></tr><tr><th id=\"L1912\"><a href=\"#L1912\">1912</a></th><td></td></tr><tr><th id=\"L1913\"><a href=\"#L1913\">1913</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Ignore marks</span></td></tr><tr><th id=\"L1914\"><a href=\"#L1914\">1914</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0code<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\u00a0<span class=\"o\">==</span>\u00a0<span class=\"s\">'1'</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1915\"><a href=\"#L1915\">1915</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span></td></tr><tr><th id=\"L1916\"><a href=\"#L1916\">1916</a></th><td></td></tr><tr><th id=\"L1917\"><a href=\"#L1917\">1917</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Check that we were expecting a response</span></td></tr><tr><th id=\"L1918\"><a href=\"#L1918\">1918</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1919\"><a href=\"#L1919\">1919</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>fail<span class=\"p\">(</span>UnexpectedResponse<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>response<span class=\"p\">))</span></td></tr><tr><th id=\"L1920\"><a href=\"#L1920\">1920</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span></td></tr><tr><th id=\"L1921\"><a href=\"#L1921\">1921</a></th><td></td></tr><tr><th id=\"L1922\"><a href=\"#L1922\">1922</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Reset the response</span></td></tr><tr><th id=\"L1923\"><a href=\"#L1923\">1923</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 response <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>response</td></tr><tr><th id=\"L1924\"><a href=\"#L1924\">1924</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>response <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L1925\"><a href=\"#L1925\">1925</a></th><td></td></tr><tr><th id=\"L1926\"><a href=\"#L1926\">1926</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Look for a success or error code, and call the appropriate callback</span></td></tr><tr><th id=\"L1927\"><a href=\"#L1927\">1927</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0code<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\u00a0<span class=\"ow\">in</span>\u00a0<span class=\"p\">(</span><span class=\"s\">'2'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'3'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1928\"><a href=\"#L1928\">1928</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Success</span></td></tr><tr><th id=\"L1929\"><a href=\"#L1929\">1929</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred<span class=\"o\">.</span>callback<span class=\"p\">(</span>response<span class=\"p\">)</span></td></tr><tr><th id=\"L1930\"><a href=\"#L1930\">1930</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">elif</span>\u00a0code<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\u00a0<span class=\"ow\">in</span>\u00a0<span class=\"p\">(</span><span class=\"s\">'4'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'5'</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1931\"><a href=\"#L1931\">1931</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Failure</span></td></tr><tr><th id=\"L1932\"><a href=\"#L1932\">1932</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred<span class=\"o\">.</span>errback<span class=\"p\">(</span>failure<span class=\"o\">.</span>Failure<span class=\"p\">(</span>CommandFailed<span class=\"p\">(</span>response<span class=\"p\">)))</span></td></tr><tr><th id=\"L1933\"><a href=\"#L1933\">1933</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L1934\"><a href=\"#L1934\">1934</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># This shouldn't happen unless something screwed up.</span></td></tr><tr><th id=\"L1935\"><a href=\"#L1935\">1935</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log<span class=\"o\">.</span>msg<span class=\"p\">(</span><span class=\"s\">'Server sent invalid response code </span><span class=\"si\">%s</span><span class=\"s\">'</span>\u00a0<span class=\"o\">%</span>\u00a0<span class=\"p\">(</span>code<span class=\"p\">,))</span></td></tr><tr><th id=\"L1936\"><a href=\"#L1936\">1936</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>nextDeferred<span class=\"o\">.</span>errback<span class=\"p\">(</span>failure<span class=\"o\">.</span>Failure<span class=\"p\">(</span>BadResponse<span class=\"p\">(</span>response<span class=\"p\">)))</span></td></tr><tr><th id=\"L1937\"><a href=\"#L1937\">1937</a></th><td></td></tr><tr><th id=\"L1938\"><a href=\"#L1938\">1938</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Run the next command</span></td></tr><tr><th id=\"L1939\"><a href=\"#L1939\">1939</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>sendNextCommand<span class=\"p\">()</span></td></tr><tr><th id=\"L1940\"><a href=\"#L1940\">1940</a></th><td></td></tr><tr><th id=\"L1941\"><a href=\"#L1941\">1941</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">connectionLost</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0reason<span class=\"p\">):</span></td></tr><tr><th id=\"L1942\"><a href=\"#L1942\">1942</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_fail<span class=\"p\">(</span>reason<span class=\"p\">)</span></td></tr><tr><th id=\"L1943\"><a href=\"#L1943\">1943</a></th><td></td></tr><tr><th id=\"L1944\"><a href=\"#L1944\">1944</a></th><td></td></tr><tr><th id=\"L1945\"><a href=\"#L1945\">1945</a></th><td></td></tr><tr><th id=\"L1946\"><a href=\"#L1946\">1946</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">_PassiveConnectionFactory</span><span class=\"p\">(</span>protocol<span class=\"o\">.</span>ClientFactory<span class=\"p\">):</span></td></tr><tr><th id=\"L1947\"><a href=\"#L1947\">1947</a></th><td>\u00a0 \u00a0 noisy <span class=\"o\">=</span>\u00a0<span class=\"bp\">False</span></td></tr><tr><th id=\"L1948\"><a href=\"#L1948\">1948</a></th><td></td></tr><tr><th id=\"L1949\"><a href=\"#L1949\">1949</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0protoInstance<span class=\"p\">):</span></td></tr><tr><th id=\"L1950\"><a href=\"#L1950\">1950</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>protoInstance <span class=\"o\">=</span>\u00a0protoInstance</td></tr><tr><th id=\"L1951\"><a href=\"#L1951\">1951</a></th><td></td></tr><tr><th id=\"L1952\"><a href=\"#L1952\">1952</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">buildProtocol</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0ignored<span class=\"p\">):</span></td></tr><tr><th id=\"L1953\"><a href=\"#L1953\">1953</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>protoInstance<span class=\"o\">.</span>factory <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span></td></tr><tr><th id=\"L1954\"><a href=\"#L1954\">1954</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>protoInstance</td></tr><tr><th id=\"L1955\"><a href=\"#L1955\">1955</a></th><td></td></tr><tr><th id=\"L1956\"><a href=\"#L1956\">1956</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">clientConnectionFailed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0connector<span class=\"p\">,</span>\u00a0reason<span class=\"p\">):</span></td></tr><tr><th id=\"L1957\"><a href=\"#L1957\">1957</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 e <span class=\"o\">=</span>\u00a0FTPError<span class=\"p\">(</span><span class=\"s\">'Connection Failed'</span><span class=\"p\">,</span>\u00a0reason<span class=\"p\">)</span></td></tr><tr><th id=\"L1958\"><a href=\"#L1958\">1958</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>protoInstance<span class=\"o\">.</span>deferred<span class=\"o\">.</span>errback<span class=\"p\">(</span>e<span class=\"p\">)</span></td></tr><tr><th id=\"L1959\"><a href=\"#L1959\">1959</a></th><td></td></tr><tr><th id=\"L1960\"><a href=\"#L1960\">1960</a></th><td></td></tr><tr><th id=\"L1961\"><a href=\"#L1961\">1961</a></th><td></td></tr><tr><th id=\"L1962\"><a href=\"#L1962\">1962</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPClient</span><span class=\"p\">(</span>FTPClientBasic<span class=\"p\">):</span></td></tr><tr><th id=\"L1963\"><a href=\"#L1963\">1963</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1964\"><a href=\"#L1964\">1964</a></th><td><span class=\"sd\">\u00a0 \u00a0 A Twisted FTP Client</span></td></tr><tr><th id=\"L1965\"><a href=\"#L1965\">1965</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1966\"><a href=\"#L1966\">1966</a></th><td><span class=\"sd\">\u00a0 \u00a0 Supports active and passive transfers.</span></td></tr><tr><th id=\"L1967\"><a href=\"#L1967\">1967</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1968\"><a href=\"#L1968\">1968</a></th><td><span class=\"sd\">\u00a0 \u00a0 This class is semi-stable.</span></td></tr><tr><th id=\"L1969\"><a href=\"#L1969\">1969</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1970\"><a href=\"#L1970\">1970</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar passive: See description in __init__.</span></td></tr><tr><th id=\"L1971\"><a href=\"#L1971\">1971</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1972\"><a href=\"#L1972\">1972</a></th><td>\u00a0 \u00a0 connectFactory <span class=\"o\">=</span>\u00a0reactor<span class=\"o\">.</span>connectTCP</td></tr><tr><th id=\"L1973\"><a href=\"#L1973\">1973</a></th><td></td></tr><tr><th id=\"L1974\"><a href=\"#L1974\">1974</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0username<span class=\"o\">=</span><span class=\"s\">'anonymous'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L1975\"><a href=\"#L1975\">1975</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0password<span class=\"o\">=</span><span class=\"s\">'twisted@twistedmatrix.com'</span><span class=\"p\">,</span></td></tr><tr><th id=\"L1976\"><a href=\"#L1976\">1976</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0passive<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">):</span></td></tr><tr><th id=\"L1977\"><a href=\"#L1977\">1977</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1978\"><a href=\"#L1978\">1978</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Constructor.</span></td></tr><tr><th id=\"L1979\"><a href=\"#L1979\">1979</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1980\"><a href=\"#L1980\">1980</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 I will login as soon as I receive the welcome message from the server.</span></td></tr><tr><th id=\"L1981\"><a href=\"#L1981\">1981</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L1982\"><a href=\"#L1982\">1982</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param username: FTP username</span></td></tr><tr><th id=\"L1983\"><a href=\"#L1983\">1983</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param password: FTP password</span></td></tr><tr><th id=\"L1984\"><a href=\"#L1984\">1984</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param passive: flag that controls if I use active or passive data</span></td></tr><tr><th id=\"L1985\"><a href=\"#L1985\">1985</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 connections.\u00a0 You can also change this after construction by</span></td></tr><tr><th id=\"L1986\"><a href=\"#L1986\">1986</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 assigning to self.passive.</span></td></tr><tr><th id=\"L1987\"><a href=\"#L1987\">1987</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1988\"><a href=\"#L1988\">1988</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 FTPClientBasic<span class=\"o\">.</span>__init__<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span></td></tr><tr><th id=\"L1989\"><a href=\"#L1989\">1989</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>queueLogin<span class=\"p\">(</span>username<span class=\"p\">,</span>\u00a0password<span class=\"p\">)</span></td></tr><tr><th id=\"L1990\"><a href=\"#L1990\">1990</a></th><td></td></tr><tr><th id=\"L1991\"><a href=\"#L1991\">1991</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>passive <span class=\"o\">=</span>\u00a0passive</td></tr><tr><th id=\"L1992\"><a href=\"#L1992\">1992</a></th><td></td></tr><tr><th id=\"L1993\"><a href=\"#L1993\">1993</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0error<span class=\"p\">):</span></td></tr><tr><th id=\"L1994\"><a href=\"#L1994\">1994</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L1995\"><a href=\"#L1995\">1995</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Disconnect, and also give an error to any queued deferreds.</span></td></tr><tr><th id=\"L1996\"><a href=\"#L1996\">1996</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L1997\"><a href=\"#L1997\">1997</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L1998\"><a href=\"#L1998\">1998</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>_fail<span class=\"p\">(</span>error<span class=\"p\">)</span></td></tr><tr><th id=\"L1999\"><a href=\"#L1999\">1999</a></th><td></td></tr><tr><th id=\"L2000\"><a href=\"#L2000\">2000</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">receiveFromConnection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0commands<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">):</span></td></tr><tr><th id=\"L2001\"><a href=\"#L2001\">2001</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2002\"><a href=\"#L2002\">2002</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Retrieves a file or listing generated by the given command,</span></td></tr><tr><th id=\"L2003\"><a href=\"#L2003\">2003</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 feeding it to the given protocol.</span></td></tr><tr><th id=\"L2004\"><a href=\"#L2004\">2004</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2005\"><a href=\"#L2005\">2005</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param command: list of strings of FTP commands to execute then receive</span></td></tr><tr><th id=\"L2006\"><a href=\"#L2006\">2006</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 the results of (e.g. LIST, RETR)</span></td></tr><tr><th id=\"L2007\"><a href=\"#L2007\">2007</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param protocol: A L{Protocol} *instance* e.g. an</span></td></tr><tr><th id=\"L2008\"><a href=\"#L2008\">2008</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 L{FTPFileListProtocol}, or something that can be adapted to one.</span></td></tr><tr><th id=\"L2009\"><a href=\"#L2009\">2009</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Typically this will be an L{IConsumer} implemenation.</span></td></tr><tr><th id=\"L2010\"><a href=\"#L2010\">2010</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2011\"><a href=\"#L2011\">2011</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: L{Deferred}.</span></td></tr><tr><th id=\"L2012\"><a href=\"#L2012\">2012</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2013\"><a href=\"#L2013\">2013</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 protocol <span class=\"o\">=</span>\u00a0interfaces<span class=\"o\">.</span>IProtocol<span class=\"p\">(</span>protocol<span class=\"p\">)</span></td></tr><tr><th id=\"L2014\"><a href=\"#L2014\">2014</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 wrapper <span class=\"o\">=</span>\u00a0ProtocolWrapper<span class=\"p\">(</span>protocol<span class=\"p\">,</span>\u00a0defer<span class=\"o\">.</span>Deferred<span class=\"p\">())</span></td></tr><tr><th id=\"L2015\"><a href=\"#L2015\">2015</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_openDataConnection<span class=\"p\">(</span>commands<span class=\"p\">,</span>\u00a0wrapper<span class=\"p\">)</span></td></tr><tr><th id=\"L2016\"><a href=\"#L2016\">2016</a></th><td></td></tr><tr><th id=\"L2017\"><a href=\"#L2017\">2017</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">queueLogin</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0username<span class=\"p\">,</span>\u00a0password<span class=\"p\">):</span></td></tr><tr><th id=\"L2018\"><a href=\"#L2018\">2018</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2019\"><a href=\"#L2019\">2019</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Login: send the username, send the password, and</span></td></tr><tr><th id=\"L2020\"><a href=\"#L2020\">2020</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 set retrieval mode to binary</span></td></tr><tr><th id=\"L2021\"><a href=\"#L2021\">2021</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2022\"><a href=\"#L2022\">2022</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 FTPClientBasic<span class=\"o\">.</span>queueLogin<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0username<span class=\"p\">,</span>\u00a0password<span class=\"p\">)</span></td></tr><tr><th id=\"L2023\"><a href=\"#L2023\">2023</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>queueStringCommand<span class=\"p\">(</span><span class=\"s\">'TYPE I'</span><span class=\"p\">,</span>\u00a0public<span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2024\"><a href=\"#L2024\">2024</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># If something goes wrong, call fail</span></td></tr><tr><th id=\"L2025\"><a href=\"#L2025\">2025</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addErrback<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>fail<span class=\"p\">)</span></td></tr><tr><th id=\"L2026\"><a href=\"#L2026\">2026</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># But also swallow the error, so we don't cause spurious errors</span></td></tr><tr><th id=\"L2027\"><a href=\"#L2027\">2027</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addErrback<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0x<span class=\"p\">:</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2028\"><a href=\"#L2028\">2028</a></th><td></td></tr><tr><th id=\"L2029\"><a href=\"#L2029\">2029</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">sendToConnection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0commands<span class=\"p\">):</span></td></tr><tr><th id=\"L2030\"><a href=\"#L2030\">2030</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2031\"><a href=\"#L2031\">2031</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 XXX</span></td></tr><tr><th id=\"L2032\"><a href=\"#L2032\">2032</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2033\"><a href=\"#L2033\">2033</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: A tuple of two L{Deferred}s:</span></td></tr><tr><th id=\"L2034\"><a href=\"#L2034\">2034</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - L{Deferred} L{IFinishableConsumer}. You must call</span></td></tr><tr><th id=\"L2035\"><a href=\"#L2035\">2035</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 the C{finish} method on the IFinishableConsumer when the file</span></td></tr><tr><th id=\"L2036\"><a href=\"#L2036\">2036</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 is completely transferred.</span></td></tr><tr><th id=\"L2037\"><a href=\"#L2037\">2037</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - L{Deferred} list of control-connection responses.</span></td></tr><tr><th id=\"L2038\"><a href=\"#L2038\">2038</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2039\"><a href=\"#L2039\">2039</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 s <span class=\"o\">=</span>\u00a0SenderProtocol<span class=\"p\">()</span></td></tr><tr><th id=\"L2040\"><a href=\"#L2040\">2040</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 r <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>_openDataConnection<span class=\"p\">(</span>commands<span class=\"p\">,</span>\u00a0s<span class=\"p\">)</span></td></tr><tr><th id=\"L2041\"><a href=\"#L2041\">2041</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"p\">(</span>s<span class=\"o\">.</span>connectedDeferred<span class=\"p\">,</span>\u00a0r<span class=\"p\">)</span></td></tr><tr><th id=\"L2042\"><a href=\"#L2042\">2042</a></th><td></td></tr><tr><th id=\"L2043\"><a href=\"#L2043\">2043</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">_openDataConnection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0commands<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">):</span></td></tr><tr><th id=\"L2044\"><a href=\"#L2044\">2044</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2045\"><a href=\"#L2045\">2045</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 This method returns a DeferredList.</span></td></tr><tr><th id=\"L2046\"><a href=\"#L2046\">2046</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2047\"><a href=\"#L2047\">2047</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 cmds <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span>FTPCommand<span class=\"p\">(</span>command<span class=\"p\">,</span>\u00a0public<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\u00a0<span class=\"k\">for</span>\u00a0command <span class=\"ow\">in</span>\u00a0commands<span class=\"p\">]</span></td></tr><tr><th id=\"L2048\"><a href=\"#L2048\">2048</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 cmdsDeferred <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>DeferredList<span class=\"p\">([</span>cmd<span class=\"o\">.</span>deferred <span class=\"k\">for</span>\u00a0cmd <span class=\"ow\">in</span>\u00a0cmds<span class=\"p\">],</span></td></tr><tr><th id=\"L2049\"><a href=\"#L2049\">2049</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fireOnOneErrback<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span>\u00a0consumeErrors<span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2050\"><a href=\"#L2050\">2050</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 cmdsDeferred<span class=\"o\">.</span>addErrback<span class=\"p\">(</span>_unwrapFirstError<span class=\"p\">)</span></td></tr><tr><th id=\"L2051\"><a href=\"#L2051\">2051</a></th><td></td></tr><tr><th id=\"L2052\"><a href=\"#L2052\">2052</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>passive<span class=\"p\">:</span></td></tr><tr><th id=\"L2053\"><a href=\"#L2053\">2053</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Hack: use a mutable object to sneak a variable out of the</span></td></tr><tr><th id=\"L2054\"><a href=\"#L2054\">2054</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># scope of doPassive</span></td></tr><tr><th id=\"L2055\"><a href=\"#L2055\">2055</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 _mutable <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"bp\">None</span><span class=\"p\">]</span></td></tr><tr><th id=\"L2056\"><a href=\"#L2056\">2056</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">doPassive</span><span class=\"p\">(</span>response<span class=\"p\">):</span></td></tr><tr><th id=\"L2057\"><a href=\"#L2057\">2057</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Connect to the port specified in the response to PASV\"\"\"</span></td></tr><tr><th id=\"L2058\"><a href=\"#L2058\">2058</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 host<span class=\"p\">,</span>\u00a0port <span class=\"o\">=</span>\u00a0decodeHostPort<span class=\"p\">(</span>response<span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">][</span><span class=\"mi\">4</span><span class=\"p\">:])</span></td></tr><tr><th id=\"L2059\"><a href=\"#L2059\">2059</a></th><td></td></tr><tr><th id=\"L2060\"><a href=\"#L2060\">2060</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 f <span class=\"o\">=</span>\u00a0_PassiveConnectionFactory<span class=\"p\">(</span>protocol<span class=\"p\">)</span></td></tr><tr><th id=\"L2061\"><a href=\"#L2061\">2061</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 _mutable<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>connectFactory<span class=\"p\">(</span>host<span class=\"p\">,</span>\u00a0port<span class=\"p\">,</span>\u00a0f<span class=\"p\">)</span></td></tr><tr><th id=\"L2062\"><a href=\"#L2062\">2062</a></th><td></td></tr><tr><th id=\"L2063\"><a href=\"#L2063\">2063</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pasvCmd <span class=\"o\">=</span>\u00a0FTPCommand<span class=\"p\">(</span><span class=\"s\">'PASV'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2064\"><a href=\"#L2064\">2064</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>queueCommand<span class=\"p\">(</span>pasvCmd<span class=\"p\">)</span></td></tr><tr><th id=\"L2065\"><a href=\"#L2065\">2065</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pasvCmd<span class=\"o\">.</span>deferred<span class=\"o\">.</span>addCallback<span class=\"p\">(</span>doPassive<span class=\"p\">)</span><span class=\"o\">.</span>addErrback<span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span>fail<span class=\"p\">)</span></td></tr><tr><th id=\"L2066\"><a href=\"#L2066\">2066</a></th><td></td></tr><tr><th id=\"L2067\"><a href=\"#L2067\">2067</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 results <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span>cmdsDeferred<span class=\"p\">,</span>\u00a0pasvCmd<span class=\"o\">.</span>deferred<span class=\"p\">,</span>\u00a0protocol<span class=\"o\">.</span>deferred<span class=\"p\">]</span></td></tr><tr><th id=\"L2068\"><a href=\"#L2068\">2068</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>DeferredList<span class=\"p\">(</span>results<span class=\"p\">,</span>\u00a0fireOnOneErrback<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\u00a0consumeErrors<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2069\"><a href=\"#L2069\">2069</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addErrback<span class=\"p\">(</span>_unwrapFirstError<span class=\"p\">)</span></td></tr><tr><th id=\"L2070\"><a href=\"#L2070\">2070</a></th><td></td></tr><tr><th id=\"L2071\"><a href=\"#L2071\">2071</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Ensure the connection is always closed</span></td></tr><tr><th id=\"L2072\"><a href=\"#L2072\">2072</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">close</span><span class=\"p\">(</span>x<span class=\"p\">,</span>\u00a0m<span class=\"o\">=</span>_mutable<span class=\"p\">):</span></td></tr><tr><th id=\"L2073\"><a href=\"#L2073\">2073</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 m<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\u00a0<span class=\"ow\">and</span>\u00a0m<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span>disconnect<span class=\"p\">()</span></td></tr><tr><th id=\"L2074\"><a href=\"#L2074\">2074</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0x</td></tr><tr><th id=\"L2075\"><a href=\"#L2075\">2075</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"o\">.</span>addBoth<span class=\"p\">(</span>close<span class=\"p\">)</span></td></tr><tr><th id=\"L2076\"><a href=\"#L2076\">2076</a></th><td></td></tr><tr><th id=\"L2077\"><a href=\"#L2077\">2077</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2078\"><a href=\"#L2078\">2078</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># We just place a marker command in the queue, and will fill in</span></td></tr><tr><th id=\"L2079\"><a href=\"#L2079\">2079</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># the host and port numbers later (see generatePortCommand)</span></td></tr><tr><th id=\"L2080\"><a href=\"#L2080\">2080</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 portCmd <span class=\"o\">=</span>\u00a0FTPCommand<span class=\"p\">(</span><span class=\"s\">'PORT'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2081\"><a href=\"#L2081\">2081</a></th><td></td></tr><tr><th id=\"L2082\"><a href=\"#L2082\">2082</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Ok, now we jump through a few hoops here.</span></td></tr><tr><th id=\"L2083\"><a href=\"#L2083\">2083</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># This is the problem: a transfer is not to be trusted as complete</span></td></tr><tr><th id=\"L2084\"><a href=\"#L2084\">2084</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># until we get both the \"226 Transfer complete\" message on the</span></td></tr><tr><th id=\"L2085\"><a href=\"#L2085\">2085</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># control connection, and the data socket is closed.\u00a0 Thus, we use</span></td></tr><tr><th id=\"L2086\"><a href=\"#L2086\">2086</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># a DeferredList to make sure we only fire the callback at the</span></td></tr><tr><th id=\"L2087\"><a href=\"#L2087\">2087</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># right time.</span></td></tr><tr><th id=\"L2088\"><a href=\"#L2088\">2088</a></th><td></td></tr><tr><th id=\"L2089\"><a href=\"#L2089\">2089</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 portCmd<span class=\"o\">.</span>transferDeferred <span class=\"o\">=</span>\u00a0protocol<span class=\"o\">.</span>deferred</td></tr><tr><th id=\"L2090\"><a href=\"#L2090\">2090</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 portCmd<span class=\"o\">.</span>protocol <span class=\"o\">=</span>\u00a0protocol</td></tr><tr><th id=\"L2091\"><a href=\"#L2091\">2091</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 portCmd<span class=\"o\">.</span>deferred<span class=\"o\">.</span>addErrback<span class=\"p\">(</span>portCmd<span class=\"o\">.</span>transferDeferred<span class=\"o\">.</span>errback<span class=\"p\">)</span></td></tr><tr><th id=\"L2092\"><a href=\"#L2092\">2092</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>queueCommand<span class=\"p\">(</span>portCmd<span class=\"p\">)</span></td></tr><tr><th id=\"L2093\"><a href=\"#L2093\">2093</a></th><td></td></tr><tr><th id=\"L2094\"><a href=\"#L2094\">2094</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Create dummy functions for the next callback to call.</span></td></tr><tr><th id=\"L2095\"><a href=\"#L2095\">2095</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># These will also be replaced with real functions in</span></td></tr><tr><th id=\"L2096\"><a href=\"#L2096\">2096</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># generatePortCommand.</span></td></tr><tr><th id=\"L2097\"><a href=\"#L2097\">2097</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 portCmd<span class=\"o\">.</span>loseConnection <span class=\"o\">=</span>\u00a0<span class=\"k\">lambda</span>\u00a0result<span class=\"p\">:</span>\u00a0result</td></tr><tr><th id=\"L2098\"><a href=\"#L2098\">2098</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 portCmd<span class=\"o\">.</span>fail <span class=\"o\">=</span>\u00a0<span class=\"k\">lambda</span>\u00a0error<span class=\"p\">:</span>\u00a0error</td></tr><tr><th id=\"L2099\"><a href=\"#L2099\">2099</a></th><td></td></tr><tr><th id=\"L2100\"><a href=\"#L2100\">2100</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Ensure that the connection always gets closed</span></td></tr><tr><th id=\"L2101\"><a href=\"#L2101\">2101</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cmdsDeferred<span class=\"o\">.</span>addErrback<span class=\"p\">(</span><span class=\"k\">lambda</span>\u00a0e<span class=\"p\">,</span>\u00a0pc<span class=\"o\">=</span>portCmd<span class=\"p\">:</span>\u00a0pc<span class=\"o\">.</span>fail<span class=\"p\">(</span>e<span class=\"p\">)</span>\u00a0<span class=\"ow\">or</span>\u00a0e<span class=\"p\">)</span></td></tr><tr><th id=\"L2102\"><a href=\"#L2102\">2102</a></th><td></td></tr><tr><th id=\"L2103\"><a href=\"#L2103\">2103</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 results <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span>cmdsDeferred<span class=\"p\">,</span>\u00a0portCmd<span class=\"o\">.</span>deferred<span class=\"p\">,</span>\u00a0portCmd<span class=\"o\">.</span>transferDeferred<span class=\"p\">]</span></td></tr><tr><th id=\"L2104\"><a href=\"#L2104\">2104</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0defer<span class=\"o\">.</span>DeferredList<span class=\"p\">(</span>results<span class=\"p\">,</span>\u00a0fireOnOneErrback<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\u00a0consumeErrors<span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2105\"><a href=\"#L2105\">2105</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># XXX: d.addErrback(_unwrapFirstError), but add a test.</span></td></tr><tr><th id=\"L2106\"><a href=\"#L2106\">2106</a></th><td></td></tr><tr><th id=\"L2107\"><a href=\"#L2107\">2107</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">for</span>\u00a0cmd <span class=\"ow\">in</span>\u00a0cmds<span class=\"p\">:</span></td></tr><tr><th id=\"L2108\"><a href=\"#L2108\">2108</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>queueCommand<span class=\"p\">(</span>cmd<span class=\"p\">)</span></td></tr><tr><th id=\"L2109\"><a href=\"#L2109\">2109</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L2110\"><a href=\"#L2110\">2110</a></th><td></td></tr><tr><th id=\"L2111\"><a href=\"#L2111\">2111</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">generatePortCommand</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0portCmd<span class=\"p\">):</span></td></tr><tr><th id=\"L2112\"><a href=\"#L2112\">2112</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2113\"><a href=\"#L2113\">2113</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 (Private) Generates the text of a given PORT command.</span></td></tr><tr><th id=\"L2114\"><a href=\"#L2114\">2114</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2115\"><a href=\"#L2115\">2115</a></th><td></td></tr><tr><th id=\"L2116\"><a href=\"#L2116\">2116</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># The problem is that we don't create the listening port until we need</span></td></tr><tr><th id=\"L2117\"><a href=\"#L2117\">2117</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># it for various reasons, and so we have to muck about to figure out</span></td></tr><tr><th id=\"L2118\"><a href=\"#L2118\">2118</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># what interface and port it's listening on, and then finally we can</span></td></tr><tr><th id=\"L2119\"><a href=\"#L2119\">2119</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># create the text of the PORT command to send to the FTP server.</span></td></tr><tr><th id=\"L2120\"><a href=\"#L2120\">2120</a></th><td></td></tr><tr><th id=\"L2121\"><a href=\"#L2121\">2121</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># FIXME: This method is far too ugly.</span></td></tr><tr><th id=\"L2122\"><a href=\"#L2122\">2122</a></th><td></td></tr><tr><th id=\"L2123\"><a href=\"#L2123\">2123</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># FIXME: The best solution is probably to only create the data port</span></td></tr><tr><th id=\"L2124\"><a href=\"#L2124\">2124</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#\u00a0 \u00a0 \u00a0 \u00a0 once per FTPClient, and just recycle it for each new download.</span></td></tr><tr><th id=\"L2125\"><a href=\"#L2125\">2125</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\">#\u00a0 \u00a0 \u00a0 \u00a0 This should be ok, because we don't pipeline commands.</span></td></tr><tr><th id=\"L2126\"><a href=\"#L2126\">2126</a></th><td></td></tr><tr><th id=\"L2127\"><a href=\"#L2127\">2127</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Start listening on a port</span></td></tr><tr><th id=\"L2128\"><a href=\"#L2128\">2128</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 factory <span class=\"o\">=</span>\u00a0FTPDataPortFactory<span class=\"p\">()</span></td></tr><tr><th id=\"L2129\"><a href=\"#L2129\">2129</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 factory<span class=\"o\">.</span>protocol <span class=\"o\">=</span>\u00a0portCmd<span class=\"o\">.</span>protocol</td></tr><tr><th id=\"L2130\"><a href=\"#L2130\">2130</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 listener <span class=\"o\">=</span>\u00a0reactor<span class=\"o\">.</span>listenTCP<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0factory<span class=\"p\">)</span></td></tr><tr><th id=\"L2131\"><a href=\"#L2131\">2131</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 factory<span class=\"o\">.</span>port <span class=\"o\">=</span>\u00a0listener</td></tr><tr><th id=\"L2132\"><a href=\"#L2132\">2132</a></th><td></td></tr><tr><th id=\"L2133\"><a href=\"#L2133\">2133</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Ensure we close the listening port if something goes wrong</span></td></tr><tr><th id=\"L2134\"><a href=\"#L2134\">2134</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">listenerFail</span><span class=\"p\">(</span>error<span class=\"p\">,</span>\u00a0listener<span class=\"o\">=</span>listener<span class=\"p\">):</span></td></tr><tr><th id=\"L2135\"><a href=\"#L2135\">2135</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0listener<span class=\"o\">.</span>connected<span class=\"p\">:</span></td></tr><tr><th id=\"L2136\"><a href=\"#L2136\">2136</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 listener<span class=\"o\">.</span>loseConnection<span class=\"p\">()</span></td></tr><tr><th id=\"L2137\"><a href=\"#L2137\">2137</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0error</td></tr><tr><th id=\"L2138\"><a href=\"#L2138\">2138</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 portCmd<span class=\"o\">.</span>fail <span class=\"o\">=</span>\u00a0listenerFail</td></tr><tr><th id=\"L2139\"><a href=\"#L2139\">2139</a></th><td></td></tr><tr><th id=\"L2140\"><a href=\"#L2140\">2140</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Construct crufty FTP magic numbers that represent host &amp; port</span></td></tr><tr><th id=\"L2141\"><a href=\"#L2141\">2141</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 host <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>transport<span class=\"o\">.</span>getHost<span class=\"p\">()</span><span class=\"o\">.</span>host</td></tr><tr><th id=\"L2142\"><a href=\"#L2142\">2142</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 port <span class=\"o\">=</span>\u00a0listener<span class=\"o\">.</span>getHost<span class=\"p\">()</span><span class=\"o\">.</span>port</td></tr><tr><th id=\"L2143\"><a href=\"#L2143\">2143</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 portCmd<span class=\"o\">.</span>text <span class=\"o\">=</span>\u00a0<span class=\"s\">'PORT '</span>\u00a0<span class=\"o\">+</span>\u00a0encodeHostPort<span class=\"p\">(</span>host<span class=\"p\">,</span>\u00a0port<span class=\"p\">)</span></td></tr><tr><th id=\"L2144\"><a href=\"#L2144\">2144</a></th><td></td></tr><tr><th id=\"L2145\"><a href=\"#L2145\">2145</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">escapePath</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L2146\"><a href=\"#L2146\">2146</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2147\"><a href=\"#L2147\">2147</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Returns a FTP escaped path (replace newlines with nulls).</span></td></tr><tr><th id=\"L2148\"><a href=\"#L2148\">2148</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2149\"><a href=\"#L2149\">2149</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># Escape newline characters</span></td></tr><tr><th id=\"L2150\"><a href=\"#L2150\">2150</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0path<span class=\"o\">.</span>replace<span class=\"p\">(</span><span class=\"s\">'</span><span class=\"se\">\\n</span><span class=\"s\">'</span><span class=\"p\">,</span>\u00a0<span class=\"s\">'</span><span class=\"se\">\\0</span><span class=\"s\">'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2151\"><a href=\"#L2151\">2151</a></th><td></td></tr><tr><th id=\"L2152\"><a href=\"#L2152\">2152</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">retrieveFile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">,</span>\u00a0offset<span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">):</span></td></tr><tr><th id=\"L2153\"><a href=\"#L2153\">2153</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2154\"><a href=\"#L2154\">2154</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Retrieve a file from the given path</span></td></tr><tr><th id=\"L2155\"><a href=\"#L2155\">2155</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2156\"><a href=\"#L2156\">2156</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 This method issues the 'RETR' FTP command.</span></td></tr><tr><th id=\"L2157\"><a href=\"#L2157\">2157</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2158\"><a href=\"#L2158\">2158</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 The file is fed into the given Protocol instance.\u00a0 The data connection</span></td></tr><tr><th id=\"L2159\"><a href=\"#L2159\">2159</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 will be passive if self.passive is set.</span></td></tr><tr><th id=\"L2160\"><a href=\"#L2160\">2160</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2161\"><a href=\"#L2161\">2161</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: path to file that you wish to receive.</span></td></tr><tr><th id=\"L2162\"><a href=\"#L2162\">2162</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param protocol: a L{Protocol} instance.</span></td></tr><tr><th id=\"L2163\"><a href=\"#L2163\">2163</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param offset: offset to start downloading from</span></td></tr><tr><th id=\"L2164\"><a href=\"#L2164\">2164</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2165\"><a href=\"#L2165\">2165</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: L{Deferred}</span></td></tr><tr><th id=\"L2166\"><a href=\"#L2166\">2166</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2167\"><a href=\"#L2167\">2167</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 cmds <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"s\">'RETR '</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>escapePath<span class=\"p\">(</span>path<span class=\"p\">)]</span></td></tr><tr><th id=\"L2168\"><a href=\"#L2168\">2168</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0offset<span class=\"p\">:</span></td></tr><tr><th id=\"L2169\"><a href=\"#L2169\">2169</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cmds<span class=\"o\">.</span>insert<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0<span class=\"p\">(</span><span class=\"s\">'REST '</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>offset<span class=\"p\">)))</span></td></tr><tr><th id=\"L2170\"><a href=\"#L2170\">2170</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>receiveFromConnection<span class=\"p\">(</span>cmds<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">)</span></td></tr><tr><th id=\"L2171\"><a href=\"#L2171\">2171</a></th><td></td></tr><tr><th id=\"L2172\"><a href=\"#L2172\">2172</a></th><td>\u00a0 \u00a0 retr <span class=\"o\">=</span>\u00a0retrieveFile</td></tr><tr><th id=\"L2173\"><a href=\"#L2173\">2173</a></th><td></td></tr><tr><th id=\"L2174\"><a href=\"#L2174\">2174</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">storeFile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">,</span>\u00a0offset<span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">):</span></td></tr><tr><th id=\"L2175\"><a href=\"#L2175\">2175</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2176\"><a href=\"#L2176\">2176</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Store a file at the given path.</span></td></tr><tr><th id=\"L2177\"><a href=\"#L2177\">2177</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2178\"><a href=\"#L2178\">2178</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 This method issues the 'STOR' FTP command.</span></td></tr><tr><th id=\"L2179\"><a href=\"#L2179\">2179</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2180\"><a href=\"#L2180\">2180</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: A tuple of two L{Deferred}s:</span></td></tr><tr><th id=\"L2181\"><a href=\"#L2181\">2181</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - L{Deferred} L{IFinishableConsumer}. You must call</span></td></tr><tr><th id=\"L2182\"><a href=\"#L2182\">2182</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 the C{finish} method on the IFinishableConsumer when the file</span></td></tr><tr><th id=\"L2183\"><a href=\"#L2183\">2183</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 is completely transferred.</span></td></tr><tr><th id=\"L2184\"><a href=\"#L2184\">2184</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - L{Deferred} list of control-connection responses.</span></td></tr><tr><th id=\"L2185\"><a href=\"#L2185\">2185</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2186\"><a href=\"#L2186\">2186</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 cmds <span class=\"o\">=</span>\u00a0<span class=\"p\">[</span><span class=\"s\">'STOR '</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>escapePath<span class=\"p\">(</span>path<span class=\"p\">)]</span></td></tr><tr><th id=\"L2187\"><a href=\"#L2187\">2187</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0offset<span class=\"p\">:</span></td></tr><tr><th id=\"L2188\"><a href=\"#L2188\">2188</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cmds<span class=\"o\">.</span>insert<span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span>\u00a0<span class=\"p\">(</span><span class=\"s\">'REST '</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"nb\">str</span><span class=\"p\">(</span>offset<span class=\"p\">)))</span></td></tr><tr><th id=\"L2189\"><a href=\"#L2189\">2189</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>sendToConnection<span class=\"p\">(</span>cmds<span class=\"p\">)</span></td></tr><tr><th id=\"L2190\"><a href=\"#L2190\">2190</a></th><td></td></tr><tr><th id=\"L2191\"><a href=\"#L2191\">2191</a></th><td>\u00a0 \u00a0 stor <span class=\"o\">=</span>\u00a0storeFile</td></tr><tr><th id=\"L2192\"><a href=\"#L2192\">2192</a></th><td></td></tr><tr><th id=\"L2193\"><a href=\"#L2193\">2193</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">):</span></td></tr><tr><th id=\"L2194\"><a href=\"#L2194\">2194</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2195\"><a href=\"#L2195\">2195</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Retrieve a file listing into the given protocol instance.</span></td></tr><tr><th id=\"L2196\"><a href=\"#L2196\">2196</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2197\"><a href=\"#L2197\">2197</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 This method issues the 'LIST' FTP command.</span></td></tr><tr><th id=\"L2198\"><a href=\"#L2198\">2198</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2199\"><a href=\"#L2199\">2199</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: path to get a file listing for.</span></td></tr><tr><th id=\"L2200\"><a href=\"#L2200\">2200</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param protocol: a L{Protocol} instance, probably a</span></td></tr><tr><th id=\"L2201\"><a href=\"#L2201\">2201</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 L{FTPFileListProtocol} instance.\u00a0 It can cope with most common file</span></td></tr><tr><th id=\"L2202\"><a href=\"#L2202\">2202</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 listing formats.</span></td></tr><tr><th id=\"L2203\"><a href=\"#L2203\">2203</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2204\"><a href=\"#L2204\">2204</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: L{Deferred}</span></td></tr><tr><th id=\"L2205\"><a href=\"#L2205\">2205</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2206\"><a href=\"#L2206\">2206</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0path <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2207\"><a href=\"#L2207\">2207</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path <span class=\"o\">=</span>\u00a0<span class=\"s\">''</span></td></tr><tr><th id=\"L2208\"><a href=\"#L2208\">2208</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>receiveFromConnection<span class=\"p\">([</span><span class=\"s\">'LIST '</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>escapePath<span class=\"p\">(</span>path<span class=\"p\">)],</span>\u00a0protocol<span class=\"p\">)</span></td></tr><tr><th id=\"L2209\"><a href=\"#L2209\">2209</a></th><td></td></tr><tr><th id=\"L2210\"><a href=\"#L2210\">2210</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">nlst</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">,</span>\u00a0protocol<span class=\"p\">):</span></td></tr><tr><th id=\"L2211\"><a href=\"#L2211\">2211</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2212\"><a href=\"#L2212\">2212</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Retrieve a short file listing into the given protocol instance.</span></td></tr><tr><th id=\"L2213\"><a href=\"#L2213\">2213</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2214\"><a href=\"#L2214\">2214</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 This method issues the 'NLST' FTP command.</span></td></tr><tr><th id=\"L2215\"><a href=\"#L2215\">2215</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2216\"><a href=\"#L2216\">2216</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 NLST (should) return a list of filenames, one per line.</span></td></tr><tr><th id=\"L2217\"><a href=\"#L2217\">2217</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2218\"><a href=\"#L2218\">2218</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: path to get short file listing for.</span></td></tr><tr><th id=\"L2219\"><a href=\"#L2219\">2219</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param protocol: a L{Protocol} instance.</span></td></tr><tr><th id=\"L2220\"><a href=\"#L2220\">2220</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2221\"><a href=\"#L2221\">2221</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0path <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2222\"><a href=\"#L2222\">2222</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path <span class=\"o\">=</span>\u00a0<span class=\"s\">''</span></td></tr><tr><th id=\"L2223\"><a href=\"#L2223\">2223</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>receiveFromConnection<span class=\"p\">([</span><span class=\"s\">'NLST '</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>escapePath<span class=\"p\">(</span>path<span class=\"p\">)],</span>\u00a0protocol<span class=\"p\">)</span></td></tr><tr><th id=\"L2224\"><a href=\"#L2224\">2224</a></th><td></td></tr><tr><th id=\"L2225\"><a href=\"#L2225\">2225</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cwd</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L2226\"><a href=\"#L2226\">2226</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2227\"><a href=\"#L2227\">2227</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Issues the CWD (Change Working Directory) command. It's also</span></td></tr><tr><th id=\"L2228\"><a href=\"#L2228\">2228</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 available as changeDirectory, which parses the result.</span></td></tr><tr><th id=\"L2229\"><a href=\"#L2229\">2229</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2230\"><a href=\"#L2230\">2230</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: a L{Deferred} that will be called when done.</span></td></tr><tr><th id=\"L2231\"><a href=\"#L2231\">2231</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2232\"><a href=\"#L2232\">2232</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>queueStringCommand<span class=\"p\">(</span><span class=\"s\">'CWD '</span>\u00a0<span class=\"o\">+</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>escapePath<span class=\"p\">(</span>path<span class=\"p\">))</span></td></tr><tr><th id=\"L2233\"><a href=\"#L2233\">2233</a></th><td></td></tr><tr><th id=\"L2234\"><a href=\"#L2234\">2234</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">changeDirectory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0path<span class=\"p\">):</span></td></tr><tr><th id=\"L2235\"><a href=\"#L2235\">2235</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2236\"><a href=\"#L2236\">2236</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Change the directory on the server and parse the result to determine</span></td></tr><tr><th id=\"L2237\"><a href=\"#L2237\">2237</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 if it was successful or not.</span></td></tr><tr><th id=\"L2238\"><a href=\"#L2238\">2238</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2239\"><a href=\"#L2239\">2239</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type path: C{str}</span></td></tr><tr><th id=\"L2240\"><a href=\"#L2240\">2240</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param path: The path to which to change.</span></td></tr><tr><th id=\"L2241\"><a href=\"#L2241\">2241</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2242\"><a href=\"#L2242\">2242</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: a L{Deferred} which will be called back when the directory</span></td></tr><tr><th id=\"L2243\"><a href=\"#L2243\">2243</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 change has succeeded or and errbacked if an error occurrs.</span></td></tr><tr><th id=\"L2244\"><a href=\"#L2244\">2244</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2245\"><a href=\"#L2245\">2245</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbParse</span><span class=\"p\">(</span>result<span class=\"p\">):</span></td></tr><tr><th id=\"L2246\"><a href=\"#L2246\">2246</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2247\"><a href=\"#L2247\">2247</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># The only valid code is 250</span></td></tr><tr><th id=\"L2248\"><a href=\"#L2248\">2248</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">int</span><span class=\"p\">(</span>result<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span>split<span class=\"p\">(</span><span class=\"s\">' '</span><span class=\"p\">,</span>\u00a0<span class=\"mi\">1</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">])</span>\u00a0<span class=\"o\">==</span>\u00a0<span class=\"mi\">250</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2249\"><a href=\"#L2249\">2249</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">True</span></td></tr><tr><th id=\"L2250\"><a href=\"#L2250\">2250</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2251\"><a href=\"#L2251\">2251</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">ValueError</span></td></tr><tr><th id=\"L2252\"><a href=\"#L2252\">2252</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0<span class=\"p\">(</span><span class=\"ne\">IndexError</span><span class=\"p\">,</span>\u00a0<span class=\"ne\">ValueError</span><span class=\"p\">),</span>\u00a0e<span class=\"p\">:</span></td></tr><tr><th id=\"L2253\"><a href=\"#L2253\">2253</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0failure<span class=\"o\">.</span>Failure<span class=\"p\">(</span>CommandFailed<span class=\"p\">(</span>result<span class=\"p\">))</span></td></tr><tr><th id=\"L2254\"><a href=\"#L2254\">2254</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>cwd<span class=\"p\">(</span>path<span class=\"p\">)</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span>cbParse<span class=\"p\">)</span></td></tr><tr><th id=\"L2255\"><a href=\"#L2255\">2255</a></th><td></td></tr><tr><th id=\"L2256\"><a href=\"#L2256\">2256</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cdup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L2257\"><a href=\"#L2257\">2257</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2258\"><a href=\"#L2258\">2258</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Issues the CDUP (Change Directory UP) command.</span></td></tr><tr><th id=\"L2259\"><a href=\"#L2259\">2259</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2260\"><a href=\"#L2260\">2260</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: a L{Deferred} that will be called when done.</span></td></tr><tr><th id=\"L2261\"><a href=\"#L2261\">2261</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2262\"><a href=\"#L2262\">2262</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>queueStringCommand<span class=\"p\">(</span><span class=\"s\">'CDUP'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2263\"><a href=\"#L2263\">2263</a></th><td></td></tr><tr><th id=\"L2264\"><a href=\"#L2264\">2264</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">pwd</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L2265\"><a href=\"#L2265\">2265</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2266\"><a href=\"#L2266\">2266</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Issues the PWD (Print Working Directory) command.</span></td></tr><tr><th id=\"L2267\"><a href=\"#L2267\">2267</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2268\"><a href=\"#L2268\">2268</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 The L{getDirectory} does the same job but automatically parses the</span></td></tr><tr><th id=\"L2269\"><a href=\"#L2269\">2269</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 result.</span></td></tr><tr><th id=\"L2270\"><a href=\"#L2270\">2270</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2271\"><a href=\"#L2271\">2271</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: a L{Deferred} that will be called when done.\u00a0 It is up to the</span></td></tr><tr><th id=\"L2272\"><a href=\"#L2272\">2272</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 caller to interpret the response, but the L{parsePWDResponse} method</span></td></tr><tr><th id=\"L2273\"><a href=\"#L2273\">2273</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 in this module should work.</span></td></tr><tr><th id=\"L2274\"><a href=\"#L2274\">2274</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2275\"><a href=\"#L2275\">2275</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>queueStringCommand<span class=\"p\">(</span><span class=\"s\">'PWD'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2276\"><a href=\"#L2276\">2276</a></th><td></td></tr><tr><th id=\"L2277\"><a href=\"#L2277\">2277</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">getDirectory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L2278\"><a href=\"#L2278\">2278</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2279\"><a href=\"#L2279\">2279</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Returns the current remote directory.</span></td></tr><tr><th id=\"L2280\"><a href=\"#L2280\">2280</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2281\"><a href=\"#L2281\">2281</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: a L{Deferred} that will be called back with a C{str} giving</span></td></tr><tr><th id=\"L2282\"><a href=\"#L2282\">2282</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 the remote directory or which will errback with L{CommandFailed}</span></td></tr><tr><th id=\"L2283\"><a href=\"#L2283\">2283</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if an error response is returned.</span></td></tr><tr><th id=\"L2284\"><a href=\"#L2284\">2284</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2285\"><a href=\"#L2285\">2285</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">cbParse</span><span class=\"p\">(</span>result<span class=\"p\">):</span></td></tr><tr><th id=\"L2286\"><a href=\"#L2286\">2286</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">try</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2287\"><a href=\"#L2287\">2287</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"c\"># The only valid code is 257</span></td></tr><tr><th id=\"L2288\"><a href=\"#L2288\">2288</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0<span class=\"nb\">int</span><span class=\"p\">(</span>result<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span>split<span class=\"p\">(</span><span class=\"s\">' '</span><span class=\"p\">,</span>\u00a0<span class=\"mi\">1</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">])</span>\u00a0<span class=\"o\">!=</span>\u00a0<span class=\"mi\">257</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2289\"><a href=\"#L2289\">2289</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">raise</span>\u00a0<span class=\"ne\">ValueError</span></td></tr><tr><th id=\"L2290\"><a href=\"#L2290\">2290</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">except</span>\u00a0<span class=\"p\">(</span><span class=\"ne\">IndexError</span><span class=\"p\">,</span>\u00a0<span class=\"ne\">ValueError</span><span class=\"p\">),</span>\u00a0e<span class=\"p\">:</span></td></tr><tr><th id=\"L2291\"><a href=\"#L2291\">2291</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0failure<span class=\"o\">.</span>Failure<span class=\"p\">(</span>CommandFailed<span class=\"p\">(</span>result<span class=\"p\">))</span></td></tr><tr><th id=\"L2292\"><a href=\"#L2292\">2292</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path <span class=\"o\">=</span>\u00a0parsePWDResponse<span class=\"p\">(</span>result<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span></td></tr><tr><th id=\"L2293\"><a href=\"#L2293\">2293</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0path <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2294\"><a href=\"#L2294\">2294</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0failure<span class=\"o\">.</span>Failure<span class=\"p\">(</span>CommandFailed<span class=\"p\">(</span>result<span class=\"p\">))</span></td></tr><tr><th id=\"L2295\"><a href=\"#L2295\">2295</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0path</td></tr><tr><th id=\"L2296\"><a href=\"#L2296\">2296</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>pwd<span class=\"p\">()</span><span class=\"o\">.</span>addCallback<span class=\"p\">(</span>cbParse<span class=\"p\">)</span></td></tr><tr><th id=\"L2297\"><a href=\"#L2297\">2297</a></th><td></td></tr><tr><th id=\"L2298\"><a href=\"#L2298\">2298</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">quit</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L2299\"><a href=\"#L2299\">2299</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"</span></td></tr><tr><th id=\"L2300\"><a href=\"#L2300\">2300</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Issues the QUIT command.</span></td></tr><tr><th id=\"L2301\"><a href=\"#L2301\">2301</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2302\"><a href=\"#L2302\">2302</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>queueStringCommand<span class=\"p\">(</span><span class=\"s\">'QUIT'</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2303\"><a href=\"#L2303\">2303</a></th><td></td></tr><tr><th id=\"L2304\"><a href=\"#L2304\">2304</a></th><td></td></tr><tr><th id=\"L2305\"><a href=\"#L2305\">2305</a></th><td><span class=\"k\">class</span>\u00a0<span class=\"nc\">FTPFileListProtocol</span><span class=\"p\">(</span>basic<span class=\"o\">.</span>LineReceiver<span class=\"p\">):</span></td></tr><tr><th id=\"L2306\"><a href=\"#L2306\">2306</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Parser for standard FTP file listings</span></td></tr><tr><th id=\"L2307\"><a href=\"#L2307\">2307</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2308\"><a href=\"#L2308\">2308</a></th><td><span class=\"sd\">\u00a0 \u00a0 This is the evil required to match::</span></td></tr><tr><th id=\"L2309\"><a href=\"#L2309\">2309</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2310\"><a href=\"#L2310\">2310</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 -rw-r--r--\u00a0 \u00a01 root\u00a0 \u00a0 \u00a0other\u00a0 \u00a0 \u00a0 \u00a0 531 Jan 29 03:26 README</span></td></tr><tr><th id=\"L2311\"><a href=\"#L2311\">2311</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2312\"><a href=\"#L2312\">2312</a></th><td><span class=\"sd\">\u00a0 \u00a0 If you need different evil for a wacky FTP server, you can</span></td></tr><tr><th id=\"L2313\"><a href=\"#L2313\">2313</a></th><td><span class=\"sd\">\u00a0 \u00a0 override either C{fileLinePattern} or C{parseDirectoryLine()}.</span></td></tr><tr><th id=\"L2314\"><a href=\"#L2314\">2314</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2315\"><a href=\"#L2315\">2315</a></th><td><span class=\"sd\">\u00a0 \u00a0 It populates the instance attribute self.files, which is a list containing</span></td></tr><tr><th id=\"L2316\"><a href=\"#L2316\">2316</a></th><td><span class=\"sd\">\u00a0 \u00a0 dicts with the following keys (examples from the above line):</span></td></tr><tr><th id=\"L2317\"><a href=\"#L2317\">2317</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 - filetype:\u00a0 \u00a0e.g. 'd' for directories, or '-' for an ordinary file</span></td></tr><tr><th id=\"L2318\"><a href=\"#L2318\">2318</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 - perms:\u00a0 \u00a0 \u00a0 e.g. 'rw-r--r--'</span></td></tr><tr><th id=\"L2319\"><a href=\"#L2319\">2319</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 - nlinks:\u00a0 \u00a0 \u00a0e.g. 1</span></td></tr><tr><th id=\"L2320\"><a href=\"#L2320\">2320</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 - owner:\u00a0 \u00a0 \u00a0 e.g. 'root'</span></td></tr><tr><th id=\"L2321\"><a href=\"#L2321\">2321</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 - group:\u00a0 \u00a0 \u00a0 e.g. 'other'</span></td></tr><tr><th id=\"L2322\"><a href=\"#L2322\">2322</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 - size:\u00a0 \u00a0 \u00a0 \u00a0e.g. 531</span></td></tr><tr><th id=\"L2323\"><a href=\"#L2323\">2323</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 - date:\u00a0 \u00a0 \u00a0 \u00a0e.g. 'Jan 29 03:26'</span></td></tr><tr><th id=\"L2324\"><a href=\"#L2324\">2324</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 - filename:\u00a0 \u00a0e.g. 'README'</span></td></tr><tr><th id=\"L2325\"><a href=\"#L2325\">2325</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 - linktarget: e.g. 'some/file'</span></td></tr><tr><th id=\"L2326\"><a href=\"#L2326\">2326</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2327\"><a href=\"#L2327\">2327</a></th><td><span class=\"sd\">\u00a0 \u00a0 Note that the 'date' value will be formatted differently depending on the</span></td></tr><tr><th id=\"L2328\"><a href=\"#L2328\">2328</a></th><td><span class=\"sd\">\u00a0 \u00a0 date.\u00a0 Check U{http://cr.yp.to/ftp.html} if you really want to try to parse</span></td></tr><tr><th id=\"L2329\"><a href=\"#L2329\">2329</a></th><td><span class=\"sd\">\u00a0 \u00a0 it.</span></td></tr><tr><th id=\"L2330\"><a href=\"#L2330\">2330</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2331\"><a href=\"#L2331\">2331</a></th><td><span class=\"sd\">\u00a0 \u00a0 @ivar files: list of dicts describing the files in this listing</span></td></tr><tr><th id=\"L2332\"><a href=\"#L2332\">2332</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2333\"><a href=\"#L2333\">2333</a></th><td>\u00a0 \u00a0 fileLinePattern <span class=\"o\">=</span>\u00a0re<span class=\"o\">.</span>compile<span class=\"p\">(</span></td></tr><tr><th id=\"L2334\"><a href=\"#L2334\">2334</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">r'^(?P&lt;filetype&gt;.)(?P&lt;perms&gt;.{9})\\s+(?P&lt;nlinks&gt;\\d*)\\s*'</span></td></tr><tr><th id=\"L2335\"><a href=\"#L2335\">2335</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">r'(?P&lt;owner&gt;\\S+)\\s+(?P&lt;group&gt;\\S+)\\s+(?P&lt;size&gt;\\d+)\\s+'</span></td></tr><tr><th id=\"L2336\"><a href=\"#L2336\">2336</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">r'(?P&lt;date&gt;...\\s+\\d+\\s+[\\d:]+)\\s+(?P&lt;filename&gt;([^ ]|</span><span class=\"se\">\\\\</span><span class=\"s\">\u00a0)*?)'</span></td></tr><tr><th id=\"L2337\"><a href=\"#L2337\">2337</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"s\">r'( -&gt; (?P&lt;linktarget&gt;[^\\r]*))?\\r?$'</span></td></tr><tr><th id=\"L2338\"><a href=\"#L2338\">2338</a></th><td>\u00a0 \u00a0 <span class=\"p\">)</span></td></tr><tr><th id=\"L2339\"><a href=\"#L2339\">2339</a></th><td>\u00a0 \u00a0 delimiter <span class=\"o\">=</span>\u00a0<span class=\"s\">'</span><span class=\"se\">\\n</span><span class=\"s\">'</span></td></tr><tr><th id=\"L2340\"><a href=\"#L2340\">2340</a></th><td></td></tr><tr><th id=\"L2341\"><a href=\"#L2341\">2341</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span></td></tr><tr><th id=\"L2342\"><a href=\"#L2342\">2342</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>files <span class=\"o\">=</span>\u00a0<span class=\"p\">[]</span></td></tr><tr><th id=\"L2343\"><a href=\"#L2343\">2343</a></th><td></td></tr><tr><th id=\"L2344\"><a href=\"#L2344\">2344</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">lineReceived</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">):</span></td></tr><tr><th id=\"L2345\"><a href=\"#L2345\">2345</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>parseDirectoryLine<span class=\"p\">(</span>line<span class=\"p\">)</span></td></tr><tr><th id=\"L2346\"><a href=\"#L2346\">2346</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0d <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2347\"><a href=\"#L2347\">2347</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>unknownLine<span class=\"p\">(</span>line<span class=\"p\">)</span></td></tr><tr><th id=\"L2348\"><a href=\"#L2348\">2348</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2349\"><a href=\"#L2349\">2349</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>addFile<span class=\"p\">(</span>d<span class=\"p\">)</span></td></tr><tr><th id=\"L2350\"><a href=\"#L2350\">2350</a></th><td></td></tr><tr><th id=\"L2351\"><a href=\"#L2351\">2351</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">parseDirectoryLine</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">):</span></td></tr><tr><th id=\"L2352\"><a href=\"#L2352\">2352</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Return a dictionary of fields, or None if line cannot be parsed.</span></td></tr><tr><th id=\"L2353\"><a href=\"#L2353\">2353</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2354\"><a href=\"#L2354\">2354</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param line: line of text expected to contain a directory entry</span></td></tr><tr><th id=\"L2355\"><a href=\"#L2355\">2355</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type line: str</span></td></tr><tr><th id=\"L2356\"><a href=\"#L2356\">2356</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2357\"><a href=\"#L2357\">2357</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @return: dict</span></td></tr><tr><th id=\"L2358\"><a href=\"#L2358\">2358</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2359\"><a href=\"#L2359\">2359</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 match <span class=\"o\">=</span>\u00a0<span class=\"bp\">self</span><span class=\"o\">.</span>fileLinePattern<span class=\"o\">.</span>match<span class=\"p\">(</span>line<span class=\"p\">)</span></td></tr><tr><th id=\"L2360\"><a href=\"#L2360\">2360</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0match <span class=\"ow\">is</span>\u00a0<span class=\"bp\">None</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2361\"><a href=\"#L2361\">2361</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">None</span></td></tr><tr><th id=\"L2362\"><a href=\"#L2362\">2362</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2363\"><a href=\"#L2363\">2363</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d <span class=\"o\">=</span>\u00a0match<span class=\"o\">.</span>groupdict<span class=\"p\">()</span></td></tr><tr><th id=\"L2364\"><a href=\"#L2364\">2364</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"p\">[</span><span class=\"s\">'filename'</span><span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0d<span class=\"p\">[</span><span class=\"s\">'filename'</span><span class=\"p\">]</span><span class=\"o\">.</span>replace<span class=\"p\">(</span><span class=\"s\">r'\\ '</span><span class=\"p\">,</span>\u00a0<span class=\"s\">' '</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2365\"><a href=\"#L2365\">2365</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"p\">[</span><span class=\"s\">'nlinks'</span><span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0<span class=\"nb\">int</span><span class=\"p\">(</span>d<span class=\"p\">[</span><span class=\"s\">'nlinks'</span><span class=\"p\">])</span></td></tr><tr><th id=\"L2366\"><a href=\"#L2366\">2366</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"p\">[</span><span class=\"s\">'size'</span><span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0<span class=\"nb\">int</span><span class=\"p\">(</span>d<span class=\"p\">[</span><span class=\"s\">'size'</span><span class=\"p\">])</span></td></tr><tr><th id=\"L2367\"><a href=\"#L2367\">2367</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">if</span>\u00a0d<span class=\"p\">[</span><span class=\"s\">'linktarget'</span><span class=\"p\">]:</span></td></tr><tr><th id=\"L2368\"><a href=\"#L2368\">2368</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 d<span class=\"p\">[</span><span class=\"s\">'linktarget'</span><span class=\"p\">]</span>\u00a0<span class=\"o\">=</span>\u00a0d<span class=\"p\">[</span><span class=\"s\">'linktarget'</span><span class=\"p\">]</span><span class=\"o\">.</span>replace<span class=\"p\">(</span><span class=\"s\">r'\\ '</span><span class=\"p\">,</span>\u00a0<span class=\"s\">' '</span><span class=\"p\">)</span></td></tr><tr><th id=\"L2369\"><a href=\"#L2369\">2369</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0d</td></tr><tr><th id=\"L2370\"><a href=\"#L2370\">2370</a></th><td></td></tr><tr><th id=\"L2371\"><a href=\"#L2371\">2371</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">addFile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0info<span class=\"p\">):</span></td></tr><tr><th id=\"L2372\"><a href=\"#L2372\">2372</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Append file information dictionary to the list of known files.</span></td></tr><tr><th id=\"L2373\"><a href=\"#L2373\">2373</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2374\"><a href=\"#L2374\">2374</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Subclasses can override or extend this method to handle file</span></td></tr><tr><th id=\"L2375\"><a href=\"#L2375\">2375</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 information differently without affecting the parsing of data</span></td></tr><tr><th id=\"L2376\"><a href=\"#L2376\">2376</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 from the server.</span></td></tr><tr><th id=\"L2377\"><a href=\"#L2377\">2377</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2378\"><a href=\"#L2378\">2378</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param info: dictionary containing the parsed representation</span></td></tr><tr><th id=\"L2379\"><a href=\"#L2379\">2379</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0of the file information</span></td></tr><tr><th id=\"L2380\"><a href=\"#L2380\">2380</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type info: dict</span></td></tr><tr><th id=\"L2381\"><a href=\"#L2381\">2381</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2382\"><a href=\"#L2382\">2382</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"bp\">self</span><span class=\"o\">.</span>files<span class=\"o\">.</span>append<span class=\"p\">(</span>info<span class=\"p\">)</span></td></tr><tr><th id=\"L2383\"><a href=\"#L2383\">2383</a></th><td></td></tr><tr><th id=\"L2384\"><a href=\"#L2384\">2384</a></th><td>\u00a0 \u00a0 <span class=\"k\">def</span>\u00a0<span class=\"nf\">unknownLine</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span>\u00a0line<span class=\"p\">):</span></td></tr><tr><th id=\"L2385\"><a href=\"#L2385\">2385</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"sd\">\"\"\"Deal with received lines which could not be parsed as file</span></td></tr><tr><th id=\"L2386\"><a href=\"#L2386\">2386</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 information.</span></td></tr><tr><th id=\"L2387\"><a href=\"#L2387\">2387</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2388\"><a href=\"#L2388\">2388</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 Subclasses can override this to perform any special processing</span></td></tr><tr><th id=\"L2389\"><a href=\"#L2389\">2389</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 needed.</span></td></tr><tr><th id=\"L2390\"><a href=\"#L2390\">2390</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2391\"><a href=\"#L2391\">2391</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @param line: unparsable line as received</span></td></tr><tr><th id=\"L2392\"><a href=\"#L2392\">2392</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 @type line: str</span></td></tr><tr><th id=\"L2393\"><a href=\"#L2393\">2393</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2394\"><a href=\"#L2394\">2394</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">pass</span></td></tr><tr><th id=\"L2395\"><a href=\"#L2395\">2395</a></th><td></td></tr><tr><th id=\"L2396\"><a href=\"#L2396\">2396</a></th><td><span class=\"k\">def</span>\u00a0<span class=\"nf\">parsePWDResponse</span><span class=\"p\">(</span>response<span class=\"p\">):</span></td></tr><tr><th id=\"L2397\"><a href=\"#L2397\">2397</a></th><td>\u00a0 \u00a0 <span class=\"sd\">\"\"\"Returns the path from a response to a PWD command.</span></td></tr><tr><th id=\"L2398\"><a href=\"#L2398\">2398</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2399\"><a href=\"#L2399\">2399</a></th><td><span class=\"sd\">\u00a0 \u00a0 Responses typically look like::</span></td></tr><tr><th id=\"L2400\"><a href=\"#L2400\">2400</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2401\"><a href=\"#L2401\">2401</a></th><td><span class=\"sd\">\u00a0 \u00a0 \u00a0 \u00a0 257 \"/home/andrew\" is current directory.</span></td></tr><tr><th id=\"L2402\"><a href=\"#L2402\">2402</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2403\"><a href=\"#L2403\">2403</a></th><td><span class=\"sd\">\u00a0 \u00a0 For this example, I will return C{'/home/andrew'}.</span></td></tr><tr><th id=\"L2404\"><a href=\"#L2404\">2404</a></th><td><span class=\"sd\"></span></td></tr><tr><th id=\"L2405\"><a href=\"#L2405\">2405</a></th><td><span class=\"sd\">\u00a0 \u00a0 If I can't find the path, I return C{None}.</span></td></tr><tr><th id=\"L2406\"><a href=\"#L2406\">2406</a></th><td><span class=\"sd\">\u00a0 \u00a0 \"\"\"</span></td></tr><tr><th id=\"L2407\"><a href=\"#L2407\">2407</a></th><td>\u00a0 \u00a0 match <span class=\"o\">=</span>\u00a0re<span class=\"o\">.</span>search<span class=\"p\">(</span><span class=\"s\">'\"(.*)\"'</span><span class=\"p\">,</span>\u00a0response<span class=\"p\">)</span></td></tr><tr><th id=\"L2408\"><a href=\"#L2408\">2408</a></th><td>\u00a0 \u00a0 <span class=\"k\">if</span>\u00a0match<span class=\"p\">:</span></td></tr><tr><th id=\"L2409\"><a href=\"#L2409\">2409</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0match<span class=\"o\">.</span>groups<span class=\"p\">()[</span><span class=\"mi\">0</span><span class=\"p\">]</span></td></tr><tr><th id=\"L2410\"><a href=\"#L2410\">2410</a></th><td>\u00a0 \u00a0 <span class=\"k\">else</span><span class=\"p\">:</span></td></tr><tr><th id=\"L2411\"><a href=\"#L2411\">2411</a></th><td>\u00a0 \u00a0 \u00a0 \u00a0 <span class=\"k\">return</span>\u00a0<span class=\"bp\">None</span></td></tr></tbody></table>\n\n      </div>\n      <div id=\"anydiff\">\n        <form action=\"/LUCICodeRepository/nomaticIM/diff\" method=\"get\">\n          <div class=\"buttons\">\n            <input type=\"hidden\" name=\"new_path\" value=\"/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py\" />\n            <input type=\"hidden\" name=\"old_path\" value=\"/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py\" />\n            <input type=\"hidden\" name=\"new_rev\" />\n            <input type=\"hidden\" name=\"old_rev\" />\n            <input type=\"submit\" value=\"View changes...\" title=\"Select paths and revs for Diff\" />\n          </div>\n        </form>\n      </div>\n      <div id=\"help\"><strong>Note:</strong> See <a href=\"/LUCICodeRepository/nomaticIM/wiki/TracBrowser\">TracBrowser</a>\n        for help on using the repository browser.</div>\n    </div>\n    <div id=\"altlinks\">\n      <h3>Download in other formats:</h3>\n      <ul>\n        <li class=\"first\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/browser/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py?format=txt\">Plain Text</a>\n        </li><li class=\"last\">\n          <a rel=\"nofollow\" href=\"/LUCICodeRepository/nomaticIM/export/1312/nomatic/tags/NomaticIM-0.0.4/buddy_bots/src/twisted/protocols/ftp.py\">Original Format</a>\n        </li>\n      </ul>\n    </div>\n    </div>\n    <div id=\"footer\" lang=\"en\" xml:lang=\"en\"><hr />\n      <a id=\"tracpowered\" href=\"http://trac.edgewall.org/\"><img src=\"/LUCICodeRepository/nomaticIM/chrome/common/trac_logo_mini.png\" height=\"30\" width=\"107\" alt=\"Trac Powered\" /></a>\n      <p class=\"left\">Powered by <a href=\"/LUCICodeRepository/nomaticIM/about\"><strong>Trac 1.0.1</strong></a><br />\n        By <a href=\"http://www.edgewall.org/\">Edgewall Software</a>.</p>\n      <p class=\"right\">All content copyright 2007-2008 by LUCI <br /><a href=\"http://luci.ics.uci.edu/\">http://luci.ics.uci.edu/</a></p>\n    </div>\n\t\t<div id=\"sitefooter\">\n\t\t\t<script src=\"http://www.google-analytics.com/urchin.js\" type=\"text/javascript\">\n\t\t\t</script>\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t_uacct = \"UA-338915-2\";\n\t\t\t\turchinTracker();\n\t\t\t</script>\n\t\t</div>\n\t</body>\n</html>", "id": 44535.0}